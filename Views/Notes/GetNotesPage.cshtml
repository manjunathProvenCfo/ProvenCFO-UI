@using Proven.Model
@{
    ViewBag.Title = "GetNotesPage";
}

<div class="container-fluid p-0" data-layout="container">
    <div class="card mb-3">
        <div class="bg-holder d-none d-lg-block bg-card" style="background-image:url(../assets/img/illustrations/corner-4.png);">
        </div>
        <!--/.bg-holder-->

        <div class="card-body" id="v-pills-Summary">
            <div class="row">
                <div class="col-lg-9">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="mb-0">Summary</h5>
                        </div>
                        <div class="col-md-6">

                        </div>
                    </div>
                    <p class="mt-2">The MailBluster service (the “Service”) is a marketing service offered through the URL MailBluster.com (including any subdomains), our campaign sites and our email websites (together referred to as the “Website”) that allows you to create, send and manage bulk email messages to individual recipients or subscribers. Each such email message in respect of which you use the Service, including the image, text, and code comprised in it, is referred to in these Terms as “Content”). MailBluster is owned and operated by. <br />$6.25 / seat month after a trial</p>
                </div>
                <div class="col-3">
                    @if (ViewBag.IsEditMode == true)
                    {
                        <h5 class="mb-0 text-right"><span class="fas fa-edit"></span></h5>
                    }
                    <div class="Words mt-8">Created by: Dave Willson , 06/21/20 | Last Edited by: Conryd Salvesen, 7/22/21 </div>
                </div>
            </div>
        </div>
    </div>
   
    <div class="row scrollspy-listing">

        <div class="col-3 order-2">

            <div class="sticky-top sticky-kit right-nav-pills bg-white">

                <div class="nav flex-column nav-pills">
                    @foreach (var Categories in (IEnumerable<NotesCategoriesModel>)TempData["CategoriesAndNotes"])
                    {
                        <a class="nav-link active" href="#v-pills-@Categories.NoteCategory" data-category-id="@Categories.Id" data-fancyscroll data-offset="80">@Categories.NoteCategory</a>
                    }
                </div>
            </div>
        </div>

        <div class="col-9 order-1">

            @{ int counter = 0; }
            @foreach (var Categories in (IEnumerable<NotesCategoriesModel>)TempData["CategoriesAndNotes"])
            {
                <div class="mb-3 v-pills-div" id="v-pills-@Categories.NoteCategory" data-category-id="@Categories.Id">
                    <div class="card">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <h3>@Categories.NoteCategory</h3>
                            @*<div class="btn btn-light p-0"><i class="fas fa-plus"></i></div>*@
                            @*Here I am writing new line for add button for testing*@
                            @if (ViewBag.IsEditMode == true)
                            {
                                <div class="dropdown">
                                    <div class="btn btn-sm btn-falcon-default dropdown-toggle dropdown-caret-none" id="notes-create-new-btn">
                                        <span class="fas fa-plus"></span>
                                    </div>
                                </div>
                            }

                        </div>
                        @if (Categories.NotesCategoriesList != null)
                        {
                            foreach (var Category in Categories.NotesCategoriesList)
                            {
                                counter++;
                                <div class="card-body" data-id="@Category.Id">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <h6 style="color: #00BE82; "> @Category.Title</h6>
                                        @if (ViewBag.IsEditMode == true)
                                        {
                                            <div class="d-flex align-items-center">
                                                <span class="mr-2" style="font-size: 14px;" id="lblIsPublished">@Category.IsPublished</span>
                                                <div class="custom-control custom-switch custom-control-inline  mr-0">
                                                    @if (@Category.IsPublished.ToLower() == "published")
                                                    {
                                                        <input class="custom-control-input" type="checkbox" id="@($"chkIsPublished{counter}")" data-id="@Category.Id" checked>
                                                    }
                                                    else
                                                    {
                                                        <input class="custom-control-input" type="checkbox" id="@($"chkIsPublished{counter}")" data-id="@Category.Id">
                                                    }
                                                    <label class="custom-control-label" for="@($"chkIsPublished{counter}")"></label>
                                                </div>
                                                <div class="ml-2" style=" font-size : 24px">
                                                    <div class="nav-item dropdown dropdown-on-hover dots-dropdown" style="list-style: none;">
                                                        <a class="dropdown" id="dividerExample" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size:24px;">
                                                            <i class="fas fa-ellipsis-v" data-fa-transform="shrink-6"></i>
                                                        </a>

                                                        <div class="dropdown-menu" aria-labelledby="dividerUSE">
                                                            <a class="dropdown-item" href="#" descriptionId="@Category.Id" onclick="openEdit(event);">Edit</a>
                                                            <a class="dropdown-item" href="#" id="moveUp">Move Up</a>
                                                            <a class="dropdown-item" href="#" id="moveDown">Move Down</a>
                                                            <div class="dropdown-divider"></div>
                                                            <a class="dropdown-item" href="#" style="color:#E63756;">Delete</a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="ml-2" style="font-size:24px;">
                                                    <i class="fas fa-check" data-fa-transform="shrink-6"></i>
                                                </div>

                                            </div>
                                        }
                                    </div>
                                    <p> @Html.Raw(Category.Description)</p>

                                    <div class="Words">
                                        Created by: @Category.CreatedByUser , @Category.CreatedDate | Last Edited by: @Category.ModifiedByUser, @Category.ModifiedDate
                                        <hr>
                                    </div>
                                </div>

                            }

                        }
                    </div>
                </div>
            }
            @{ Html.RenderAction("CreateNewNotes", "Notes");}
            @{ Html.RenderAction("OpenDescription", "Notes"); }
        </div>

    </div>
</div>

@section Scripts{
    @*@Scripts.Render("~/bundles/jqueryval")*@
    <script src="~/assets/lib/tinymce/tinymce.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            //var ClientID = $("#ddlclient option:selected").val();

            $(".v-pills-div").find(".card-body:first #moveUp").remove();
            $(".v-pills-div").find(".card-body:last #moveDown").remove();
        });

        $(function () {
            $("[id='notes-create-new-btn']").click(function (e) {

                let btnAdd = $(this);
                let categoryId = btnAdd.parents('.v-pills-div').data().categoryId;
                $("#NoteCatId").val(categoryId);
                tinymce.get("txtDescription").getContent()
                tinymce.get("txtDescription").setContent("");
                tinyMCE.activeEditor.setContent("");
                $("#notes-modal-new").modal("show");

                $("#btnCreateNewNotesDescription").text("Create");

            });
            $("#btnCreateNewNotesDescription").click(function () {
                var id = $('#Id').val();
                var title = $('#txtNotesTitle').val();
                var noteCatId = $('#NoteCatId').val();
                var ClientID = $("#ddlclient option:selected").val();
                var agencyId = $('#ClientID').val();

                var isPublished = "Unpublished";
                if ($("#chkPublished").prop("checked") === true) {
                    isPublished = "Published";
                }
                var position = $('#Position').val();
              
                var description = tinyMCE.get("txtDescription").getContent();
                var status = $('#NotesStatus').val();

                $("#btnCreateNewNotesDescription").prop('create', 'Save');

                var pdata = { Id: id, Title: title, Description: description, NoteCatId: noteCatId, AgencyId: ClientID, IsPublished: isPublished, Position: position, Status: status, };
                let json = JSON.stringify({ Notes: pdata });

                postAjax('/Notes/CreateNewNotes', JSON.stringify({ Notes: pdata }), function (response) {
                    if (response.Message == 'Success') {
                        window.location.reload();
                        $('.close-circle').click();
                        $('.modal-backdrop').remove();
                    }
                    else {
                        if (response.Message == 'Exist') {
                            ShowAlertBox('Required!', response.Message, 'warning');
                        }
                        else {
                            ShowAlertBox('Exist!', response.Message, 'warning');

                        }
                    }

                })
            });

            $("[id^=chkIsPublished]").change(function () {
               
                let el = $(this);
                let isChecked = el[0].checked;
                if (isChecked == true)
                    el.parent('div').siblings("span#lblIsPublished").text("Published");
                else
                    el.parent('div').siblings("span#lblIsPublished").text("Unpublished");
                //TODO//Update status in database
                /*let pdata = { Id: el.data().id, IsPublished: isChecked };*/
                postAjax('/Notes/PublishingNotes?Id=' + el.data().id, function (response) {
                    
                    if (response.Message == 'Success') {
                    }
                      /*  window.location.reload();*/
                        //$('.close-circle').click();
                        //$('.modal-backdrop').remove();
                });

            });

            $("[Id=moveUp]").click(function () {
                let el = $(this);
                debugger
                let id = el.parents(".card-body").data().id;
                let swapId = el.parents(".card-body").prev().data().id;
                let pdata = { Id: id, SwapId: swapId };
                //postAjax('', JSON.stringify({ pdata }), function (response) {

                //});
            })

            $("[Id=moveDown]").click(function () {
                let el = $(this);
                debugger
                let id = el.parents(".card-body").data().id;
                let swapId = el.parents(".card-body").next().data().id;
                let pdata = { Id: id, SwapId: swapId };
                //postAjax('', JSON.stringify({ pdata }), function (response) {

                //});
            })

        });

        function openEdit(e) {
            var catDesId = e.currentTarget.attributes["descriptionId"].value;
            $("#NoteCatId").val(NoteCatId);
            $("#notes-modal-new").modal("show");
            $("#btnCreateNewNotesDescription").text("Update");
            $.ajax({
                url: '/Notes/OpenExistingDescription?NotesDescriptionId=' + catDesId,
                //cache: false,
                success: function (response) {
                    if (response.Message == 'Success') {
                        if (response.Description != null) {
                            let published = response.Description.IsPublished;
                            let title = response.Description.Title;

                            $('#Id').val(response.Description.Id);
                            $('#txtNotesTitle').val(title);
                            if (published.toLowerCase() == "published") {
                                $("#chkPublished").prop('checked', true);
                            }
                            else
                                $("#chkPublished").prop('checked', false);

                            $('#txtDescription').html(response.Description.Description);
                            if (response.Description.Description != null) {
                                $('#txtDescription').html(response.Description.Description);
                                tinymce.get("txtDescription").setContent(response.Description.Description);
                            }

                            $("#NoteCatId").val(response.Description.NoteCatId);
                            $("#AgencyId").val(response.Description.AgencyId);
                            $("#Position").val(response.Description.Position);
                        }
                    }
                    else {
                        if (response.Message == 'Exist') {
                            ShowAlertBox('Required!', response.Message, 'warning');
                        }
                        else {
                            ShowAlertBox('Exist!', response.Message, 'warning');
                        }
                    }
                }

            });
        }

    </script>
}
