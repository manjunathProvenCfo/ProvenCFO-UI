@using Proven.Model
@{
    ViewBag.Title = "GetNotesPage";
}

<div class="container-fluid p-0" data-layout="container">
    <div class="card mb-3">
        <div class="bg-holder d-none d-lg-block bg-card" style="background-image:url(../assets/img/illustrations/corner-4.png);">
        </div>
        <!--/.bg-holder-->







        <div class="card-body" id="v-pills-Summary">
            <div class="row">
                <div class="col-lg-9">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="mb-0">Summary</h5>
                        </div>
                        <div class="col-md-6">

                        </div>
                    </div>
                    <p class="mt-2">The MailBluster service (the “Service”) is a marketing service offered through the URL MailBluster.com (including any subdomains), our campaign sites and our email websites (together referred to as the “Website”) that allows you to create, send and manage bulk email messages to individual recipients or subscribers. Each such email message in respect of which you use the Service, including the image, text, and code comprised in it, is referred to in these Terms as “Content”). MailBluster is owned and operated by. <br />$6.25 / seat month after a trial</p>
                </div>
                <div class="col-3">
                    <h5 class="mb-0 text-right"><span class="fas fa-edit"></span></h5>
                    <div class="Words mt-8">Created by: Dave Willson , 06/21/20 | Last Edited by: Conryd Salvesen, 7/22/21 </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row scrollspy-listing">

        <div class="col-3 order-2">

            <div class="sticky-top sticky-kit right-nav-pills bg-white">

                <div class="nav flex-column nav-pills">
                    @foreach (var Categories in (IEnumerable<NotesCategoriesModel>)TempData["CategoriesAndNotes"])
                    {
                        <a class="nav-link active" href="#v-pills-@Categories.NoteCategory" data-category-id="@Categories.Id" data-fancyscroll data-offset="80">@Categories.NoteCategory</a>
                    }
                </div>
            </div>
        </div>

        <div class="col-9 order-1">
            @foreach (var Categories in (IEnumerable<NotesCategoriesModel>)TempData["CategoriesAndNotes"])
            {
                <div class="mb-3 v-pills-div" id="v-pills-@Categories.NoteCategory" data-category-id="@Categories.Id">
                    <div class="card">
                        <div class="card-header d-flex align-items-center justify-content-between">
                            <h3>@Categories.NoteCategory</h3>
                            @*<div class="btn btn-light p-0"><i class="fas fa-plus"></i></div>*@
                            @*Here I am writing new line for add button for testing*@
                            <div class="dropdown">
                                <div class="btn btn-sm btn-falcon-default dropdown-toggle dropdown-caret-none" id="notes-create-new-btn">
                                    <span class="fas fa-plus"></span>
                                </div>
                            </div>

                        </div>
                        @if (Categories.NotesCategoriesList != null)
                        {
                            foreach (var Category in Categories.NotesCategoriesList)
                            {

                                <div class="card-body">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <h6 style="color: #00BE82; "> @Category.Title</h6>
                                        <div class="d-flex align-items-center">
                                            <span class="mr-2" style="font-size: 14px;">@Category.IsPublished</span>
                                            <div class="custom-control custom-switch custom-control-inline  mr-0">
                                                @if (@Category.IsPublished.ToLower() == "published")
                                                {
                                                    <input class="custom-control-input" id="chkIsPublished" type="checkbox" checked>
                                                }
                                                else
                                                {
                                                    <input class="custom-control-input" id="chkIsPublished" type="checkbox">
                                                }
                                                <label class="custom-control-label" for="chkIsPublished"></label>
                                            </div>
                                            <div class="ml-2" style=" font-size : 24px">
                                                <div class="nav-item dropdown dropdown-on-hover dots-dropdown" style="list-style: none;">
                                                    <a class="dropdown" id="dividerExample" href="#" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="font-size:24px;">
                                                        <i class="fas fa-ellipsis-v" data-fa-transform="shrink-6"></i>
                                                    </a>

                                                    <div class="dropdown-menu" aria-labelledby="dividerUSE">
                                                        <a class="dropdown-item" href="#" descriptionId="@Category.Id" isPublished="@Category.IsPublished" onclick="openEdit(event);">Edit</a>
                                                        <a class="dropdown-item" href="#">Move Up</a>
                                                        <a class="dropdown-item" href="#">Move Down</a>
                                                        <div class="dropdown-divider"></div>
                                                        <a class="dropdown-item" href="#" style="color:#E63756;">Delete</a>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="ml-2" style="font-size:24px;">
                                                <i class="fas fa-check" data-fa-transform="shrink-6"></i>
                                            </div>

                                        </div>
                                    </div>
                                    <p> @Html.Raw(Category.Description)</p>

                                    <div class="Words">
                                        Created by: @Category.CreatedByUser , @Category.CreatedDate | Last Edited by: @Category.ModifiedByUser, @Category.ModifiedDate
                                        <hr>
                                    </div>
                                </div>

                            }

                        }
                    </div>
                </div>
            }
            @{ Html.RenderAction("CreateNewNotes", "Notes");}
            @{ Html.RenderAction("OpenDescription", "Notes"); }
        </div>

    </div>

    <footer>
        <div class="row no-gutters justify-content-between fs--1 mt-4 mb-3">
            <div class="col-12 col-sm-auto text-center">
                <p class="mb-0 text-600">2021 © ProvenCFO<span class="d-none d-sm-inline-block"> </span><br class="d-sm-none" /></p>
            </div>
            <div class="col-12 col-sm-auto text-center">
                <p class="mb-0 text-600">v 0.1.2</p>
            </div>
        </div>
    </footer>
</div>

@section Scripts{
    @*@Scripts.Render("~/bundles/jqueryval")*@
    <script src="~/assets/lib/tinymce/tinymce.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            //AgencyDropdownPartialViewChange();
            var ClientID = $("#ddlclient option:selected").val();
            //getAgencyMembersList(ClientID);


        });

        $(function () {
            $("[id='notes-create-new-btn']").click(function (e) {
                
                let btnAdd = $(this);
                let categoryId = btnAdd.parents('.v-pills-div').data().categoryId;
                $("#NoteCatId").val(categoryId);
                tinymce.get("txtDescription").getContent()
                tinymce.get("txtDescription").setContent("");
                tinyMCE.activeEditor.setContent("");
                $("#notes-modal-new").modal("show");

                $("#btnCreateNewNotesDescription").text("Create");


            });
            $("#btnCreateNewNotesDescription").click(function () {
                debugger
                var id = $('#Id').val();
                var title = $('#txtNotesTitle').val();
                var noteCatId = $('#NoteCatId').val();
                var ClientID = $("#ddlclient option:selected").val();
                var agencyId = $('#ClientID').val();

                var isPublished = "Unpublished";
                if ($("#chkPublished").prop("checked") === true) {
                    isPublished = "Published";
                }
                var position = $('#Position').val();
                var description = tinyMCE.activeEditor.getContent();
                var status = $('#NotesStatus').val();

                $("#btnCreateNewNotesDescription").prop('create', 'Save');

                var pdata = { Id : id, Title: title, Description: description, NoteCatId: noteCatId, AgencyId: ClientID, IsPublished: isPublished, Position: position, Status: status, };
                let json = JSON.stringify({ Notes: pdata });

                postAjax('/Notes/CreateNewNotes', JSON.stringify({ Notes: pdata }), function (response) {
                    if (response.Message == 'Success') {
                        window.location.reload();
                        $('.close-circle').click();
                        $('.modal-backdrop').remove();
                    }
                    else {
                        if (response.Message == 'Exist') {
                            ShowAlertBox('Required!', response.Message, 'warning');
                        }
                        else {
                            ShowAlertBox('Exist!', response.Message, 'warning');

                        }
                    }

                })

            });
        });

        function openEdit(e) {
            var catDesId = e.currentTarget.attributes["descriptionId"].value;
            //var isPublished = e.currentTarget.attributes["isPublished"].value;
            $("#NoteCatId").val(NoteCatId);
            tinymce.get("txtDescription").getContent();
            $("#notes-modal-new").modal("show");
            $("#btnCreateNewNotesDescription").text("Update");
            $.ajax({
                url: '/Notes/OpenExistingDescription?NotesDescriptionId=' + catDesId,
                //cache: false,
                success: function (response) {
                    if (response.Message == 'Success') {
                        if (response.Description != null) {
                            let published = response.Description.IsPublished;
                            let title = response.Description.Title;

                            $('#Id').val(response.Description.Id);
                            $('#txtNotesTitle').val(title);
                            if (published.toLowerCase() == "published") {
                                $("#chkPublished").prop('checked', true);
                            }
                            else
                                $("#chkPublished").prop('checked', false);

                            $('#txtDescription').html(response.Description.Description);
                            if (response.Description.Description != null) {
                                $('#txtDescription').html(response.Description.Description);
                                tinymce.get("txtDescription").setContent(response.Description.Description);
                            }

                            $("#NoteCatId").val(response.Description.NoteCatId);
                            $("#AgencyId").val(response.Description.AgencyId);
                            $("#Position").val(response.Description.Position);
                        }
                    }
                    else {
                        if (response.Message == 'Exist') {
                            ShowAlertBox('Required!', response.Message, 'warning');
                        }
                        else {
                            ShowAlertBox('Exist!', response.Message, 'warning');
                        }
                    }
                }

            });

            $("#btnUpdateNewNotesDescription").click(function () {
                debugger;
                UpdateNotesDescription(Id, Title, DescriptionText, isPublished);
                //Description.descriptionId = $("#txtId").val();
                //Description.Title = $("#txtNotesTitle1").val();
                //Description.Description = $("#txtDescription").val();



                $("#btnUpdateNewNotesDescription").prop('update', 'Save');

                postAjax('/Notes/UpdateNotesDescription', JSON.stringify({ Notes: pdata }), function (response) {
                    if (response.Message == 'Success') {
                        window.location.reload();
                        $('.close-circle').click();
                        $('.modal-backdrop').remove();
                    }
                    else {
                        if (response.Message == 'Exist') {
                            ShowAlertBox('Required!', response.Message, 'warning');
                        }
                        else {
                            ShowAlertBox('Exist!', response.Message, 'warning');

                        }
                    }

                })

            });

        }



        function AgencyDropdownPartialViewChange() {
            var ClientID = $("#ddlclient option:selected").val();
            //getTeamMembersList(ClientID);
            if (ClientID != null && ClientID != undefined && ClientID != '') {
                $.ajax({
                    url: '/AgencyService/GetClientDetails?id=' + ClientID,
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (data) {
                        debugger
                        if (data != null) {
                            $('#Notes-create-new-btn').show();//TODO
                            // Write here what should happend once client selected

                            SetUserPreferencesForAgency();
                            window.location.reload();
                        }
                        else {
                            // Write here what should happend once selected client is null
                        }
                    },
                    error: function () {
                        // Write here what should happend when action result is errored.
                    }
                });
            }
            else {

                window.location.reload();
            }
        }

        function UpdateNotesDescription(Id, Title, DescriptionText, isPublished) {

            var pdata = {
                Id: Id, Title: Title, Description: DescriptionText, IsPublished: isPublished
            }
            $.ajax({
                type: "POST",
                url: "/Needs/UpdateNotesDescription",
                data: JSON.stringify({ Task: pdata }),
                contentType: "application/json; charset=utf-8",
                dataType: "json",
                success: function (response) {
                    if (response.Message == 'Success') {
                        return true;
                    }
                    else {
                        return false;
                    }
                },
                failure: function (response) {
                    alert(response.responseText);
                },
                error: function (response) {
                    alert(response.responseText);
                }
            });
        }


    </script>
}
