/*
@license
The following license applies to all parts of this software except as
documented below.

    Copyright (c) 2019, Twilio, inc.
    All rights reserved.

    Redistribution and use in source and binary forms, with or without
    modification, are permitted provided that the following conditions are
    met:

      1. Redistributions of source code must retain the above copyright
         notice, this list of conditions and the following disclaimer.

      2. Redistributions in binary form must reproduce the above copyright
         notice, this list of conditions and the following disclaimer in
         the documentation and/or other materials provided with the
         distribution.

      3. Neither the name of Twilio nor the names of its contributors may
         be used to endorse or promote products derived from this software
         without specific prior written permission.

    THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
    "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
    LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
    A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
    HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
    SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
    LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
    DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
    THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
    (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
    OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

This software includes javascript-state-machine under the following license.

    Copyright (c) 2012, 2013, 2014, 2015, Jake Gordon and contributors

    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to deal
    in the Software without restriction, including without limitation the rights
    to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE

This software includes loglevel under the following license.

    Copyright (c) 2013 Tim Perry

    Permission is hereby granted, free of charge, to any person
    obtaining a copy of this software and associated documentation
    files (the "Software"), to deal in the Software without
    restriction, including without limitation the rights to use,
    copy, modify, merge, publish, distribute, sublicense, and/or sell
    copies of the Software, and to permit persons to whom the
    Software is furnished to do so, subject to the following
    conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
    OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
    HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
    WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
    OTHER DEALINGS IN THE SOFTWARE.

This software includes q under the following license.

    Copyright 2009–2014 Kristopher Michael Kowal. All rights reserved.
    Permission is hereby granted, free of charge, to any person obtaining a copy
    of this software and associated documentation files (the "Software"), to
    deal in the Software without restriction, including without limitation the
    rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
    sell copies of the Software, and to permit persons to whom the Software is
    furnished to do so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in
    all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
    FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
    IN THE SOFTWARE.

This software includes platform.js under the following license.

    Copyright 2014 Benjamin Tan <https://d10.github.io/>
    Copyright 2011-2015 John-David Dalton <http://allyoucanleet.com/>

    Permission is hereby granted, free of charge, to any person obtaining
    a copy of this software and associated documentation files (the
    "Software"), to deal in the Software without restriction, including
    without limitation the rights to use, copy, modify, merge, publish,
    distribute, sublicense, and/or sell copies of the Software, and to
    permit persons to whom the Software is furnished to do so, subject to
    the following conditions:

    The above copyright notice and this permission notice shall be
    included in all copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
    EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
    MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
    NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
    LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION
    OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION
    WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

*/
this.Twilio=this.Twilio||{},this.Twilio.Conversations=function(e){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function n(e){if(e.__esModule)return e;var t=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(e).forEach((function(n){var r=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return e[n]}})})),t}var r=function(e){return e&&e.Math==Math&&e},i=r("object"==typeof globalThis&&globalThis)||r("object"==typeof window&&window)||r("object"==typeof self&&self)||r("object"==typeof t&&t)||function(){return this}()||Function("return this")(),a={},o=function(e){try{return!!e()}catch(e){return!0}},s=!o((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),u={},c={}.propertyIsEnumerable,l=Object.getOwnPropertyDescriptor,f=l&&!c.call({1:2},1);u.f=f?function(e){var t=l(this,e);return!!t&&t.enumerable}:c;var d=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},h={}.toString,p=function(e){return h.call(e).slice(8,-1)},v=p,y="".split,m=o((function(){return!Object("z").propertyIsEnumerable(0)}))?function(e){return"String"==v(e)?y.call(e,""):Object(e)}:Object,g=function(e){if(null==e)throw TypeError("Can't call method on "+e);return e},b=m,k=g,w=function(e){return b(k(e))},x=function(e){return"object"==typeof e?null!==e:"function"==typeof e},_=x,S=function(e,t){if(!_(e))return e;var n,r;if(t&&"function"==typeof(n=e.toString)&&!_(r=n.call(e)))return r;if("function"==typeof(n=e.valueOf)&&!_(r=n.call(e)))return r;if(!t&&"function"==typeof(n=e.toString)&&!_(r=n.call(e)))return r;throw TypeError("Can't convert object to primitive value")},T=g,E=function(e){return Object(T(e))},I=E,R={}.hasOwnProperty,C=Object.hasOwn||function(e,t){return R.call(I(e),t)},P=x,O=i.document,M=P(O)&&P(O.createElement),A=function(e){return M?O.createElement(e):{}},D=A,j=!s&&!o((function(){return 7!=Object.defineProperty(D("div"),"a",{get:function(){return 7}}).a})),N=s,L=u,U=d,F=w,B=S,q=C,W=j,z=Object.getOwnPropertyDescriptor;a.f=N?z:function(e,t){if(e=F(e),t=B(t,!0),W)try{return z(e,t)}catch(e){}if(q(e,t))return U(!L.f.call(e,t),e[t])};var G={},V=x,H=function(e){if(!V(e))throw TypeError(String(e)+" is not an object");return e},J=s,K=j,$=H,Q=S,Y=Object.defineProperty;G.f=J?Y:function(e,t,n){if($(e),t=Q(t,!0),$(n),K)try{return Y(e,t,n)}catch(e){}if("get"in n||"set"in n)throw TypeError("Accessors not supported");return"value"in n&&(e[t]=n.value),e};var X=G,Z=d,ee=s?function(e,t,n){return X.f(e,t,Z(1,n))}:function(e,t,n){return e[t]=n,e},te={exports:{}},ne=i,re=ee,ie=function(e,t){try{re(ne,e,t)}catch(n){ne[e]=t}return t},ae=ie,oe="__core-js_shared__",se=i[oe]||ae(oe,{}),ue=se,ce=Function.toString;"function"!=typeof ue.inspectSource&&(ue.inspectSource=function(e){return ce.call(e)});var le=ue.inspectSource,fe=le,de=i.WeakMap,he="function"==typeof de&&/native code/.test(fe(de)),pe={exports:{}},ve=se;(pe.exports=function(e,t){return ve[e]||(ve[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.15.2",mode:"global",copyright:"© 2021 Denis Pushkarev (zloirock.ru)"});var ye,me,ge,be=0,ke=Math.random(),we=function(e){return"Symbol("+String(void 0===e?"":e)+")_"+(++be+ke).toString(36)},xe=pe.exports,_e=we,Se=xe("keys"),Te=function(e){return Se[e]||(Se[e]=_e(e))},Ee={},Ie=he,Re=x,Ce=ee,Pe=C,Oe=se,Me=Te,Ae=Ee,De="Object already initialized",je=i.WeakMap;if(Ie||Oe.state){var Ne=Oe.state||(Oe.state=new je),Le=Ne.get,Ue=Ne.has,Fe=Ne.set;ye=function(e,t){if(Ue.call(Ne,e))throw new TypeError(De);return t.facade=e,Fe.call(Ne,e,t),t},me=function(e){return Le.call(Ne,e)||{}},ge=function(e){return Ue.call(Ne,e)}}else{var Be=Me("state");Ae[Be]=!0,ye=function(e,t){if(Pe(e,Be))throw new TypeError(De);return t.facade=e,Ce(e,Be,t),t},me=function(e){return Pe(e,Be)?e[Be]:{}},ge=function(e){return Pe(e,Be)}}var qe={set:ye,get:me,has:ge,enforce:function(e){return ge(e)?me(e):ye(e,{})},getterFor:function(e){return function(t){var n;if(!Re(t)||(n=me(t)).type!==e)throw TypeError("Incompatible receiver, "+e+" required");return n}}},We=i,ze=ee,Ge=C,Ve=ie,He=le,Je=qe.get,Ke=qe.enforce,$e=String(String).split("String");(te.exports=function(e,t,n,r){var i,a=!!r&&!!r.unsafe,o=!!r&&!!r.enumerable,s=!!r&&!!r.noTargetGet;"function"==typeof n&&("string"!=typeof t||Ge(n,"name")||ze(n,"name",t),(i=Ke(n)).source||(i.source=$e.join("string"==typeof t?t:""))),e!==We?(a?!s&&e[t]&&(o=!0):delete e[t],o?e[t]=n:ze(e,t,n)):o?e[t]=n:Ve(t,n)})(Function.prototype,"toString",(function(){return"function"==typeof this&&Je(this).source||He(this)}));var Qe=i,Ye=Qe,Xe=i,Ze=function(e){return"function"==typeof e?e:void 0},et=function(e,t){return arguments.length<2?Ze(Ye[e])||Ze(Xe[e]):Ye[e]&&Ye[e][t]||Xe[e]&&Xe[e][t]},tt={},nt=Math.ceil,rt=Math.floor,it=function(e){return isNaN(e=+e)?0:(e>0?rt:nt)(e)},at=it,ot=Math.min,st=function(e){return e>0?ot(at(e),9007199254740991):0},ut=it,ct=Math.max,lt=Math.min,ft=function(e,t){var n=ut(e);return n<0?ct(n+t,0):lt(n,t)},dt=w,ht=st,pt=ft,vt=function(e){return function(t,n,r){var i,a=dt(t),o=ht(a.length),s=pt(r,o);if(e&&n!=n){for(;o>s;)if((i=a[s++])!=i)return!0}else for(;o>s;s++)if((e||s in a)&&a[s]===n)return e||s||0;return!e&&-1}},yt={includes:vt(!0),indexOf:vt(!1)},mt=C,gt=w,bt=yt.indexOf,kt=Ee,wt=function(e,t){var n,r=gt(e),i=0,a=[];for(n in r)!mt(kt,n)&&mt(r,n)&&a.push(n);for(;t.length>i;)mt(r,n=t[i++])&&(~bt(a,n)||a.push(n));return a},xt=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],_t=wt,St=xt.concat("length","prototype");tt.f=Object.getOwnPropertyNames||function(e){return _t(e,St)};var Tt={};Tt.f=Object.getOwnPropertySymbols;var Et,It=tt,Rt=Tt,Ct=H,Pt=et("Reflect","ownKeys")||function(e){var t=It.f(Ct(e)),n=Rt.f;return n?t.concat(n(e)):t},Ot=C,Mt=Pt,At=a,Dt=G,jt=function(e,t){for(var n=Mt(t),r=Dt.f,i=At.f,a=0;a<n.length;a++){var o=n[a];Ot(e,o)||r(e,o,i(t,o))}},Nt=o,Lt=/#|\.prototype\./,Ut=function(e,t){var n=Bt[Ft(e)];return n==Wt||n!=qt&&("function"==typeof t?Nt(t):!!t)},Ft=Ut.normalize=function(e){return String(e).replace(Lt,".").toLowerCase()},Bt=Ut.data={},qt=Ut.NATIVE="N",Wt=Ut.POLYFILL="P",zt=Ut,Gt=i,Vt=a.f,Ht=ee,Jt=te.exports,Kt=ie,$t=jt,Qt=zt,Yt=function(e,t){var n,r,i,a,o,s=e.target,u=e.global,c=e.stat;if(n=u?Gt:c?Gt[s]||Kt(s,{}):(Gt[s]||{}).prototype)for(r in t){if(a=t[r],i=e.noTargetGet?(o=Vt(n,r))&&o.value:n[r],!Qt(u?r:s+(c?".":"#")+r,e.forced)&&void 0!==i){if(typeof a==typeof i)continue;$t(a,i)}(e.sham||i&&i.sham)&&Ht(a,"sham",!0),Jt(n,r,a,e)}},Xt=function(e){if("function"!=typeof e)throw TypeError(String(e)+" is not a function");return e},Zt=wt,en=xt,tn=Object.keys||function(e){return Zt(e,en)},nn=G,rn=H,an=tn,on=s?Object.defineProperties:function(e,t){rn(e);for(var n,r=an(t),i=r.length,a=0;i>a;)nn.f(e,n=r[a++],t[n]);return e},sn=et("document","documentElement"),un=H,cn=on,ln=xt,fn=Ee,dn=sn,hn=A,pn=Te("IE_PROTO"),vn=function(){},yn=function(e){return"<script>"+e+"</"+"script>"},mn=function(){try{Et=document.domain&&new ActiveXObject("htmlfile")}catch(e){}var e,t;mn=Et?function(e){e.write(yn("")),e.close();var t=e.parentWindow.Object;return e=null,t}(Et):((t=hn("iframe")).style.display="none",dn.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write(yn("document.F=Object")),e.close(),e.F);for(var n=ln.length;n--;)delete mn.prototype[ln[n]];return mn()};fn[pn]=!0;var gn=Object.create||function(e,t){var n;return null!==e?(vn.prototype=un(e),n=new vn,vn.prototype=null,n[pn]=e):n=mn(),void 0===t?n:cn(n,t)},bn=Xt,kn=x,wn=[].slice,xn={},_n=function(e,t,n){if(!(t in xn)){for(var r=[],i=0;i<t;i++)r[i]="a["+i+"]";xn[t]=Function("C,a","return new C("+r.join(",")+")")}return xn[t](e,n)},Sn=Function.bind||function(e){var t=bn(this),n=wn.call(arguments,1),r=function(){var i=n.concat(wn.call(arguments));return this instanceof r?_n(t,i.length,i):t.apply(e,i)};return kn(t.prototype)&&(r.prototype=t.prototype),r},Tn=Yt,En=Xt,In=H,Rn=x,Cn=gn,Pn=Sn,On=o,Mn=et("Reflect","construct"),An=On((function(){function e(){}return!(Mn((function(){}),[],e)instanceof e)})),Dn=!On((function(){Mn((function(){}))})),jn=An||Dn;Tn({target:"Reflect",stat:!0,forced:jn,sham:jn},{construct:function(e,t){En(e),In(t);var n=arguments.length<3?e:En(arguments[2]);if(Dn&&!An)return Mn(e,t,n);if(e==n){switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3])}var r=[null];return r.push.apply(r,t),new(Pn.apply(e,r))}var i=n.prototype,a=Cn(Rn(i)?i:Object.prototype),o=Function.apply.call(e,a,t);return Rn(o)?o:a}});var Nn=E,Ln=tn;Yt({target:"Object",stat:!0,forced:o((function(){Ln(1)}))},{keys:function(e){return Ln(Nn(e))}});var Un,Fn,Bn=et("navigator","userAgent")||"",qn=Bn,Wn=i.process,zn=Wn&&Wn.versions,Gn=zn&&zn.v8;Gn?Fn=(Un=Gn.split("."))[0]<4?1:Un[0]+Un[1]:qn&&(!(Un=qn.match(/Edge\/(\d+)/))||Un[1]>=74)&&(Un=qn.match(/Chrome\/(\d+)/))&&(Fn=Un[1]);var Vn=Fn&&+Fn,Hn=Vn,Jn=o,Kn=!!Object.getOwnPropertySymbols&&!Jn((function(){var e=Symbol();return!String(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&Hn&&Hn<41})),$n=Kn&&!Symbol.sham&&"symbol"==typeof Symbol.iterator,Qn=p,Yn=Array.isArray||function(e){return"Array"==Qn(e)},Xn={},Zn=w,er=tt.f,tr={}.toString,nr="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];Xn.f=function(e){return nr&&"[object Window]"==tr.call(e)?function(e){try{return er(e)}catch(e){return nr.slice()}}(e):er(Zn(e))};var rr=i,ir=pe.exports,ar=C,or=we,sr=Kn,ur=$n,cr=ir("wks"),lr=rr.Symbol,fr=ur?lr:lr&&lr.withoutSetter||or,dr=function(e){return ar(cr,e)&&(sr||"string"==typeof cr[e])||(sr&&ar(lr,e)?cr[e]=lr[e]:cr[e]=fr("Symbol."+e)),cr[e]},hr={},pr=dr;hr.f=pr;var vr=Qe,yr=C,mr=hr,gr=G.f,br=function(e){var t=vr.Symbol||(vr.Symbol={});yr(t,e)||gr(t,e,{value:mr.f(e)})},kr=G.f,wr=C,xr=dr("toStringTag"),_r=function(e,t,n){e&&!wr(e=n?e:e.prototype,xr)&&kr(e,xr,{configurable:!0,value:t})},Sr=Xt,Tr=function(e,t,n){if(Sr(e),void 0===t)return e;switch(n){case 0:return function(){return e.call(t)};case 1:return function(n){return e.call(t,n)};case 2:return function(n,r){return e.call(t,n,r)};case 3:return function(n,r,i){return e.call(t,n,r,i)}}return function(){return e.apply(t,arguments)}},Er=x,Ir=Yn,Rr=dr("species"),Cr=function(e,t){var n;return Ir(e)&&("function"!=typeof(n=e.constructor)||n!==Array&&!Ir(n.prototype)?Er(n)&&null===(n=n[Rr])&&(n=void 0):n=void 0),new(void 0===n?Array:n)(0===t?0:t)},Pr=Tr,Or=m,Mr=E,Ar=st,Dr=Cr,jr=[].push,Nr=function(e){var t=1==e,n=2==e,r=3==e,i=4==e,a=6==e,o=7==e,s=5==e||a;return function(u,c,l,f){for(var d,h,p=Mr(u),v=Or(p),y=Pr(c,l,3),m=Ar(v.length),g=0,b=f||Dr,k=t?b(u,m):n||o?b(u,0):void 0;m>g;g++)if((s||g in v)&&(h=y(d=v[g],g,p),e))if(t)k[g]=h;else if(h)switch(e){case 3:return!0;case 5:return d;case 6:return g;case 2:jr.call(k,d)}else switch(e){case 4:return!1;case 7:jr.call(k,d)}return a?-1:r||i?i:k}},Lr={forEach:Nr(0),map:Nr(1),filter:Nr(2),some:Nr(3),every:Nr(4),find:Nr(5),findIndex:Nr(6),filterOut:Nr(7)},Ur=Yt,Fr=i,Br=et,qr=s,Wr=Kn,zr=$n,Gr=o,Vr=C,Hr=Yn,Jr=x,Kr=H,$r=E,Qr=w,Yr=S,Xr=d,Zr=gn,ei=tn,ti=tt,ni=Xn,ri=Tt,ii=a,ai=G,oi=u,si=ee,ui=te.exports,ci=pe.exports,li=Ee,fi=we,di=dr,hi=hr,pi=br,vi=_r,yi=qe,mi=Lr.forEach,gi=Te("hidden"),bi="Symbol",ki=di("toPrimitive"),wi=yi.set,xi=yi.getterFor(bi),_i=Object.prototype,Si=Fr.Symbol,Ti=Br("JSON","stringify"),Ei=ii.f,Ii=ai.f,Ri=ni.f,Ci=oi.f,Pi=ci("symbols"),Oi=ci("op-symbols"),Mi=ci("string-to-symbol-registry"),Ai=ci("symbol-to-string-registry"),Di=ci("wks"),ji=Fr.QObject,Ni=!ji||!ji.prototype||!ji.prototype.findChild,Li=qr&&Gr((function(){return 7!=Zr(Ii({},"a",{get:function(){return Ii(this,"a",{value:7}).a}})).a}))?function(e,t,n){var r=Ei(_i,t);r&&delete _i[t],Ii(e,t,n),r&&e!==_i&&Ii(_i,t,r)}:Ii,Ui=function(e,t){var n=Pi[e]=Zr(Si.prototype);return wi(n,{type:bi,tag:e,description:t}),qr||(n.description=t),n},Fi=zr?function(e){return"symbol"==typeof e}:function(e){return Object(e)instanceof Si},Bi=function(e,t,n){e===_i&&Bi(Oi,t,n),Kr(e);var r=Yr(t,!0);return Kr(n),Vr(Pi,r)?(n.enumerable?(Vr(e,gi)&&e[gi][r]&&(e[gi][r]=!1),n=Zr(n,{enumerable:Xr(0,!1)})):(Vr(e,gi)||Ii(e,gi,Xr(1,{})),e[gi][r]=!0),Li(e,r,n)):Ii(e,r,n)},qi=function(e,t){Kr(e);var n=Qr(t),r=ei(n).concat(Vi(n));return mi(r,(function(t){qr&&!Wi.call(n,t)||Bi(e,t,n[t])})),e},Wi=function(e){var t=Yr(e,!0),n=Ci.call(this,t);return!(this===_i&&Vr(Pi,t)&&!Vr(Oi,t))&&(!(n||!Vr(this,t)||!Vr(Pi,t)||Vr(this,gi)&&this[gi][t])||n)},zi=function(e,t){var n=Qr(e),r=Yr(t,!0);if(n!==_i||!Vr(Pi,r)||Vr(Oi,r)){var i=Ei(n,r);return!i||!Vr(Pi,r)||Vr(n,gi)&&n[gi][r]||(i.enumerable=!0),i}},Gi=function(e){var t=Ri(Qr(e)),n=[];return mi(t,(function(e){Vr(Pi,e)||Vr(li,e)||n.push(e)})),n},Vi=function(e){var t=e===_i,n=Ri(t?Oi:Qr(e)),r=[];return mi(n,(function(e){!Vr(Pi,e)||t&&!Vr(_i,e)||r.push(Pi[e])})),r};(Wr||(ui((Si=function(){if(this instanceof Si)throw TypeError("Symbol is not a constructor");var e=arguments.length&&void 0!==arguments[0]?String(arguments[0]):void 0,t=fi(e),n=function(e){this===_i&&n.call(Oi,e),Vr(this,gi)&&Vr(this[gi],t)&&(this[gi][t]=!1),Li(this,t,Xr(1,e))};return qr&&Ni&&Li(_i,t,{configurable:!0,set:n}),Ui(t,e)}).prototype,"toString",(function(){return xi(this).tag})),ui(Si,"withoutSetter",(function(e){return Ui(fi(e),e)})),oi.f=Wi,ai.f=Bi,ii.f=zi,ti.f=ni.f=Gi,ri.f=Vi,hi.f=function(e){return Ui(di(e),e)},qr&&(Ii(Si.prototype,"description",{configurable:!0,get:function(){return xi(this).description}}),ui(_i,"propertyIsEnumerable",Wi,{unsafe:!0}))),Ur({global:!0,wrap:!0,forced:!Wr,sham:!Wr},{Symbol:Si}),mi(ei(Di),(function(e){pi(e)})),Ur({target:bi,stat:!0,forced:!Wr},{for:function(e){var t=String(e);if(Vr(Mi,t))return Mi[t];var n=Si(t);return Mi[t]=n,Ai[n]=t,n},keyFor:function(e){if(!Fi(e))throw TypeError(e+" is not a symbol");if(Vr(Ai,e))return Ai[e]},useSetter:function(){Ni=!0},useSimple:function(){Ni=!1}}),Ur({target:"Object",stat:!0,forced:!Wr,sham:!qr},{create:function(e,t){return void 0===t?Zr(e):qi(Zr(e),t)},defineProperty:Bi,defineProperties:qi,getOwnPropertyDescriptor:zi}),Ur({target:"Object",stat:!0,forced:!Wr},{getOwnPropertyNames:Gi,getOwnPropertySymbols:Vi}),Ur({target:"Object",stat:!0,forced:Gr((function(){ri.f(1)}))},{getOwnPropertySymbols:function(e){return ri.f($r(e))}}),Ti)&&Ur({target:"JSON",stat:!0,forced:!Wr||Gr((function(){var e=Si();return"[null]"!=Ti([e])||"{}"!=Ti({a:e})||"{}"!=Ti(Object(e))}))},{stringify:function(e,t,n){for(var r,i=[e],a=1;arguments.length>a;)i.push(arguments[a++]);if(r=t,(Jr(t)||void 0!==e)&&!Fi(e))return Hr(t)||(t=function(e,t){if("function"==typeof r&&(t=r.call(this,e,t)),!Fi(t))return t}),i[1]=t,Ti.apply(null,i)}});Si.prototype[ki]||si(Si.prototype,ki,Si.prototype.valueOf),vi(Si,bi),li[gi]=!0;var Hi=o,Ji=Vn,Ki=dr("species"),$i=function(e){return Ji>=51||!Hi((function(){var t=[];return(t.constructor={})[Ki]=function(){return{foo:1}},1!==t[e](Boolean).foo}))},Qi=Lr.filter;Yt({target:"Array",proto:!0,forced:!$i("filter")},{filter:function(e){return Qi(this,e,arguments.length>1?arguments[1]:void 0)}});var Yi=Yt,Xi=o,Zi=w,ea=a.f,ta=s,na=Xi((function(){ea(1)}));Yi({target:"Object",stat:!0,forced:!ta||na,sham:!ta},{getOwnPropertyDescriptor:function(e,t){return ea(Zi(e),t)}});var ra=S,ia=G,aa=d,oa=function(e,t,n){var r=ra(t);r in e?ia.f(e,r,aa(0,n)):e[r]=n},sa=Pt,ua=w,ca=a,la=oa;function fa(e,t,n,r,i,a,o){try{var s=e[a](o),u=s.value}catch(e){return void n(e)}s.done?t(u):Promise.resolve(u).then(r,i)}function da(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var a=e.apply(t,n);function o(e){fa(a,r,i,o,s,"next",e)}function s(e){fa(a,r,i,o,s,"throw",e)}o(void 0)}))}}function ha(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function pa(e,t,n){return t&&ha(e.prototype,t),n&&ha(e,n),e}function va(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ya(e,t){return(ya=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ma(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ya(e,t)}function ga(e){return(ga="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function ba(e,t){return!t||"object"!==ga(t)&&"function"!=typeof t?va(e):t}function ka(e){return(ka=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function wa(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function xa(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}Yt({target:"Object",stat:!0,sham:!s},{getOwnPropertyDescriptors:function(e){for(var t,n,r=ua(e),i=ca.f,a=sa(r),o={},s=0;a.length>s;)void 0!==(n=i(r,t=a[s++]))&&la(o,t,n);return o}});var _a,Sa=Object.prototype,Ta=Sa.hasOwnProperty,Ea="function"==typeof Symbol?Symbol:{},Ia=Ea.iterator||"@@iterator",Ra=Ea.asyncIterator||"@@asyncIterator",Ca=Ea.toStringTag||"@@toStringTag";function Pa(e,t,n,r){var i=t&&t.prototype instanceof La?t:La,a=Object.create(i.prototype),o=new Qa(r||[]);return a._invoke=function(e,t,n){var r=Ma;return function(i,a){if(r===Da)throw new Error("Generator is already running");if(r===ja){if("throw"===i)throw a;return Xa()}for(n.method=i,n.arg=a;;){var o=n.delegate;if(o){var s=Ja(o,n);if(s){if(s===Na)continue;return s}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(r===Ma)throw r=ja,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r=Da;var u=Oa(e,t,n);if("normal"===u.type){if(r=n.done?ja:Aa,u.arg===Na)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(r=ja,n.method="throw",n.arg=u.arg)}}}(e,n,o),a}function Oa(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}var Ma="suspendedStart",Aa="suspendedYield",Da="executing",ja="completed",Na={};function La(){}function Ua(){}function Fa(){}var Ba={};Ba[Ia]=function(){return this};var qa=Object.getPrototypeOf,Wa=qa&&qa(qa(Ya([])));Wa&&Wa!==Sa&&Ta.call(Wa,Ia)&&(Ba=Wa);var za=Fa.prototype=La.prototype=Object.create(Ba);function Ga(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function Va(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===Ua||"GeneratorFunction"===(t.displayName||t.name))}function Ha(e,t){function n(r,i,a,o){var s=Oa(e[r],e,i);if("throw"!==s.type){var u=s.arg,c=u.value;return c&&"object"===ga(c)&&Ta.call(c,"__await")?t.resolve(c.__await).then((function(e){n("next",e,a,o)}),(function(e){n("throw",e,a,o)})):t.resolve(c).then((function(e){u.value=e,a(u)}),(function(e){return n("throw",e,a,o)}))}o(s.arg)}var r;this._invoke=function(e,i){function a(){return new t((function(t,r){n(e,i,t,r)}))}return r=r?r.then(a,a):a()}}function Ja(e,t){var n=e.iterator[t.method];if(n===_a){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=_a,Ja(e,t),"throw"===t.method))return Na;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return Na}var r=Oa(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,Na;var i=r.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=_a),t.delegate=null,Na):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,Na)}function Ka(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function $a(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function Qa(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(Ka,this),this.reset(!0)}function Ya(e){if(e){var t=e[Ia];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,r=function t(){for(;++n<e.length;)if(Ta.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=_a,t.done=!0,t};return r.next=r}}return{next:Xa}}function Xa(){return{value:_a,done:!0}}Ua.prototype=za.constructor=Fa,Fa.constructor=Ua,Fa[Ca]=Ua.displayName="GeneratorFunction",Ga(Ha.prototype),Ha.prototype[Ra]=function(){return this},Ga(za),za[Ca]="Generator",za[Ia]=function(){return this},za.toString=function(){return"[object Generator]"},Qa.prototype={constructor:Qa,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=_a,this.done=!1,this.delegate=null,this.method="next",this.arg=_a,this.tryEntries.forEach($a),!e)for(var t in this)"t"===t.charAt(0)&&Ta.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=_a)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,r){return a.type="throw",a.arg=e,t.next=n,r&&(t.method="next",t.arg=_a),!!r}for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r],a=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var o=Ta.call(i,"catchLoc"),s=Ta.call(i,"finallyLoc");if(o&&s){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(o){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&Ta.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var i=r;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var a=i?i.completion:{};return a.type=e,a.arg=t,i?(this.method="next",this.next=i.finallyLoc,Na):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),Na},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),$a(n),Na}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;$a(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:Ya(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=_a),Na}};var Za={wrap:Pa,isGeneratorFunction:Va,AsyncIterator:Ha,mark:function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,Fa):(e.__proto__=Fa,Ca in e||(e[Ca]="GeneratorFunction")),e.prototype=Object.create(za),e},awrap:function(e){return{__await:e}},async:function(e,t,n,r,i){void 0===i&&(i=Promise);var a=new Ha(Pa(e,t,n,r),i);return Va(t)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},keys:function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},values:Ya},eo={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},to=o,no=function(e,t){var n=[][e];return!!n&&to((function(){n.call(null,t||function(){throw 1},1)}))},ro=Lr.forEach,io=i,ao=eo,oo=no("forEach")?[].forEach:function(e){return ro(this,e,arguments.length>1?arguments[1]:void 0)},so=ee;for(var uo in ao){var co=io[uo],lo=co&&co.prototype;if(lo&&lo.forEach!==oo)try{so(lo,"forEach",oo)}catch(e){lo.forEach=oo}}var fo=gn,ho=G,po=dr("unscopables"),vo=Array.prototype;null==vo[po]&&ho.f(vo,po,{configurable:!0,value:fo(null)});var yo,mo,go,bo=function(e){vo[po][e]=!0},ko={},wo=!o((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),xo=C,_o=E,So=wo,To=Te("IE_PROTO"),Eo=Object.prototype,Io=So?Object.getPrototypeOf:function(e){return e=_o(e),xo(e,To)?e[To]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?Eo:null},Ro=o,Co=Io,Po=ee,Oo=C,Mo=dr("iterator"),Ao=!1;[].keys&&("next"in(go=[].keys())?(mo=Co(Co(go)))!==Object.prototype&&(yo=mo):Ao=!0),(null==yo||Ro((function(){var e={};return yo[Mo].call(e)!==e})))&&(yo={}),Oo(yo,Mo)||Po(yo,Mo,(function(){return this}));var Do={IteratorPrototype:yo,BUGGY_SAFARI_ITERATORS:Ao},jo=Do.IteratorPrototype,No=gn,Lo=d,Uo=_r,Fo=ko,Bo=function(){return this},qo=x,Wo=H,zo=function(e){if(!qo(e)&&null!==e)throw TypeError("Can't set "+String(e)+" as a prototype");return e},Go=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,n={};try{(e=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(n,[]),t=n instanceof Array}catch(e){}return function(n,r){return Wo(n),zo(r),t?e.call(n,r):n.__proto__=r,n}}():void 0),Vo=Yt,Ho=function(e,t,n){var r=t+" Iterator";return e.prototype=No(jo,{next:Lo(1,n)}),Uo(e,r,!1),Fo[r]=Bo,e},Jo=Io,Ko=Go,$o=_r,Qo=ee,Yo=te.exports,Xo=ko,Zo=Do.IteratorPrototype,es=Do.BUGGY_SAFARI_ITERATORS,ts=dr("iterator"),ns="keys",rs="values",is="entries",as=function(){return this},os=function(e,t,n,r,i,a,o){Ho(n,t,r);var s,u,c,l=function(e){if(e===i&&v)return v;if(!es&&e in h)return h[e];switch(e){case ns:case rs:case is:return function(){return new n(this,e)}}return function(){return new n(this)}},f=t+" Iterator",d=!1,h=e.prototype,p=h[ts]||h["@@iterator"]||i&&h[i],v=!es&&p||l(i),y="Array"==t&&h.entries||p;if(y&&(s=Jo(y.call(new e)),Zo!==Object.prototype&&s.next&&(Jo(s)!==Zo&&(Ko?Ko(s,Zo):"function"!=typeof s[ts]&&Qo(s,ts,as)),$o(s,f,!0))),i==rs&&p&&p.name!==rs&&(d=!0,v=function(){return p.call(this)}),h[ts]!==v&&Qo(h,ts,v),Xo[t]=v,i)if(u={values:l(rs),keys:a?v:l(ns),entries:l(is)},o)for(c in u)(es||d||!(c in h))&&Yo(h,c,u[c]);else Vo({target:t,proto:!0,forced:es||d},u);return u},ss=w,us=bo,cs=ko,ls=qe,fs=os,ds="Array Iterator",hs=ls.set,ps=ls.getterFor(ds),vs=fs(Array,"Array",(function(e,t){hs(this,{type:ds,target:ss(e),index:0,kind:t})}),(function(){var e=ps(this),t=e.target,n=e.kind,r=e.index++;return!t||r>=t.length?(e.target=void 0,{value:void 0,done:!0}):"keys"==n?{value:r,done:!1}:"values"==n?{value:t[r],done:!1}:{value:[r,t[r]],done:!1}}),"values");cs.Arguments=cs.Array,us("keys"),us("values"),us("entries");var ys={};ys[dr("toStringTag")]="z";var ms="[object z]"===String(ys),gs=ms,bs=p,ks=dr("toStringTag"),ws="Arguments"==bs(function(){return arguments}()),xs=gs?bs:function(e){var t,n,r;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(n=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),ks))?n:ws?bs(t):"Object"==(r=bs(t))&&"function"==typeof t.callee?"Arguments":r},_s=xs,Ss=ms?{}.toString:function(){return"[object "+_s(this)+"]"},Ts=ms,Es=te.exports,Is=Ss;Ts||Es(Object.prototype,"toString",Is,{unsafe:!0});var Rs=i.Promise,Cs=te.exports,Ps=function(e,t,n){for(var r in t)Cs(e,r,t[r],n);return e},Os=et,Ms=G,As=s,Ds=dr("species"),js=function(e){var t=Os(e),n=Ms.f;As&&t&&!t[Ds]&&n(t,Ds,{configurable:!0,get:function(){return this}})},Ns=function(e,t,n){if(!(e instanceof t))throw TypeError("Incorrect "+(n?n+" ":"")+"invocation");return e},Ls=ko,Us=dr("iterator"),Fs=Array.prototype,Bs=function(e){return void 0!==e&&(Ls.Array===e||Fs[Us]===e)},qs=xs,Ws=ko,zs=dr("iterator"),Gs=function(e){if(null!=e)return e[zs]||e["@@iterator"]||Ws[qs(e)]},Vs=H,Hs=function(e){var t=e.return;if(void 0!==t)return Vs(t.call(e)).value},Js=H,Ks=Bs,$s=st,Qs=Tr,Ys=Gs,Xs=Hs,Zs=function(e,t){this.stopped=e,this.result=t},eu=function(e,t,n){var r,i,a,o,s,u,c,l=n&&n.that,f=!(!n||!n.AS_ENTRIES),d=!(!n||!n.IS_ITERATOR),h=!(!n||!n.INTERRUPTED),p=Qs(t,l,1+f+h),v=function(e){return r&&Xs(r),new Zs(!0,e)},y=function(e){return f?(Js(e),h?p(e[0],e[1],v):p(e[0],e[1])):h?p(e,v):p(e)};if(d)r=e;else{if("function"!=typeof(i=Ys(e)))throw TypeError("Target is not iterable");if(Ks(i)){for(a=0,o=$s(e.length);o>a;a++)if((s=y(e[a]))&&s instanceof Zs)return s;return new Zs(!1)}r=i.call(e)}for(u=r.next;!(c=u.call(r)).done;){try{s=y(c.value)}catch(e){throw Xs(r),e}if("object"==typeof s&&s&&s instanceof Zs)return s}return new Zs(!1)},tu=dr("iterator"),nu=!1;try{var ru=0,iu={next:function(){return{done:!!ru++}},return:function(){nu=!0}};iu[tu]=function(){return this},Array.from(iu,(function(){throw 2}))}catch(e){}var au,ou,su,uu=function(e,t){if(!t&&!nu)return!1;var n=!1;try{var r={};r[tu]=function(){return{next:function(){return{done:n=!0}}}},e(r)}catch(e){}return n},cu=H,lu=Xt,fu=dr("species"),du=function(e,t){var n,r=cu(e).constructor;return void 0===r||null==(n=cu(r)[fu])?t:lu(n)},hu=/(?:iphone|ipod|ipad).*applewebkit/i.test(Bn),pu="process"==p(i.process),vu=i,yu=o,mu=Tr,gu=sn,bu=A,ku=hu,wu=pu,xu=vu.location,_u=vu.setImmediate,Su=vu.clearImmediate,Tu=vu.process,Eu=vu.MessageChannel,Iu=vu.Dispatch,Ru=0,Cu={},Pu="onreadystatechange",Ou=function(e){if(Cu.hasOwnProperty(e)){var t=Cu[e];delete Cu[e],t()}},Mu=function(e){return function(){Ou(e)}},Au=function(e){Ou(e.data)},Du=function(e){vu.postMessage(e+"",xu.protocol+"//"+xu.host)};_u&&Su||(_u=function(e){for(var t=[],n=1;arguments.length>n;)t.push(arguments[n++]);return Cu[++Ru]=function(){("function"==typeof e?e:Function(e)).apply(void 0,t)},au(Ru),Ru},Su=function(e){delete Cu[e]},wu?au=function(e){Tu.nextTick(Mu(e))}:Iu&&Iu.now?au=function(e){Iu.now(Mu(e))}:Eu&&!ku?(su=(ou=new Eu).port2,ou.port1.onmessage=Au,au=mu(su.postMessage,su,1)):vu.addEventListener&&"function"==typeof postMessage&&!vu.importScripts&&xu&&"file:"!==xu.protocol&&!yu(Du)?(au=Du,vu.addEventListener("message",Au,!1)):au=Pu in bu("script")?function(e){gu.appendChild(bu("script")).onreadystatechange=function(){gu.removeChild(this),Ou(e)}}:function(e){setTimeout(Mu(e),0)});var ju,Nu,Lu,Uu,Fu,Bu,qu,Wu,zu={set:_u,clear:Su},Gu=/web0s(?!.*chrome)/i.test(Bn),Vu=i,Hu=a.f,Ju=zu.set,Ku=hu,$u=Gu,Qu=pu,Yu=Vu.MutationObserver||Vu.WebKitMutationObserver,Xu=Vu.document,Zu=Vu.process,ec=Vu.Promise,tc=Hu(Vu,"queueMicrotask"),nc=tc&&tc.value;nc||(ju=function(){var e,t;for(Qu&&(e=Zu.domain)&&e.exit();Nu;){t=Nu.fn,Nu=Nu.next;try{t()}catch(e){throw Nu?Uu():Lu=void 0,e}}Lu=void 0,e&&e.enter()},Ku||Qu||$u||!Yu||!Xu?ec&&ec.resolve?((qu=ec.resolve(void 0)).constructor=ec,Wu=qu.then,Uu=function(){Wu.call(qu,ju)}):Uu=Qu?function(){Zu.nextTick(ju)}:function(){Ju.call(Vu,ju)}:(Fu=!0,Bu=Xu.createTextNode(""),new Yu(ju).observe(Bu,{characterData:!0}),Uu=function(){Bu.data=Fu=!Fu}));var rc=nc||function(e){var t={fn:e,next:void 0};Lu&&(Lu.next=t),Nu||(Nu=t,Uu()),Lu=t},ic={},ac=Xt,oc=function(e){var t,n;this.promise=new e((function(e,r){if(void 0!==t||void 0!==n)throw TypeError("Bad Promise constructor");t=e,n=r})),this.resolve=ac(t),this.reject=ac(n)};ic.f=function(e){return new oc(e)};var sc,uc,cc,lc,fc=H,dc=x,hc=ic,pc=i,vc="object"==typeof window,yc=Yt,mc=i,gc=et,bc=Rs,kc=te.exports,wc=Ps,xc=Go,_c=_r,Sc=js,Tc=x,Ec=Xt,Ic=Ns,Rc=le,Cc=eu,Pc=uu,Oc=du,Mc=zu.set,Ac=rc,Dc=function(e,t){if(fc(e),dc(t)&&t.constructor===e)return t;var n=hc.f(e);return(0,n.resolve)(t),n.promise},jc=function(e,t){var n=pc.console;n&&n.error&&(1===arguments.length?n.error(e):n.error(e,t))},Nc=ic,Lc=function(e){try{return{error:!1,value:e()}}catch(e){return{error:!0,value:e}}},Uc=qe,Fc=zt,Bc=vc,qc=pu,Wc=Vn,zc=dr("species"),Gc="Promise",Vc=Uc.get,Hc=Uc.set,Jc=Uc.getterFor(Gc),Kc=bc&&bc.prototype,$c=bc,Qc=Kc,Yc=mc.TypeError,Xc=mc.document,Zc=mc.process,el=Nc.f,tl=el,nl=!!(Xc&&Xc.createEvent&&mc.dispatchEvent),rl="function"==typeof PromiseRejectionEvent,il="unhandledrejection",al=!1,ol=Fc(Gc,(function(){var e=Rc($c),t=e!==String($c);if(!t&&66===Wc)return!0;if(Wc>=51&&/native code/.test(e))return!1;var n=new $c((function(e){e(1)})),r=function(e){e((function(){}),(function(){}))};return(n.constructor={})[zc]=r,!(al=n.then((function(){}))instanceof r)||!t&&Bc&&!rl})),sl=ol||!Pc((function(e){$c.all(e).catch((function(){}))})),ul=function(e){var t;return!(!Tc(e)||"function"!=typeof(t=e.then))&&t},cl=function(e,t){if(!e.notified){e.notified=!0;var n=e.reactions;Ac((function(){for(var r=e.value,i=1==e.state,a=0;n.length>a;){var o,s,u,c=n[a++],l=i?c.ok:c.fail,f=c.resolve,d=c.reject,h=c.domain;try{l?(i||(2===e.rejection&&hl(e),e.rejection=1),!0===l?o=r:(h&&h.enter(),o=l(r),h&&(h.exit(),u=!0)),o===c.promise?d(Yc("Promise-chain cycle")):(s=ul(o))?s.call(o,f,d):f(o)):d(r)}catch(e){h&&!u&&h.exit(),d(e)}}e.reactions=[],e.notified=!1,t&&!e.rejection&&fl(e)}))}},ll=function(e,t,n){var r,i;nl?((r=Xc.createEvent("Event")).promise=t,r.reason=n,r.initEvent(e,!1,!0),mc.dispatchEvent(r)):r={promise:t,reason:n},!rl&&(i=mc["on"+e])?i(r):e===il&&jc("Unhandled promise rejection",n)},fl=function(e){Mc.call(mc,(function(){var t,n=e.facade,r=e.value;if(dl(e)&&(t=Lc((function(){qc?Zc.emit("unhandledRejection",r,n):ll(il,n,r)})),e.rejection=qc||dl(e)?2:1,t.error))throw t.value}))},dl=function(e){return 1!==e.rejection&&!e.parent},hl=function(e){Mc.call(mc,(function(){var t=e.facade;qc?Zc.emit("rejectionHandled",t):ll("rejectionhandled",t,e.value)}))},pl=function(e,t,n){return function(r){e(t,r,n)}},vl=function(e,t,n){e.done||(e.done=!0,n&&(e=n),e.value=t,e.state=2,cl(e,!0))},yl=function(e,t,n){if(!e.done){e.done=!0,n&&(e=n);try{if(e.facade===t)throw Yc("Promise can't be resolved itself");var r=ul(t);r?Ac((function(){var n={done:!1};try{r.call(t,pl(yl,n,e),pl(vl,n,e))}catch(t){vl(n,t,e)}})):(e.value=t,e.state=1,cl(e,!1))}catch(t){vl({done:!1},t,e)}}};if(ol&&(Qc=($c=function(e){Ic(this,$c,Gc),Ec(e),sc.call(this);var t=Vc(this);try{e(pl(yl,t),pl(vl,t))}catch(e){vl(t,e)}}).prototype,(sc=function(e){Hc(this,{type:Gc,done:!1,notified:!1,parent:!1,reactions:[],rejection:!1,state:0,value:void 0})}).prototype=wc(Qc,{then:function(e,t){var n=Jc(this),r=el(Oc(this,$c));return r.ok="function"!=typeof e||e,r.fail="function"==typeof t&&t,r.domain=qc?Zc.domain:void 0,n.parent=!0,n.reactions.push(r),0!=n.state&&cl(n,!1),r.promise},catch:function(e){return this.then(void 0,e)}}),uc=function(){var e=new sc,t=Vc(e);this.promise=e,this.resolve=pl(yl,t),this.reject=pl(vl,t)},Nc.f=el=function(e){return e===$c||e===cc?new uc(e):tl(e)},"function"==typeof bc&&Kc!==Object.prototype)){lc=Kc.then,al||(kc(Kc,"then",(function(e,t){var n=this;return new $c((function(e,t){lc.call(n,e,t)})).then(e,t)}),{unsafe:!0}),kc(Kc,"catch",Qc.catch,{unsafe:!0}));try{delete Kc.constructor}catch(e){}xc&&xc(Kc,Qc)}yc({global:!0,wrap:!0,forced:ol},{Promise:$c}),_c($c,Gc,!1),Sc(Gc),cc=gc(Gc),yc({target:Gc,stat:!0,forced:ol},{reject:function(e){var t=el(this);return t.reject.call(void 0,e),t.promise}}),yc({target:Gc,stat:!0,forced:ol},{resolve:function(e){return Dc(this,e)}}),yc({target:Gc,stat:!0,forced:sl},{all:function(e){var t=this,n=el(t),r=n.resolve,i=n.reject,a=Lc((function(){var n=Ec(t.resolve),a=[],o=0,s=1;Cc(e,(function(e){var u=o++,c=!1;a.push(void 0),s++,n.call(t,e).then((function(e){c||(c=!0,a[u]=e,--s||r(a))}),i)})),--s||r(a)}));return a.error&&i(a.value),n.promise},race:function(e){var t=this,n=el(t),r=n.reject,i=Lc((function(){var i=Ec(t.resolve);Cc(e,(function(e){i.call(t,e).then(n.resolve,r)}))}));return i.error&&r(i.value),n.promise}});var ml=it,gl=g,bl=function(e){return function(t,n){var r,i,a=String(gl(t)),o=ml(n),s=a.length;return o<0||o>=s?e?"":void 0:(r=a.charCodeAt(o))<55296||r>56319||o+1===s||(i=a.charCodeAt(o+1))<56320||i>57343?e?a.charAt(o):r:e?a.slice(o,o+2):i-56320+(r-55296<<10)+65536}},kl={codeAt:bl(!1),charAt:bl(!0)},wl=kl.charAt,xl=qe,_l=os,Sl="String Iterator",Tl=xl.set,El=xl.getterFor(Sl);_l(String,"String",(function(e){Tl(this,{type:Sl,string:String(e),index:0})}),(function(){var e,t=El(this),n=t.string,r=t.index;return r>=n.length?{value:void 0,done:!0}:(e=wl(n,r),t.index+=e.length,{value:e,done:!1})}));var Il=i,Rl=eo,Cl=vs,Pl=ee,Ol=dr,Ml=Ol("iterator"),Al=Ol("toStringTag"),Dl=Cl.values;for(var jl in Rl){var Nl=Il[jl],Ll=Nl&&Nl.prototype;if(Ll){if(Ll[Ml]!==Dl)try{Pl(Ll,Ml,Dl)}catch(e){Ll[Ml]=Dl}if(Ll[Al]||Pl(Ll,Al,jl),Rl[jl])for(var Ul in Cl)if(Ll[Ul]!==Cl[Ul])try{Pl(Ll,Ul,Cl[Ul])}catch(e){Ll[Ul]=Cl[Ul]}}}var Fl=s,Bl=o,ql=tn,Wl=Tt,zl=u,Gl=E,Vl=m,Hl=Object.assign,Jl=Object.defineProperty,Kl=!Hl||Bl((function(){if(Fl&&1!==Hl({b:1},Hl(Jl({},"a",{enumerable:!0,get:function(){Jl(this,"b",{value:3,enumerable:!1})}}),{b:2})).b)return!0;var e={},t={},n=Symbol(),r="abcdefghijklmnopqrst";return e[n]=7,r.split("").forEach((function(e){t[e]=e})),7!=Hl({},e)[n]||ql(Hl({},t)).join("")!=r}))?function(e,t){for(var n=Gl(e),r=arguments.length,i=1,a=Wl.f,o=zl.f;r>i;)for(var s,u=Vl(arguments[i++]),c=a?ql(u).concat(a(u)):ql(u),l=c.length,f=0;l>f;)s=c[f++],Fl&&!o.call(u,s)||(n[s]=u[s]);return n}:Hl;Yt({target:"Object",stat:!0,forced:Object.assign!==Kl},{assign:Kl});var $l=x,Ql=Go,Yl=function(e,t,n){var r,i;return Ql&&"function"==typeof(r=t.constructor)&&r!==n&&$l(i=r.prototype)&&i!==n.prototype&&Ql(e,i),e},Xl=g,Zl="[\t\n\v\f\r                　\u2028\u2029\ufeff]",ef=RegExp("^"+Zl+Zl+"*"),tf=RegExp(Zl+Zl+"*$"),nf=function(e){return function(t){var n=String(Xl(t));return 1&e&&(n=n.replace(ef,"")),2&e&&(n=n.replace(tf,"")),n}},rf={start:nf(1),end:nf(2),trim:nf(3)},af=s,of=i,sf=zt,uf=te.exports,cf=C,lf=p,ff=Yl,df=S,hf=o,pf=gn,vf=tt.f,yf=a.f,mf=G.f,gf=rf.trim,bf="Number",kf=of.Number,wf=kf.prototype,xf=lf(pf(wf))==bf,_f=function(e){var t,n,r,i,a,o,s,u,c=df(e,!1);if("string"==typeof c&&c.length>2)if(43===(t=(c=gf(c)).charCodeAt(0))||45===t){if(88===(n=c.charCodeAt(2))||120===n)return NaN}else if(48===t){switch(c.charCodeAt(1)){case 66:case 98:r=2,i=49;break;case 79:case 111:r=8,i=55;break;default:return+c}for(o=(a=c.slice(2)).length,s=0;s<o;s++)if((u=a.charCodeAt(s))<48||u>i)return NaN;return parseInt(a,r)}return+c};if(sf(bf,!kf(" 0o1")||!kf("0b1")||kf("+0x1"))){for(var Sf,Tf=function(e){var t=arguments.length<1?0:e,n=this;return n instanceof Tf&&(xf?hf((function(){wf.valueOf.call(n)})):lf(n)!=bf)?ff(new kf(_f(t)),n,Tf):_f(t)},Ef=af?vf(kf):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger,fromString,range".split(","),If=0;Ef.length>If;If++)cf(kf,Sf=Ef[If])&&!cf(Tf,Sf)&&mf(Tf,Sf,yf(kf,Sf));Tf.prototype=wf,wf.constructor=Tf,uf(of,bf,Tf)}function Rf(e,t,n,r){var i,a=arguments.length,o=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"===("undefined"==typeof Reflect?"undefined":ga(Reflect))&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,n,r);else for(var s=e.length-1;s>=0;s--)(i=e[s])&&(o=(a<3?i(o):a>3?i(t,n,o):i(t,n))||o);return a>3&&o&&Object.defineProperty(t,n,o),o}function Cf(e,t){if("object"===("undefined"==typeof Reflect?"undefined":ga(Reflect))&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function Pf(){}function Of(){Of.init.call(this)}function Mf(e){return void 0===e._maxListeners?Of.defaultMaxListeners:e._maxListeners}function Af(e,t,n){if(t)e.call(n);else for(var r=e.length,i=qf(e,r),a=0;a<r;++a)i[a].call(n)}function Df(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,a=qf(e,i),o=0;o<i;++o)a[o].call(n,r)}function jf(e,t,n,r,i){if(t)e.call(n,r,i);else for(var a=e.length,o=qf(e,a),s=0;s<a;++s)o[s].call(n,r,i)}function Nf(e,t,n,r,i,a){if(t)e.call(n,r,i,a);else for(var o=e.length,s=qf(e,o),u=0;u<o;++u)s[u].call(n,r,i,a)}function Lf(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,a=qf(e,i),o=0;o<i;++o)a[o].apply(n,r)}function Uf(e,t,n,r){var i,a,o,s;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),o=a[t]):(a=e._events=new Pf,e._eventsCount=0),o){if("function"==typeof o?o=a[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(i=Mf(e))&&i>0&&o.length>i){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,s=u,"function"==typeof console.warn?console.warn(s):console.log(s)}}else o=a[t]=n,++e._eventsCount;return e}function Ff(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function Bf(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function qf(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}Pf.prototype=Object.create(null),Of.EventEmitter=Of,Of.usingDomains=!1,Of.prototype.domain=void 0,Of.prototype._events=void 0,Of.prototype._maxListeners=void 0,Of.defaultMaxListeners=10,Of.init=function(){this.domain=null,Of.usingDomains&&undefined.active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new Pf,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},Of.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},Of.prototype.getMaxListeners=function(){return Mf(this)},Of.prototype.emit=function(e){var t,n,r,i,a,o,s,u="error"===e;if(o=this._events)u=u&&null==o.error;else if(!u)return!1;if(s=this.domain,u){if(t=arguments[1],!s){if(t instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=s,t.domainThrown=!1,s.emit("error",t),!1}if(!(n=o[e]))return!1;var l="function"==typeof n;switch(r=arguments.length){case 1:Af(n,l,this);break;case 2:Df(n,l,this,arguments[1]);break;case 3:jf(n,l,this,arguments[1],arguments[2]);break;case 4:Nf(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),a=1;a<r;a++)i[a-1]=arguments[a];Lf(n,l,this,i)}return!0},Of.prototype.addListener=function(e,t){return Uf(this,e,t,!1)},Of.prototype.on=Of.prototype.addListener,Of.prototype.prependListener=function(e,t){return Uf(this,e,t,!0)},Of.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,Ff(this,e,t)),this},Of.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,Ff(this,e,t)),this},Of.prototype.removeListener=function(e,t){var n,r,i,a,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new Pf:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,a=n.length;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){o=n[a].listener,i=a;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new Pf,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,o||t)}return this},Of.prototype.off=function(e,t){return this.removeListener(e,t)},Of.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new Pf,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new Pf:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),a=0;a<i.length;++a)"removeListener"!==(r=i[a])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new Pf,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},Of.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[]},Of.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):Bf.call(e,t)},Of.prototype.listenerCount=Bf,Of.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var Wf=Object.freeze({__proto__:null,default:Of,EventEmitter:Of}),zf=Yt,Gf=o,Vf=Yn,Hf=x,Jf=E,Kf=st,$f=oa,Qf=Cr,Yf=$i,Xf=Vn,Zf=dr("isConcatSpreadable"),ed=9007199254740991,td="Maximum allowed index exceeded",nd=Xf>=51||!Gf((function(){var e=[];return e[Zf]=!1,e.concat()[0]!==e})),rd=Yf("concat"),id=function(e){if(!Hf(e))return!1;var t=e[Zf];return void 0!==t?!!t:Vf(e)};zf({target:"Array",proto:!0,forced:!nd||!rd},{concat:function(e){var t,n,r,i,a,o=Jf(this),s=Qf(o,0),u=0;for(t=-1,r=arguments.length;t<r;t++)if(id(a=-1===t?o:arguments[t])){if(u+(i=Kf(a.length))>ed)throw TypeError(td);for(n=0;n<i;n++,u++)n in a&&$f(s,u,a[n])}else{if(u>=ed)throw TypeError(td);$f(s,u++,a)}return s.length=u,s}});var ad=H,od=Hs,sd=Tr,ud=E,cd=function(e,t,n,r){try{return r?t(ad(n)[0],n[1]):t(n)}catch(t){throw od(e),t}},ld=Bs,fd=st,dd=oa,hd=Gs,pd=function(e){var t,n,r,i,a,o,s=ud(e),u="function"==typeof this?this:Array,c=arguments.length,l=c>1?arguments[1]:void 0,f=void 0!==l,d=hd(s),h=0;if(f&&(l=sd(l,c>2?arguments[2]:void 0,2)),null==d||u==Array&&ld(d))for(n=new u(t=fd(s.length));t>h;h++)o=f?l(s[h],h):s[h],dd(n,h,o);else for(a=(i=d.call(s)).next,n=new u;!(r=a.call(i)).done;h++)o=f?cd(i,l,[r.value,h],!0):r.value,dd(n,h,o);return n.length=h,n};Yt({target:"Array",stat:!0,forced:!uu((function(e){Array.from(e)}))},{from:pd});var vd,yd,md,gd={exports:{}};function bd(e,t){return["".concat((new Date).toISOString()," Conversations ").concat(e,":")].concat(Array.from(t))}yd=t,md=function(){var e=function(){},t="undefined",n=("undefined"==typeof window?"undefined":ga(window))!==t&&ga(window.navigator)!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),r=["trace","debug","info","warn","error"];function i(e,t){var n=e[t];if("function"==typeof n.bind)return n.bind(e);try{return Function.prototype.bind.call(n,e)}catch(t){return function(){return Function.prototype.apply.apply(n,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function o(r){return"debug"===r&&(r="log"),("undefined"==typeof console?"undefined":ga(console))!==t&&("trace"===r&&n?a:void 0!==console[r]?i(console,r):void 0!==console.log?i(console,"log"):e)}function s(t,n){for(var i=0;i<r.length;i++){var a=r[i];this[a]=i<t?e:this.methodFactory(a,t,n)}this.log=this.debug}function u(e,n,r){return function(){("undefined"==typeof console?"undefined":ga(console))!==t&&(s.call(this,n,r),this[e].apply(this,arguments))}}function c(e,t,n){return o(e)||u.apply(this,arguments)}function l(e,n,i){var a,o=this,u="loglevel";function l(){var e;if(("undefined"==typeof window?"undefined":ga(window))!==t&&u){try{e=window.localStorage[u]}catch(e){}if(ga(e)===t)try{var n=window.document.cookie,r=n.indexOf(encodeURIComponent(u)+"=");-1!==r&&(e=/^([^;]+)/.exec(n.slice(r))[1])}catch(e){}return void 0===o.levels[e]&&(e=void 0),e}}"string"==typeof e?u+=":"+e:"symbol"===ga(e)&&(u=void 0),o.name=e,o.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},o.methodFactory=i||c,o.getLevel=function(){return a},o.setLevel=function(n,i){if("string"==typeof n&&void 0!==o.levels[n.toUpperCase()]&&(n=o.levels[n.toUpperCase()]),!("number"==typeof n&&n>=0&&n<=o.levels.SILENT))throw"log.setLevel() called with invalid level: "+n;if(a=n,!1!==i&&function(e){var n=(r[e]||"silent").toUpperCase();if(("undefined"==typeof window?"undefined":ga(window))!==t&&u){try{return void(window.localStorage[u]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(u)+"="+n+";"}catch(e){}}}(n),s.call(o,n,e),("undefined"==typeof console?"undefined":ga(console))===t&&n<o.levels.SILENT)return"No console available for logging"},o.setDefaultLevel=function(e){l()||o.setLevel(e,!1)},o.enableAll=function(e){o.setLevel(o.levels.TRACE,e)},o.disableAll=function(e){o.setLevel(o.levels.SILENT,e)};var f=l();null==f&&(f=null==n?"WARN":n),o.setLevel(f,!1)}var f=new l,d={};f.getLogger=function(e){if("symbol"!==ga(e)&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=d[e];return t||(t=d[e]=new l(e,f.getLevel(),f.methodFactory)),t};var h=("undefined"==typeof window?"undefined":ga(window))!==t?window.log:void 0;return f.noConflict=function(){return("undefined"==typeof window?"undefined":ga(window))!==t&&window.log===f&&(window.log=h),f},f.getLoggers=function(){return d},f.default=f,f},(vd=gd).exports?vd.exports=md():yd.log=md();var kd=gd.exports.getLogger("twilio-conversations"),wd=function(){function e(t){xa(this,e),wa(this,"prefix",""),this.prefix=null!=t&&t.length>0?t+" ":""}return pa(e,[{key:"setLevel",value:function(e){kd.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];kd.trace.apply(null,bd(this.prefix+"T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];kd.debug.apply(null,bd(this.prefix+"D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];kd.info.apply(null,bd(this.prefix+"I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];kd.warn.apply(null,bd(this.prefix+"W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];kd.error.apply(null,bd(this.prefix+"E",t))}}],[{key:"scope",value:function(t){return new e(t)}},{key:"setLevel",value:function(e){kd.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];kd.trace.apply(null,bd("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];kd.debug.apply(null,bd("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];kd.info.apply(null,bd("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];kd.warn.apply(null,bd("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];kd.error.apply(null,bd("E",t))}}]),e}(),xd=function(){function e(t){xa(this,e);var n=(t=t||{}).Chat||t.IPMessaging||t||{};this.region=n.region||t.region,this.baseUrl=n.apiUri||n.typingUri||(this.region&&"us1"!==this.region?"https://aim.".concat(this.region,".twilio.com"):"https://aim.twilio.com"),this.typingIndicatorUri=this.baseUrl+"/v1/typing",this.typingIndicatorTimeoutOverride=n.typingIndicatorTimeoutOverride,this.httpCacheIntervalOverride=n.httpCacheIntervalOverride,this.consumptionReportIntervalOverride=n.consumptionReportIntervalOverride,this.userInfosToSubscribeOverride=n.userInfosToSubscribeOverride,this.retryWhenThrottledOverride=n.retryWhenThrottledOverride,this.backoffConfigOverride=n.backoffConfigOverride,this.productId=t.productId}return pa(e,[{key:"typingIndicatorTimeoutDefault",get:function(){return 5e3}},{key:"httpCacheIntervalDefault",get:function(){return"PT5S"}},{key:"consumptionReportIntervalDefault",get:function(){return"PT5S"}},{key:"userInfosToSubscribeDefault",get:function(){return 100}},{key:"retryWhenThrottledDefault",get:function(){return true}},{key:"backoffConfigDefault",get:function(){return{min:1e3,max:4e3,maxAttemptsCount:3}}}]),e}(),_d=Lr.map;Yt({target:"Array",proto:!0,forced:!$i("map")},{map:function(e){return _d(this,e,arguments.length>1?arguments[1]:void 0)}});var Sd=H,Td=function(){var e=Sd(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t},Ed={},Id=o,Rd=function(e,t){return RegExp(e,t)};Ed.UNSUPPORTED_Y=Id((function(){var e=Rd("a","y");return e.lastIndex=2,null!=e.exec("abcd")})),Ed.BROKEN_CARET=Id((function(){var e=Rd("^r","gy");return e.lastIndex=2,null!=e.exec("str")}));var Cd,Pd,Od=o((function(){var e=RegExp(".","string".charAt(0));return!(e.dotAll&&e.exec("\n")&&"s"===e.flags)})),Md=o((function(){var e=RegExp("(?<a>b)","string".charAt(5));return"b"!==e.exec("b").groups.a||"bc"!=="b".replace(e,"$<a>c")})),Ad=Td,Dd=Ed,jd=pe.exports,Nd=gn,Ld=qe.get,Ud=Od,Fd=Md,Bd=RegExp.prototype.exec,qd=jd("native-string-replace",String.prototype.replace),Wd=Bd,zd=(Cd=/a/,Pd=/b*/g,Bd.call(Cd,"a"),Bd.call(Pd,"a"),0!==Cd.lastIndex||0!==Pd.lastIndex),Gd=Dd.UNSUPPORTED_Y||Dd.BROKEN_CARET,Vd=void 0!==/()??/.exec("")[1];(zd||Vd||Gd||Ud||Fd)&&(Wd=function(e){var t,n,r,i,a,o,s,u=this,c=Ld(u),l=c.raw;if(l)return l.lastIndex=u.lastIndex,t=Wd.call(l,e),u.lastIndex=l.lastIndex,t;var f=c.groups,d=Gd&&u.sticky,h=Ad.call(u),p=u.source,v=0,y=e;if(d&&(-1===(h=h.replace("y","")).indexOf("g")&&(h+="g"),y=String(e).slice(u.lastIndex),u.lastIndex>0&&(!u.multiline||u.multiline&&"\n"!==e[u.lastIndex-1])&&(p="(?: "+p+")",y=" "+y,v++),n=new RegExp("^(?:"+p+")",h)),Vd&&(n=new RegExp("^"+p+"$(?!\\s)",h)),zd&&(r=u.lastIndex),i=Bd.call(d?n:u,y),d?i?(i.input=i.input.slice(v),i[0]=i[0].slice(v),i.index=u.lastIndex,u.lastIndex+=i[0].length):u.lastIndex=0:zd&&i&&(u.lastIndex=u.global?i.index+i[0].length:r),Vd&&i&&i.length>1&&qd.call(i[0],n,(function(){for(a=1;a<arguments.length-2;a++)void 0===arguments[a]&&(i[a]=void 0)})),i&&f)for(i.groups=o=Nd(null),a=0;a<f.length;a++)o[(s=f[a])[0]]=i[s[1]];return i});var Hd=Wd;Yt({target:"RegExp",proto:!0,forced:/./.exec!==Hd},{exec:Hd});var Jd=te.exports,Kd=Hd,$d=o,Qd=dr,Yd=ee,Xd=Qd("species"),Zd=RegExp.prototype,eh=kl.charAt,th=E,nh=Math.floor,rh="".replace,ih=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,ah=/\$([$&'`]|\d{1,2})/g,oh=p,sh=Hd,uh=function(e,t,n,r){var i=Qd(e),a=!$d((function(){var t={};return t[i]=function(){return 7},7!=""[e](t)})),o=a&&!$d((function(){var t=!1,n=/a/;return"split"===e&&((n={}).constructor={},n.constructor[Xd]=function(){return n},n.flags="",n[i]=/./[i]),n.exec=function(){return t=!0,null},n[i](""),!t}));if(!a||!o||n){var s=/./[i],u=t(i,""[e],(function(e,t,n,r,i){var o=t.exec;return o===Kd||o===Zd.exec?a&&!i?{done:!0,value:s.call(t,n,r)}:{done:!0,value:e.call(n,t,r)}:{done:!1}}));Jd(String.prototype,e,u[0]),Jd(Zd,i,u[1])}r&&Yd(Zd[i],"sham",!0)},ch=o,lh=H,fh=st,dh=it,hh=g,ph=function(e,t,n){return t+(n?eh(e,t).length:1)},vh=function(e,t,n,r,i,a){var o=n+e.length,s=r.length,u=ah;return void 0!==i&&(i=th(i),u=ih),rh.call(a,u,(function(a,u){var c;switch(u.charAt(0)){case"$":return"$";case"&":return e;case"`":return t.slice(0,n);case"'":return t.slice(o);case"<":c=i[u.slice(1,-1)];break;default:var l=+u;if(0===l)return a;if(l>s){var f=nh(l/10);return 0===f?a:f<=s?void 0===r[f-1]?u.charAt(1):r[f-1]+u.charAt(1):a}c=r[l-1]}return void 0===c?"":c}))},yh=function(e,t){var n=e.exec;if("function"==typeof n){var r=n.call(e,t);if("object"!=typeof r)throw TypeError("RegExp exec method returned something other than an Object or null");return r}if("RegExp"!==oh(e))throw TypeError("RegExp#exec called on incompatible receiver");return sh.call(e,t)},mh=dr("replace"),gh=Math.max,bh=Math.min,kh="$0"==="a".replace(/./,"$0"),wh=!!/./[mh]&&""===/./[mh]("a","$0");uh("replace",(function(e,t,n){var r=wh?"$":"$0";return[function(e,n){var r=hh(this),i=null==e?void 0:e[mh];return void 0!==i?i.call(e,r,n):t.call(String(r),e,n)},function(e,i){if("string"==typeof i&&-1===i.indexOf(r)&&-1===i.indexOf("$<")){var a=n(t,this,e,i);if(a.done)return a.value}var o=lh(this),s=String(e),u="function"==typeof i;u||(i=String(i));var c=o.global;if(c){var l=o.unicode;o.lastIndex=0}for(var f=[];;){var d=yh(o,s);if(null===d)break;if(f.push(d),!c)break;""===String(d[0])&&(o.lastIndex=ph(s,fh(o.lastIndex),l))}for(var h,p="",v=0,y=0;y<f.length;y++){d=f[y];for(var m=String(d[0]),g=gh(bh(dh(d.index),s.length),0),b=[],k=1;k<d.length;k++)b.push(void 0===(h=d[k])?h:String(h));var w=d.groups;if(u){var x=[m].concat(b,g,s);void 0!==w&&x.push(w);var _=String(i.apply(void 0,x))}else _=vh(m,s,g,b,w,i);g>=v&&(p+=s.slice(v,g)+_,v=g+m.length)}return p+s.slice(v)}]}),!!ch((function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")}))||!kh||wh);var xh=Yt,_h=w,Sh=[].join,Th=m!=Object,Eh=no("join",",");xh({target:"Array",proto:!0,forced:Th||!Eh},{join:function(e){return Sh.call(_h(this),void 0===e?",":e)}});var Ih={},Rh={};function Ch(e){return e.replace(/~1/g,"/").replace(/~0/g,"~")}function Ph(e){return e.replace(/~/g,"~0").replace(/\//g,"~1")}Object.defineProperty(Rh,"__esModule",{value:!0}),Rh.Pointer=void 0;var Oh=function(){function e(e){void 0===e&&(e=[""]),this.tokens=e}return e.fromJSON=function(t){var n=t.split("/").map(Ch);if(""!==n[0])throw new Error("Invalid JSON Pointer: "+t);return new e(n)},e.prototype.toString=function(){return this.tokens.map(Ph).join("/")},e.prototype.evaluate=function(e){for(var t=null,n="",r=e,i=1,a=this.tokens.length;i<a;i++)r=((t=r)||{})[n=this.tokens[i]];return{parent:t,key:n,value:r}},e.prototype.get=function(e){return this.evaluate(e).value},e.prototype.set=function(e,t){for(var n=e,r=1,i=this.tokens.length-1,a=this.tokens[r];r<i;r++)n=(n||{})[a];n&&(n[this.tokens[this.tokens.length-1]]=t)},e.prototype.push=function(e){this.tokens.push(e)},e.prototype.add=function(t){return new e(this.tokens.concat(String(t)))},e}();Rh.Pointer=Oh;var Mh={},Ah={};!function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.clone=e.objectType=e.hasOwnProperty=void 0,e.hasOwnProperty=Object.prototype.hasOwnProperty,e.objectType=function(e){return void 0===e?"undefined":null===e?"null":Array.isArray(e)?"array":ga(e)},e.clone=function t(n){if(null==n||"object"!=ga(n))return n;if(n.constructor==Array){for(var r=n.length,i=new Array(r),a=0;a<r;a++)i[a]=t(n[a]);return i}var o={};for(var s in n)e.hasOwnProperty.call(n,s)&&(o[s]=t(n[s]));return o}}(Ah);var Dh={};Object.defineProperty(Dh,"__esModule",{value:!0}),Dh.compare=void 0;var jh=Ah;function Nh(e,t){if(e===t)return!0;var n=jh.objectType(e),r=jh.objectType(t);return"array"==n&&"array"==r?function(e,t){var n=e.length;if(n!==t.length)return!1;for(var r=0;r<n;r++)if(!Nh(e[r],t[r]))return!1;return!0}(e,t):"object"==n&&"object"==r&&function(e,t){var n=Object.keys(e),r=Object.keys(t),i=n.length;if(i!==r.length)return!1;for(var a=0;a<i;a++){var o=n[a];if(!jh.hasOwnProperty.call(t,o)||!Nh(e[o],t[o]))return!1}return!0}(e,t)}Dh.compare=Nh;var Lh,Uh=t&&t.__extends||(Lh=function(e,t){return(Lh=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,t)},function(e,t){function n(){this.constructor=e}Lh(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)});Object.defineProperty(Mh,"__esModule",{value:!0}),Mh.apply=Mh.InvalidOperationError=Mh.test=Mh.copy=Mh.move=Mh.replace=Mh.remove=Mh.add=Mh.TestError=Mh.MissingError=void 0;var Fh=Rh,Bh=Ah,qh=Dh,Wh=function(e){function t(t){var n=e.call(this,"Value required at path: "+t)||this;return n.path=t,n.name="MissingError",n}return Uh(t,e),t}(Error);Mh.MissingError=Wh;var zh=function(e){function t(t,n){var r=e.call(this,"Test failed: "+t+" != "+n)||this;return r.actual=t,r.expected=n,r.name="TestError",r}return Uh(t,e),t}(Error);function Gh(e,t,n){if(Array.isArray(e))if("-"==t)e.push(n);else{var r=parseInt(t,10);e.splice(r,0,n)}else e[t]=n}function Vh(e,t){if(Array.isArray(e)){var n=parseInt(t,10);e.splice(n,1)}else delete e[t]}function Hh(e,t){var n=Fh.Pointer.fromJSON(t.path).evaluate(e);return void 0===n.parent?new Wh(t.path):(Gh(n.parent,n.key,Bh.clone(t.value)),null)}function Jh(e,t){var n=Fh.Pointer.fromJSON(t.path).evaluate(e);return void 0===n.value?new Wh(t.path):(Vh(n.parent,n.key),null)}function Kh(e,t){var n=Fh.Pointer.fromJSON(t.path).evaluate(e);if(null===n.parent)return new Wh(t.path);if(Array.isArray(n.parent)){if(parseInt(n.key,10)>=n.parent.length)return new Wh(t.path)}else if(void 0===n.value)return new Wh(t.path);return n.parent[n.key]=t.value,null}function $h(e,t){var n=Fh.Pointer.fromJSON(t.from).evaluate(e);if(void 0===n.value)return new Wh(t.from);var r=Fh.Pointer.fromJSON(t.path).evaluate(e);return void 0===r.parent?new Wh(t.path):(Vh(n.parent,n.key),Gh(r.parent,r.key,n.value),null)}function Qh(e,t){var n=Fh.Pointer.fromJSON(t.from).evaluate(e);if(void 0===n.value)return new Wh(t.from);var r=Fh.Pointer.fromJSON(t.path).evaluate(e);return void 0===r.parent?new Wh(t.path):(Gh(r.parent,r.key,Bh.clone(n.value)),null)}function Yh(e,t){var n=Fh.Pointer.fromJSON(t.path).evaluate(e);return qh.compare(n.value,t.value)?null:new zh(n.value,t.value)}Mh.TestError=zh,Mh.add=Hh,Mh.remove=Jh,Mh.replace=Kh,Mh.move=$h,Mh.copy=Qh,Mh.test=Yh;var Xh=function(e){function t(t){var n=e.call(this,"Invalid operation: "+t.op)||this;return n.operation=t,n.name="InvalidOperationError",n}return Uh(t,e),t}(Error);Mh.InvalidOperationError=Xh,Mh.apply=function(e,t){switch(t.op){case"add":return Hh(e,t);case"remove":return Jh(e,t);case"replace":return Kh(e,t);case"move":return $h(e,t);case"copy":return Qh(e,t);case"test":return Yh(e,t)}return new Xh(t)};var Zh={};Object.defineProperty(Zh,"__esModule",{value:!0}),Zh.diffAny=Zh.diffObjects=Zh.diffArrays=Zh.intersection=Zh.subtract=Zh.isDestructive=void 0;var ep=Dh,tp=Ah;function np(e,t){var n={};for(var r in e)tp.hasOwnProperty.call(e,r)&&void 0!==e[r]&&(n[r]=1);for(var i in t)tp.hasOwnProperty.call(t,i)&&void 0!==t[i]&&delete n[i];return Object.keys(n)}function rp(e){for(var t=e.length,n={},r=0;r<t;r++){var i=e[r];for(var a in i)tp.hasOwnProperty.call(i,a)&&void 0!==i[a]&&(n[a]=(n[a]||0)+1)}for(var a in n)n[a]<t&&delete n[a];return Object.keys(n)}function ip(e,t){return{operations:e.operations.concat(t),cost:e.cost+1}}function ap(e,t,n,r){void 0===r&&(r=sp);var i={"0,0":{operations:[],cost:0}};var a=isNaN(e.length)||e.length<=0?0:e.length,o=isNaN(t.length)||t.length<=0?0:t.length;return function n(r,a){var o=r+","+a,s=i[o];if(void 0===s){if(r>0&&a>0&&ep.compare(e[r-1],t[a-1]))s=n(r-1,a-1);else{var u=[];if(r>0){var c=n(r-1,a),l={op:"remove",index:r-1};u.push(ip(c,l))}if(a>0){var f=n(r,a-1),d={op:"add",index:r-1,value:t[a-1]};u.push(ip(f,d))}if(r>0&&a>0){var h=n(r-1,a-1),p={op:"replace",index:r-1,original:e[r-1],value:t[a-1]};u.push(ip(h,p))}s=u.sort((function(e,t){return e.cost-t.cost}))[0]}i[o]=s}return s}(a,o).operations.reduce((function(e,t){var i=e[0],o=e[1];if(function(e){return"add"===e.op}(t)){var s=t.index+1+o,u=s<a+o?String(s):"-",c={op:t.op,path:n.add(u).toString(),value:t.value};return[i.concat(c),o+1]}if(function(e){return"remove"===e.op}(t)){c={op:t.op,path:n.add(String(t.index+o)).toString()};return[i.concat(c),o-1]}var l=n.add(String(t.index+o)),f=r(t.original,t.value,l);return[i.concat.apply(i,f),o]}),[[],0])[0]}function op(e,t,n,r){void 0===r&&(r=sp);var i=[];return np(e,t).forEach((function(e){i.push({op:"remove",path:n.add(e).toString()})})),np(t,e).forEach((function(e){i.push({op:"add",path:n.add(e).toString(),value:t[e]})})),rp([e,t]).forEach((function(a){i.push.apply(i,r(e[a],t[a],n.add(a)))})),i}function sp(e,t,n,r){if(void 0===r&&(r=sp),e===t)return[];var i=tp.objectType(e),a=tp.objectType(t);return"array"==i&&"array"==a?ap(e,t,n,r):"object"==i&&"object"==a?op(e,t,n,r):[{op:"replace",path:n.toString(),value:t}]}Zh.isDestructive=function(e){var t=e.op;return"remove"===t||"replace"===t||"copy"===t||"move"===t},Zh.subtract=np,Zh.intersection=rp,Zh.diffArrays=ap,Zh.diffObjects=op,Zh.diffAny=sp,Object.defineProperty(Ih,"__esModule",{value:!0}),Ih.createTests=fp=Ih.createPatch=Ih.applyPatch=void 0;var up=Rh,cp=Mh,lp=Zh;Ih.applyPatch=function(e,t){return t.map((function(t){return cp.apply(e,t)}))};var fp=Ih.createPatch=function(e,t,n){var r=new up.Pointer;return(n?function(e){return function t(n,r,i){var a=e(n,r,i);return Array.isArray(a)?a:lp.diffAny(n,r,i,t)}}(n):lp.diffAny)(e,t,r)};function dp(e,t){var n=up.Pointer.fromJSON(t).evaluate(e);if(void 0!==n)return{op:"test",path:t,value:n.value}}function hp(e,t){return 0===fp(e,t).length}function pp(e){return void 0===e||isNaN(Number(e))?null:Number(e)}function vp(e){try{return new Date(e)}catch(e){return null}}function yp(e,t,n){var r={};if(e)try{r=JSON.parse(e)}catch(e){n.warn(t,e)}return r}Ih.createTests=function(e,t){var n=new Array;return t.filter(lp.isDestructive).forEach((function(t){var r=dp(e,t.path);if(r&&n.push(r),"from"in t){var i=dp(e,t.from);i&&n.push(i)}})),n};var mp=function(){function e(t){xa(this,e),this.base=t.replace(/\/$/,""),this.args=[],this.paths=[]}return pa(e,[{key:"arg",value:function(e,t){return void 0!==t&&this.args.push(encodeURIComponent(e)+"="+encodeURIComponent(t)),this}},{key:"path",value:function(e){return this.paths.push(encodeURIComponent(e)),this}},{key:"build",value:function(){var e=this.base;return this.paths.length&&(e+="/"+this.paths.join("/")),this.args.length&&(e+="?"+this.args.join("&")),e}}]),e}(),gp={},bp=Yt,kp=x,wp=Yn,xp=ft,_p=st,Sp=w,Tp=oa,Ep=dr,Ip=$i("slice"),Rp=Ep("species"),Cp=[].slice,Pp=Math.max;bp({target:"Array",proto:!0,forced:!Ip},{slice:function(e,t){var n,r,i,a=Sp(this),o=_p(a.length),s=xp(e,o),u=xp(void 0===t?o:t,o);if(wp(a)&&("function"!=typeof(n=a.constructor)||n!==Array&&!wp(n.prototype)?kp(n)&&null===(n=n[Rp])&&(n=void 0):n=void 0,n===Array||void 0===n))return Cp.call(a,s,u);for(r=new(void 0===n?Array:n)(Pp(u-s,0)),i=0;s<u;s++,i++)s in a&&Tp(r,i,a[s]);return r.length=i,r}});var Op=Yt,Mp=s,Ap=i,Dp=C,jp=x,Np=G.f,Lp=jt,Up=Ap.Symbol;if(Mp&&"function"==typeof Up&&(!("description"in Up.prototype)||void 0!==Up().description)){var Fp={},Bp=function(){var e=arguments.length<1||void 0===arguments[0]?void 0:String(arguments[0]),t=this instanceof Bp?new Up(e):void 0===e?Up():Up(e);return""===e&&(Fp[t]=!0),t};Lp(Bp,Up);var qp=Bp.prototype=Up.prototype;qp.constructor=Bp;var Wp=qp.toString,zp="Symbol(test)"==String(Up("test")),Gp=/^Symbol\((.*)\)[^)]+$/;Np(qp,"description",{configurable:!0,get:function(){var e=jp(this)?this.valueOf():this,t=Wp.call(e);if(Dp(Fp,e))return"";var n=zp?t.slice(7,-1):t.replace(Gp,"$1");return""===n?void 0:n}}),Op({global:!0,forced:!0},{Symbol:Bp})}br("iterator");var Vp={exports:{}};!function(e){function t(n){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?(e.exports=t=function(e){return typeof e},e.exports.default=e.exports,e.exports.__esModule=!0):(e.exports=t=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e.exports.default=e.exports,e.exports.__esModule=!0),t(n)}e.exports=t,e.exports.default=e.exports,e.exports.__esModule=!0}(Vp);var Hp=s,Jp=G.f,Kp=Function.prototype,$p=Kp.toString,Qp=/^\s*function ([^ (]*)/,Yp="name";Hp&&!(Yp in Kp)&&Jp(Kp,Yp,{configurable:!0,get:function(){try{return $p.call(this).match(Qp)[1]}catch(e){return""}}});var Xp=x,Zp=Math.floor;Yt({target:"Number",stat:!0},{isInteger:function(e){return!Xp(e)&&isFinite(e)&&Zp(e)===e}});var ev={exports:{}},tv={exports:{}};!function(e){e.exports=function(e){if(Array.isArray(e))return e},e.exports.default=e.exports,e.exports.__esModule=!0}(tv);var nv={exports:{}};!function(e){e.exports=function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a=[],o=!0,s=!1;try{for(n=n.call(e);!(o=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);o=!0);}catch(e){s=!0,i=e}finally{try{o||null==n.return||n.return()}finally{if(s)throw i}}return a}},e.exports.default=e.exports,e.exports.__esModule=!0}(nv);var rv={exports:{}},iv={exports:{}};!function(e){e.exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r},e.exports.default=e.exports,e.exports.__esModule=!0}(iv),function(e){var t=iv.exports;e.exports=function(e,n){if(e){if("string"==typeof e)return t(e,n);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?t(e,n):void 0}},e.exports.default=e.exports,e.exports.__esModule=!0}(rv);var av={exports:{}};!function(e){e.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},e.exports.default=e.exports,e.exports.__esModule=!0}(av),function(e){var t=tv.exports,n=nv.exports,r=rv.exports,i=av.exports;e.exports=function(e,a){return t(e)||n(e,a)||r(e,a)||i()},e.exports.default=e.exports,e.exports.__esModule=!0}(ev);var ov=s,sv=tn,uv=w,cv=u.f,lv=function(e){return function(t){for(var n,r=uv(t),i=sv(r),a=i.length,o=0,s=[];a>o;)n=i[o++],ov&&!cv.call(r,n)||s.push(e?[n,r[n]]:r[n]);return s}},fv={entries:lv(!0),values:lv(!1)}.entries;Yt({target:"Object",stat:!0},{entries:function(e){return fv(e)}});var dv={exports:{}},hv={exports:{}};!function(e){var t=iv.exports;e.exports=function(e){if(Array.isArray(e))return t(e)},e.exports.default=e.exports,e.exports.__esModule=!0}(hv);var pv={exports:{}};!function(e){e.exports=function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)},e.exports.default=e.exports,e.exports.__esModule=!0}(pv);var vv={exports:{}};!function(e){e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")},e.exports.default=e.exports,e.exports.__esModule=!0}(vv),function(e){var t=hv.exports,n=pv.exports,r=rv.exports,i=vv.exports;e.exports=function(e){return t(e)||n(e)||r(e)||i()},e.exports.default=e.exports,e.exports.__esModule=!0}(dv);var yv={exports:{}};!function(e){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},e.exports.default=e.exports,e.exports.__esModule=!0}(yv);var mv={exports:{}},gv={exports:{}};!function(e){function t(n,r){return e.exports=t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},e.exports.default=e.exports,e.exports.__esModule=!0,t(n,r)}e.exports=t,e.exports.default=e.exports,e.exports.__esModule=!0}(gv),function(e){var t=gv.exports;e.exports=function(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),n&&t(e,n)},e.exports.default=e.exports,e.exports.__esModule=!0}(mv);var bv={exports:{}},kv={exports:{}};!function(e){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e},e.exports.default=e.exports,e.exports.__esModule=!0}(kv),function(e){var t=Vp.exports.default,n=kv.exports;e.exports=function(e,r){return!r||"object"!==t(r)&&"function"!=typeof r?n(e):r},e.exports.default=e.exports,e.exports.__esModule=!0}(bv);var wv={exports:{}};!function(e){function t(n){return e.exports=t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},e.exports.default=e.exports,e.exports.__esModule=!0,t(n)}e.exports=t,e.exports.default=e.exports,e.exports.__esModule=!0}(wv);var xv=yt.includes,_v=bo;Yt({target:"Array",proto:!0},{includes:function(e){return xv(this,e,arguments.length>1?arguments[1]:void 0)}}),_v("includes"),Object.defineProperty(gp,"__esModule",{value:!0});var Sv=ev.exports,Tv=dv.exports,Ev=yv.exports,Iv=mv.exports,Rv=bv.exports,Cv=wv.exports;function Pv(e){return e&&"object"===ga(e)&&"default"in e?e:{default:e}}var Ov=Pv(Vp.exports),Mv=Pv(Sv),Av=Pv(Tv),Dv=Pv(Ev),jv=Pv(Iv),Nv=Pv(Rv),Lv=Pv(Cv),Uv=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return{checks:t}};function Fv(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return Bv(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return Bv(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function Bv(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var qv=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Uv((function(e){var n,r=!1,i=[],a=Fv(t);try{for(a.s();!(n=a.n()).done;){var o=n.value;"string"!=typeof o?(r=r||e instanceof o,i.push("an instance of ".concat(o.name))):(r=r||Ov.default(e)===o,i.push("of type ".concat(o)))}}catch(e){a.e(e)}finally{a.f()}return[r,i]}))};function Wv(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return zv(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return zv(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function zv(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Gv=Uv((function(e){return["string"==typeof e&&e.length>0,"a non-empty string"]})),Vv=Uv((function(e){return["number"==typeof e&&Number.isInteger(e)&&e>=0,"a non-negative integer"]})),Hv=Uv((function(e){return["object"===Ov.default(e)&&null!==e&&!Array.isArray(e),"a pure object (non-null and non-array)"]}));function Jv(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=Lv.default(e);if(t){var i=Lv.default(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return Nv.default(this,n)}}function Kv(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return $v(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return $v(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function $v(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Qv=function(e,t){if(t.length>e.length)throw new Error("Expected at most ".concat(e.length," argument(s), but got ").concat(t.length));for(;t.length<e.length;)t.push(void 0);var n,r=Kv(t.entries());try{for(r.s();!(n=r.n()).done;){var i=Mv.default(n.value,2),a=i[0],o=i[1],s=ey(e[a],o),u=Mv.default(s,4),c=u[0],l=u[1],f=u[2],d=u[3];if(!c)throw new Error("Argument ".concat(a+1," is expected to be ").concat(f).concat(d," but got ").concat(l))}}catch(e){r.e(e)}finally{r.f()}},Yv=function(e){var t,n,r;(["undefined","boolean","number","bigint","string"].includes(Ov.default(e))&&(n="string"==typeof e?'"'.concat(e,'"'):"".concat(e)),"object"===Ov.default(e)&&"Object"!==(null==e||null===(t=e.constructor)||void 0===t?void 0:t.name))&&(n=null===e?"null":"instance of ".concat(null==e||null===(r=e.constructor)||void 0===r?void 0:r.name));return n||(n=Ov.default(e)),n},Xv=function(e){var t,n=[],r=Kv(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;n.push(Zv(i))}}catch(e){r.e(e)}finally{r.f()}return n},Zv=function(e){var t,n=[],r=Kv(Array.isArray(e)?e:[e]);try{for(r.s();!(t=r.n()).done;){var i=t.value;"string"!=typeof i&&"function"!=typeof i?n.push(i):n.push(qv(i))}}catch(e){r.e(e)}finally{r.f()}return n},ey=function(e,t){var n,r,i=[],a=!1,o=Kv(e);try{for(o.s();!(r=o.n()).done;){var s,u=Kv(r.value.checks);try{for(u.s();!(s=u.n()).done;){var c=(0,s.value)(t),l=Mv.default(c,3),f=l[0],d=l[1],h=l[2];a=a||f,!n&&h&&(n=h),d&&(i=[].concat(Av.default(i),"string"==typeof d?[d]:Av.default(d)))}}catch(e){u.e(e)}finally{u.f()}}}catch(e){o.e(e)}finally{o.f()}if(a)return[!0];var p=n||Yv(t),v=i.length-1;return[!1,p,v>0?"".concat(i.slice(0,v).join(", ")," or ").concat(i[v]):i.join(", "),v>1?";":","]};function ty(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return ny(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return ny(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function ny(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}gp.array=function(e,t){return Uv((function(n){if(!Array.isArray(n))return[!1,"an array of ".concat(e)];var r,i=ty(n.entries());try{for(i.s();!(r=i.n()).done;){var a=Mv.default(r.value,2),o=a[0],s=a[1],u=ey(Zv(t),s),c=Mv.default(u,3),l=c[0],f=c[1],d=c[2];if(!l)return[!1,"a valid array of ".concat(e," (index ").concat(o," should be ").concat(d,")"),"malformed array of ".concat(e," (index ").concat(o," is ").concat(f,")")]}}catch(e){i.e(e)}finally{i.f()}return[!0]}))};var ry=gp.custom=Uv,iy=gp.literal=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Uv((function(e){var n,r=!1,i=[],a=Wv(t);try{for(a.s();!(n=a.n()).done;){var o=n.value;r=r||e===o,i.push("string"==typeof o?'"'.concat(o,'"'):"".concat(o))}}catch(e){a.e(e)}finally{a.f()}return[r,i]}))},ay=gp.nonEmptyString=Gv,oy=gp.nonNegativeInteger=Vv,sy=gp.objectSchema=function(e,t){return Uv((function(n){if("object"!==Ov.default(n)||null===n||Array.isArray(n))return[!1,"valid ".concat(e," (should be a pure object)")];for(var r=0,i=Object.entries(t);r<i.length;r++){var a=Mv.default(i[r],2),o=a[0],s=a[1],u=ey(Zv(s),n[o]),c=Mv.default(u,3),l=c[0],f=c[1],d=c[2];if(!l)return[!1,"valid ".concat(e,' (key "').concat(o,'" should be ').concat(d,")"),"malformed ".concat(e,' (key "').concat(o,'" is ').concat(f,")")]}return[!0]}))},uy=gp.pureObject=Hv;gp.runtimeTypeValidation=Qv,gp.stringifyReceivedType=Yv,gp.type=qv,gp.validateConstructorTypes=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=Xv(t);return function(e){return function(e){jv.default(n,e);var t=Jv(n);function n(){Dv.default(this,n);for(var e=arguments.length,i=new Array(e),a=0;a<e;a++)i[a]=arguments[a];return Qv(r,i),t.call.apply(t,[this].concat(i))}return n}(e)}};var cy=gp.validateTypes=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=Xv(t);return function(e,t,n){if("function"!=typeof n.value)throw new Error("The validateTypes decorator can only be applied to methods");var i=n.value;n.value=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Qv(r,t),i.apply(this,t)}}},ly=gp.validateTypesAsync=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r=Xv(t);return function(e,t,n){if("function"!=typeof n.value)throw new Error("The validateTypesAsync decorator can only be applied to methods");var i=n.value;n.value=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];try{Qv(r,t)}catch(e){return Promise.reject(e)}return i.apply(this,t)}}};function fy(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}var dy=wd.scope("User"),User=function(e){ma(User,e);var t,n,r,i,a=fy(User);function User(e,t,n){var r;return xa(this,User),(r=a.call(this)).subscribed="initializing",r.setMaxListeners(0),r.services=n,r.state={identity:e,entityName:t,friendlyName:null,attributes:{},online:null,notifiable:null},r}return pa(User,[{key:"identity",get:function(){return this.state.identity},set:function(e){this.state.identity=e}},{key:"entityName",set:function(e){this.state.entityName=e}},{key:"attributes",get:function(){return this.state.attributes}},{key:"friendlyName",get:function(){return this.state.friendlyName}},{key:"isOnline",get:function(){return this.state.online}},{key:"isNotifiable",get:function(){return this.state.notifiable}},{key:"isSubscribed",get:function(){return"subscribed"==this.subscribed}},{key:"_update",value:function(e,t){var n=[];switch(dy.debug("User for",this.state.identity,"updated:",e,t),e){case"friendlyName":this.state.friendlyName!==t.value&&(n.push("friendlyName"),this.state.friendlyName=t.value);break;case"attributes":var r=yp(t.value,"Retrieved malformed attributes from the server for user: ".concat(this.state.identity),dy);hp(this.state.attributes,r)||(this.state.attributes=r,n.push("attributes"));break;case"reachability":this.state.online!==t.online&&(this.state.online=t.online,n.push("reachabilityOnline")),this.state.notifiable!==t.notifiable&&(this.state.notifiable=t.notifiable,n.push("reachabilityNotifiable"));break;default:return}n.length>0&&this.emit("updated",{user:this,updateReasons:n})}},{key:"_updateReachabilityInfo",value:function(e,t){var n=this;return this.services.session.reachabilityEnabled?e.get("reachability").then(t).catch((function(e){dy.warn("Failed to get reachability info for ",n.state.identity,e)})):Promise.resolve()}},{key:"_fetch",value:(i=da(Za.mark((function e(){var t=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.state.entityName){e.next=2;break}return e.abrupt("return",this);case 2:return this.promiseToFetch=this.services.syncClient.map({id:this.state.entityName,mode:"open_existing",includeItems:!0}).then((function(e){return t.entity=e,e.on("itemUpdated",(function(e){return dy.debug(t.state.entityName+" ("+t.state.identity+") itemUpdated: "+e.item.key),t._update(e.item.key,e.item.data)})),Promise.all([e.get("friendlyName").then((function(e){return t._update(e.key,e.data)})),e.get("attributes").then((function(e){return t._update(e.key,e.data)})),t._updateReachabilityInfo(e,(function(e){return t._update(e.key,e.data)}))])})).then((function(){return dy.debug("Fetched for",t.identity),t.subscribed="subscribed",t.emit("userSubscribed",t),t})).catch((function(e){throw t.promiseToFetch=null,e})),e.abrupt("return",this.promiseToFetch);case 4:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"_ensureFetched",value:function(){return this.promiseToFetch||this._fetch()}},{key:"updateAttributes",value:(r=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("unsubscribed"!=this.subscribed){e.next=2;break}throw new Error("Can't modify unsubscribed object");case 2:return e.next=4,this.services.session.addCommand("editUserAttributes",{username:this.state.identity,attributes:JSON.stringify(t)});case 4:return e.abrupt("return",this);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"updateFriendlyName",value:(n=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("unsubscribed"!=this.subscribed){e.next=2;break}throw new Error("Can't modify unsubscribed object");case 2:return e.next=4,this.services.session.addCommand("editUserFriendlyName",{username:this.state.identity,friendlyName:t});case 4:return e.abrupt("return",this);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"unsubscribe",value:(t=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.promiseToFetch){e.next=7;break}return e.next=3,this.promiseToFetch;case 3:this.entity.close(),this.promiseToFetch=null,this.subscribed="unsubscribed",this.emit("userUnsubscribed",this);case 7:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),User}(Of);function hy(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function py(e,t){if(e){if("string"==typeof e)return hy(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?hy(e,t):void 0}}function vy(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,a=[],o=!0,s=!1;try{for(n=n.call(e);!(o=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);o=!0);}catch(e){s=!0,i=e}finally{try{o||null==n.return||n.return()}finally{if(s)throw i}}return a}}(e,t)||py(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}Rf([ly(["string","number","boolean","object",iy(null)]),Cf("design:type",Function),Cf("design:paramtypes",[Object]),Cf("design:returntype",Promise)],User.prototype,"updateAttributes",null),Rf([ly(["string",iy(null)]),Cf("design:type",Function),Cf("design:paramtypes",[String]),Cf("design:returntype",Promise)],User.prototype,"updateFriendlyName",null);var yy={exports:{}},my=!o((function(){return Object.isExtensible(Object.preventExtensions({}))})),gy=Ee,by=x,ky=C,wy=G.f,xy=my,_y=we("meta"),Sy=0,Ty=Object.isExtensible||function(){return!0},Ey=function(e){wy(e,_y,{value:{objectID:"O"+Sy++,weakData:{}}})},Iy=yy.exports={REQUIRED:!1,fastKey:function(e,t){if(!by(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!ky(e,_y)){if(!Ty(e))return"F";if(!t)return"E";Ey(e)}return e[_y].objectID},getWeakData:function(e,t){if(!ky(e,_y)){if(!Ty(e))return!0;if(!t)return!1;Ey(e)}return e[_y].weakData},onFreeze:function(e){return xy&&Iy.REQUIRED&&Ty(e)&&!ky(e,_y)&&Ey(e),e}};gy[_y]=!0;var Ry=Yt,Cy=i,Py=zt,Oy=te.exports,My=yy.exports,Ay=eu,Dy=Ns,jy=x,Ny=o,Ly=uu,Uy=_r,Fy=Yl,By=function(e,t,n){var r=-1!==e.indexOf("Map"),i=-1!==e.indexOf("Weak"),a=r?"set":"add",o=Cy[e],s=o&&o.prototype,u=o,c={},l=function(e){var t=s[e];Oy(s,e,"add"==e?function(e){return t.call(this,0===e?0:e),this}:"delete"==e?function(e){return!(i&&!jy(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return i&&!jy(e)?void 0:t.call(this,0===e?0:e)}:"has"==e?function(e){return!(i&&!jy(e))&&t.call(this,0===e?0:e)}:function(e,n){return t.call(this,0===e?0:e,n),this})};if(Py(e,"function"!=typeof o||!(i||s.forEach&&!Ny((function(){(new o).entries().next()})))))u=n.getConstructor(t,e,r,a),My.REQUIRED=!0;else if(Py(e,!0)){var f=new u,d=f[a](i?{}:-0,1)!=f,h=Ny((function(){f.has(1)})),p=Ly((function(e){new o(e)})),v=!i&&Ny((function(){for(var e=new o,t=5;t--;)e[a](t,t);return!e.has(-0)}));p||((u=t((function(t,n){Dy(t,u,e);var i=Fy(new o,t,u);return null!=n&&Ay(n,i[a],{that:i,AS_ENTRIES:r}),i}))).prototype=s,s.constructor=u),(h||v)&&(l("delete"),l("has"),r&&l("get")),(v||d)&&l(a),i&&s.clear&&delete s.clear}return c[e]=u,Ry({global:!0,forced:u!=o},c),Uy(u,e),i||n.setStrong(u,e,r),u},qy=G.f,Wy=gn,zy=Ps,Gy=Tr,Vy=Ns,Hy=eu,Jy=os,Ky=js,$y=s,Qy=yy.exports.fastKey,Yy=qe.set,Xy=qe.getterFor,Zy={getConstructor:function(e,t,n,r){var i=e((function(e,a){Vy(e,i,t),Yy(e,{type:t,index:Wy(null),first:void 0,last:void 0,size:0}),$y||(e.size=0),null!=a&&Hy(a,e[r],{that:e,AS_ENTRIES:n})})),a=Xy(t),o=function(e,t,n){var r,i,o=a(e),u=s(e,t);return u?u.value=n:(o.last=u={index:i=Qy(t,!0),key:t,value:n,previous:r=o.last,next:void 0,removed:!1},o.first||(o.first=u),r&&(r.next=u),$y?o.size++:e.size++,"F"!==i&&(o.index[i]=u)),e},s=function(e,t){var n,r=a(e),i=Qy(t);if("F"!==i)return r.index[i];for(n=r.first;n;n=n.next)if(n.key==t)return n};return zy(i.prototype,{clear:function(){for(var e=a(this),t=e.index,n=e.first;n;)n.removed=!0,n.previous&&(n.previous=n.previous.next=void 0),delete t[n.index],n=n.next;e.first=e.last=void 0,$y?e.size=0:this.size=0},delete:function(e){var t=this,n=a(t),r=s(t,e);if(r){var i=r.next,o=r.previous;delete n.index[r.index],r.removed=!0,o&&(o.next=i),i&&(i.previous=o),n.first==r&&(n.first=i),n.last==r&&(n.last=o),$y?n.size--:t.size--}return!!r},forEach:function(e){for(var t,n=a(this),r=Gy(e,arguments.length>1?arguments[1]:void 0,3);t=t?t.next:n.first;)for(r(t.value,t.key,this);t&&t.removed;)t=t.previous},has:function(e){return!!s(this,e)}}),zy(i.prototype,n?{get:function(e){var t=s(this,e);return t&&t.value},set:function(e,t){return o(this,0===e?0:e,t)}}:{add:function(e){return o(this,e=0===e?0:e,e)}}),$y&&qy(i.prototype,"size",{get:function(){return a(this).size}}),i},setStrong:function(e,t,n){var r=t+" Iterator",i=Xy(t),a=Xy(r);Jy(e,t,(function(e,t){Yy(this,{type:r,target:e,state:i(e),kind:t,last:void 0})}),(function(){for(var e=a(this),t=e.kind,n=e.last;n&&n.removed;)n=n.previous;return e.target&&(e.last=n=n?n.next:e.state.first)?"keys"==t?{value:n.key,done:!1}:"values"==t?{value:n.value,done:!1}:{value:[n.key,n.value],done:!1}:(e.target=void 0,{value:void 0,done:!0})}),n?"entries":"values",!n,!0),Ky(t)}};By("Map",(function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}}),Zy);var em={},tm={exports:{}};function nm(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}function rm(e){return e&&"object"===ga(e)&&"default"in e?e:{default:e}}!function(e){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e},e.exports.default=e.exports,e.exports.__esModule=!0}(tm),Object.defineProperty(em,"__esModule",{value:!0});var im=rm(tm.exports);function am(){}function om(){om.init.call(this)}function sm(e){return void 0===e._maxListeners?om.defaultMaxListeners:e._maxListeners}function um(e,t,n){if(t)e.call(n);else for(var r=e.length,i=ym(e,r),a=0;a<r;++a)i[a].call(n)}function cm(e,t,n,r){if(t)e.call(n,r);else for(var i=e.length,a=ym(e,i),o=0;o<i;++o)a[o].call(n,r)}function lm(e,t,n,r,i){if(t)e.call(n,r,i);else for(var a=e.length,o=ym(e,a),s=0;s<a;++s)o[s].call(n,r,i)}function fm(e,t,n,r,i,a){if(t)e.call(n,r,i,a);else for(var o=e.length,s=ym(e,o),u=0;u<o;++u)s[u].call(n,r,i,a)}function dm(e,t,n,r){if(t)e.apply(n,r);else for(var i=e.length,a=ym(e,i),o=0;o<i;++o)a[o].apply(n,r)}function hm(e,t,n,r){var i,a,o,s;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if((a=e._events)?(a.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),a=e._events),o=a[t]):(a=e._events=new am,e._eventsCount=0),o){if("function"==typeof o?o=a[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),!o.warned&&(i=sm(e))&&i>0&&o.length>i){o.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=o.length,s=u,"function"==typeof console.warn?console.warn(s):console.log(s)}}else o=a[t]=n,++e._eventsCount;return e}function pm(e,t,n){var r=!1;function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}return i.listener=n,i}function vm(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function ym(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}am.prototype=Object.create(null),om.EventEmitter=om,om.usingDomains=!1,om.prototype.domain=void 0,om.prototype._events=void 0,om.prototype._maxListeners=void 0,om.defaultMaxListeners=10,om.init=function(){this.domain=null,om.usingDomains&&undefined.active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new am,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},om.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},om.prototype.getMaxListeners=function(){return sm(this)},om.prototype.emit=function(e){var t,n,r,i,a,o,s,u="error"===e;if(o=this._events)u=u&&null==o.error;else if(!u)return!1;if(s=this.domain,u){if(t=arguments[1],!s){if(t instanceof Error)throw t;var c=new Error('Uncaught, unspecified "error" event. ('+t+")");throw c.context=t,c}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=s,t.domainThrown=!1,s.emit("error",t),!1}if(!(n=o[e]))return!1;var l="function"==typeof n;switch(r=arguments.length){case 1:um(n,l,this);break;case 2:cm(n,l,this,arguments[1]);break;case 3:lm(n,l,this,arguments[1],arguments[2]);break;case 4:fm(n,l,this,arguments[1],arguments[2],arguments[3]);break;default:for(i=new Array(r-1),a=1;a<r;a++)i[a-1]=arguments[a];dm(n,l,this,i)}return!0},om.prototype.addListener=function(e,t){return hm(this,e,t,!1)},om.prototype.on=om.prototype.addListener,om.prototype.prependListener=function(e,t){return hm(this,e,t,!0)},om.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,pm(this,e,t)),this},om.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,pm(this,e,t)),this},om.prototype.removeListener=function(e,t){var n,r,i,a,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new am:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,a=n.length;a-- >0;)if(n[a]===t||n[a].listener&&n[a].listener===t){o=n[a].listener,i=a;break}if(i<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new am,this;delete r[e]}else!function(e,t){for(var n=t,r=n+1,i=e.length;r<i;n+=1,r+=1)e[n]=e[r];e.pop()}(n,i);r.removeListener&&this.emit("removeListener",e,o||t)}return this},om.prototype.off=function(e,t){return this.removeListener(e,t)},om.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new am,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new am:delete n[e]),this;if(0===arguments.length){for(var r,i=Object.keys(n),a=0;a<i.length;++a)"removeListener"!==(r=i[a])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new am,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},om.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(t):[]},om.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):vm.call(e,t)},om.prototype.listenerCount=vm,om.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var mm=function(e){ma(n,e);var t=nm(n);function n(e){var r;return xa(this,n),r=t.call(this),im.default(va(r),"timeout",null),im.default(va(r),"startTimestamp",-1),r.minDelay=e.min,r.maxDelay=e.max,r.initialDelay=e.initial||0,r.maxAttemptsCount=e.maxAttemptsCount||0,r.maxAttemptsTime=e.maxAttemptsTime||0,r.randomness=e.randomness||0,r.inProgress=!1,r.attemptNum=0,r.prevDelay=0,r.currDelay=0,r}return pa(n,[{key:"attempt",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.attemptNum++,this.emit("attempt",this)}},{key:"nextDelay",value:function(e){if("number"==typeof e)return this.prevDelay=0,this.currDelay=e,e;if(0==this.attemptNum)return this.initialDelay;if(1==this.attemptNum)return this.currDelay=this.minDelay,this.currDelay;this.prevDelay=this.currDelay;var t=this.currDelay+this.prevDelay;return this.maxDelay&&t>this.maxDelay&&(this.currDelay=this.maxDelay,t=this.maxDelay),this.currDelay=t,t}},{key:"randomize",value:function(e){var t=e*this.randomness,n=Math.round(Math.random()*t*2-t);return Math.max(0,e+n)}},{key:"scheduleAttempt",value:function(e){var t=this;if(this.maxAttemptsCount&&this.attemptNum>=this.maxAttemptsCount)return this.cleanup(),void this.emit("failed",new Error("Maximum attempt count limit reached"));var n=this.nextDelay(e);if(n=this.randomize(n),this.maxAttemptsTime&&this.startTimestamp+this.maxAttemptsTime<Date.now()+n)return this.cleanup(),void this.emit("failed",new Error("Maximum attempt time limit reached"));this.timeout=setTimeout((function(){return t.attempt()}),n)}},{key:"cleanup",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.inProgress=!1,this.attemptNum=0,this.prevDelay=0,this.currDelay=0}},{key:"start",value:function(){if(this.inProgress)throw new Error("Retrier is already in progress");this.inProgress=!0,this.startTimestamp=Date.now(),this.scheduleAttempt(this.initialDelay)}},{key:"cancel",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null,this.inProgress=!1,this.emit("cancelled"))}},{key:"succeeded",value:function(e){this.emit("succeeded",e)}},{key:"failed",value:function(e,t){if(this.timeout)throw new Error("Retrier attempt is already in progress");this.scheduleAttempt(t)}}]),n}(om),gm=function(e){ma(n,e);var t=nm(n);function n(e){var r;return xa(this,n),r=t.call(this),im.default(va(r),"resolve",(function(){})),im.default(va(r),"reject",(function(){})),r.retrier=new mm(e),r}return pa(n,[{key:"run",value:function(e){var t=this;return this.retrier.on("attempt",(function(){e().then((function(e){return t.retrier.succeeded(e)})).catch((function(e){return t.retrier.failed(e)}))})),this.retrier.on("succeeded",(function(e){return t.resolve(e)})),this.retrier.on("cancelled",(function(){return t.reject(new Error("Cancelled"))})),this.retrier.on("failed",(function(e){return t.reject(e)})),new Promise((function(e,n){t.resolve=e,t.reject=n,t.retrier.start()}))}},{key:"cancel",value:function(){this.retrier.cancel()}}]),n}(om);function bm(e){return null!=e}var km=function(e){ma(n,e);var t=nm(n);function n(e){var r;xa(this,n),r=t.call(this),im.default(va(r),"backoffDelay",0),im.default(va(r),"nextBackoffDelay",0),im.default(va(r),"backoffNumber",0),im.default(va(r),"timeoutID",null),im.default(va(r),"maxNumberOfRetry",-1);var i=e=e||{},a=i.initialDelay,o=i.maxDelay,s=i.randomisationFactor,u=i.factor;if(bm(a)&&a<1)throw new Error("The initial timeout must be equal to or greater than 1.");if(bm(o)&&o<=1)throw new Error("The maximal timeout must be greater than 1.");if(bm(s)&&(s<0||s>1))throw new Error("The randomisation factor must be between 0 and 1.");if(bm(u)&&u<=1)throw new Error("Exponential factor should be greater than 1.");if(r.initialDelay=a||100,r.maxDelay=o||1e4,r.maxDelay<=r.initialDelay)throw new Error("The maximal backoff delay must be greater than the initial backoff delay.");return r.randomisationFactor=s||0,r.factor=u||2,r.reset(),r}return pa(n,[{key:"backoff",value:function(e){null==this.timeoutID&&(this.backoffNumber===this.maxNumberOfRetry?(this.emit("fail",e),this.reset()):(this.backoffDelay=this.next(),this.timeoutID=setTimeout(this.onBackoff.bind(this),this.backoffDelay),this.emit("backoff",this.backoffNumber,this.backoffDelay,e)))}},{key:"reset",value:function(){this.backoffDelay=0,this.nextBackoffDelay=this.initialDelay,this.backoffNumber=0,this.timeoutID&&clearTimeout(this.timeoutID),this.timeoutID=null}},{key:"failAfter",value:function(e){if(e<=0)throw new Error("Expected a maximum number of retry greater than 0 but got ".concat(e));this.maxNumberOfRetry=e}},{key:"next",value:function(){this.backoffDelay=Math.min(this.nextBackoffDelay,this.maxDelay),this.nextBackoffDelay=this.backoffDelay*this.factor;var e=1+Math.random()*this.randomisationFactor;return Math.min(this.maxDelay,Math.round(this.backoffDelay*e))}},{key:"onBackoff",value:function(){this.timeoutID=null,this.emit("ready",this.backoffNumber,this.backoffDelay),this.backoffNumber++}}],[{key:"exponential",value:function(e){return new n(e)}}]),n}(om);em.AsyncRetrier=gm,em.Backoff=km;var wm=em.Retrier=mm;function xm(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return _m(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return _m(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function _m(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var Sm=function(){function e(t,n){var r=this;xa(this,e),this.config=t,this.services=n,this.cache=new Map,this.cacheLifetime=0,this.services.session.getHttpCacheInterval().then((function(e){r.cacheLifetime=1e3*e,r.cleanupCache()}))}return pa(e,[{key:"backoffConfig",value:function(){return Object.assign(this.config.backoffConfigDefault,this.config.backoffConfigOverride)}},{key:"retryWhenThrottled",value:function(){return void 0!==this.config.retryWhenThrottledOverride?this.config.retryWhenThrottledOverride:void 0!==this.config.retryWhenThrottledDefault&&this.config.retryWhenThrottledDefault}},{key:"isExpired",value:function(e){return!this.cacheLifetime||Date.now()-e>this.cacheLifetime}},{key:"cleanupCache",value:function(){var e,t=xm(this.cache);try{for(t.s();!(e=t.n()).done;){var n=vy(e.value,2),r=n[0],i=n[1];this.isExpired(i.timestamp)&&this.cache.delete(r)}}catch(e){t.e(e)}finally{t.f()}0===this.cache.size&&clearInterval(this.timer)}},{key:"pokeTimer",value:function(){var e=this;this.timer=this.timer||setInterval((function(){return e.cleanupCache()}),2*this.cacheLifetime)}},{key:"executeWithRetry",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise((function(r,i){var a=[502,503,504];n&&a.push(429);var o=new wm(t.backoffConfig());o.on("attempt",(function(){e().then((function(e){return o.succeeded(e)})).catch((function(e){a.indexOf(e.status)>-1||"Twilsock disconnected"===e.message?o.failed(e):(o.removeAllListeners(),o.cancel(),i(e))}))})),o.on("succeeded",(function(e){r(e)})),o.on("cancelled",(function(e){return i(e)})),o.on("failed",(function(e){return i(e)})),o.start()}))}},{key:"get",value:function(){var e=da(Za.mark((function e(t){var n,r,i,a=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.cache.get(t))||this.isExpired(n.timestamp)){e.next=3;break}return e.abrupt("return",n.response);case 3:return r={},e.next=6,this.executeWithRetry((function(){return a.services.transport.get(t,r,a.config.productId)}),this.retryWhenThrottled());case 6:return i=e.sent,this.cache.set(t,{response:i,timestamp:Date.now()}),this.pokeTimer(),e.abrupt("return",i);case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()}]),e}(),Tm=function e(){xa(this,e)};wa(Tm,"TYPING_INDICATOR","twilio.ipmsg.typing_indicator"),wa(Tm,"NEW_MESSAGE","twilio.conversations.new_message"),wa(Tm,"ADDED_TO_CONVERSATION","twilio.conversations.added_to_conversation"),wa(Tm,"REMOVED_FROM_CONVERSATION","twilio.conversations.removed_from_conversation"),wa(Tm,"CONSUMPTION_UPDATE","twilio.channel.consumption_update");var Em=function(){function e(t,n,r,i){xa(this,e),this.state={prevToken:r,nextToken:i,source:n,items:t}}return pa(e,[{key:"hasNextPage",get:function(){return!!this.state.nextToken}},{key:"hasPrevPage",get:function(){return!!this.state.prevToken}},{key:"items",get:function(){return this.state.items}},{key:"nextPage",value:function(){return this.hasNextPage?this.state.source(this.state.nextToken):Promise.reject(new Error("No next page"))}},{key:"prevPage",value:function(){return this.hasPrevPage?this.state.source(this.state.prevToken):Promise.reject(new Error("No previous page"))}}]),e}(),Im=function e(t){xa(this,e),this.channel_sid=t.channel_sid,this.status=t.status,this.channel=t.channel,this.messages=t.messages,this.roster=t.roster,this.lastConsumedMessageIndex=t.last_consumed_message_index,this.notificationLevel=t.notification_level,this.descriptor=t},Rm=function(){function e(t){xa(this,e),this.services=t}var t;return pa(e,[{key:"getPage",value:(t=da(Za.mark((function e(t){var n,r,i,a=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},e.next=3,this.services.session.getSessionLinks();case 3:return n=e.sent,r=new mp(n.syncListUrl).arg("PageToken",t.pageToken).build(),e.next=7,this.services.network.get(r);case 7:return i=e.sent,e.abrupt("return",new Em(i.body.channels.map((function(e){return new Im(e)})),(function(e){return a.getPage({pageToken:e})}),i.body.meta.previous_token,i.body.meta.next_token));case 9:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}(),Cm={};function Pm(e,t,n){return(Pm="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ka(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(n):i.value}})(e,t,n||e)}var Om={},Mm=n(Wf),Am={};Object.defineProperty(Am,"__esModule",{value:!0});var Dm=gd.exports.getLogger("twilsock");function jm(e,t){return["".concat((new Date).toISOString()," Twilsock ").concat(e,":")].concat(Array.from(t))}var Nm=function(){function e(t){xa(this,e),this.prefix="",this.prefix=null!=t&&t.length>0?" "+t+":":""}return pa(e,[{key:"setLevel",value:function(e){Dm.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Dm.debug.apply(null,jm("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Dm.debug.apply(null,jm("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Dm.info.apply(null,jm("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Dm.warn.apply(null,jm("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Dm.error.apply(null,jm("E",t))}}],[{key:"setLevel",value:function(e){Dm.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Dm.trace.apply(null,jm("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Dm.debug.apply(null,jm("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Dm.info.apply(null,jm("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Dm.warn.apply(null,jm("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Dm.error.apply(null,jm("E",t))}}]),e}();Am.Logger=Nm;var Lm=new Nm("");Am.log=Lm;var Um={};Object.defineProperty(Um,"__esModule",{value:!0});var Fm="0.6.2",Bm=function(){function e(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};xa(this,e),this.confirmedCapabilities=new Set,this.activeGrant=n,this._token=t;var i=r.region||"us1",a="wss://tsock.".concat(i,".twilio.com/v3/wsconnect"),o=r.twilsock||r.Twilsock||{};this.url=o.uri||a,this._continuationToken=r.continuationToken?r.continuationToken:null,this.logLevel=r.logLevel?r.logLevel:"error",this.retryPolicy=r.retryPolicy?r.retryPolicy:{min:1e3,max:12e4,randomness:.2},this.clientMetadata=r.clientMetadata?r.clientMetadata:{},this.clientMetadata.ver=Fm,this.initRegistrations=r.initRegistrations?r.initRegistrations:null,this.tweaks=r.tweaks?r.tweaks:null}return pa(e,[{key:"token",get:function(){return this._token}},{key:"continuationToken",get:function(){return this._continuationToken}},{key:"updateToken",value:function(e){this._token=e}},{key:"updateContinuationToken",value:function(e){this._continuationToken=e}}]),e}();Um.Configuration=Bm;var qm={},Wm={exports:{}};!function(e,t){var n;n=function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=e,n.c=t,n.i=function(e){return e},n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:r})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=5)}([function(e,t,n){e.exports=function(e,t){var n,r,i;for(n=1;n<arguments.length;n++)for(i in r=arguments[n])r.hasOwnProperty(i)&&(e[i]=r[i]);return e}},function(e,t,n){var r=n(0);e.exports={build:function(e,t){var n,i,a,o=t.plugins;for(n=0,i=o.length;n<i;n++)(a=o[n]).methods&&r(e,a.methods),a.properties&&Object.defineProperties(e,a.properties)},hook:function(e,t,n){var r,i,a,o,s=e.config.plugins,u=[e.context];for(n&&(u=u.concat(n)),r=0,i=s.length;r<i;r++)o=s[r],(a=s[r][t])&&a.apply(o,u)}}},function(e,t,n){function r(e){if(0===e.length)return e;var t,n,r=e.split(/[_-]/);if(1===r.length&&r[0][0].toLowerCase()===r[0][0])return e;for(n=r[0].toLowerCase(),t=1;t<r.length;t++)n=n+r[t].charAt(0).toUpperCase()+r[t].substring(1).toLowerCase();return n}r.prepended=function(e,t){return e+(t=r(t))[0].toUpperCase()+t.substring(1)},e.exports=r},function(e,t,n){var r=n(0),i=n(2);function a(e,t){e=e||{},this.options=e,this.defaults=t.defaults,this.states=[],this.transitions=[],this.map={},this.lifecycle=this.configureLifecycle(),this.init=this.configureInitTransition(e.init),this.data=this.configureData(e.data),this.methods=this.configureMethods(e.methods),this.map[this.defaults.wildcard]={},this.configureTransitions(e.transitions||[]),this.plugins=this.configurePlugins(e.plugins,t.plugin)}r(a.prototype,{addState:function(e){this.map[e]||(this.states.push(e),this.addStateLifecycleNames(e),this.map[e]={})},addStateLifecycleNames:function(e){this.lifecycle.onEnter[e]=i.prepended("onEnter",e),this.lifecycle.onLeave[e]=i.prepended("onLeave",e),this.lifecycle.on[e]=i.prepended("on",e)},addTransition:function(e){this.transitions.indexOf(e)<0&&(this.transitions.push(e),this.addTransitionLifecycleNames(e))},addTransitionLifecycleNames:function(e){this.lifecycle.onBefore[e]=i.prepended("onBefore",e),this.lifecycle.onAfter[e]=i.prepended("onAfter",e),this.lifecycle.on[e]=i.prepended("on",e)},mapTransition:function(e){var t=e.name,n=e.from,r=e.to;return this.addState(n),"function"!=typeof r&&this.addState(r),this.addTransition(t),this.map[n][t]=e,e},configureLifecycle:function(){return{onBefore:{transition:"onBeforeTransition"},onAfter:{transition:"onAfterTransition"},onEnter:{state:"onEnterState"},onLeave:{state:"onLeaveState"},on:{transition:"onTransition"}}},configureInitTransition:function(e){return"string"==typeof e?this.mapTransition(r({},this.defaults.init,{to:e,active:!0})):"object"===ga(e)?this.mapTransition(r({},this.defaults.init,e,{active:!0})):(this.addState(this.defaults.init.from),this.defaults.init)},configureData:function(e){return"function"==typeof e?e:"object"===ga(e)?function(){return e}:function(){return{}}},configureMethods:function(e){return e||{}},configurePlugins:function(e,t){var n,r,i;for(n=0,r=(e=e||[]).length;n<r;n++)"function"==typeof(i=e[n])&&(e[n]=i=i()),i.configure&&i.configure(this);return e},configureTransitions:function(e){var t,n,r,i,a,o=this.defaults.wildcard;for(n=0;n<e.length;n++)for(r=e[n],i=Array.isArray(r.from)?r.from:[r.from||o],a=r.to||o,t=0;t<i.length;t++)this.mapTransition({name:r.name,from:i[t],to:a})},transitionFor:function(e,t){var n=this.defaults.wildcard;return this.map[e][t]||this.map[n][t]},transitionsFor:function(e){var t=this.defaults.wildcard;return Object.keys(this.map[e]).concat(Object.keys(this.map[t]))},allStates:function(){return this.states},allTransitions:function(){return this.transitions}}),e.exports=a},function(e,t,n){var r=n(0),i=n(6),a=n(1),o=[null,[]];function s(e,t){this.context=e,this.config=t,this.state=t.init.from,this.observers=[e]}r(s.prototype,{init:function(e){if(r(this.context,this.config.data.apply(this.context,e)),a.hook(this,"init"),this.config.init.active)return this.fire(this.config.init.name,[])},is:function(e){return Array.isArray(e)?e.indexOf(this.state)>=0:this.state===e},isPending:function(){return this.pending},can:function(e){return!this.isPending()&&!!this.seek(e)},cannot:function(e){return!this.can(e)},allStates:function(){return this.config.allStates()},allTransitions:function(){return this.config.allTransitions()},transitions:function(){return this.config.transitionsFor(this.state)},seek:function(e,t){var n=this.config.defaults.wildcard,r=this.config.transitionFor(this.state,e),i=r&&r.to;return"function"==typeof i?i.apply(this.context,t):i===n?this.state:i},fire:function(e,t){return this.transit(e,this.state,this.seek(e,t),t)},transit:function(e,t,n,r){var i=this.config.lifecycle,a=this.config.options.observeUnchangedState||t!==n;return n?this.isPending()?this.context.onPendingTransition(e,t,n):(this.config.addState(n),this.beginTransit(),r.unshift({transition:e,from:t,to:n,fsm:this.context}),this.observeEvents([this.observersForEvent(i.onBefore.transition),this.observersForEvent(i.onBefore[e]),a?this.observersForEvent(i.onLeave.state):o,a?this.observersForEvent(i.onLeave[t]):o,this.observersForEvent(i.on.transition),a?["doTransit",[this]]:o,a?this.observersForEvent(i.onEnter.state):o,a?this.observersForEvent(i.onEnter[n]):o,a?this.observersForEvent(i.on[n]):o,this.observersForEvent(i.onAfter.transition),this.observersForEvent(i.onAfter[e]),this.observersForEvent(i.on[e])],r)):this.context.onInvalidTransition(e,t,n)},beginTransit:function(){this.pending=!0},endTransit:function(e){return this.pending=!1,e},failTransit:function(e){throw this.pending=!1,e},doTransit:function(e){this.state=e.to},observe:function(e){if(2===e.length){var t={};t[e[0]]=e[1],this.observers.push(t)}else this.observers.push(e[0])},observersForEvent:function(e){for(var t,n=0,r=this.observers.length,i=[];n<r;n++)(t=this.observers[n])[e]&&i.push(t);return[e,i,!0]},observeEvents:function(e,t,n,r){if(0===e.length)return this.endTransit(void 0===r||r);var i=e[0][0],o=e[0][1],s=e[0][2];if(t[0].event=i,i&&s&&i!==n&&a.hook(this,"lifecycle",t),0===o.length)return e.shift(),this.observeEvents(e,t,i,r);var u=o.shift(),c=u[i].apply(u,t);return c&&"function"==typeof c.then?c.then(this.observeEvents.bind(this,e,t,i)).catch(this.failTransit.bind(this)):!1===c?this.endTransit(!1):this.observeEvents(e,t,i,c)},onInvalidTransition:function(e,t,n){throw new i("transition is invalid in current state",e,t,n,this.state)},onPendingTransition:function(e,t,n){throw new i("transition is invalid while previous transition is still in progress",e,t,n,this.state)}}),e.exports=s},function(e,t,n){var r=n(0),i=n(2),a=n(1),o=n(3),s=n(4),u={is:function(e){return this._fsm.is(e)},can:function(e){return this._fsm.can(e)},cannot:function(e){return this._fsm.cannot(e)},observe:function(){return this._fsm.observe(arguments)},transitions:function(){return this._fsm.transitions()},allTransitions:function(){return this._fsm.allTransitions()},allStates:function(){return this._fsm.allStates()},onInvalidTransition:function(e,t,n){return this._fsm.onInvalidTransition(e,t,n)},onPendingTransition:function(e,t,n){return this._fsm.onPendingTransition(e,t,n)}},c={state:{configurable:!1,enumerable:!0,get:function(){return this._fsm.state},set:function(e){throw Error("use transitions to change state")}}};function l(e){return f(this||{},e)}function f(e,t){return d(e,new o(t,l)),e._fsm(),e}function d(e,t){if("object"!==ga(e)||Array.isArray(e))throw Error("StateMachine can only be applied to objects");a.build(e,t),Object.defineProperties(e,c),r(e,u),r(e,t.methods),t.allTransitions().forEach((function(t){e[i(t)]=function(){return this._fsm.fire(t,[].slice.call(arguments))}})),e._fsm=function(){this._fsm=new s(this,t),this._fsm.init(arguments)}}l.version="3.0.1",l.factory=function(){var e,t;"function"==typeof arguments[0]?(e=arguments[0],t=arguments[1]||{}):(e=function(){this._fsm.apply(this,arguments)},t=arguments[0]||{});var n=new o(t,l);return d(e.prototype,n),e.prototype._fsm.config=n,e},l.apply=f,l.defaults={wildcard:"*",init:{name:"init",from:"none"}},e.exports=l},function(e,t,n){e.exports=function(e,t,n,r,i){this.message=e,this.transition=t,this.from=n,this.to=r,this.current=i}}])},e.exports=n()}(Wm);var zm={},Gm={},Vm={},Hm={exports:{}},Jm="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(Jm){var Km=new Uint8Array(16);Hm.exports=function(){return Jm(Km),Km}}else{var $m=new Array(16);Hm.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),$m[t]=e>>>((3&t)<<3)&255;return $m}}for(var Qm=[],Ym=0;Ym<256;++Ym)Qm[Ym]=(Ym+256).toString(16).substr(1);var Xm,Zm,eg=function(e,t){var n=t||0,r=Qm;return[r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],"-",r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]],r[e[n++]]].join("")},tg=Hm.exports,ng=eg,rg=0,ig=0;var ag=function(e,t,n){var r=t&&n||0,i=t||[],a=(e=e||{}).node||Xm,o=void 0!==e.clockseq?e.clockseq:Zm;if(null==a||null==o){var s=tg();null==a&&(a=Xm=[1|s[0],s[1],s[2],s[3],s[4],s[5]]),null==o&&(o=Zm=16383&(s[6]<<8|s[7]))}var u=void 0!==e.msecs?e.msecs:(new Date).getTime(),c=void 0!==e.nsecs?e.nsecs:ig+1,l=u-rg+(c-ig)/1e4;if(l<0&&void 0===e.clockseq&&(o=o+1&16383),(l<0||u>rg)&&void 0===e.nsecs&&(c=0),c>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");rg=u,ig=c,Zm=o;var f=(1e4*(268435455&(u+=122192928e5))+c)%4294967296;i[r++]=f>>>24&255,i[r++]=f>>>16&255,i[r++]=f>>>8&255,i[r++]=255&f;var d=u/4294967296*1e4&268435455;i[r++]=d>>>8&255,i[r++]=255&d,i[r++]=d>>>24&15|16,i[r++]=d>>>16&255,i[r++]=o>>>8|128,i[r++]=255&o;for(var h=0;h<6;++h)i[r+h]=a[h];return t||ng(i)},og=Hm.exports,sg=eg;var ug=ag,cg=function(e,t,n){var r=t&&n||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var i=(e=e||{}).random||(e.rng||og)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t)for(var a=0;a<16;++a)t[r+a]=i[a];return t||sg(i)},lg=cg;lg.v1=ug,lg.v4=cg;var fg=lg;Object.defineProperty(Vm,"__esModule",{value:!0});var dg=fg;function hg(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Vm.AbstractMessage=function e(t){xa(this,e),this.id=t||"TM".concat(dg.v4())},Object.defineProperty(Gm,"__esModule",{value:!0});var pg=function(e){ma(n,e);var t=hg(n);function n(e,r,i){var a,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;return xa(this,n),(a=t.call(this)).method="init",a.token=e,a.continuation_token=r,a.metadata=i,a.registrations=o,a.tweaks=s,a.capabilities=["client_update","offline_storage","telemetry.v1"],a}return n}(Vm.AbstractMessage);Gm.Init=pg;var vg={};function yg(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(vg,"__esModule",{value:!0});var mg=Vm;vg.ContinuationTokenStatus=function e(){xa(this,e)};var gg=function(e){ma(n,e);var t=yg(n);function n(e,r,i,a,o,s,u){var c;return xa(this,n),(c=t.call(this,e)).continuationToken=r,c.continuationTokenStatus=i,c.offlineStorage=a,c.initRegistrations=o,c.debugInfo=s,c.confirmedCapabilities=u,c}return n}(mg.AbstractMessage);vg.InitReply=gg;var bg={};function kg(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(bg,"__esModule",{value:!0});var wg=function(e){ma(n,e);var t=kg(n);function n(e){var r;return xa(this,n),(r=t.call(this)).method="update",r.token=e,r}return n}(Vm.AbstractMessage);bg.Update=wg;var xg={};function _g(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(xg,"__esModule",{value:!0});var Sg=function(e){ma(Message,e);var t=_g(Message);function Message(e,n,r){var i;return xa(this,Message),(i=t.call(this)).method="message",i.active_grant=e,i.payload_type=n,i.http_request=r,i}return Message}(Vm.AbstractMessage);xg.Message=Sg;var Tg={};function Eg(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(Tg,"__esModule",{value:!0});var Ig=function(e){ma(n,e);var t=Eg(n);function n(e){var r;return xa(this,n),(r=t.call(this,e)).method="reply",r.payload_type="application/json",r.status={code:200,status:"OK"},r}return n}(Vm.AbstractMessage);Tg.Reply=Ig;var Rg={};function Cg(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(Rg,"__esModule",{value:!0});var Pg=function(e){ma(n,e);var t=Cg(n);function n(){var e;return xa(this,n),(e=t.call(this)).method="close",e}return n}(Vm.AbstractMessage);Rg.Close=Pg;var Og={};function Mg(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(Og,"__esModule",{value:!0});var Ag=Vm;Og.TelemetryEvent=function e(t,n,r,i,a,o){xa(this,e),this.start=t,this.end=n,this.title=r,this.details=i,this.id=a,this.type=o};var Dg=function(e){ma(n,e);var t=Mg(n);function n(e){var r;return xa(this,n),(r=t.call(this)).method="telemetry.v1",r.events=e,r}return n}(Ag.AbstractMessage);Og.Telemetry=Dg,Object.defineProperty(zm,"__esModule",{value:!0});var jg=Gm;zm.Init=jg.Init;var Ng=vg;zm.InitReply=Ng.InitReply;var Lg=bg;zm.Update=Lg.Update;var Ug=xg;zm.Message=Ug.Message;var Fg=Tg;zm.Reply=Fg.Reply;var Bg=Rg;zm.Close=Bg.Close;var qg=Og;zm.Telemetry=qg.Telemetry;var Wg={};Object.defineProperty(Wg,"__esModule",{value:!0});var zg=Am;function Gg(e){return encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode("0x"+t)})).length}function Vg(e){var t=encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,(function(e,t){return String.fromCharCode("0x"+t)})),n=new Uint8Array(t.length);return Array.prototype.forEach.call(t,(function(e,t){n[t]=e.charCodeAt(0)})),n}function Hg(e){var t=Array.prototype.map.call(e,(function(e){return String.fromCharCode(e)})).join("").replace(/(.)/g,(function(e,t){var n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}));return decodeURIComponent(t)}function Jg(e){return JSON.parse(Hg(e))}var Kg=function(){function e(){xa(this,e)}return pa(e,null,[{key:"parse",value:function(e){var t=new Uint8Array(e),n=function(e){for(var t="",n=0;n<e.length;++n){var r=String.fromCharCode(e[n]);if(t+=r,"\r"===r){n+=2;break}}var i=t.split(" ");return{size:n,protocol:i[0],version:i[1],headerSize:Number(i[2])}}(t);if("TWILSOCK"===n.protocol&&"V3.0"===n.version){var r=null;try{r=Jg(t.subarray(n.size,n.size+n.headerSize))}catch(t){return void zg.log.error("failed to parse message header",t,e)}zg.log.debug("message received: ",r.method),zg.log.trace("message received: ",r);var i=null;if(r.payload_size>0){var a=2+n.size+n.headerSize,o=r.payload_size;if(r.hasOwnProperty("payload_type")&&0!==r.payload_type.indexOf("application/json"))0===r.payload_type.indexOf("text/plain")&&(i=Hg(t.subarray(a,a+o)));else try{i=Jg(t.subarray(a,a+o))}catch(t){return void zg.log.error("failed to parse message body",t,e)}}return{method:r.method,header:r,payload:i}}zg.log.error("unsupported protocol: ".concat(n.protocol," ver ").concat(n.version))}},{key:"createPacket",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";e.payload_size=Gg(t);var n=JSON.stringify(e)+"\r\n",r="TWILSOCK V3.0 "+(Gg(n)-2)+"\r\n";zg.log.debug("send request:",r+n+t);var i=Vg(r+n+t);return i.buffer}}]),e}();Wg.Parser=Kg;var $g={};function Qg(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function Yg(e,t,n){return(Yg=Qg()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&ya(i,n.prototype),i}).apply(null,arguments)}function Xg(e){var t="function"==typeof Map?new Map:void 0;return(Xg=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return Yg(e,arguments,ka(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),ya(r,e)})(e)}var Zg={};function eb(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(Zg,"__esModule",{value:!0});var tb=function(e){ma(n,e);var t=eb(n);function n(e){return xa(this,n),t.call(this,e)}return n}(Xg(Error));function nb(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Zg.TwilsockError=tb,Object.defineProperty($g,"__esModule",{value:!0});var rb=function(e){ma(n,e);var t=nb(n);function n(e,r){var i;return xa(this,n),(i=t.call(this,e)).reply=r,i}return n}(Zg.TwilsockError);$g.TwilsockReplyError=rb;var ib={},ab={},ob={};function sb(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(ob,"__esModule",{value:!0});var ub=function(e){ma(n,e);var t=sb(n);function n(e){var r;return xa(this,n),(r=t.call(this)).minDelay=e.min,r.maxDelay=e.max,r.initialDelay=e.initial||0,r.maxAttemptsCount=e.maxAttemptsCount||0,r.maxAttemptsTime=e.maxAttemptsTime||0,r.randomness=e.randomness||0,r.inProgress=!1,r.attemptNum=0,r.prevDelay=0,r.currDelay=0,r}return pa(n,[{key:"attempt",value:function(){clearTimeout(this.timeout),this.attemptNum++,this.timeout=null,this.emit("attempt",this)}},{key:"nextDelay",value:function(e){if("number"==typeof e)return this.prevDelay=0,this.currDelay=e,e;if(0==this.attemptNum)return this.initialDelay;if(1==this.attemptNum)return this.currDelay=this.minDelay,this.currDelay;this.prevDelay=this.currDelay;var t=this.currDelay+this.prevDelay;return this.maxDelay&&t>this.maxDelay&&(this.currDelay=this.maxDelay,t=this.maxDelay),this.currDelay=t,t}},{key:"randomize",value:function(e){var t=e*this.randomness,n=Math.round(Math.random()*t*2-t);return Math.max(0,e+n)}},{key:"scheduleAttempt",value:function(e){var t=this;if(this.maxAttemptsCount&&this.attemptNum>=this.maxAttemptsCount)return this.cleanup(),this.emit("failed",new Error("Maximum attempt count limit reached")),void this.reject(new Error("Maximum attempt count reached"));var n=this.nextDelay(e);if(n=this.randomize(n),this.maxAttemptsTime&&this.startTimestamp+this.maxAttemptsTime<Date.now()+n)return this.cleanup(),this.emit("failed",new Error("Maximum attempt time limit reached")),void this.reject(new Error("Maximum attempt time limit reached"));this.timeout=setTimeout((function(){return t.attempt()}),n)}},{key:"cleanup",value:function(){clearTimeout(this.timeout),this.timeout=null,this.inProgress=!1,this.attemptNum=0,this.prevDelay=0,this.currDelay=0}},{key:"start",value:function(){var e=this;if(this.inProgress)throw new Error("Retrier is already in progress");return this.inProgress=!0,new Promise((function(t,n){e.resolve=t,e.reject=n,e.startTimestamp=Date.now(),e.scheduleAttempt(e.initialDelay)}))}},{key:"cancel",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null,this.inProgress=!1,this.emit("cancelled"),this.reject(new Error("Cancelled")))}},{key:"succeeded",value:function(e){this.emit("succeeded",e),this.resolve(e)}},{key:"failed",value:function(e,t){if(this.timeout)throw new Error("Retrier attempt is already in progress");this.scheduleAttempt(t)}},{key:"run",value:function(e){var t=this;return this.on("attempt",(function(){e().then((function(e){return t.succeeded(e)})).catch((function(e){return t.failed(e)}))})),this.start()}}]),n}(Mm.EventEmitter);ob.Retrier=ub,ob.default=ub;var cb={};function lb(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}function fb(e){return null!=e}Object.defineProperty(cb,"__esModule",{value:!0});var db=function(e){ma(n,e);var t=lb(n);function n(e){var r;if(xa(this,n),r=t.call(this),fb((e=e||{}).initialDelay)&&e.initialDelay<1)throw new Error("The initial timeout must be equal to or greater than 1.");if(fb(e.maxDelay)&&e.maxDelay<=1)throw new Error("The maximal timeout must be greater than 1.");if(fb(e.randomisationFactor)&&(e.randomisationFactor<0||e.randomisationFactor>1))throw new Error("The randomisation factor must be between 0 and 1.");if(fb(e.factor)&&e.factor<=1)throw new Error("Exponential factor should be greater than 1.");if(r.initialDelay=e.initialDelay||100,r.maxDelay=e.maxDelay||1e4,r.maxDelay<=r.initialDelay)throw new Error("The maximal backoff delay must be greater than the initial backoff delay.");return r.randomisationFactor=e.randomisationFactor||0,r.factor=e.factor||2,r.maxNumberOfRetry=-1,r.reset(),r}return pa(n,[{key:"backoff",value:function(e){null==this.timeoutID&&(this.backoffNumber===this.maxNumberOfRetry?(this.emit("fail",e),this.reset()):(this.backoffDelay=this.next(),this.timeoutID=setTimeout(this.onBackoff.bind(this),this.backoffDelay),this.emit("backoff",this.backoffNumber,this.backoffDelay,e)))}},{key:"reset",value:function(){this.backoffDelay=0,this.nextBackoffDelay=this.initialDelay,this.backoffNumber=0,clearTimeout(this.timeoutID),this.timeoutID=null}},{key:"failAfter",value:function(e){if(e<=0)throw new Error("Expected a maximum number of retry greater than 0 but got ".concat(e));this.maxNumberOfRetry=e}},{key:"next",value:function(){this.backoffDelay=Math.min(this.nextBackoffDelay,this.maxDelay),this.nextBackoffDelay=this.backoffDelay*this.factor;var e=1+Math.random()*this.randomisationFactor;return Math.min(this.maxDelay,Math.round(this.backoffDelay*e))}},{key:"onBackoff",value:function(){this.timeoutID=null,this.emit("ready",this.backoffNumber,this.backoffDelay),this.backoffNumber++}}],[{key:"exponential",value:function(e){return new n(e)}}]),n}(Mm.EventEmitter);cb.Backoff=db,cb.default=db,Object.defineProperty(ab,"__esModule",{value:!0});var hb=ob;ab.Retrier=hb.Retrier;var pb=cb;function vb(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}ab.Backoff=pb.Backoff,ab.default=hb.Retrier,Object.defineProperty(ib,"__esModule",{value:!0});var yb=ab,mb=function(e){ma(n,e);var t=vb(n);function n(e){var r;return xa(this,n),(r=t.call(this)).options=e?Object.assign({},e):{},r}return pa(n,[{key:"inProgress",get:function(){return!!this.retrier}},{key:"start",value:function(){if(this.inProgress)throw new Error("Already waiting for next attempt, call finishAttempt(success : boolean) to finish it");this.createRetrier()}},{key:"stop",value:function(){this.cleanRetrier(),this.newBackoff=null,this.usedBackoff=null}},{key:"modifyBackoff",value:function(e){this.newBackoff=e}},{key:"attemptFailed",value:function(){if(!this.inProgress)throw new Error("No attempt is in progress");this.newBackoff?!this.usedBackoff||this.usedBackoff<this.newBackoff?this.createRetrier():this.retrier.failed(new Error):this.retrier.failed(new Error)}},{key:"cancel",value:function(){this.retrier&&this.retrier.cancel()}},{key:"cleanRetrier",value:function(){this.retrier&&(this.retrier.removeAllListeners(),this.retrier.cancel(),this.retrier=null)}},{key:"getRetryPolicy",value:function(){var e=Object.assign({},this.options);return this.newBackoff&&(e.min=this.newBackoff,e.max=this.options.max&&this.options.max>this.newBackoff?this.options.max:this.newBackoff),e.maxAttemptsCount=this.options.maxAttemptsCount?this.options.maxAttemptsCount+1:void 0,e}},{key:"createRetrier",value:function(){var e=this;this.cleanRetrier();var t=this.getRetryPolicy();this.retrier=new yb.Retrier(t),this.retrier.once("attempt",(function(){e.retrier.on("attempt",(function(){return e.emit("attempt")})),e.retrier.failed(new Error("Skipping first attempt"))})),this.retrier.on("failed",(function(t){return e.emit("failed",t)})),this.usedBackoff=this.newBackoff,this.newBackoff=null,this.retrier.start().catch((function(e){}))}}]),n}(Mm.EventEmitter);function gb(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}ib.BackoffRetrier=mb,Object.defineProperty(qm,"__esModule",{value:!0});var bb=Mm,kb=Wm.exports,wb=Am,xb=zm,_b=Wg,Sb=$g,Tb=ib;qm.Response=function e(){xa(this,e)};var Eb=function(e){ma(i,e);var t,n,r=gb(i);function i(e,t,n){var a;return xa(this,i),(a=r.call(this)).terminalStates=["disconnected","rejected"],a.lastEmittedState=void 0,a.tokenExpiredSasCode=20104,a.terminationReason="Connection is not initialized",a.websocket=e,a.websocket.on("connected",(function(){return a.fsm.socketConnected()})),a.websocket.on("disconnected",(function(e){return a.fsm.socketClosed()})),a.websocket.on("message",(function(e){return a.onIncomingMessage(e)})),a.websocket.on("socketError",(function(e){return a.emit("connectionError",{terminal:!1,message:"Socket error: ".concat(e.message),httpStatusCode:null,errorCode:null})})),a.transport=t,a.config=n,a.retrier=new Tb.BackoffRetrier(n.retryPolicy),a.retrier.on("attempt",(function(){return a.retry()})),a.retrier.on("failed",(function(e){wb.log.warn("Retrying failed: ".concat(e.message)),a.disconnect()})),"undefined"!=typeof window&&void 0!==window.addEventListener&&(window.addEventListener("online",(function(){wb.log.debug("Browser reported connectivity state: online"),a.resetBackoff(),a.fsm.systemOnline()})),window.addEventListener("offline",(function(){wb.log.debug("Browser reported connectivity state: offline"),a.websocket.close(),a.fsm.socketClosed()}))),a.fsm=new kb({init:"disconnected",transitions:[{name:"userConnect",from:["disconnected","rejected"],to:"connecting"},{name:"userConnect",from:["connecting","connected"]},{name:"userDisconnect",from:["connecting","initialising","connected","updating","retrying","rejected","waitSocketClosed","waitOffloadSocketClosed"],to:"disconnecting"},{name:"userRetry",from:["retrying"],to:"connecting"},{name:"socketConnected",from:["connecting"],to:"initialising"},{name:"socketClosed",from:["connecting","initialising","connected","updating","error","waitOffloadSocketClosed"],to:"retrying"},{name:"socketClosed",from:["disconnecting"],to:"disconnected"},{name:"socketClosed",from:["waitSocketClosed"],to:"disconnected"},{name:"socketClosed",from:["rejected"],to:"rejected"},{name:"initSuccess",from:["initialising"],to:"connected"},{name:"initError",from:["initialising"],to:"error"},{name:"tokenRejected",from:["initialising","updating"],to:"rejected"},{name:"protocolError",from:["initialising","connected","updating"],to:"error"},{name:"receiveClose",from:["initialising","connected","updating"],to:"waitSocketClosed"},{name:"receiveOffload",from:["initialising","connected","updating"],to:"waitOffloadSocketClosed"},{name:"unsupportedProtocol",from:["initialising","connected","updating"],to:"unsupported"},{name:"receiveFatalClose",from:["initialising","connected","updating"],to:"unsupported"},{name:"userUpdateToken",from:["disconnected","rejected","connecting","retrying"],to:"connecting"},{name:"userUpdateToken",from:["connected"],to:"updating"},{name:"updateSuccess",from:["updating"],to:"connected"},{name:"updateError",from:["updating"],to:"error"},{name:"userSend",from:["connected"],to:"connected"},{name:"systemOnline",from:["retrying"],to:"connecting"}],methods:{onConnecting:function(){a.setupSocket(),a.emit("connecting")},onEnterInitialising:function(){a.sendInit()},onLeaveInitialising:function(){a.cancelInit()},onEnterUpdating:function(){a.sendUpdate()},onLeaveUpdating:function(){a.cancelUpdate()},onEnterRetrying:function(){a.initRetry(),a.emit("connecting")},onEnterConnected:function(){a.resetBackoff(),a.onConnected()},onUserUpdateToken:function(){a.resetBackoff()},onTokenRejected:function(){a.resetBackoff(),a.closeSocket(!0),a.finalizeSocket()},onUserDisconnect:function(){a.closeSocket(!0)},onEnterDisconnecting:function(){a.startDisconnectTimer()},onLeaveDisconnecting:function(){a.cancelDisconnectTimer()},onEnterWaitSocketClosed:function(){a.startDisconnectTimer()},onLeaveWaitSocketClosed:function(){a.cancelDisconnectTimer()},onEnterWaitOffloadSocketClosed:function(){a.startDisconnectTimer()},onLeaveWaitOffloadSocketClosed:function(){a.cancelDisconnectTimer()},onDisconnected:function(){a.resetBackoff(),a.finalizeSocket()},onReceiveClose:function(e,t){a.onCloseReceived(t)},onReceiveOffload:function(e,t){wb.log.debug("onreceiveoffload: ",t),a.modifyBackoff(t.body),a.onCloseReceived(t.status)},onUnsupported:function(){a.closeSocket(!0),a.finalizeSocket()},onError:function(e,t){a.closeSocket(t),a.finalizeSocket()},onEnterState:function(e){"none"!==e.from&&a.changeState(e)},onInvalidTransition:function(e,t,n){wb.log.warn("FSM: unexpected transition",t,n)}}}),a}return pa(i,[{key:"changeState",value:function(e){wb.log.debug("FSM: ".concat(e.transition,": ").concat(e.from," --\x3e ").concat(e.to)),this.lastEmittedState!==this.state&&(this.lastEmittedState=this.state,this.emit("stateChanged",this.state))}},{key:"resetBackoff",value:function(){wb.log.trace("resetBackoff"),this.retrier.stop()}},{key:"modifyBackoff",value:function(e){wb.log.trace("modifyBackoff",e);var t=e?e.backoff_policy:null;t&&"number"==typeof t.reconnect_min_ms&&this.retrier.modifyBackoff(t.reconnect_min_ms)}},{key:"startDisconnectTimer",value:function(){var e=this;wb.log.trace("startDisconnectTimer"),this.disconnectingTimer&&(clearTimeout(this.disconnectingTimer),this.disconnectingTimer=null),this.disconnectingTimer=setTimeout((function(){wb.log.debug("disconnecting is timed out"),e.closeSocket(!0)}),3e3)}},{key:"cancelDisconnectTimer",value:function(){wb.log.trace("cancelDisconnectTimer"),this.disconnectingTimer&&(clearTimeout(this.disconnectingTimer),this.disconnectingTimer=null)}},{key:"isConnected",get:function(){return"connected"===this.state&&this.websocket.isConnected}},{key:"state",get:function(){switch(this.fsm.state){case"connecting":case"initialising":case"retrying":case"error":return"connecting";case"updating":case"connected":return"connected";case"rejected":return"rejected";case"disconnecting":case"waitSocketClosed":case"waitOffloadSocketClosed":return"disconnecting";case"disconnected":default:return"disconnected"}}},{key:"initRetry",value:function(){wb.log.debug("initRetry"),this.retrier.inProgress?this.retrier.attemptFailed():this.retrier.start()}},{key:"retry",value:function(){"connecting"!=this.fsm.state?(wb.log.trace("retry"),this.websocket.close(),this.fsm.userRetry()):wb.log.trace("can\t retry as already connecting")}},{key:"onConnected",value:function(){this.emit("connected")}},{key:"finalizeSocket",value:function(){wb.log.trace("finalizeSocket"),this.websocket.close(),this.emit("disconnected"),this.disconnectedPromiseResolve&&(this.disconnectedPromiseResolve(),this.disconnectedPromiseResolve=null)}},{key:"setupSocket",value:function(){wb.log.trace("setupSocket:",this.config.token),this.emit("beforeConnect"),this.websocket.connect()}},{key:"onIncomingMessage",value:function(e){var t=_b.Parser.parse(e),n=t.method,r=t.header,i=t.payload;if("reply"!==n&&this.confirmReceiving(r),"notification"===n)this.emit("message",r.message_type,i);else if("reply"===r.method)this.transport.processReply({id:r.id,status:r.status,header:r,body:i});else if("client_update"===r.method)"token_about_to_expire"===r.client_update_type&&this.emit("tokenAboutToExpire");else if("close"===r.method)if(308===r.status.code)wb.log.debug("Connection has been offloaded"),this.fsm.receiveOffload({status:r.status.status,body:i});else if(406===r.status.code){var a="Server closed connection because can't parse protocol: ".concat(JSON.stringify(r.status));this.emitReplyConnectionError(a,r,!0),wb.log.error(a),this.fsm.receiveFatalClose()}else 417===r.status.code?(wb.log.error("Server closed connection because can't parse client reply: ".concat(JSON.stringify(r.status))),this.fsm.receiveFatalClose(r.status.status)):410===r.status.code?(wb.log.warn("Server closed connection: ".concat(JSON.stringify(r.status))),this.fsm.receiveClose(r.status.status),this.emit("tokenExpired")):401===r.status.code?(wb.log.error("Server closed connection: ".concat(JSON.stringify(r.status))),this.fsm.receiveClose(r.status.status)):(wb.log.warn("unexpected message: ",r.status),this.fsm.receiveOffload({status:r.status.status,body:null}))}},{key:"sendInit",value:(n=da(Za.mark((function e(){var t,n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return wb.log.trace("sendInit"),e.prev=1,this.emit("beforeSendInit"),e.next=5,this.transport.sendInit();case 5:t=e.sent,this.config.updateContinuationToken(t.continuationToken),this.config.confirmedCapabilities=t.confirmedCapabilities,this.fsm.initSuccess(t),this.emit("initialized",t),this.emit("tokenUpdated"),e.next=17;break;case 13:e.prev=13,e.t0=e.catch(1),e.t0 instanceof Sb.TwilsockReplyError?(n=!1,wb.log.warn("Init rejected by server: ".concat(JSON.stringify(e.t0.reply.status))),this.emit("sendInitFailed"),401===e.t0.reply.status.code||403===e.t0.reply.status.code?(n=!0,this.fsm.tokenRejected(e.t0.reply.status),e.t0.reply.status.errorCode===this.tokenExpiredSasCode&&this.emit("tokenExpired")):429===e.t0.reply.status.code?(this.modifyBackoff(e.t0.reply.body),this.fsm.initError(!0)):500===e.t0.reply.status.code?this.fsm.initError(!1):this.fsm.initError(!0),this.emitReplyConnectionError(e.t0.message,e.t0.reply,n)):(this.terminationReason=e.t0.message,this.emit("connectionError",{terminal:!0,message:"Unknown error during connection initialisation: ".concat(e.t0.message,"\n").concat(JSON.stringify(e.t0,null,2)),httpStatusCode:null,errorCode:null}),this.fsm.initError(!0)),this.emit("tokenUpdated",e.t0);case 17:case"end":return e.stop()}}),e,this,[[1,13]])}))),function(){return n.apply(this,arguments)})},{key:"sendUpdate",value:(t=da(Za.mark((function e(){var t,n,r;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return wb.log.trace("sendUpdate"),t=new xb.Update(this.config.token),e.prev=2,e.next=5,this.transport.sendWithReply(t);case 5:n=e.sent,this.fsm.updateSuccess(n.body),this.emit("tokenUpdated"),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(2),e.t0 instanceof Sb.TwilsockReplyError?(r=!1,wb.log.warn("Token update rejected by server: ".concat(JSON.stringify(e.t0.reply.status))),401===e.t0.reply.status.code||403===e.t0.reply.status.code?(r=!0,this.fsm.tokenRejected(e.t0.reply.status),e.t0.reply.status.errorCode===this.tokenExpiredSasCode&&this.emit("tokenExpired")):429===e.t0.reply.status.code?(this.modifyBackoff(e.t0.reply.body),this.fsm.updateError(e.t0.reply.status)):this.fsm.updateError(e.t0.reply.status),this.emitReplyConnectionError(e.t0.message,e.t0.reply,r)):(this.emit("error",!1,e.t0.message,null,null),this.fsm.updateError(e.t0)),this.emit("tokenUpdated",e.t0);case 14:case"end":return e.stop()}}),e,this,[[2,10]])}))),function(){return t.apply(this,arguments)})},{key:"emitReplyConnectionError",value:function(e,t,n){var r=t.status&&t.status.description?t.status.description:e,i=t.status.code,a=t.status&&t.status.errorCode?t.status.errorCode:null;n&&(this.terminationReason=r),this.emit("connectionError",{terminal:n,message:"Connection error: ".concat(r),httpStatusCode:i,errorCode:a})}},{key:"cancelInit",value:function(){wb.log.trace("cancelInit")}},{key:"cancelUpdate",value:function(){wb.log.trace("cancelUpdate")}},{key:"confirmReceiving",value:function(e){wb.log.trace("confirmReceiving");try{this.transport.send(new xb.Reply(e.id))}catch(e){wb.log.debug("failed to confirm packet receiving",e)}}},{key:"closeSocket",value:function(e){var t=this;wb.log.trace("closeSocket (graceful: ".concat(e,")")),e&&this.transport.isConnected&&this.transport.sendClose(),this.websocket.close(),setTimeout((function(){return t.fsm.socketClosed()}),0)}},{key:"connect",value:function(){wb.log.trace("connect"),this.fsm.userConnect()}},{key:"disconnect",value:function(){var e=this;return wb.log.trace("disconnect"),this.fsm.is("disconnected")?Promise.resolve():new Promise((function(t){e.disconnectedPromiseResolve=t,e.fsm.userDisconnect()}))}},{key:"updateToken",value:function(e){var t=this;return wb.log.trace("updateToken:",e),new Promise((function(e,n){t.once("tokenUpdated",(function(t){t?n(t):e()})),t.fsm.userUpdateToken()}))}},{key:"isTerminalState",get:function(){return-1!==this.terminalStates.indexOf(this.fsm.state)}},{key:"getTerminationReason",get:function(){return this.terminationReason}},{key:"onCloseReceived",value:function(e){this.websocket.close()}}]),i}(bb.EventEmitter);qm.TwilsockChannel=Eb,qm.TwilsockImpl=Eb;var Ib={},Rb={},Cb={exports:{}};!function(e,n){(function(){var r={function:!0,object:!0}["undefined"==typeof window?"undefined":ga(window)]&&window||this,i=n,a=e&&!e.nodeType&&e,o=i&&a&&"object"==ga(t)&&t;!o||o.global!==o&&o.window!==o&&o.self!==o||(r=o);var s=Math.pow(2,53)-1,u=/\bOpera/,c=Object.prototype,l=c.hasOwnProperty,f=c.toString;function d(e){return(e=String(e)).charAt(0).toUpperCase()+e.slice(1)}function h(e){return e=g(e),/^(?:webOS|i(?:OS|P))/.test(e)?e:d(e)}function p(e,t){for(var n in e)l.call(e,n)&&t(e[n],n,e)}function v(e){return null==e?d(e):f.call(e).slice(8,-1)}function y(e){return String(e).replace(/([ -])(?!$)/g,"$1?")}function m(e,t){var n=null;return function(e,t){var n=-1,r=e?e.length:0;if("number"==typeof r&&r>-1&&r<=s)for(;++n<r;)t(e[n],n,e);else p(e,t)}(e,(function(r,i){n=t(n,r,i,e)})),n}function g(e){return String(e).replace(/^ +| +$/g,"")}var b=function e(t){var n=r,i=t&&"object"==ga(t)&&"String"!=v(t);i&&(n=t,t=null);var a=n.navigator||{},o=a.userAgent||"";t||(t=o);var s,c,l=i?!!a.likeChrome:/\bChrome\b/.test(t)&&!/internal|\n/i.test(f.toString()),d="Object",b=i?d:"ScriptBridgingProxyObject",k=i?d:"Environment",w=i&&n.java?"JavaPackage":v(n.java),x=i?d:"RuntimeObject",_=/\bJava/.test(w)&&n.java,S=_&&v(n.environment)==k,T=_?"a":"α",E=_?"b":"β",I=n.document||{},R=n.operamini||n.opera,C=u.test(C=i&&R?R["[[Class]]"]:v(R))?C:R=null,P=t,O=[],M=null,A=t==o,D=A&&R&&"function"==typeof R.version&&R.version(),j=m([{label:"EdgeHTML",pattern:"Edge"},"Trident",{label:"WebKit",pattern:"AppleWebKit"},"iCab","Presto","NetFront","Tasman","KHTML","Gecko"],(function(e,n){return e||RegExp("\\b"+(n.pattern||y(n))+"\\b","i").exec(t)&&(n.label||n)})),N=function(e){return m(e,(function(e,n){return e||RegExp("\\b"+(n.pattern||y(n))+"\\b","i").exec(t)&&(n.label||n)}))}(["Adobe AIR","Arora","Avant Browser","Breach","Camino","Electron","Epiphany","Fennec","Flock","Galeon","GreenBrowser","iCab","Iceweasel","K-Meleon","Konqueror","Lunascape","Maxthon",{label:"Microsoft Edge",pattern:"(?:Edge|Edg|EdgA|EdgiOS)"},"Midori","Nook Browser","PaleMoon","PhantomJS","Raven","Rekonq","RockMelt",{label:"Samsung Internet",pattern:"SamsungBrowser"},"SeaMonkey",{label:"Silk",pattern:"(?:Cloud9|Silk-Accelerated)"},"Sleipnir","SlimBrowser",{label:"SRWare Iron",pattern:"Iron"},"Sunrise","Swiftfox","Vivaldi","Waterfox","WebPositive",{label:"Yandex Browser",pattern:"YaBrowser"},{label:"UC Browser",pattern:"UCBrowser"},"Opera Mini",{label:"Opera Mini",pattern:"OPiOS"},"Opera",{label:"Opera",pattern:"OPR"},"Chromium","Chrome",{label:"Chrome",pattern:"(?:HeadlessChrome)"},{label:"Chrome Mobile",pattern:"(?:CriOS|CrMo)"},{label:"Firefox",pattern:"(?:Firefox|Minefield)"},{label:"Firefox for iOS",pattern:"FxiOS"},{label:"IE",pattern:"IEMobile"},{label:"IE",pattern:"MSIE"},"Safari"]),L=B([{label:"BlackBerry",pattern:"BB10"},"BlackBerry",{label:"Galaxy S",pattern:"GT-I9000"},{label:"Galaxy S2",pattern:"GT-I9100"},{label:"Galaxy S3",pattern:"GT-I9300"},{label:"Galaxy S4",pattern:"GT-I9500"},{label:"Galaxy S5",pattern:"SM-G900"},{label:"Galaxy S6",pattern:"SM-G920"},{label:"Galaxy S6 Edge",pattern:"SM-G925"},{label:"Galaxy S7",pattern:"SM-G930"},{label:"Galaxy S7 Edge",pattern:"SM-G935"},"Google TV","Lumia","iPad","iPod","iPhone","Kindle",{label:"Kindle Fire",pattern:"(?:Cloud9|Silk-Accelerated)"},"Nexus","Nook","PlayBook","PlayStation Vita","PlayStation","TouchPad","Transformer",{label:"Wii U",pattern:"WiiU"},"Wii","Xbox One",{label:"Xbox 360",pattern:"Xbox"},"Xoom"]),U=function(e){return m(e,(function(e,n,r){return e||(n[L]||n[/^[a-z]+(?: +[a-z]+\b)*/i.exec(L)]||RegExp("\\b"+y(r)+"(?:\\b|\\w*\\d)","i").exec(t))&&r}))}({Apple:{iPad:1,iPhone:1,iPod:1},Alcatel:{},Archos:{},Amazon:{Kindle:1,"Kindle Fire":1},Asus:{Transformer:1},"Barnes & Noble":{Nook:1},BlackBerry:{PlayBook:1},Google:{"Google TV":1,Nexus:1},HP:{TouchPad:1},HTC:{},Huawei:{},Lenovo:{},LG:{},Microsoft:{Xbox:1,"Xbox One":1},Motorola:{Xoom:1},Nintendo:{"Wii U":1,Wii:1},Nokia:{Lumia:1},Oppo:{},Samsung:{"Galaxy S":1,"Galaxy S2":1,"Galaxy S3":1,"Galaxy S4":1},Sony:{PlayStation:1,"PlayStation Vita":1},Xiaomi:{Mi:1,Redmi:1}}),F=function(e){return m(e,(function(e,n){var r=n.pattern||y(n);return!e&&(e=RegExp("\\b"+r+"(?:/[\\d.]+|[ \\w.]*)","i").exec(t))&&(e=function(e,t,n){var r={"10.0":"10",6.4:"10 Technical Preview",6.3:"8.1",6.2:"8",6.1:"Server 2008 R2 / 7","6.0":"Server 2008 / Vista",5.2:"Server 2003 / XP 64-bit",5.1:"XP",5.01:"2000 SP1","5.0":"2000","4.0":"NT","4.90":"ME"};return t&&n&&/^Win/i.test(e)&&!/^Windows Phone /i.test(e)&&(r=r[/[\d.]+$/.exec(e)])&&(e="Windows "+r),e=String(e),t&&n&&(e=e.replace(RegExp(t,"i"),n)),h(e.replace(/ ce$/i," CE").replace(/\bhpw/i,"web").replace(/\bMacintosh\b/,"Mac OS").replace(/_PowerPC\b/i," OS").replace(/\b(OS X) [^ \d]+/i,"$1").replace(/\bMac (OS X)\b/,"$1").replace(/\/(\d)/," $1").replace(/_/g,".").replace(/(?: BePC|[ .]*fc[ \d.]+)$/i,"").replace(/\bx86\.64\b/gi,"x86_64").replace(/\b(Windows Phone) OS\b/,"$1").replace(/\b(Chrome OS \w+) [\d.]+\b/,"$1").split(" on ")[0])}(e,r,n.label||n)),e}))}(["Windows Phone","KaiOS","Android","CentOS",{label:"Chrome OS",pattern:"CrOS"},"Debian",{label:"DragonFly BSD",pattern:"DragonFly"},"Fedora","FreeBSD","Gentoo","Haiku","Kubuntu","Linux Mint","OpenBSD","Red Hat","SuSE","Ubuntu","Xubuntu","Cygwin","Symbian OS","hpwOS","webOS ","webOS","Tablet OS","Tizen","Linux","Mac OS X","Macintosh","Mac","Windows 98;","Windows "]);function B(e){return m(e,(function(e,n){var r=n.pattern||y(n);return!e&&(e=RegExp("\\b"+r+" *\\d+[.\\w_]*","i").exec(t)||RegExp("\\b"+r+" *\\w+-[\\w]*","i").exec(t)||RegExp("\\b"+r+"(?:; *(?:[a-z]+[_-])?[a-z]+\\d+|[^ ();-]*)","i").exec(t))&&((e=String(n.label&&!RegExp(r,"i").test(n.label)?n.label:e).split("/"))[1]&&!/[\d.]+/.test(e[0])&&(e[0]+=" "+e[1]),n=n.label||n,e=h(e[0].replace(RegExp(r,"i"),n).replace(RegExp("; *(?:"+n+"[_-])?","i")," ").replace(RegExp("("+n+")[-_.]?(\\w)","i"),"$1 $2"))),e}))}function q(e){return m(e,(function(e,n){return e||(RegExp(n+"(?:-[\\d.]+/|(?: for [\\w-]+)?[ /-])([\\d.]+[^ ();/_-]*)","i").exec(t)||0)[1]||null}))}if(j&&(j=[j]),/\bAndroid\b/.test(F)&&!L&&(s=/\bAndroid[^;]*;(.*?)(?:Build|\) AppleWebKit)\b/i.exec(t))&&(L=g(s[1]).replace(/^[a-z]{2}-[a-z]{2};\s*/i,"")||null),U&&!L?L=B([U]):U&&L&&(L=L.replace(RegExp("^("+y(U)+")[-_.\\s]","i"),U+" ").replace(RegExp("^("+y(U)+")[-_.]?(\\w)","i"),U+" $2")),(s=/\bGoogle TV\b/.exec(L))&&(L=s[0]),/\bSimulator\b/i.test(t)&&(L=(L?L+" ":"")+"Simulator"),"Opera Mini"==N&&/\bOPiOS\b/.test(t)&&O.push("running in Turbo/Uncompressed mode"),"IE"==N&&/\blike iPhone OS\b/.test(t)?(U=(s=e(t.replace(/like iPhone OS/,""))).manufacturer,L=s.product):/^iP/.test(L)?(N||(N="Safari"),F="iOS"+((s=/ OS ([\d_]+)/i.exec(t))?" "+s[1].replace(/_/g,"."):"")):"Konqueror"==N&&/^Linux\b/i.test(F)?F="Kubuntu":U&&"Google"!=U&&(/Chrome/.test(N)&&!/\bMobile Safari\b/i.test(t)||/\bVita\b/.test(L))||/\bAndroid\b/.test(F)&&/^Chrome/.test(N)&&/\bVersion\//i.test(t)?(N="Android Browser",F=/\bAndroid\b/.test(F)?F:"Android"):"Silk"==N?(/\bMobi/i.test(t)||(F="Android",O.unshift("desktop mode")),/Accelerated *= *true/i.test(t)&&O.unshift("accelerated")):"UC Browser"==N&&/\bUCWEB\b/.test(t)?O.push("speed mode"):"PaleMoon"==N&&(s=/\bFirefox\/([\d.]+)\b/.exec(t))?O.push("identifying as Firefox "+s[1]):"Firefox"==N&&(s=/\b(Mobile|Tablet|TV)\b/i.exec(t))?(F||(F="Firefox OS"),L||(L=s[1])):!N||(s=!/\bMinefield\b/i.test(t)&&/\b(?:Firefox|Safari)\b/.exec(N))?(N&&!L&&/[\/,]|^[^(]+?\)/.test(t.slice(t.indexOf(s+"/")+8))&&(N=null),(s=L||U||F)&&(L||U||/\b(?:Android|Symbian OS|Tablet OS|webOS)\b/.test(F))&&(N=/[a-z]+(?: Hat)?/i.exec(/\bAndroid\b/.test(F)?F:s)+" Browser")):"Electron"==N&&(s=(/\bChrome\/([\d.]+)\b/.exec(t)||0)[1])&&O.push("Chromium "+s),D||(D=q(["(?:Cloud9|CriOS|CrMo|Edge|Edg|EdgA|EdgiOS|FxiOS|HeadlessChrome|IEMobile|Iron|Opera ?Mini|OPiOS|OPR|Raven|SamsungBrowser|Silk(?!/[\\d.]+$)|UCBrowser|YaBrowser)","Version",y(N),"(?:Firefox|Minefield|NetFront)"])),(s=("iCab"==j&&parseFloat(D)>3?"WebKit":/\bOpera\b/.test(N)&&(/\bOPR\b/.test(t)?"Blink":"Presto"))||/\b(?:Midori|Nook|Safari)\b/i.test(t)&&!/^(?:Trident|EdgeHTML)$/.test(j)&&"WebKit"||!j&&/\bMSIE\b/i.test(t)&&("Mac OS"==F?"Tasman":"Trident")||"WebKit"==j&&/\bPlayStation\b(?! Vita\b)/i.test(N)&&"NetFront")&&(j=[s]),"IE"==N&&(s=(/; *(?:XBLWP|ZuneWP)(\d+)/i.exec(t)||0)[1])?(N+=" Mobile",F="Windows Phone "+(/\+$/.test(s)?s:s+".x"),O.unshift("desktop mode")):/\bWPDesktop\b/i.test(t)?(N="IE Mobile",F="Windows Phone 8.x",O.unshift("desktop mode"),D||(D=(/\brv:([\d.]+)/.exec(t)||0)[1])):"IE"!=N&&"Trident"==j&&(s=/\brv:([\d.]+)/.exec(t))&&(N&&O.push("identifying as "+N+(D?" "+D:"")),N="IE",D=s[1]),A){if(function(e,t){var n=null!=e?ga(e[t]):"number";return!(/^(?:boolean|number|string|undefined)$/.test(n)||"object"==n&&!e[t])}(n,"global"))if(_&&(P=(s=_.lang.System).getProperty("os.arch"),F=F||s.getProperty("os.name")+" "+s.getProperty("os.version")),S){try{D=n.require("ringo/engine").version.join("."),N="RingoJS"}catch(e){(s=n.system)&&s.global.system==n.system&&(N="Narwhal",F||(F=s[0].os||null))}N||(N="Rhino")}else"object"==ga(n.process)&&!n.process.browser&&(s=n.process)&&("object"==ga(s.versions)&&("string"==typeof s.versions.electron?(O.push("Node "+s.versions.node),N="Electron",D=s.versions.electron):"string"==typeof s.versions.nw&&(O.push("Chromium "+D,"Node "+s.versions.node),N="NW.js",D=s.versions.nw)),N||(N="Node.js",P=s.arch,F=s.platform,D=(D=/[\d.]+/.exec(s.version))?D[0]:null));else v(s=n.runtime)==b?(N="Adobe AIR",F=s.flash.system.Capabilities.os):v(s=n.phantom)==x?(N="PhantomJS",D=(s=s.version||null)&&s.major+"."+s.minor+"."+s.patch):"number"==typeof I.documentMode&&(s=/\bTrident\/(\d+)/i.exec(t))?(D=[D,I.documentMode],(s=+s[1]+4)!=D[1]&&(O.push("IE "+D[1]+" mode"),j&&(j[1]=""),D[1]=s),D="IE"==N?String(D[1].toFixed(1)):D[0]):"number"==typeof I.documentMode&&/^(?:Chrome|Firefox)\b/.test(N)&&(O.push("masking as "+N+" "+D),N="IE",D="11.0",j=["Trident"],F="Windows");F=F&&h(F)}if(D&&(s=/(?:[ab]|dp|pre|[ab]\d+pre)(?:\d+\+?)?$/i.exec(D)||/(?:alpha|beta)(?: ?\d)?/i.exec(t+";"+(A&&a.appMinorVersion))||/\bMinefield\b/i.test(t)&&"a")&&(M=/b/i.test(s)?"beta":"alpha",D=D.replace(RegExp(s+"\\+?$"),"")+("beta"==M?E:T)+(/\d+\+?/.exec(s)||"")),"Fennec"==N||"Firefox"==N&&/\b(?:Android|Firefox OS|KaiOS)\b/.test(F))N="Firefox Mobile";else if("Maxthon"==N&&D)D=D.replace(/\.[\d.]+/,".x");else if(/\bXbox\b/i.test(L))"Xbox 360"==L&&(F=null),"Xbox 360"==L&&/\bIEMobile\b/.test(t)&&O.unshift("mobile mode");else if(!/^(?:Chrome|IE|Opera)$/.test(N)&&(!N||L||/Browser|Mobi/.test(N))||"Windows CE"!=F&&!/Mobi/i.test(t))if("IE"==N&&A)try{null===n.external&&O.unshift("platform preview")}catch(e){O.unshift("embedded")}else(/\bBlackBerry\b/.test(L)||/\bBB10\b/.test(t))&&(s=(RegExp(L.replace(/ +/g," *")+"/([.\\d]+)","i").exec(t)||0)[1]||D)?(F=((s=[s,/BB10/.test(t)])[1]?(L=null,U="BlackBerry"):"Device Software")+" "+s[0],D=null):this!=p&&"Wii"!=L&&(A&&R||/Opera/.test(N)&&/\b(?:MSIE|Firefox)\b/i.test(t)||"Firefox"==N&&/\bOS X (?:\d+\.){2,}/.test(F)||"IE"==N&&(F&&!/^Win/.test(F)&&D>5.5||/\bWindows XP\b/.test(F)&&D>8||8==D&&!/\bTrident\b/.test(t)))&&!u.test(s=e.call(p,t.replace(u,"")+";"))&&s.name&&(s="ing as "+s.name+((s=s.version)?" "+s:""),u.test(N)?(/\bIE\b/.test(s)&&"Mac OS"==F&&(F=null),s="identify"+s):(s="mask"+s,N=C?h(C.replace(/([a-z])([A-Z])/g,"$1 $2")):"Opera",/\bIE\b/.test(s)&&(F=null),A||(D=null)),j=["Presto"],O.push(s));else N+=" Mobile";(s=(/\bAppleWebKit\/([\d.]+\+?)/i.exec(t)||0)[1])&&(s=[parseFloat(s.replace(/\.(\d)$/,".0$1")),s],"Safari"==N&&"+"==s[1].slice(-1)?(N="WebKit Nightly",M="alpha",D=s[1].slice(0,-1)):D!=s[1]&&D!=(s[2]=(/\bSafari\/([\d.]+\+?)/i.exec(t)||0)[1])||(D=null),s[1]=(/\b(?:Headless)?Chrome\/([\d.]+)/i.exec(t)||0)[1],537.36==s[0]&&537.36==s[2]&&parseFloat(s[1])>=28&&"WebKit"==j&&(j=["Blink"]),A&&(l||s[1])?(j&&(j[1]="like Chrome"),s=s[1]||((s=s[0])<530?1:s<532?2:s<532.05?3:s<533?4:s<534.03?5:s<534.07?6:s<534.1?7:s<534.13?8:s<534.16?9:s<534.24?10:s<534.3?11:s<535.01?12:s<535.02?"13+":s<535.07?15:s<535.11?16:s<535.19?17:s<536.05?18:s<536.1?19:s<537.01?20:s<537.11?"21+":s<537.13?23:s<537.18?24:s<537.24?25:s<537.36?26:"Blink"!=j?"27":"28")):(j&&(j[1]="like Safari"),s=(s=s[0])<400?1:s<500?2:s<526?3:s<533?4:s<534?"4+":s<535?5:s<537?6:s<538?7:s<601?8:s<602?9:s<604?10:s<606?11:s<608?12:"12"),j&&(j[1]+=" "+(s+="number"==typeof s?".x":/[.+]/.test(s)?"":"+")),"Safari"==N&&(!D||parseInt(D)>45)?D=s:"Chrome"==N&&/\bHeadlessChrome/i.test(t)&&O.unshift("headless")),"Opera"==N&&(s=/\bzbov|zvav$/.exec(F))?(N+=" ",O.unshift("desktop mode"),"zvav"==s?(N+="Mini",D=null):N+="Mobile",F=F.replace(RegExp(" *"+s+"$"),"")):"Safari"==N&&/\bChrome\b/.exec(j&&j[1])?(O.unshift("desktop mode"),N="Chrome Mobile",D=null,/\bOS X\b/.test(F)?(U="Apple",F="iOS 4.3+"):F=null):/\bSRWare Iron\b/.test(N)&&!D&&(D=q("Chrome")),D&&0==D.indexOf(s=/[\d.]+$/.exec(F))&&t.indexOf("/"+s+"-")>-1&&(F=g(F.replace(s,""))),F&&-1!=F.indexOf(N)&&!RegExp(N+" OS").test(F)&&(F=F.replace(RegExp(" *"+y(N)+" *"),"")),j&&!/\b(?:Avant|Nook)\b/.test(N)&&(/Browser|Lunascape|Maxthon/.test(N)||"Safari"!=N&&/^iOS/.test(F)&&/\bSafari\b/.test(j[1])||/^(?:Adobe|Arora|Breach|Midori|Opera|Phantom|Rekonq|Rock|Samsung Internet|Sleipnir|SRWare Iron|Vivaldi|Web)/.test(N)&&j[1])&&(s=j[j.length-1])&&O.push(s),O.length&&(O=["("+O.join("; ")+")"]),U&&L&&L.indexOf(U)<0&&O.push("on "+U),L&&O.push((/^on /.test(O[O.length-1])?"":"on ")+L),F&&(s=/ ([\d.+]+)$/.exec(F),c=s&&"/"==F.charAt(F.length-s[0].length-1),F={architecture:32,family:s&&!c?F.replace(s[0],""):F,version:s?s[1]:null,toString:function(){var e=this.version;return this.family+(e&&!c?" "+e:"")+(64==this.architecture?" 64-bit":"")}}),(s=/\b(?:AMD|IA|Win|WOW|x86_|x)64\b/i.exec(P))&&!/\bi686\b/i.test(P)?(F&&(F.architecture=64,F.family=F.family.replace(RegExp(" *"+s),"")),N&&(/\bWOW64\b/i.test(t)||A&&/\w(?:86|32)$/.test(a.cpuClass||a.platform)&&!/\bWin64; x64\b/i.test(t))&&O.unshift("32-bit")):F&&/^OS X/.test(F.family)&&"Chrome"==N&&parseFloat(D)>=39&&(F.architecture=64),t||(t=null);var W={};return W.description=t,W.layout=j&&j[0],W.manufacturer=U,W.name=N,W.prerelease=M,W.product=L,W.ua=t,W.version=N&&D,W.os=F||{architecture:null,family:null,version:null,toString:function(){return"null"}},W.parse=e,W.toString=function(){return this.description||""},W.version&&O.unshift(D),W.name&&O.unshift(N),F&&N&&(F!=String(F).split(" ")[0]||F!=N.split(" ")[0]&&!L)&&O.push(L?"("+F+")":"on "+F),O.length&&(W.description=O.join(" ")),W}();i&&a?p(b,(function(e,t){i[t]=e})):r.platform=b}).call(t)}(Cb,Cb.exports);var Pb=Cb.exports,Ob=Object.freeze(Object.assign(Object.create(null),Cb.exports,{default:Pb}));Object.defineProperty(Rb,"__esModule",{value:!0});var Mb=Cb.exports,Ab=function(){function e(){xa(this,e)}return pa(e,null,[{key:"getMetadata",value:function(e){"undefined"!=typeof navigator&&Mb.parse(navigator.userAgent);var t=e&&e.clientMetadata?e.clientMetadata:{},n={env:Mb.name,envv:Mb.version,os:Mb.os.family,osv:Mb.os.version,osa:Mb.os.architecture,sdk:"js-default"},r={};return["ver","env","envv","os","osv","osa","type","sdk","sdkv","dev","devv","devt","app","appv"].filter((function(e){return e in t||e in n})).forEach((function(e){return r[e]=e in t?t[e]:n[e]})),r}}]),e}();Rb.Metadata=Ab,Object.defineProperty(Ib,"__esModule",{value:!0});var Db=Am,jb=fg,Nb=Zg,Lb=$g,Ub=Wg,Fb=zm,Bb=Rb;Ib.PacketResponse=function e(){xa(this,e)};var qb=function(){function e(t,n){var r=this;xa(this,e),this.config=n,this.activeRequests=new Map,this.channel=t,this.channel.on("reply",(function(e){return r.processReply(e)})),this.channel.on("disconnected",(function(){r.activeRequests.forEach((function(e){clearTimeout(e.timeout),e.reject(new Nb.TwilsockError("disconnected"))})),r.activeRequests.clear()}))}var t;return pa(e,[{key:"isConnected",get:function(){return this.channel.isConnected}},{key:"processReply",value:function(e){var t,n=this.activeRequests.get(e.id);n&&(clearTimeout(n.timeout),this.activeRequests.delete(e.id),(t=e.status.code)>=200&&t<300?n.resolve(e):(n.reject(new Lb.TwilsockReplyError("Transport failure: "+e.status.status,e)),Db.log.trace("message rejected")))}},{key:"storeRequest",value:function(e,t,n){var r={resolve:t,reject:n,timeout:setTimeout((function(){Db.log.trace("request",e,"is timed out"),n(new Nb.TwilsockError("Twilsock: request timeout: "+e))}),3e4)};this.activeRequests.set(e,r)}},{key:"shutdown",value:function(){this.activeRequests.forEach((function(e){clearTimeout(e.timeout),e.reject(new Nb.TwilsockError("Twilsock: request cancelled by user"))})),this.activeRequests.clear()}},{key:"sendInit",value:(t=da(Za.mark((function e(){var t,n,r;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Db.log.trace("sendInit"),t=Bb.Metadata.getMetadata(this.config),n=new Fb.Init(this.config.token,this.config.continuationToken,t,this.config.initRegistrations,this.config.tweaks),e.next=5,this.sendWithReply(n);case 5:return r=e.sent,e.abrupt("return",new Fb.InitReply(r.id,r.header.continuation_token,r.header.continuation_token_status,r.header.offline_storage,r.header.init_registrations,r.header.debug_info,new Set(r.header.capabilities)));case 7:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"sendClose",value:function(){var e=new Fb.Close;this.send(e)}},{key:"sendWithReply",value:function(e,t){var n=this;return new Promise((function(r,i){var a=n.send(e,t);n.storeRequest(a,r,i)}))}},{key:"send",value:function(e,t){e.id=e.id||"TM".concat(jb.v4());var n=Ub.Parser.createPacket(e,function(e){switch(ga(e)){case"undefined":return"";case"object":return JSON.stringify(e);default:return e}}(t));try{return this.channel.send(n),e.id}catch(t){throw Db.log.debug("failed to send ",e,t),Db.log.trace(t.stack),t}}}]),e}();Ib.PacketInterface=qb;var Wb={},zb=n(Object.freeze({__proto__:null,default:{}}));function Gb(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(Wb,"__esModule",{value:!0});var Vb=Am,Hb=function(e){ma(r,e);var n=Gb(r);function r(e){var i;return xa(this,r),(i=n.call(this)).url=e,i.WebSocket=t.WebSocket||t.MozWebSocket||zb,i}return pa(r,[{key:"isConnected",get:function(){return this.socket&&1===this.socket.readyState}},{key:"connect",value:function(){var e,t=this;Vb.log.trace("connecting to socket");try{e=new this.WebSocket(this.url)}catch(e){return Vb.log.debug("Socket error: ".concat(this.url)),void this.emit("socketError",e)}e.binaryType="arraybuffer",e.onopen=function(){Vb.log.debug("socket opened ".concat(t.url)),t.emit("connected")},e.onclose=function(e){Vb.log.debug("socket closed",e),t.emit("disconnected",e)},e.onerror=function(e){Vb.log.debug("Socket error:",e),t.emit("socketError",e)},e.onmessage=function(e){t.emit("message",e.data)},this.socket=e}},{key:"send",value:function(e){this.socket.send(e)}},{key:"close",value:function(){if(Vb.log.trace("closing socket"),this.socket){this.socket.onopen=null,this.socket.onclose=null,this.socket.onerror=null,this.socket.onmessage=null;try{this.socket.close()}finally{}}}}]),r}(Mm.EventEmitter);Wb.WebSocketChannel=Hb;var Jb={};function Kb(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(Jb,"__esModule",{value:!0});var $b=Am,Qb=fg,Yb=Zg,Xb=function(e){ma(o,e);var t,n,r,i,a=Kb(o);function o(e){var t;return xa(this,o),(t=a.call(this)).transport=e,t.registrations=new Map,t.registrationsInProgress=new Map,t}return pa(o,[{key:"putNotificationContext",value:(i=da(Za.mark((function e(t,n){var r;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={method:"put_notification_ctx",notification_ctx_id:t},e.next=3,this.transport.sendWithReply(r,n);case 3:case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"deleteNotificationContext",value:(r=da(Za.mark((function e(t){var n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={method:"delete_notification_ctx",notification_ctx_id:t},e.next=3,this.transport.sendWithReply(n);case 3:case 4:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"updateRegistration",value:(n=da(Za.mark((function e(t,n){var r,i;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return $b.log.debug("update registration for context",t),(r=this.registrationsInProgress.get(t))||(r=new Set,this.registrationsInProgress.set(t,r)),i=Qb.v4(),r.add(i),e.prev=5,e.next=8,this.putNotificationContext(t,n);case 8:$b.log.debug("registration attempt succeeded for context",n),r.delete(i),0===r.size&&(this.registrationsInProgress.delete(t),this.emit("registered",t)),e.next=19;break;case 13:e.prev=13,e.t0=e.catch(5),$b.log.warn("registration attempt failed for context",n),$b.log.debug(e.t0),r.delete(i),0===r.size&&(this.registrationsInProgress.delete(t),this.emit("registrationFailed",t,e.t0));case 19:case"end":return e.stop()}}),e,this,[[5,13]])}))),function(e,t){return n.apply(this,arguments)})},{key:"updateRegistrations",value:function(){var e=this;$b.log.trace("refreshing ".concat(this.registrations.size," registrations")),this.registrations.forEach((function(t,n){e.updateRegistration(n,t)}))}},{key:"setNotificationsContext",value:function(e,t){if(!e||!t)throw new Yb.TwilsockError("Invalid arguments provided");this.registrations.set(e,t),this.transport.isConnected&&this.updateRegistration(e,t)}},{key:"removeNotificationsContext",value:(t=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.registrations.has(t)){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.deleteNotificationContext(t);case 4:this.transport.isConnected&&this.registrations.delete(t);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),o}(Mm.EventEmitter);Jb.Registrations=Xb;var Zb={},ek={};function tk(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(ek,"__esModule",{value:!0});var nk=function(e){ma(n,e);var t=tk(n);function n(e,r,i){var a;return xa(this,n),(a=t.call(this,r)).status=e,a.description=r,a.body=i,a}return n}(Zg.TwilsockError);ek.TwilsockUpstreamError=nk;var rk={};function ik(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(rk,"__esModule",{value:!0});var ak=function(e){ma(n,e);var t=ik(n);function n(e){return xa(this,n),t.call(this,e)}return n}(Zg.TwilsockError);rk.TransportUnavailableError=ak,Object.defineProperty(Zb,"__esModule",{value:!0});var ok=Am,sk=Zg,uk=ek,ck=zm,lk=rk;function fk(e,t){var n=function(e){var t=e.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)(\/[^?#]*)(\?[^#]*|)(#.*|)$/);if(t){var n={protocol:t[1],host:t[2],hostname:t[3],port:t[4],pathname:t[5],search:t[6],hash:t[7],params:null};if(n.search.length>0){var r=n.search.substring(1);n.params=r.split("&").map((function(e){return e.split("=")})).reduce((function(e,t){return e.hasOwnProperty(t[0])?Array.isArray(e[t[0]])?e[t[0]].push(t[1]):e[t[0]]=[e[t[0]],t[1]]:e[t[0]]=t[1],e}),{})}return n}throw new sk.TwilsockError("Incorrect URI: "+e)}(t),r={method:e,host:n.host,path:n.pathname};return n.params&&(r.params=n.params),r}function dk(e,t,n,r,i){return{to:fk(e,t),headers:n,body:r,grant:i}}var hk=function(){function e(t,n,r){xa(this,e),this.config=r,this.transport=t,this.pendingMessages=[],this.twilsock=n}var t;return pa(e,[{key:"saveMessage",value:function(e){var t=this;return new Promise((function(n,r){var i={message:e,resolve:n,reject:r,alreadyRejected:!1,timeout:setTimeout((function(){ok.log.debug("request is timed out"),r(new sk.TwilsockError("request '".concat(e.to.method,"' to '").concat(e.to.host,"' timed out"))),i.alreadyRejected=!0}),2e4)};t.pendingMessages.push(i)}))}},{key:"sendPendingMessages",value:function(){for(var e=this,t=function(){var t=e.pendingMessages[0];if(!t.alreadyRejected)try{var n=t.message;e.actualSend(n).then((function(e){return t.resolve(e)})).catch((function(e){return t.reject(e)})),clearTimeout(t.timeout)}catch(e){return ok.log.debug("Failed to send pending message",e),"break"}e.pendingMessages.splice(0,1)};this.pendingMessages.length;){if("break"===t())break}}},{key:"rejectPendingMessages",value:function(){var e=this;this.pendingMessages.forEach((function(t){t.reject(new lk.TransportUnavailableError("Unable to connect: "+e.twilsock.getTerminationReason)),clearTimeout(t.timeout)})),this.pendingMessages.splice(0,this.pendingMessages.length)}},{key:"actualSend",value:(t=da(Za.mark((function e(t){var n,r,i,a,o,s,u;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.to,r=t.headers,i=t.body,a=t.grant?t.grant:this.config.activeGrant,o={host:n.host,path:n.path,method:n.method,params:n.params,headers:r},s=new ck.Message(a,r["Content-Type"]||"application/json",o),e.next=8,this.transport.sendWithReply(s,i);case 8:if(u=e.sent,!((l=u)&&l.header&&l.header.http_status)||(c=u.header.http_status.code)>=200&&c<300){e.next=11;break}throw new uk.TwilsockUpstreamError(u.header.http_status.code,u.header.http_status.status,u.body);case 11:return e.abrupt("return",{status:u.header.http_status,headers:u.header.http_headers,body:u.body});case 12:case"end":return e.stop()}var c,l}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"send",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=arguments.length>3?arguments[3]:void 0,i=arguments.length>4?arguments[4]:void 0;if(this.twilsock.isTerminalState)return Promise.reject(new lk.TransportUnavailableError("Unable to connect: "+this.twilsock.getTerminationReason));var a=dk(e,t,n,r,i);return this.twilsock.isConnected?this.actualSend(a):this.saveMessage(a)}}]),e}();Zb.Upstream=hk;var pk={};Object.defineProperty(pk,"__esModule",{value:!0});var vk=function(){function e(){var t=this;xa(this,e),this._promise=new Promise((function(e,n){t._resolve=e,t._reject=n}))}return pa(e,[{key:"promise",get:function(){return this._promise}},{key:"update",value:function(e){this._resolve(e)}},{key:"set",value:function(e){this.current=e,this._resolve(e)}},{key:"fail",value:function(e){this._reject(e)}}]),e}();pk.Deferred=vk;var yk={};Object.defineProperty(yk,"__esModule",{value:!0});var mk=Zg,gk=function(){function e(t){xa(this,e),this.id=t}return pa(e,null,[{key:"create",value:function(t){if(t instanceof Object&&"storage_id"in t)return new e(t.storage_id);throw new mk.TwilsockError('Field "storage_id" is missing')}}]),e}();yk.OfflineProductStorage=gk;var bk={};Object.defineProperty(bk,"__esModule",{value:!0});var kk=function(){function e(){xa(this,e)}return pa(e,null,[{key:"sessionStorage",get:function(){try{return t.sessionStorage}catch(e){return null}}},{key:"window",get:function(){try{return t.window}catch(e){return null}}},{key:"storeToken",value:function(t,n){e.canStore&&e.sessionStorage.setItem(e.getKeyName(n),t)}},{key:"getStoredToken",value:function(t){return e.canStore?e.sessionStorage.getItem(e.getKeyName(t)):null}},{key:"initialize",value:function(){e.canStore&&(e.sessionStorage.getItem(e.initializedFlag)&&this.clear(),e.sessionStorage.setItem(e.initializedFlag,"true"),e.window.addEventListener("unload",(function(){e.sessionStorage.removeItem(e.initializedFlag)})))}},{key:"clear",value:function(){if(e.canStore){for(var t=[],n=0;n<e.sessionStorage.length;n++){var r=e.sessionStorage.key(n);0===r.indexOf(e.tokenStoragePrefix)&&t.push(r)}t.forEach((function(t){return e.sessionStorage.removeItem(t)})),e.sessionStorage.removeItem(e.initializedFlag)}}},{key:"getKeyName",value:function(t){return"".concat(e.tokenStoragePrefix).concat(t)}},{key:"canStore",get:function(){return e.sessionStorage&&e.window}}]),e}();bk.TokenStorage=kk,kk.initializedFlag="twilio_twilsock_token_storage",kk.tokenStoragePrefix="twilio_continuation_token_",kk.initialize();var wk={};Object.defineProperty(wk,"__esModule",{value:!0});var xk,_k=Og,Sk=Am,Tk=function(){function e(t,n,r,i,a,o){xa(this,e),this.title=t,this.details=n,this.start=r,this.type=a,this.id=o,this.end=i}return pa(e,[{key:"toTelemetryEvent",value:function(){var e=new Date,t=this.start,n=this.end?this.end:e;if(n<t){var r=n;n=t,t=r}var i=t.getTime()-e.getTime(),a=n.getTime()-e.getTime();return new _k.TelemetryEvent(i,a,this.title,this.details,this.id,this.type)}}]),e}(),Ek=wk.TelemetryEventDescription=Tk;!function(e){e[e.Start=0]="Start",e[e.End=1]="End"}(xk||(xk={}));var Ik,Rk=wk.TelemetryPoint=xk;!function(e){e[e.MinEventsPortion=0]="MinEventsPortion",e[e.AnyEvents=1]="AnyEvents",e[e.AnyEventsIncludingUnfinished=2]="AnyEventsIncludingUnfinished"}(Ik||(Ik={})),wk.EventSendingLimitation=Ik;var Ck=function(){function e(t,n){xa(this,e),this.minEventsPortionToSend=50,this.maxEventsPortionToSend=100,this.pendingEvents=new Map,this.readyEvents=[],this.hasInitializationFinished=!1,this._canSendTelemetry=!1,this.config=t,this.packetInterface=n}return pa(e,[{key:"isTelemetryEnabled",get:function(){return this.config.confirmedCapabilities.has("telemetry.v1")}},{key:"canSendTelemetry",get:function(){return this._canSendTelemetry&&this.isTelemetryEnabled},set:function(e){Sk.log.debug("TelemetryTracker.canSendTelemetry: ".concat(e," TelemetryTracker.isTelemetryEnabled: ").concat(this.isTelemetryEnabled)),this._canSendTelemetry&&!e&&(this.pendingEvents.clear(),this.readyEvents=[]),this._canSendTelemetry=e,e&&this.sendTelemetry(Ik.AnyEvents),e&&!this.hasInitializationFinished&&(this.hasInitializationFinished=!0)}},{key:"addTelemetryEvent",value:function(e){!this.canSendTelemetry&&this.hasInitializationFinished||this.readyEvents.push(e)}},{key:"addPartialEvent",value:function(e,t,n){Sk.log.debug("Adding ".concat(n===xk.Start?"starting":"ending"," timepoint for '").concat(t,"' event"));var r=this.pendingEvents.has(t);if(n===xk.Start)r&&Sk.log.debug("Overwriting starting point for '".concat(t,"' event")),this.pendingEvents.set(t,e);else{if(!r)return void Sk.log.info("Could not find started event for '".concat(t,"' event"));this.addTelemetryEvent(this.merge(this.pendingEvents.get(t),e)),this.pendingEvents.delete(t)}}},{key:"getTelemetryToSend",value:function(e){return this.canSendTelemetry&&0!=this.readyEvents.length?e==Ik.MinEventsPortion&&this.readyEvents.length<this.minEventsPortionToSend?[]:this.getTelemetryPortion(e==Ik.AnyEventsIncludingUnfinished):[]}},{key:"getTelemetryPortion",value:function(e){var t=this,n=Math.min(this.readyEvents.length,this.maxEventsPortionToSend),r=this.readyEvents.splice(0,n);return e&&r.length<this.maxEventsPortionToSend&&this.pendingEvents.forEach((function(e,n){if(!(r.length>=t.maxEventsPortionToSend)){var i=t.pendingEvents.get(n);t.pendingEvents.delete(n),r.push(new Tk("[UNFINISHED] ".concat(i.title),i.details,i.start,null,i.type,i.id))}})),r}},{key:"merge",value:function(e,t){return new Tk(t.title?t.title:e.title,t.details?t.details:e.details,e.start,t.end,t.type?t.type:e.type,t.id?t.id:e.id)}},{key:"sendTelemetryIfMinimalPortionCollected",value:function(){this.sendTelemetry(Ik.MinEventsPortion)}},{key:"sendTelemetry",value:function(e){var t=this.getTelemetryToSend(e);if(0!==t.length)try{this.packetInterface.send(new _k.Telemetry(t.map((function(e){return e.toTelemetryEvent()}))))}catch(e){Sk.log.debug("Error while sending ".concat(t.length," telemetry events due to ").concat(e,"; they will be resubmitted")),this.readyEvents=this.readyEvents.concat(t)}}}]),e}();function Pk(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}wk.TelemetryTracker=Ck,Object.defineProperty(Om,"__esModule",{value:!0});var Ok=Mm,Mk=Am,Ak=Um,Dk=qm,jk=Ib,Nk=Wb,Lk=Jb,Uk=Zb,Fk=pk,Bk=Zg,qk=yk,Wk=bk,zk=wk,Gk=function e(){xa(this,e)};Om.TelemetryEvents=Gk,Gk.TWILSOCK_CONNECT="twilsock.sdk.connect",Gk.TWILSOCK_INIT="twilsock.sdk.init";var Vk=function(e){ma(r,e);var t,n=Pk(r);function r(e,t){var i,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};xa(this,r),(i=n.call(this)).offlineStorageDeferred=new Fk.Deferred,a.continuationToken=a.continuationToken?a.continuationToken:Wk.TokenStorage.getStoredToken(t);var o=i.config=new Ak.Configuration(e,t,a);Mk.log.setLevel(o.logLevel);var s=new Nk.WebSocketChannel(o.url),u=a.transport?a.transport:new jk.PacketInterface(s,o);return i.channel=a.channel?a.channel:new Dk.TwilsockImpl(s,u,o),i.registrations=a.registrations?a.registrations:new Lk.Registrations(u),i.upstream=new Uk.Upstream(u,i.channel,o),i.telemetryTracker=new zk.TelemetryTracker(o,u),i.channel.on("initialized",(function(){return i.telemetryTracker.canSendTelemetry=!0})),s.on("disconnected",(function(){return i.telemetryTracker.canSendTelemetry=!1})),i.registrations.on("registered",(function(e){return i.emit("registered",e)})),i.channel.on("message",(function(e,t){return setTimeout((function(){return i.emit("message",e,t)}),0)})),i.channel.on("stateChanged",(function(e){return setTimeout((function(){return i.emit("stateChanged",e)}),0)})),i.channel.on("connectionError",(function(e){return setTimeout((function(){return i.emit("connectionError",e)}),0)})),i.channel.on("tokenAboutToExpire",(function(){return setTimeout((function(){return i.emit("tokenAboutToExpire")}),0)})),i.channel.on("tokenExpired",(function(){return setTimeout((function(){return i.emit("tokenExpired")}),0)})),i.channel.on("connected",(function(){return i.registrations.updateRegistrations()})),i.channel.on("connected",(function(){return i.upstream.sendPendingMessages()})),i.channel.on("connected",(function(){return setTimeout((function(){return i.emit("connected")}),0)})),i.channel.on("beforeConnect",(function(){return i.telemetryTracker.addPartialEvent(new zk.TelemetryEventDescription("Establish WebSocket connection","",new Date),Gk.TWILSOCK_CONNECT,zk.TelemetryPoint.Start)})),i.channel.on("connected",(function(){return i.telemetryTracker.addPartialEvent(new zk.TelemetryEventDescription("Establish WebSocket connection","",new Date,new Date),Gk.TWILSOCK_CONNECT,zk.TelemetryPoint.End)})),i.channel.on("beforeSendInit",(function(){return i.telemetryTracker.addPartialEvent(new zk.TelemetryEventDescription("Send Twilsock init","",new Date),Gk.TWILSOCK_INIT,zk.TelemetryPoint.Start)})),i.channel.on("initialized",(function(){return i.telemetryTracker.addPartialEvent(new zk.TelemetryEventDescription("Send Twilsock init","Succeeded",new Date,new Date),Gk.TWILSOCK_INIT,zk.TelemetryPoint.End)})),i.channel.on("sendInitFailed",(function(){return i.telemetryTracker.addPartialEvent(new zk.TelemetryEventDescription("Send Twilsock init","Failed",new Date,new Date),Gk.TWILSOCK_INIT,zk.TelemetryPoint.End)})),i.channel.on("initialized",(function(e){i.handleStorageId(t,e),Wk.TokenStorage.storeToken(e.continuationToken,t),setTimeout((function(){return i.emit("initialized",e)}),0)})),i.channel.on("disconnected",(function(){return setTimeout((function(){return i.emit("disconnected")}),0)})),i.channel.on("disconnected",(function(){return i.upstream.rejectPendingMessages()})),i.channel.on("disconnected",(function(){return i.offlineStorageDeferred.fail(new Bk.TwilsockError("Client disconnected"))})),i.offlineStorageDeferred.promise.catch((function(){})),i}return pa(r,[{key:"emit",value:function(e){for(var t,n=arguments.length,i=new Array(n>1?n-1:0),a=1;a<n;a++)i[a-1]=arguments[a];return Mk.log.debug("Emitting ".concat(e.toString(),"(").concat(i.map((function(e){return JSON.stringify(e)})).join(", "),")")),(t=Pm(ka(r.prototype),"emit",this)).call.apply(t,[this,e].concat(i))}},{key:"handleStorageId",value:function(e,t){if(t.offlineStorage)if(t.offlineStorage.hasOwnProperty(e))try{this.offlineStorageDeferred.set(qk.OfflineProductStorage.create(t.offlineStorage[e])),Mk.log.debug("Offline storage for '".concat(e,"' product: ").concat(JSON.stringify(t.offlineStorage[e]),"."))}catch(n){this.offlineStorageDeferred.fail(new Bk.TwilsockError("Failed to parse offline storage for ".concat(e," ").concat(JSON.stringify(t.offlineStorage[e]),". ").concat(n,".")))}else this.offlineStorageDeferred.fail(new Bk.TwilsockError("No offline storage id for '".concat(e,"' product: ").concat(JSON.stringify(t.offlineStorage))));else this.offlineStorageDeferred.fail(new Bk.TwilsockError("No offline storage id"))}},{key:"storageId",value:function(){return this.offlineStorageDeferred.promise}},{key:"isConnected",get:function(){return this.channel.isConnected}},{key:"state",get:function(){return this.channel.state}},{key:"updateToken",value:(t=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Mk.log.trace("updating token '".concat(t,"'")),this.config.token!==t){e.next=3;break}return e.abrupt("return");case 3:return this.config.updateToken(t),e.abrupt("return",this.channel.updateToken(t));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"setNotificationsContext",value:function(e,t){this.registrations.setNotificationsContext(e,t)}},{key:"removeNotificationsContext",value:function(e){this.registrations.removeNotificationsContext(e)}},{key:"connect",value:function(){return this.channel.connect()}},{key:"disconnect",value:function(){return this.telemetryTracker.sendTelemetry(zk.EventSendingLimitation.AnyEventsIncludingUnfinished),this.channel.disconnect()}},{key:"get",value:function(e,t,n){return this.telemetryTracker.sendTelemetry(zk.EventSendingLimitation.AnyEvents),this.upstream.send("GET",e,t,void 0,n)}},{key:"post",value:function(e,t,n,r){return this.telemetryTracker.sendTelemetry(zk.EventSendingLimitation.AnyEvents),this.upstream.send("POST",e,t,n,r)}},{key:"put",value:function(e,t,n,r){return this.telemetryTracker.sendTelemetry(zk.EventSendingLimitation.AnyEvents),this.upstream.send("PUT",e,t,n,r)}},{key:"delete",value:function(e,t,n){return this.telemetryTracker.sendTelemetry(zk.EventSendingLimitation.AnyEvents),this.upstream.send("DELETE",e,t,void 0,n)}},{key:"addTelemetryEvent",value:function(e){this.telemetryTracker.addTelemetryEvent(e),this.telemetryTracker.sendTelemetryIfMinimalPortionCollected()}},{key:"addPartialTelemetryEvent",value:function(e,t,n){this.telemetryTracker.addPartialEvent(e,t,n),n===zk.TelemetryPoint.End&&this.telemetryTracker.sendTelemetryIfMinimalPortionCollected()}}]),r}(Ok.EventEmitter);Om.TwilsockClient=Vk,Om.Twilsock=Vk,Object.defineProperty(Cm,"__esModule",{value:!0});var Hk=Om;Cm.TwilsockClient=Hk.TwilsockClient;var Jk=Cm.Twilsock=Hk.TwilsockClient,Kk=Zg;Cm.TwilsockError=Kk.TwilsockError;var $k=rk;Cm.TransportUnavailableError=$k.TransportUnavailableError;var Qk={},Yk={},Xk={};Object.defineProperty(Xk,"__esModule",{value:!0}),Xk.Configuration=void 0;var Zk=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};xa(this,e);var r=n.notifications||{},i=r.region||n.region||"us1",a="https://ers.".concat(i,".twilio.com/v1/registrations");this.registrarUrl=r.ersUrl||a,this._token=t}return pa(e,[{key:"updateToken",value:function(e){this._token=e}},{key:"token",get:function(){return this._token}}]),e}();Xk.Configuration=Zk;var ew={},tw={},nw={},rw={};function iw(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(rw,"__esModule",{value:!0});var aw=function(e){ma(n,e);var t=iw(n);function n(e){var r;return xa(this,n),(r=t.call(this)).minDelay=e.min,r.maxDelay=e.max,r.initialDelay=e.initial||0,r.maxAttemptsCount=e.maxAttemptsCount||0,r.maxAttemptsTime=e.maxAttemptsTime||0,r.randomness=e.randomness||0,r.inProgress=!1,r.attemptNum=0,r.prevDelay=0,r.currDelay=0,r}return pa(n,[{key:"attempt",value:function(){clearTimeout(this.timeout),this.attemptNum++,this.timeout=null,this.emit("attempt",this)}},{key:"nextDelay",value:function(e){if("number"==typeof e)return this.prevDelay=0,this.currDelay=e,e;if(0==this.attemptNum)return this.initialDelay;if(1==this.attemptNum)return this.currDelay=this.minDelay,this.currDelay;this.prevDelay=this.currDelay;var t=this.currDelay+this.prevDelay;return this.maxDelay&&t>this.maxDelay&&(this.currDelay=this.maxDelay,t=this.maxDelay),this.currDelay=t,t}},{key:"randomize",value:function(e){var t=e*this.randomness,n=Math.round(Math.random()*t*2-t);return Math.max(0,e+n)}},{key:"scheduleAttempt",value:function(e){var t=this;if(this.maxAttemptsCount&&this.attemptNum>=this.maxAttemptsCount)return this.cleanup(),this.emit("failed",new Error("Maximum attempt count limit reached")),void this.reject(new Error("Maximum attempt count reached"));var n=this.nextDelay(e);if(n=this.randomize(n),this.maxAttemptsTime&&this.startTimestamp+this.maxAttemptsTime<Date.now()+n)return this.cleanup(),this.emit("failed",new Error("Maximum attempt time limit reached")),void this.reject(new Error("Maximum attempt time limit reached"));this.timeout=setTimeout((function(){return t.attempt()}),n)}},{key:"cleanup",value:function(){clearTimeout(this.timeout),this.timeout=null,this.inProgress=!1,this.attemptNum=0,this.prevDelay=0,this.currDelay=0}},{key:"start",value:function(){var e=this;if(this.inProgress)throw new Error("Retrier is already in progress");return this.inProgress=!0,new Promise((function(t,n){e.resolve=t,e.reject=n,e.startTimestamp=Date.now(),e.scheduleAttempt(e.initialDelay)}))}},{key:"cancel",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null,this.inProgress=!1,this.emit("cancelled"),this.reject(new Error("Cancelled")))}},{key:"succeeded",value:function(e){this.emit("succeeded",e),this.resolve(e)}},{key:"failed",value:function(e,t){if(this.timeout)throw new Error("Retrier attempt is already in progress");this.scheduleAttempt(t)}},{key:"run",value:function(e){var t=this;return this.on("attempt",(function(){e().then((function(e){return t.succeeded(e)})).catch((function(e){return t.failed(e)}))})),this.start()}}]),n}(Mm.EventEmitter);rw.Retrier=aw,rw.default=aw;var ow={};function sw(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}function uw(e){return null!=e}Object.defineProperty(ow,"__esModule",{value:!0});var cw=function(e){ma(n,e);var t=sw(n);function n(e){var r;if(xa(this,n),r=t.call(this),uw((e=e||{}).initialDelay)&&e.initialDelay<1)throw new Error("The initial timeout must be equal to or greater than 1.");if(uw(e.maxDelay)&&e.maxDelay<=1)throw new Error("The maximal timeout must be greater than 1.");if(uw(e.randomisationFactor)&&(e.randomisationFactor<0||e.randomisationFactor>1))throw new Error("The randomisation factor must be between 0 and 1.");if(uw(e.factor)&&e.factor<=1)throw new Error("Exponential factor should be greater than 1.");if(r.initialDelay=e.initialDelay||100,r.maxDelay=e.maxDelay||1e4,r.maxDelay<=r.initialDelay)throw new Error("The maximal backoff delay must be greater than the initial backoff delay.");return r.randomisationFactor=e.randomisationFactor||0,r.factor=e.factor||2,r.maxNumberOfRetry=-1,r.reset(),r}return pa(n,[{key:"backoff",value:function(e){null==this.timeoutID&&(this.backoffNumber===this.maxNumberOfRetry?(this.emit("fail",e),this.reset()):(this.backoffDelay=this.next(),this.timeoutID=setTimeout(this.onBackoff.bind(this),this.backoffDelay),this.emit("backoff",this.backoffNumber,this.backoffDelay,e)))}},{key:"reset",value:function(){this.backoffDelay=0,this.nextBackoffDelay=this.initialDelay,this.backoffNumber=0,clearTimeout(this.timeoutID),this.timeoutID=null}},{key:"failAfter",value:function(e){if(e<=0)throw new Error("Expected a maximum number of retry greater than 0 but got ".concat(e));this.maxNumberOfRetry=e}},{key:"next",value:function(){this.backoffDelay=Math.min(this.nextBackoffDelay,this.maxDelay),this.nextBackoffDelay=this.backoffDelay*this.factor;var e=1+Math.random()*this.randomisationFactor;return Math.min(this.maxDelay,Math.round(this.backoffDelay*e))}},{key:"onBackoff",value:function(){this.timeoutID=null,this.emit("ready",this.backoffNumber,this.backoffDelay),this.backoffNumber++}}],[{key:"exponential",value:function(e){return new n(e)}}]),n}(Mm.EventEmitter);ow.Backoff=cw,ow.default=cw,Object.defineProperty(nw,"__esModule",{value:!0});var lw=rw;nw.Retrier=lw.Retrier;var fw=ow;nw.Backoff=fw.Backoff,nw.default=lw.Retrier;var dw={};Object.defineProperty(dw,"__esModule",{value:!0}),dw.log=dw.Logger=void 0;var hw=gd.exports;function pw(e,t){return["".concat((new Date).toISOString()," Notifications ").concat(e,":")].concat(Array.from(t))}var vw=function(){function e(){xa(this,e),this.prefix=""}return pa(e,[{key:"setLevel",value:function(e){hw.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];hw.debug.apply(null,pw("T"+this.prefix,t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];hw.debug.apply(null,pw("D"+this.prefix,t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];hw.info.apply(null,pw("I"+this.prefix,t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];hw.warn.apply(null,pw("W"+this.prefix,t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];hw.error.apply(null,pw("E"+this.prefix,t))}}],[{key:"scope",value:function(){return new e}}]),e}();dw.Logger=vw;var yw=vw.scope();function mw(e){return function(e){if(Array.isArray(e))return hy(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||py(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}dw.log=yw;var gw={};function bw(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(gw,"__esModule",{value:!0}),gw.Connector=gw.RegistrationState=void 0;var kw=Mm,ww=dw,xw=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new Set;xa(this,e),this.token=t,this.notificationId=n,this.messageTypes=r}return pa(e,[{key:"clone",value:function(){return new e(this.token,this.notificationId,new Set(this.messageTypes))}}]),e}();function _w(e,t){var n=new Set;return e.notificationId!==t.notificationId&&n.add("notificationId"),e.token!==t.token&&n.add("token"),function(e,t){return[].concat(mw(mw(e).filter((function(e){return!t.has(e)}))),mw(mw(t).filter((function(t){return!e.has(t)}))))}(e.messageTypes,t.messageTypes).length>0&&n.add("messageType"),[n.size>0,n]}gw.RegistrationState=xw;var Sw=function(e){ma(a,e);var t,n,r,i=bw(a);function a(e){var t;return xa(this,a),(t=i.call(this)).config=e,t.desiredState=new xw,t.currentState=new xw,t.hasActiveAttempt=!1,t}return pa(a,[{key:"subscribe",value:(r=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.desiredState.messageTypes.has(t)){e.next=3;break}return ww.log.debug("message type already registered ",t),e.abrupt("return");case 3:return this.desiredState.messageTypes.add(t),e.next=6,this.persistRegistration();case 6:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"unsubscribe",value:(n=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.desiredState.messageTypes.has(t)){e.next=2;break}return e.abrupt("return");case 2:return this.desiredState.messageTypes.delete(t),e.next=5,this.persistRegistration();case 5:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"updateToken",value:function(e){this.desiredState.token=e,this.persistRegistration()}},{key:"persistRegistration",value:(t=da(Za.mark((function e(){var t,n,r,i,a,o,s=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.config.token&&0!==this.config.token.length){e.next=3;break}return ww.log.trace("Can't persist registration: token is not set"),e.abrupt("return");case 3:if(!this.hasActiveAttempt){e.next=6;break}return ww.log.trace("One registration attempt is already in progress"),e.abrupt("return");case 6:if(t=_w(this.desiredState,this.currentState),n=vy(t,2),r=n[0],i=n[1],r){e.next=9;break}return e.abrupt("return");case 9:if(this.currentState.notificationId||i.delete("notificationId"),ww.log.trace("Persisting registration",i,this.desiredState),e.prev=11,this.hasActiveAttempt=!0,!((a=this.desiredState.clone()).messageTypes.size>0)){e.next=24;break}return e.next=17,this.updateRegistration(a,i);case 17:o=e.sent,this.currentState.token=o.token,this.currentState.notificationId=o.notificationId,this.currentState.messageTypes=o.messageTypes,this.emit("stateChanged","registered"),e.next=30;break;case 24:return e.next=26,this.removeRegistration();case 26:this.currentState.token=a.token,this.currentState.notificationId=a.notificationId,this.currentState.messageTypes.clear(),this.emit("stateChanged","unregistered");case 30:return e.prev=30,this.hasActiveAttempt=!1,setTimeout((function(){return s.persistRegistration()}),0),e.finish(30);case 34:case"end":return e.stop()}}),e,this,[[11,,30,34]])}))),function(){return t.apply(this,arguments)})},{key:"setNotificationId",value:function(e){this.desiredState.notificationId=e,this.persistRegistration()}}]),a}(kw.EventEmitter);function Tw(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}gw.Connector=Sw,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.RegistrarConnector=e.Connector=void 0;var t=nw,n=dw,r=gw;Object.defineProperty(e,"Connector",{enumerable:!0,get:function(){return r.Connector}});var i={min:2e3,max:12e4,randomness:.2},a=function(e){ma(u,e);var r,a,o,s=Tw(u);function u(e,t,n,r){var i;return xa(this,u),(i=s.call(this,r)).channelType=e,i.context=t,i.transport=n,i}return pa(u,[{key:"updateRegistration",value:(o=da(Za.mark((function e(t,n){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!n.has("notificationId")){e.next=3;break}return e.next=3,this.removeRegistration();case 3:if(t.notificationId&&t.notificationId.length){e.next=5;break}return e.abrupt("return",t);case 5:return e.next=7,this.register(t);case 7:return e.abrupt("return",t);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)})},{key:"removeRegistration",value:(a=da(Za.mark((function e(){var r,a,o=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.registrationId){e.next=2;break}return e.abrupt("return");case 2:return r="".concat(this.config.registrarUrl,"/").concat(this.registrationId,"?productId=").concat(this.context.productId),a={"Content-Type":"application/json","X-Twilio-Token":this.config.token},e.prev=4,n.log.trace("Removing registration for ",this.channelType),e.next=8,new t.Retrier(Object.assign(i,{maxAttemptsCount:3})).run((function(){return o.transport.delete(r,a)}));case 8:n.log.debug("Registration removed for",this.channelType),e.next=15;break;case 11:throw e.prev=11,e.t0=e.catch(4),n.log.error("Failed to remove of registration ",this.channelType,e.t0),e.t0;case 15:case"end":return e.stop()}}),e,this,[[4,11]])}))),function(){return a.apply(this,arguments)})},{key:"register",value:(r=da(Za.mark((function e(r){var a,o,s,u,c=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.log.trace("Registering",this.channelType,r),a={endpoint_platform:this.context.platform,channel_type:this.channelType,version:this.context.protocolVersion.toString(),message_types:Array.from(r.messageTypes),data:{registration_id:r.notificationId},ttl:"PT24H"},o="".concat(this.config.registrarUrl,"?productId=").concat(this.context.productId),s={"Content-Type":"application/json","X-Twilio-Token":r.token},n.log.trace("Creating registration for channel ",this.channelType),e.prev=5,e.next=8,new t.Retrier(i).run((function(){return c.transport.post(o,s,a)}));case 8:u=e.sent,this.registrationId=u.body.id,n.log.debug("Registration created: ",u),e.next=17;break;case 13:throw e.prev=13,e.t0=e.catch(5),n.log.error("Registration failed: ",e.t0),e.t0;case 17:case"end":return e.stop()}}),e,this,[[5,13]])}))),function(e){return r.apply(this,arguments)})}]),u}(r.Connector);e.RegistrarConnector=a}(tw);var Ew={};function Iw(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(Ew,"__esModule",{value:!0}),Ew.TwilsockConnector=void 0;var Rw=fg,Cw=function(e){ma(i,e);var t,n,r=Iw(i);function i(e,t,n){var a;return xa(this,i),(a=r.call(this,n)).twilsock=t,a.context=e,e.id=Rw.v4(),a.twilsock.on("stateChanged",(function(e){"connected"!==e&&a.emit("transportReady",!1)})),a.twilsock.on("registered",(function(n){e&&n===e.id&&"connected"===t.state&&a.emit("transportReady",!0)})),a}return pa(i,[{key:"setNotificationId",value:function(){}},{key:"updateToken",value:function(e){}},{key:"updateContextRequest",value:(n=da(Za.mark((function e(t){var n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={product_id:this.context.productId,notification_protocol_version:4,endpoint_platform:this.context.platform,message_types:t},this.emit("transportReady",!1),e.next=4,this.twilsock.setNotificationsContext(this.context.id,n);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"updateRegistration",value:(t=da(Za.mark((function e(t,n){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.has("messageType")){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.updateContextRequest(Array.from(t.messageTypes));case 4:return e.abrupt("return",t);case 5:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"removeRegistration",value:function(){return this.twilsock.removeNotificationsContext(this.context.id)}}]),i}(gw.Connector);function Pw(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Ew.TwilsockConnector=Cw,Object.defineProperty(ew,"__esModule",{value:!0}),ew.Registrar=void 0;var Ow=tw,Mw=Ew,Aw=function(e){ma(n,e);var t=Pw(n);function n(e,r,i,a){var o;xa(this,n),(o=t.call(this)).config=a,o.connectors=new Map;var s=o.detectPlatform();return o.connectors.set("gcm",new Ow.RegistrarConnector("gcm",{protocolVersion:3,productId:e,platform:s},r,a)),o.connectors.set("fcm",new Ow.RegistrarConnector("fcm",{protocolVersion:3,productId:e,platform:s},r,a)),o.connectors.set("apn",new Ow.RegistrarConnector("apn",{protocolVersion:4,productId:e,platform:s},r,a)),o.connectors.set("twilsock",new Mw.TwilsockConnector({productId:e,platform:s},i,a)),o.connectors.get("twilsock").on("transportReady",(function(e){return o.emit("transportReady",e)})),o}return pa(n,[{key:"setNotificationId",value:function(e,t){this.connector(e).setNotificationId(t)}},{key:"subscribe",value:function(e,t){return this.connector(t).subscribe(e)}},{key:"unsubscribe",value:function(e,t){return this.connector(t).unsubscribe(e)}},{key:"updateToken",value:function(e){this.connectors.forEach((function(t){return t.updateToken(e)}))}},{key:"connector",value:function(e){var t=this.connectors.get(e);if(!t)throw new Error("Unknown channel type: ".concat(e));return t}},{key:"detectPlatform",value:function(){var e="";return"undefined"!=typeof navigator?(e="unknown",void 0!==navigator.product&&(e=navigator.product),void 0!==navigator.userAgent&&(e=navigator.userAgent)):e="web",e.substring(0,128)}}]),n}(Mm.EventEmitter);function Dw(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}ew.Registrar=Aw,Object.defineProperty(Yk,"__esModule",{value:!0}),Yk.Client=void 0;var jw=Cm,Nw=Xk,Lw=ew,Uw=dw,Fw=function(e){ma(Client,e);var t,n=Dw(Client);function Client(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(xa(this,Client),t=n.call(this),!e||0===e.length)throw new Error("Token is required for Notifications client");r.logLevel=r.logLevel||"error",Uw.log.setLevel(r.logLevel),r.minTokenRefreshInterval;var i=r.productId||"notifications";return r.twilsockClient=r.twilsockClient||new jw.TwilsockClient(e,i,r),r.transport=r.transport||r.twilsockClient,t.services={twilsock:r.twilsockClient,transport:r.transport,config:new Nw.Configuration(null,r)},t.registrar=new Lw.Registrar(i,t.services.transport,t.services.twilsock,t.services.config),t.reliableTransportState={overall:!1,transport:!1,registration:!1,lastEmitted:null},t._onTransportStateChange(t.services.twilsock.isConnected),t.registrar.on("transportReady",(function(e){t._onRegistrationStateChange(e?"registered":"")})),t.registrar.on("stateChanged",(function(e){t._onRegistrationStateChange(e)})),t.registrar.on("needReliableTransport",t._onNeedReliableTransport.bind(va(t))),t.services.twilsock.on("message",(function(e,n){return t._routeMessage(e,n)})),t.services.twilsock.on("connected",(function(e){t._onTransportStateChange(!0),t.registrar.setNotificationId("twilsock",e)})),t.services.twilsock.on("disconnected",(function(){t._onTransportStateChange(!1)})),t.services.config.updateToken(e),t.registrar.updateToken(e),t}return pa(Client,[{key:"connectionState",get:function(){return"disconnected"===this.services.twilsock.state?"disconnected":"disconnecting"===this.services.twilsock.state?"disconnecting":"connected"===this.services.twilsock.state&&this.reliableTransportState.registration?"connected":"rejected"===this.services.twilsock.state?"denied":"connecting"}},{key:"_routeMessage",value:function(e,t){Uw.log.trace("Message arrived: ",e,t),this.emit("message",e,t)}},{key:"_onNeedReliableTransport",value:function(e){e?this.services.twilsock.connect():this.services.twilsock.disconnect()}},{key:"_onRegistrationStateChange",value:function(e){this.reliableTransportState.registration="registered"===e,this._updateTransportState()}},{key:"_onTransportStateChange",value:function(e){this.reliableTransportState.transport=e,this._updateTransportState()}},{key:"_updateTransportState",value:function(){var e=this.reliableTransportState.transport&&this.reliableTransportState.registration;this.reliableTransportState.overall!==e&&(this.reliableTransportState.overall=e,Uw.log.info("Transport ready:",e),this.emit("transportReady",e)),this.reliableTransportState.lastEmitted!==this.connectionState&&(this.reliableTransportState.lastEmitted=this.connectionState,this.emit("connectionStateChanged",this.connectionState))}},{key:"subscribe",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"twilsock";return Uw.log.trace("Add subscriptions for message type: ",e,t),this.registrar.subscribe(e,t)}},{key:"unsubscribe",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"twilsock";return Uw.log.trace("Remove subscriptions for message type: ",e,t),this.registrar.unsubscribe(e,t)}},{key:"handlePushNotification",value:function(e){return{messageType:e.twi_message_type,payload:e.payload}}},{key:"setPushRegistrationId",value:function(e,t){Uw.log.trace("Set push registration id",e,t),this.registrar.setNotificationId(t,e)}},{key:"updateToken",value:(t=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(Uw.log.info("authTokenUpdated"),this.services.config.token!==t){e.next=3;break}return e.abrupt("return");case 3:return e.next=5,this.services.twilsock.updateToken(t);case 5:this.services.config.updateToken(t),this.registrar.updateToken(t);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),Client}(Mm.EventEmitter);Yk.Client=Fw,function(e){Object.defineProperty(e,"__esModule",{value:!0}),e.Notifications=void 0;var t=Yk;Object.defineProperty(e,"Notifications",{enumerable:!0,get:function(){return t.Client}})}(Qk);var Bw={exports:{}},qw={},Ww={};Object.defineProperty(Ww,"__esModule",{value:!0});var zw=function(){function e(t){xa(this,e),this.base=t,this.args=new Array,this.paths=new Array}return pa(e,[{key:"pathSegment",value:function(e){return this.paths.push(encodeURIComponent(e)),this}},{key:"queryParam",value:function(e,t){return void 0!==t&&this.args.push(encodeURIComponent(e)+"="+encodeURIComponent(t)),this}},{key:"build",value:function(){var e=this.base;return this.paths.length&&(e+="/"+this.paths.join("/")),this.args.length&&(e+="?"+this.args.join("&")),e}}]),e}();Ww.UriBuilder=zw;var Gw={};function Vw(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(Gw,"__esModule",{value:!0});var Hw=function(e){ma(n,e);var t=Vw(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return xa(this,n),(r=t.call(this)).name=r.constructor.name,r.message="".concat(e," (status: ").concat(i,", code: ").concat(a,")"),r.status=i,r.code=a,r}return n}(Xg(Error));Gw.SyncError=Hw;var Jw=function(e){ma(n,e);var t=Vw(n);function n(e){var r,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3?arguments[3]:void 0;return xa(this,n),(r=t.call(this,e,i,a)).body=o,r}return n}(Hw);Gw.SyncNetworkError=Jw,Gw.default=Hw;var Kw={};Object.defineProperty(Kw,"__esModule",{value:!0});var $w=Gw;function Qw(e,t){if(!t||void 0!==e){var n,r=ga(e);if("number"!==r||!(Yw(n=e)&&n>=0)){var i="object"===r?"object":"'".concat(e,"' of type '").concat(r,"'");throw new $w.default("Invalid TTL, expected a positive integer of type number, was ".concat(i),400,54011)}}}function Yw(e){return!isNaN(parseInt(e))&&isFinite(e)}Kw.deepClone=function(e){return JSON.parse(JSON.stringify(e))},Kw.validateId=function(e){if(void 0!==e){var t=ga(e);if("string"!==t)throw new Error("Invalid ID type, expected a string, got '".concat(t,"'"))}},Kw.validateOptionalTtl=function(e){Qw(e,!0)},Kw.validateMandatoryTtl=function(e){Qw(e,!1)},Kw.validatePageSize=function(e){var t;if(!(void 0===e||Yw(t=e)&&t>0))throw new $w.default("Invalid pageSize parameter. Expected a positive integer, was '".concat(e,"'."),400,20007)},Kw.validateMode=function(e){if(!["open_or_create","open_existing","create_new"].includes(e))throw new Error("Invalid open mode. Expected one of { 'create_new', 'open_or_create', 'open_existing' }")};var Xw={};Object.defineProperty(Xw,"__esModule",{value:!0});var Zw=gd.exports.getLogger("twilio-sync");function ex(e,t){return["".concat((new Date).toISOString()," Sync ").concat(e,":")].concat(Array.from(t))}Xw.default={setLevel:function(e){Zw.setLevel(e)},trace:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Zw.trace.apply(null,ex("T",t))},debug:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Zw.debug.apply(null,ex("D",t))},info:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Zw.info.apply(null,ex("I",t))},warn:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Zw.warn.apply(null,ex("W",t))},error:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];Zw.error.apply(null,ex("E",t))}};var tx={};Object.defineProperty(tx,"__esModule",{value:!0});var nx="/v4/Subscriptions",rx="/v3/Maps",ix="/v3/Lists",ax="/v3/Documents",ox="/v3/Streams",sx="/v3/Insights";function ux(e,t,n){return e&&void 0!==e[t]?e[t]:n}var cx=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};xa(this,e);var n=t.region||"us1",r="https://cds.".concat(n,".twilio.com"),i=t.cdsUri||r;this.settings={subscriptionsUri:i+nx,documentsUri:i+ax,listsUri:i+ix,mapsUri:i+rx,streamsUri:i+ox,insightsUri:i+sx,sessionStorageEnabled:ux(t.Sync,"enableSessionStorage",!0),productId:t.productId}}return pa(e,[{key:"subscriptionsUri",get:function(){return this.settings.subscriptionsUri}},{key:"documentsUri",get:function(){return this.settings.documentsUri}},{key:"listsUri",get:function(){return this.settings.listsUri}},{key:"mapsUri",get:function(){return this.settings.mapsUri}},{key:"streamsUri",get:function(){return this.settings.streamsUri}},{key:"insightsUri",get:function(){return this.settings.insightsUri}},{key:"backoffConfig",get:function(){return this.settings.backoffConfig||{}}},{key:"sessionStorageEnabled",get:function(){return this.settings.sessionStorageEnabled}},{key:"productId",get:function(){return this.settings.productId}}]),e}();tx.Configuration=cx;var lx={},fx={},dx={};function hx(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(dx,"__esModule",{value:!0});var px=function(e){ma(n,e);var t=hx(n);function n(e){var r;return xa(this,n),(r=t.call(this)).minDelay=e.min,r.maxDelay=e.max,r.initialDelay=e.initial||0,r.maxAttemptsCount=e.maxAttemptsCount||0,r.maxAttemptsTime=e.maxAttemptsTime||0,r.randomness=e.randomness||0,r.inProgress=!1,r.attemptNum=0,r.prevDelay=0,r.currDelay=0,r}return pa(n,[{key:"attempt",value:function(){clearTimeout(this.timeout),this.attemptNum++,this.timeout=null,this.emit("attempt",this)}},{key:"nextDelay",value:function(e){if("number"==typeof e)return this.prevDelay=0,this.currDelay=e,e;if(0==this.attemptNum)return this.initialDelay;if(1==this.attemptNum)return this.currDelay=this.minDelay,this.currDelay;this.prevDelay=this.currDelay;var t=this.currDelay+this.prevDelay;return this.maxDelay&&t>this.maxDelay&&(this.currDelay=this.maxDelay,t=this.maxDelay),this.currDelay=t,t}},{key:"randomize",value:function(e){var t=e*this.randomness,n=Math.round(Math.random()*t*2-t);return Math.max(0,e+n)}},{key:"scheduleAttempt",value:function(e){var t=this;if(this.maxAttemptsCount&&this.attemptNum>=this.maxAttemptsCount)return this.cleanup(),this.emit("failed",new Error("Maximum attempt count limit reached")),void this.reject(new Error("Maximum attempt count reached"));var n=this.nextDelay(e);if(n=this.randomize(n),this.maxAttemptsTime&&this.startTimestamp+this.maxAttemptsTime<Date.now()+n)return this.cleanup(),this.emit("failed",new Error("Maximum attempt time limit reached")),void this.reject(new Error("Maximum attempt time limit reached"));this.timeout=setTimeout((function(){return t.attempt()}),n)}},{key:"cleanup",value:function(){clearTimeout(this.timeout),this.timeout=null,this.inProgress=!1,this.attemptNum=0,this.prevDelay=0,this.currDelay=0}},{key:"start",value:function(){var e=this;if(this.inProgress)throw new Error("Retrier is already in progress");return this.inProgress=!0,new Promise((function(t,n){e.resolve=t,e.reject=n,e.startTimestamp=Date.now(),e.scheduleAttempt(e.initialDelay)}))}},{key:"cancel",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null,this.inProgress=!1,this.emit("cancelled"),this.reject(new Error("Cancelled")))}},{key:"succeeded",value:function(e){this.emit("succeeded",e),this.resolve(e)}},{key:"failed",value:function(e,t){if(this.timeout)throw new Error("Retrier attempt is already in progress");this.scheduleAttempt(t)}},{key:"run",value:function(e){var t=this;return this.on("attempt",(function(){e().then((function(e){return t.succeeded(e)})).catch((function(e){return t.failed(e)}))})),this.start()}}]),n}(Mm.EventEmitter);dx.Retrier=px,dx.default=px;var vx={};function yx(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}function mx(e){return null!=e}Object.defineProperty(vx,"__esModule",{value:!0});var gx=function(e){ma(n,e);var t=yx(n);function n(e){var r;if(xa(this,n),r=t.call(this),mx((e=e||{}).initialDelay)&&e.initialDelay<1)throw new Error("The initial timeout must be equal to or greater than 1.");if(mx(e.maxDelay)&&e.maxDelay<=1)throw new Error("The maximal timeout must be greater than 1.");if(mx(e.randomisationFactor)&&(e.randomisationFactor<0||e.randomisationFactor>1))throw new Error("The randomisation factor must be between 0 and 1.");if(mx(e.factor)&&e.factor<=1)throw new Error("Exponential factor should be greater than 1.");if(r.initialDelay=e.initialDelay||100,r.maxDelay=e.maxDelay||1e4,r.maxDelay<=r.initialDelay)throw new Error("The maximal backoff delay must be greater than the initial backoff delay.");return r.randomisationFactor=e.randomisationFactor||0,r.factor=e.factor||2,r.maxNumberOfRetry=-1,r.reset(),r}return pa(n,[{key:"backoff",value:function(e){null==this.timeoutID&&(this.backoffNumber===this.maxNumberOfRetry?(this.emit("fail",e),this.reset()):(this.backoffDelay=this.next(),this.timeoutID=setTimeout(this.onBackoff.bind(this),this.backoffDelay),this.emit("backoff",this.backoffNumber,this.backoffDelay,e)))}},{key:"reset",value:function(){this.backoffDelay=0,this.nextBackoffDelay=this.initialDelay,this.backoffNumber=0,clearTimeout(this.timeoutID),this.timeoutID=null}},{key:"failAfter",value:function(e){if(e<=0)throw new Error("Expected a maximum number of retry greater than 0 but got ".concat(e));this.maxNumberOfRetry=e}},{key:"next",value:function(){this.backoffDelay=Math.min(this.nextBackoffDelay,this.maxDelay),this.nextBackoffDelay=this.backoffDelay*this.factor;var e=1+Math.random()*this.randomisationFactor;return Math.min(this.maxDelay,Math.round(this.backoffDelay*e))}},{key:"onBackoff",value:function(){this.timeoutID=null,this.emit("ready",this.backoffNumber,this.backoffDelay),this.backoffNumber++}}],[{key:"exponential",value:function(e){return new n(e)}}]),n}(Mm.EventEmitter);vx.Backoff=gx,vx.default=gx,Object.defineProperty(fx,"__esModule",{value:!0});var bx=dx;fx.Retrier=bx.Retrier;var kx=vx;function wx(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return xx(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return xx(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function xx(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}fx.Backoff=kx.Backoff,fx.default=bx.Retrier,Object.defineProperty(lx,"__esModule",{value:!0});var _x=fx,Sx=Gw,Tx=Xw,Ex=Cm,Ix=function(){function e(t){xa(this,e),this.localObject=t,this.pendingCorrelationId=null,this.pendingAction=null,this.established=!1,this.retryCount=0}return pa(e,[{key:"sid",get:function(){return this.localObject.sid}},{key:"type",get:function(){return this.localObject.type}},{key:"lastEventId",get:function(){return this.localObject.lastEventId}},{key:"indexName",get:function(){return this.localObject.indexName}},{key:"queryString",get:function(){return this.localObject.queryString}},{key:"isEstablished",get:function(){return this.established}},{key:"update",value:function(e,t){this.localObject._update(e,t)}},{key:"updatePending",value:function(e,t){this.pendingAction=e,this.pendingCorrelationId=t}},{key:"reset",value:function(){this.updatePending(null,null),this.retryCount=0,this.established=!1,this.setSubscriptionState("none")}},{key:"markAsFailed",value:function(e){this.rejectedWithError=e.error,this.updatePending(null,null),this.localObject.reportFailure(new Sx.SyncError("Failed to subscribe on service events: ".concat(e.error.message),e.error.status,e.error.code))}},{key:"complete",value:function(e){this.updatePending(null,null),this.established=!0,this.localObject._advanceLastEventId(e)}},{key:"setSubscriptionState",value:function(e){this.localObject._setSubscriptionState(e)}}]),e}(),Rx=function(){function e(t){var n=this;xa(this,e),this.isConnected=!1,this.maxBatchSize=100,this.subscriptionTtlTimer=null,this.pendingPokeReason=null,this.services=t,this.subscriptions=new Map,this.persisted=new Map,this.latestPokeResponseArrivalTimestampByCorrelationId=new Map;this.backoff=_x.Backoff.exponential(Object.assign({randomisationFactor:.2,initialDelay:100,maxDelay:12e4},this.services.config.backoffConfig)),this.backoff.on("ready",(function(){var e=n.getSubscriptionUpdateBatch(),t=e.action,r=e.subscriptions;t?n.applyNewSubscriptionUpdateBatch(t,r):(n.backoff.reset(),Tx.default.debug("All subscriptions resolved."))}))}var t;return pa(e,[{key:"getSubscriptionUpdateBatch",value:function(){function e(e,t,n,r){var i,a=[],o=wx(e);try{for(o.s();!(i=o.n()).done;){var s=vy(i.value,2),u=s[0],c=s[1];if(!t.get(u)&&n!==c.pendingAction&&!c.rejectedWithError&&(a.push(c),r&&a.length>=r))break}}catch(e){o.e(e)}finally{o.f()}return a}var t=e(this.subscriptions,this.persisted,"establish",this.maxBatchSize);if(t.length>0)return{action:"establish",subscriptions:t};var n=e(this.persisted,this.subscriptions,"cancel",this.maxBatchSize);return n.length>0?{action:"cancel",subscriptions:n}:{action:null,subscriptions:null}}},{key:"persist",value:function(){this.backoff.backoff()}},{key:"applyNewSubscriptionUpdateBatch",value:(t=da(Za.mark((function e(t,n){var r,i,a,o,s,u,c,l,f,d,h,p,v=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isConnected){e.next=4;break}return Tx.default.debug("Twilsock connection (required for subscription) not ready; waiting…"),this.backoff.reset(),e.abrupt("return");case 4:n=this.processLocalActions(t,n),r=(new Date).getTime(),i=wx(n);try{for(i.s();!(a=i.n()).done;)o=a.value,this.recordActionAttemptOn(o,t,r)}catch(e){i.e(e)}finally{i.f()}return s=this.pendingPokeReason,this.pendingPokeReason=null,e.prev=10,e.next=13,this.request(t,r,s,n);case 13:u=e.sent,c=u.body.max_batch_size,!isNaN(parseInt(c))&&isFinite(c)&&c>0&&(this.maxBatchSize=c),this.subscriptionTtlTimer||(l=u.body.ttl_in_s,!isNaN(parseFloat(l))&&isFinite(l)&&l>0&&(this.subscriptionTtlTimer=setTimeout((function(){return v.onSubscriptionTtlElapsed()}),1e3*l))),"establish"===t&&(f=u.body.estimated_delivery_in_ms,!isNaN(parseFloat(f))&&isFinite(f)&&f>0?setTimeout((function(){return v.verifyPokeDelivery(r,f,n)}),f):Tx.default.error("Invalid timeout: ".concat(f)),n.filter((function(e){return e.pendingCorrelationId===r})).forEach((function(e){return e.setSubscriptionState("response_in_flight")}))),this.backoff.reset(),e.next=26;break;case 21:e.prev=21,e.t0=e.catch(10),d=wx(n);try{for(d.s();!(h=d.n()).done;)p=h.value,this.recordActionFailureOn(p,t)}catch(e){d.e(e)}finally{d.f()}e.t0 instanceof Ex.TransportUnavailableError?(Tx.default.debug("Twilsock connection (required for subscription) not ready (c:".concat(r,"); waiting…")),this.backoff.reset()):(Tx.default.debug("Failed an attempt to ".concat(t," subscriptions (c:").concat(r,"); retrying"),e.t0),this.persist());case 26:case"end":return e.stop()}}),e,this,[[10,21]])}))),function(e,n){return t.apply(this,arguments)})},{key:"verifyPokeDelivery",value:function(e,t,n){var r=this,i=this.latestPokeResponseArrivalTimestampByCorrelationId.get(e),a=i?(new Date).getTime()-i:t;a>=t?(n.filter((function(t){return t.pendingCorrelationId===e})).forEach((function(e){e.updatePending(null,null),e.retryCount++,r.persisted.delete(e.sid)})),this.persist(),this.latestPokeResponseArrivalTimestampByCorrelationId.delete(e)):setTimeout((function(){return r.verifyPokeDelivery(e,t,n)}),t-a)}},{key:"processLocalActions",value:function(e,t){return"cancel"===e?t.filter((function(e){return!e.rejectedWithError})):t}},{key:"recordActionAttemptOn",value:function(e,t,n){if(e.setSubscriptionState("request_in_flight"),"establish"===t)this.persisted.set(e.sid,e),e.updatePending(t,n);else{var r=this.persisted.get(e.sid);r&&r.updatePending(t,n)}}},{key:"recordActionFailureOn",value:function(e,t){e.setSubscriptionState("none"),e.updatePending(null,null),"establish"===t&&this.persisted.delete(e.sid)}},{key:"request",value:function(e,t,n,r){var i=r.map((function(t){return{object_sid:t.sid,object_type:t.type,last_event_id:"establish"===e?t.lastEventId:void 0,index_name:"establish"===e?t.indexName:void 0,query_string:"establish"===e?t.queryString:void 0}})),a=r.filter((function(e){return e.retryCount>0})).length;Tx.default.debug("Attempting '".concat(e,"' request (c:").concat(t,"):"),i);var o={event_protocol_version:3,action:e,correlation_id:t,retried_requests:a,ttl_in_s:-1,requests:i};return"ttl"===n&&(o.reason=n),this.services.network.post(this.services.config.subscriptionsUri,o)}},{key:"add",value:function(e,t){Tx.default.debug("Establishing intent to subscribe to ".concat(e));var n=this.subscriptions.get(e);n&&t&&n.lastEventId===t.lastEventId||(this.persisted.delete(e),this.subscriptions.set(e,new Ix(t)),this.persist())}},{key:"remove",value:function(e){Tx.default.debug("Establishing intent to unsubscribe from ".concat(e)),this.subscriptions.delete(e)&&this.persist()}},{key:"acceptMessage",value:function(e,t){var n;switch(Tx.default.trace("Subscriptions received",e),e.correlation_id&&this.latestPokeResponseArrivalTimestampByCorrelationId.set(e.correlation_id,(new Date).getTime()),e.event_type){case"subscription_established":this.applySubscriptionEstablishedMessage(e.event,e.correlation_id);break;case"subscription_canceled":this.applySubscriptionCancelledMessage(e.event,e.correlation_id);break;case"subscription_failed":this.applySubscriptionFailedMessage(e.event,e.correlation_id);break;case(n=e.event_type.match(/^(?:map|list|document|stream|live_query)_/)||{}).input:var r;switch(n[0]){case"map_":r=e.event.map_sid;break;case"list_":r=e.event.list_sid;break;case"document_":r=e.event.document_sid;break;case"stream_":r=e.event.stream_sid;break;case"live_query_":r=e.event.query_id,t=!1,!0===e.strictly_ordered&&(t=!0);break;default:r=void 0}this.applyEventToSubscribedEntity(r,e,t);break;default:Tx.default.debug("Dropping unknown message type ".concat(e.event_type))}}},{key:"applySubscriptionEstablishedMessage",value:function(e,t){var n=e.object_sid,r=this.persisted.get(e.object_sid);r&&r.pendingCorrelationId===t?"interrupted"===e.replay_status?(Tx.default.debug("Event Replay for subscription to ".concat(n," (c:").concat(t,") interrupted; continuing eagerly.")),r.updatePending(null,null),this.persisted.delete(r.sid),this.backoff.reset()):"completed"===e.replay_status&&(Tx.default.debug("Event Replay for subscription to ".concat(n," (c:").concat(t,") completed. Subscription is ready.")),r.complete(e.last_event_id),this.persisted.set(e.object_sid,r),r.setSubscriptionState("established"),this.backoff.reset()):Tx.default.debug("Late message for ".concat(e.object_sid," (c:").concat(t,") dropped.")),this.persist()}},{key:"applySubscriptionCancelledMessage",value:function(e,t){var n=this.persisted.get(e.object_sid);n&&n.pendingCorrelationId===t?(n.updatePending(null,null),n.setSubscriptionState("none"),this.persisted.delete(e.object_sid)):Tx.default.debug("Late message for ".concat(e.object_sid," (c:").concat(t,") dropped.")),this.persist()}},{key:"applySubscriptionFailedMessage",value:function(e,t){var n=e.object_sid,r=this.subscriptions.get(n),i=this.persisted.get(n);r&&i?i.pendingCorrelationId===t&&(Tx.default.error("Failed to subscribe on ".concat(i.sid),e.error),i.markAsFailed(e),i.setSubscriptionState("none")):!r&&i&&(this.persisted.delete(n),i.setSubscriptionState("none")),this.persist()}},{key:"applyEventToSubscribedEntity",value:function(e,t,n){if(e){var r;n=n||(r=this.persisted.get(e))&&r.isEstablished;var i=this.subscriptions.get(e);i?(t.event.type=t.event_type,i.update(t.event,n)):Tx.default.debug("Message dropped for SID '".concat(e,"', for which there is no subscription."))}}},{key:"onConnectionStateChanged",value:function(e){this.isConnected=e,e&&this.poke("reconnect")}},{key:"onSubscriptionTtlElapsed",value:function(){this.isConnected&&this.poke("ttl")}},{key:"poke",value:function(e){Tx.default.debug("Triggering event replay for all subscriptions, reason=".concat(e)),this.pendingPokeReason=e,this.subscriptionTtlTimer&&(clearTimeout(this.subscriptionTtlTimer),this.subscriptionTtlTimer=null);var t,n=[],r=wx(this.persisted.values());try{for(r.s();!(t=r.n()).done;){var i=t.value;i.reset(),i.rejectedWithError&&n.push(i)}}catch(e){r.e(e)}finally{r.f()}this.persisted.clear();for(var a=0,o=n;a<o.length;a++){var s=o[a];this.persisted.set(s.sid,s)}this.persist()}},{key:"shutdown",value:function(){this.backoff.reset(),this.subscriptions.clear()}}]),e}();lx.Subscriptions=Rx;var Cx={};Object.defineProperty(Cx,"__esModule",{value:!0});var Px=Xw,Ox="com.twilio.rtd.cds.document",Mx="com.twilio.rtd.cds.list",Ax="com.twilio.rtd.cds.map",Dx="twilio.sync.event",jx=function(){function e(t){var n=this;xa(this,e),this.config=t.config,this.subscriptions=t.subscriptions,this.notifications=t.notifications,this.notifications.subscribe(Dx),this.notifications.subscribe(Ox),this.notifications.subscribe(Mx),this.notifications.subscribe(Ax),this.notifications.on("message",(function(e,t){return n.onMessage(e,t)})),this.notifications.on("transportReady",(function(e){return n.onConnectionStateChanged(e)}))}return pa(e,[{key:"onMessage",value:function(e,t){switch(Px.default.trace("Notification type:",e,"content:",t),e){case Ox:case Mx:case Ax:this.subscriptions.acceptMessage(t,!1);break;case Dx:this.subscriptions.acceptMessage(t,!0)}}},{key:"subscribe",value:function(e,t){this.subscriptions.add(e,t)}},{key:"unsubscribe",value:function(e){this.subscriptions.remove(e)}},{key:"onConnectionStateChanged",value:function(e){this.subscriptions.onConnectionStateChanged(e)}}]),e}();Cx.Router=jx,Cx.default=jx;var Nx={};Object.defineProperty(Nx,"__esModule",{value:!0});var Lx=fg,Ux=Gw,Fx=Xw,Bx=fx,qx=Cm;function Wx(e){if(e.body&&e.body.message)return e.body.message;switch(e.status){case 429:return"Throttled by server";case 404:return"Not found from server";default:return"Error from server"}}function zx(e){return e.body?e.body.code:0}function Gx(e){return 409===e.status?new Ux.SyncNetworkError(Wx(e),e.status,zx(e),e.body):e.status?new Ux.SyncError(Wx(e),e.status,zx(e)):e instanceof qx.TransportUnavailableError?e:new Ux.SyncError(e.message,0,0)}var Vx=function(){function e(t,n,r){xa(this,e),this.clientInfo=t,this.config=n,this.transport=r}return pa(e,[{key:"createHeaders",value:function(){return{"Content-Type":"application/json","Twilio-Sync-Client-Info":JSON.stringify(this.clientInfo),"Twilio-Request-Id":"RQ"+Lx.v4().replace(/-/g,"")}}},{key:"backoffConfig",value:function(){return Object.assign({min:4e3,max:6e4,maxAttemptsTime:9e4,randomness:.2},this.config.backoffConfig)}},{key:"executeWithRetry",value:function(e){var t=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return new Promise((function(r,i){var a=[502,503,504];n&&a.push(429);var o=new Bx.Retrier(t.backoffConfig());o.on("attempt",(function(){e().then((function(e){return o.succeeded(e)})).catch((function(e){if(a.includes(e.status)){var t=parseInt(e.headers?e.headers["Retry-After"]:null);o.failed(Gx(e),isNaN(t)?null:1e3*t)}else"Twilsock disconnected"===e.message?o.failed(Gx(e)):(o.removeAllListeners(),o.cancel(),i(Gx(e)))}))})),o.on("succeeded",(function(e){r(e)})),o.on("cancelled",(function(e){return i(Gx(e))})),o.on("failed",(function(e){return i(Gx(e))})),o.start()}))}},{key:"get",value:function(e){var t=this,n=this.createHeaders();return Fx.default.debug("GET",e,"ID:",n["Twilio-Request-Id"]),this.executeWithRetry((function(){return t.transport.get(e,n,t.config.productId)}),!0)}},{key:"post",value:function(e,t,n){var r=this,i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=this.createHeaders();return null!=n&&(a["If-Match"]=n),Fx.default.debug("POST",e,"ID:",a["Twilio-Request-Id"]),this.executeWithRetry((function(){return r.transport.post(e,a,t,r.config.productId)}),i)}},{key:"put",value:function(e,t,n){var r=this,i=this.createHeaders();return null!=n&&(i["If-Match"]=n),Fx.default.debug("PUT",e,"ID:",i["Twilio-Request-Id"]),this.executeWithRetry((function(){return r.transport.put(e,i,t,r.config.productId)}),!1)}},{key:"delete",value:function(e){var t=this,n=this.createHeaders();return Fx.default.debug("DELETE",e,"ID:",n["Twilio-Request-Id"]),this.executeWithRetry((function(){return t.transport.delete(e,n,t.config.productId)}),!1)}}]),e}();Nx.NetworkService=Vx;var Hx={},Jx={};function Kx(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return $x(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return $x(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function $x(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}Object.defineProperty(Jx,"__esModule",{value:!0});var Qx=function(){function e(t,n){xa(this,e),this.services=t,this.removalHandler=n,this.subscriptionState="none",this._attachedListeners=new Map}return pa(e,[{key:"_advanceLastEventId",value:function(e,t){}},{key:"reportFailure",value:function(e){404===e.status?this.onRemoved(!1):this.broadcastEventToListeners("failure",e)}},{key:"_subscribe",value:function(){this.services.router.subscribe(this.sid,this)}},{key:"_unsubscribe",value:function(){this.services.router.unsubscribe(this.sid)}},{key:"_setSubscriptionState",value:function(e){this.subscriptionState=e,this.broadcastEventToListeners("_subscriptionStateChanged",e)}},{key:"close",value:function(){this._unsubscribe(),null!=this.removalHandler&&this.removalHandler(this.type,this.sid,this.uniqueName)}},{key:"attach",value:function(e){var t=e.listenerUuid;this._attachedListeners.get(t)||(this._attachedListeners.size||this._subscribe(),this._attachedListeners.set(t,e))}},{key:"detach",value:function(e){this._attachedListeners.delete(e),this._attachedListeners.size||this.close()}},{key:"broadcastEventToListeners",value:function(e,t){var n,r=Kx(this._attachedListeners.values());try{for(r.s();!(n=r.n()).done;){n.value.emit(e,t)}}catch(e){r.e(e)}finally{r.f()}}}]),e}();Jx.SyncEntity=Qx,Jx.default=Qx;var Yx={};Object.defineProperty(Yx,"__esModule",{value:!0});var Xx=function(){function e(t){xa(this,e),this.queuedRequests=[],this.isRequestInFlight=!1,this.inputMergingFunction=t}return pa(e,[{key:"add",value:function(e,t){var n=this,r=new Promise((function(r,i){return n.queuedRequests.push({input:e,requestFunction:t,resolve:r,reject:i})}));return this.wakeupQueue(),r}},{key:"squashAndAdd",value:function(e,t){var n,r=this.queuedRequests;this.queuedRequests=[],r.length>0?(n=r.map((function(e){return e.input})).reduce(this.inputMergingFunction),n=this.inputMergingFunction(n,e)):n=e;var i=this.add(n,t);return r.forEach((function(e){return i.then(e.resolve,e.reject)})),i}},{key:"isEmpty",value:function(){return 0===this.queuedRequests.length&&!this.isRequestInFlight}},{key:"wakeupQueue",value:function(){var e=this;if(0!==this.queuedRequests.length&&!this.isRequestInFlight){var t=this.queuedRequests.shift();this.isRequestInFlight=!0,t.requestFunction(t.input).then(t.resolve,t.reject).then((function(t){e.isRequestInFlight=!1,e.wakeupQueue()}))}}}]),e}();Yx.MergingQueue=Xx;var Zx=function(){function e(t){xa(this,e),this.queueByNamespaceKey=new Map,this.inputReducer=t}var t,n;return pa(e,[{key:"add",value:function(){var e=da(Za.mark((function e(t,n,r){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.invokeQueueMethod(t,(function(e){return e.add(n,r)})));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n,r){return e.apply(this,arguments)}}()},{key:"squashAndAdd",value:(n=da(Za.mark((function e(t,n,r){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.invokeQueueMethod(t,(function(e){return e.squashAndAdd(n,r)})));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return n.apply(this,arguments)})},{key:"invokeQueueMethod",value:(t=da(Za.mark((function e(t,n){var r,i;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.queueByNamespaceKey.has(t)||this.queueByNamespaceKey.set(t,new Xx(this.inputReducer)),r=this.queueByNamespaceKey.get(t),i=n(r),this.queueByNamespaceKey.get(t).isEmpty()&&this.queueByNamespaceKey.delete(t),e.abrupt("return",i);case 5:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})}]),e}();Yx.NamespacedMergingQueue=Zx;var e_={};function t_(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(e_,"__esModule",{value:!0});var n_=fg,r_=function(e){ma(n,e);var t=t_(n);function n(){var e;return xa(this,n),(e=t.call(this)).closed=!1,e.uuid=n_(),e}return pa(n,[{key:"listenerUuid",get:function(){return this.uuid}},{key:"close",value:function(){this.removeAllListeners(),this.closed=!0}},{key:"ensureNotClosed",value:function(){if(this.closed)throw new Error("Invalid operation on closed object")}}]),n}(Mm.EventEmitter);function i_(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}e_.Closeable=r_,e_.default=r_,Object.defineProperty(Hx,"__esModule",{value:!0});var a_=Gw,o_=Kw,s_=Xw,u_=Yx,c_=e_,l_=function(e){ma(f,e);var t,n,r,i,a,o,s,u,c,l=i_(f);function f(e,t,n){var r;xa(this,f),(r=l.call(this,e,n)).isDeleted=!1;return r.updateMergingQueue=new u_.MergingQueue((function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e})),r.descriptor=t,r.descriptor.data=r.descriptor.data||{},r.descriptor.date_updated=new Date(r.descriptor.date_updated),r}return pa(f,[{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"document"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"data",get:function(){return this.descriptor.data}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"_update",value:function(e){switch(e.date_created=new Date(e.date_created),e.type){case"document_updated":if(e.id<=this.lastEventId){s_.default.trace("Document update skipped, current:",this.lastEventId,", remote:",e.id);break}var t=void 0!==this.descriptor.data?o_.deepClone(this.descriptor.data):null;this.descriptor.last_event_id=e.id,this.descriptor.revision=e.document_revision,this.descriptor.date_updated=e.date_created,this.descriptor.data=e.document_data,this.broadcastEventToListeners("updated",{data:e.document_data,isLocal:!1,previousData:t}),this.services.storage.update(this.type,this.sid,this.uniqueName,{last_event_id:e.id,revision:e.document_revision,date_updated:e.date_created,data:e.document_data});break;case"document_removed":this.onRemoved(!1)}}},{key:"set",value:(c=da(Za.mark((function e(t,n){var r,i=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n||{},o_.validateOptionalTtl(r.ttl),e.abrupt("return",this.updateMergingQueue.squashAndAdd(r,(function(e){return i._setUnconditionally(t,e.ttl)})));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"mutate",value:(u=da(Za.mark((function e(t,n){var r,i=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n||{},o_.validateOptionalTtl(r.ttl),e.abrupt("return",this.updateMergingQueue.add(r,(function(e){return i._setWithIfMatch(t,e.ttl)})));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t){return u.apply(this,arguments)})},{key:"update",value:(s=da(Za.mark((function e(t,n){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate((function(e){return Object.assign(e,t)}),n));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t){return s.apply(this,arguments)})},{key:"setTtl",value:(o=da(Za.mark((function e(t){var n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o_.validateMandatoryTtl(t),e.next=3,this._postUpdateToServer({ttl:t});case 3:n=e.sent,this.descriptor.date_expires=n.date_expires;case 5:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"_setUnconditionally",value:(a=da(Za.mark((function e(t,n){var r;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._postUpdateToServer({data:t,revision:void 0,ttl:n});case 2:return r=e.sent,this._handleSuccessfulUpdateResult(r),e.abrupt("return",this.descriptor.data);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"_setWithIfMatch",value:(i=da(Za.mark((function e(t,n){var r,i,a;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=t(o_.deepClone(this.descriptor.data)))){e.next=22;break}return i=this.revision,e.prev=3,e.next=6,this._postUpdateToServer({data:r,revision:i,ttl:n});case 6:return a=e.sent,this._handleSuccessfulUpdateResult(a),e.abrupt("return",this.descriptor.data);case 11:if(e.prev=11,e.t0=e.catch(3),412!==e.t0.status){e.next=19;break}return e.next=16,this._softSync();case 16:return e.abrupt("return",this._setWithIfMatch(t));case 19:throw e.t0;case 20:e.next=23;break;case 22:return e.abrupt("return",this.descriptor.data);case 23:case"end":return e.stop()}}),e,this,[[3,11]])}))),function(e,t){return i.apply(this,arguments)})},{key:"_handleSuccessfulUpdateResult",value:function(e){if(!(e.last_event_id<=this.descriptor.last_event_id)){var t=void 0!==this.descriptor.data?o_.deepClone(this.descriptor.data):null;this.descriptor.revision=e.revision,this.descriptor.data=e.data,this.descriptor.last_event_id=e.last_event_id,this.descriptor.date_expires=e.date_expires,this.descriptor.date_updated=new Date(e.date_updated),this.services.storage.update(this.type,this.sid,this.uniqueName,{last_event_id:e.last_event_id,revision:e.revision,date_updated:e.date_updated,data:e.data}),this.broadcastEventToListeners("updated",{data:this.descriptor.data,isLocal:!0,previousData:t})}}},{key:"_postUpdateToServer",value:(r=da(Za.mark((function e(t){var n,r,i;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isDeleted){e.next=17;break}return n={data:t.data},void 0!==t.ttl&&(n.ttl=t.ttl),r=t.revision,e.prev=4,e.next=7,this.services.network.post(this.uri,n,r);case 7:return i=e.sent,e.abrupt("return",{revision:i.body.revision,data:t.data,last_event_id:i.body.last_event_id,date_updated:i.body.date_updated,date_expires:i.body.date_expires});case 11:throw e.prev=11,e.t0=e.catch(4),404===e.t0.status&&this.onRemoved(!1),e.t0;case 15:e.next=18;break;case 17:return e.abrupt("return",Promise.reject(new a_.SyncError("The Document has been removed",404,54100)));case 18:case"end":return e.stop()}}),e,this,[[4,11]])}))),function(e){return r.apply(this,arguments)})},{key:"_softSync",value:(n=da(Za.mark((function e(){var t=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.services.network.get(this.uri).then((function(e){var n={type:"document_updated",id:e.body.last_event_id,document_revision:e.body.revision,document_data:e.body.data,date_created:e.body.date_updated};return t._update(n),t})).catch((function(e){404===e.status?t.onRemoved(!1):s_.default.error("Can't get updates for ".concat(t.sid,":"),e)})));case 1:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"onRemoved",value:function(e){if(!this.isDeleted){var t=void 0!==this.descriptor.data?o_.deepClone(this.descriptor.data):null;this.isDeleted=!0,this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e,previousData:t})}}},{key:"removeDocument",value:(t=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isDeleted){e.next=6;break}return e.next=3,this.services.network.delete(this.uri);case 3:this.onRemoved(!0),e.next=7;break;case 6:return e.abrupt("return",Promise.reject(new a_.SyncError("The Document has been removed",404,54100)));case 7:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}],[{key:"type",get:function(){return"document"}}]),f}(Jx.SyncEntity);Hx.SyncDocumentImpl=l_;var f_=function(e){ma(s,e);var t,n,r,i,a,o=i_(s);function s(e){var t;return xa(this,s),(t=o.call(this)).syncDocumentImpl=e,t.syncDocumentImpl.attach(va(t)),t}return pa(s,[{key:"uri",get:function(){return this.syncDocumentImpl.uri}},{key:"revision",get:function(){return this.syncDocumentImpl.revision}},{key:"lastEventId",get:function(){return this.syncDocumentImpl.lastEventId}},{key:"dateExpires",get:function(){return this.syncDocumentImpl.dateExpires}},{key:"type",get:function(){return l_.type}},{key:"sid",get:function(){return this.syncDocumentImpl.sid}},{key:"data",get:function(){return this.syncDocumentImpl.data}},{key:"dateUpdated",get:function(){return this.syncDocumentImpl.dateUpdated}},{key:"uniqueName",get:function(){return this.syncDocumentImpl.uniqueName}},{key:"set",value:(a=da(Za.mark((function e(t,n){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.set(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"mutate",value:(i=da(Za.mark((function e(t,n){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.mutate(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"update",value:(r=da(Za.mark((function e(t,n){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.update(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"setTtl",value:(n=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.setTtl(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"removeDocument",value:(t=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncDocumentImpl.removeDocument());case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"close",value:function(){Pm(ka(s.prototype),"close",this).call(this),this.syncDocumentImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return l_.type}}]),s}(c_.default);Hx.SyncDocument=f_,Hx.default=f_;var d_={},h_={};Object.defineProperty(h_,"__esModule",{value:!0});var p_=function(){function e(t){xa(this,e),this.descriptor=t}return pa(e,[{key:"uri",get:function(){return this.descriptor.uri}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.lastEventId}},{key:"dateUpdated",get:function(){return this.descriptor.dateUpdated}},{key:"dateExpires",get:function(){return this.descriptor.dateExpires}},{key:"index",get:function(){return this.descriptor.index}},{key:"data",get:function(){return this.descriptor.data}},{key:"update",value:function(e,t,n,r){return this.descriptor.lastEventId=e,this.descriptor.revision=t,this.descriptor.data=n,this.descriptor.dateUpdated=r,this}},{key:"updateDateExpires",value:function(e){this.descriptor.dateExpires=e}}]),e}();h_.ListItem=p_,h_.default=p_;var v_={};Object.defineProperty(v_,"__esModule",{value:!0});var Paginator=function(){function Paginator(e,t,n,r){xa(this,Paginator),this.prevToken=n,this.nextToken=r,this.items=e,this.source=t}var e,t;return pa(Paginator,[{key:"hasNextPage",get:function(){return!!this.nextToken}},{key:"hasPrevPage",get:function(){return!!this.prevToken}},{key:"nextPage",value:(t=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasNextPage){e.next=2;break}throw new Error("No next page");case 2:return e.abrupt("return",this.source(this.nextToken));case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"prevPage",value:(e=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.hasPrevPage){e.next=2;break}throw new Error("No previous page");case 2:return e.abrupt("return",this.source(this.prevToken));case 3:case"end":return e.stop()}}),e,this)}))),function(){return e.apply(this,arguments)})}]),Paginator}();v_.Paginator=Paginator;var y_={},m_={};function g_(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return b_(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return b_(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function b_(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}Object.defineProperty(m_,"__esModule",{value:!0});var k_=function(){function e(t,n){xa(this,e),this.balanceFactor=0,this.key=t,this.value=n,this.parent=null,this.left=null,this.right=null}return pa(e,[{key:"isRoot",get:function(){return null===this.parent}},{key:"isLeaf",get:function(){return null===this.left&&null===this.right}},{key:"isLeftChild",get:function(){return this.parent.left===this}},{key:"update",value:function(e){this.value=e}},{key:"replace",value:function(e,t){e&&(this.left===t?this.left=t:this.right===t&&(this.right=t))}}]),e}(),w_=function(){function e(t,n){xa(this,e),this.isLessThan=t||function(e,t){return e<t},this.isEqual=n||function(e,t){return e===t},this.root=null,this.count=null}return pa(e,[{key:"size",get:function(){return this.count}},{key:"clear",value:function(){this.root=null,this.count=0}},{key:"set",value:function(e,t){var n=this.getNode(e);n?n.update(t):this.insert(e,t)}},{key:"insert",value:function(e,t){var n=new k_(e,t);if(this.count++,this.root){for(var r=this.root;;)if(this.isLessThan(e,r.key)){if(!r.left){r.left=n;break}r=r.left}else{if(!r.right){r.right=n;break}r=r.right}for(n.parent=r,r=n;r.parent;){var i=r.parent,a=i.balanceFactor;if(r.isLeftChild?i.balanceFactor++:i.balanceFactor--,Math.abs(i.balanceFactor)<Math.abs(a))break;if(i.balanceFactor<-1||i.balanceFactor>1){this.rebalance(i);break}r=i}}else this.root=n}},{key:"get",value:function(e){for(var t=this.root;t;){if(this.isEqual(e,t.key))return t.value;t=this.isLessThan(e,t.key)?t.left:t.right}return null}},{key:"delete",value:function(e){var t=this.getNode(e);if(!t||t.key!==e)return null;var n=t.parent,r=t.left,i=t.right;if(!!r!=!!i){var a=r||i;n||a?n&&!a?this.root=a:(n.replace(t,null),this.rebalance(n)):this.root=null}else{for(var o=t.left;o.right;)o=o.right;if(t.left===o)t.isRoot?(this.root=o,o.parent=null):(t.isLeftChild?t.parent.left=o:t.parent.right=o,o.parent=t.parent),o.right=t.right,o.right.parent=o,o.balanceFactor=t.balanceFactor,t={parent:o,isLeftChild:!0};else{var s=o.parent,u=o.left;s.right=u,u&&(u.parent=s),t.isRoot?(this.root=o,o.parent=null):(t.isLeftChild?t.parent.left=o:t.parent.right=o,o.parent=t.parent),o.right=t.right,o.right.parent=o,o.left=t.left,o.left.parent=o,o.balanceFactor=t.balanceFactor,t={parent:s,isLeftChild:!1}}}for(this.count--;t.parent;){var c=t.parent,l=c.balanceFactor;if(t.isLeftChild?c.balanceFactor-=1:c.balanceFactor+=1,Math.abs(c.balanceFactor)>Math.abs(l)){if(!(c.balanceFactor<-1||c.balanceFactor>1))break;if(this.rebalance(c),0!==c.parent.balanceFactor)break;t=c.parent}else t=c}return null}},{key:"getNode",value:function(e){for(var t=this.root;t;){if(this.isEqual(e,t.key))return t;t=this.isLessThan(e,t.key)?t.left:t.right}return null}},{key:"rebalance",value:function(e){e.balanceFactor<0?e.right.balanceFactor>0?(this.rotateRight(e.right),this.rotateLeft(e)):this.rotateLeft(e):e.balanceFactor>0&&(e.left.balanceFactor<0?(this.rotateLeft(e.left),this.rotateRight(e)):this.rotateRight(e))}},{key:"rotateLeft",value:function(e){var t=e.right;e.right=t.left,null!==t.left&&(t.left.parent=e),t.parent=e.parent,null===t.parent?this.root=t:e.isLeftChild?t.parent.left=t:t.parent.right=t,t.left=e,e.parent=t,e.balanceFactor=e.balanceFactor+1-Math.min(t.balanceFactor,0),t.balanceFactor=t.balanceFactor+1-Math.max(e.balanceFactor,0)}},{key:"rotateRight",value:function(e){var t=e.left;e.left=t.right,null!==t.right&&(t.right.parent=e),t.parent=e.parent,null===t.parent?this.root=t:e.isLeftChild?t.parent.left=t:t.parent.right=t,t.right=e,e.parent=t,e.balanceFactor=e.balanceFactor-1-Math.min(t.balanceFactor,0),t.balanceFactor=t.balanceFactor-1-Math.max(e.balanceFactor,0)}},{key:Symbol.iterator,value:Za.mark((function e(){var t,n,r;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=g_(this.getIterator()),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=9;break}return r=n.value,e.next=7,r;case 7:e.next=3;break;case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(1),t.e(e.t0);case 14:return e.prev=14,t.f(),e.finish(14);case 17:case"end":return e.stop()}}),e,this,[[1,11,14,17]])}))},{key:"getIterator",value:Za.mark((function e(){var t,n,r,i=arguments;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=i.length>0&&void 0!==i[0]?i[0]:null,n=this.root;case 2:if(!n){e.next=8;break}if(!this.isEqual(t,n.key)&&(null!==t||n.left)){e.next=5;break}return e.abrupt("break",8);case 5:n=this.isLessThan(t,n.key)||null===t?n.left:n.right,e.next=2;break;case 8:if(n){e.next=10;break}return e.abrupt("return",null);case 10:r=!0;case 11:if(!r){e.next=29;break}return e.next=14,[n.key,n.value];case 14:if(r=!1,!n.right){e.next=21;break}for(n=n.right;n.left;)n=n.left;r=!0,e.next=27;break;case 21:if(!n.parent){e.next=26;break}r=n.parent.left===n,n=n.parent,e.next=27;break;case 26:return e.abrupt("break",37);case 27:e.next=35;break;case 29:if(!n.parent){e.next=34;break}r=n.parent.left===n,n=n.parent,e.next=35;break;case 34:return e.abrupt("break",37);case 35:e.next=11;break;case 37:return e.abrupt("return",null);case 38:case"end":return e.stop()}}),e,this)}))},{key:"getReverseIterator",value:Za.mark((function e(){var t,n,r,i=arguments;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=i.length>0&&void 0!==i[0]?i[0]:null,n=this.root;case 2:if(!n){e.next=8;break}if(!this.isEqual(t,n.key)&&(null!==t||n.right)){e.next=5;break}return e.abrupt("break",8);case 5:n=this.isLessThan(t,n.key)&&null!==t?n.left:n.right,e.next=2;break;case 8:if(n){e.next=10;break}return e.abrupt("return",null);case 10:r=!0;case 11:if(!r){e.next=29;break}return e.next=14,[n.key,n.value];case 14:if(r=!1,!n.left){e.next=21;break}for(n=n.left;n.right;)n=n.right;r=!0,e.next=27;break;case 21:if(!n.parent){e.next=26;break}r=n.parent.right===n,n=n.parent,e.next=27;break;case 26:return e.abrupt("break",37);case 27:e.next=35;break;case 29:if(!n.parent){e.next=34;break}r=n.parent.right===n,n=n.parent,e.next=35;break;case 34:return e.abrupt("break",37);case 35:e.next=11;break;case 37:return e.abrupt("return",null);case 38:case"end":return e.stop()}}),e,this)}))}]),e}();function x_(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return __(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return __(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function __(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}m_.TreeMap=w_,Object.defineProperty(y_,"__esModule",{value:!0});var S_=m_,T_=function(){function e(t,n){xa(this,e),this.value=t,this.revision=n||0}return pa(e,[{key:"isValid",get:function(){return!0}}]),e}(),E_=function(){function e(t){xa(this,e),this.revision=t}return pa(e,[{key:"isValid",get:function(){return!1}}]),e}(),I_=function(){function e(){xa(this,e),this.items=new S_.TreeMap}return pa(e,[{key:"store",value:function(e,t,n){var r=this.items.get(e);return r&&r.revision>n?r.isValid?r.value:null:(this.items.set(e,new T_(t,n)),t)}},{key:"delete",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=this.items.get(e);(!r||r.revision<t||r&&!0===n)&&this.items.set(e,new E_(t))}},{key:"isKnown",value:function(e,t){var n=this.items.get(e);return n&&n.revision>=t}},{key:"get",value:function(e){var t=this.items.get(e);return t&&t.isValid?t.value:null}},{key:"has",value:function(e){var t=this.items.get(e);return t&&t.isValid}},{key:"forEach",value:function(e){if(this.items){var t,n=x_(this.items);try{for(n.s();!(t=n.n()).done;){var r=vy(t.value,2),i=r[0],a=r[1];a.isValid&&e(i,a.value)}}catch(e){n.e(e)}finally{n.f()}}}}]),e}();function R_(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}y_.Cache=I_,y_.default=I_,Object.defineProperty(d_,"__esModule",{value:!0});var C_=Kw,P_=Ww,O_=Gw,M_=Xw,A_=h_,D_=v_,j_=y_,N_=Yx,L_=e_,U_=function(e){ma(v,e);var t,n,r,i,a,o,s,u,c,l,f,d,h,p=R_(v);function v(e,t,n){var r;xa(this,v);return(r=p.call(this,e,n)).updateMergingQueue=new N_.NamespacedMergingQueue((function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e})),r.cache=new j_.Cache,r.descriptor=t,r.descriptor.date_updated=new Date(r.descriptor.date_updated),r}return pa(v,[{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"links",get:function(){return this.descriptor.links}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"list"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"_addOrUpdateItemOnServer",value:(h=da(Za.mark((function e(t,n,r,i){var a,o;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a={data:n},void 0!==i&&(a.ttl=i),e.next=4,this.services.network.post(t,a,r);case 4:return(o=e.sent).body.data=n,o.body.date_updated=new Date(o.body.date_updated),e.abrupt("return",o.body);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t,n,r){return h.apply(this,arguments)})},{key:"push",value:(d=da(Za.mark((function e(t,n){var r,i,a;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(n||{}).ttl,C_.validateOptionalTtl(r),e.next=4,this._addOrUpdateItemOnServer(this.links.items,t,void 0,r);case 4:return i=e.sent,a=Number(i.index),this._handleItemMutated(a,i.url,i.last_event_id,i.revision,t,i.date_updated,i.date_expires,!0,!1),e.abrupt("return",this.cache.get(a));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return d.apply(this,arguments)})},{key:"set",value:(f=da(Za.mark((function e(t,n,r){var i,a=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},C_.validateOptionalTtl(i.ttl),e.abrupt("return",this.updateMergingQueue.squashAndAdd(t,i,(function(e){return a._updateItemUnconditionally(t,n,e.ttl)})));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return f.apply(this,arguments)})},{key:"_updateItemUnconditionally",value:(l=da(Za.mark((function e(t,n,r){var i,a;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return i=e.sent,e.next=5,this._addOrUpdateItemOnServer(i.uri,n,void 0,r);case 5:return a=e.sent,this._handleItemMutated(t,a.url,a.last_event_id,a.revision,a.data,a.date_updated,a.date_expires,!1,!1),e.abrupt("return",this.cache.get(t));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"_updateItemWithIfMatch",value:(c=da(Za.mark((function e(t,n,r){var i,a,o,s;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:if(i=e.sent,!(a=n(C_.deepClone(i.data)))){e.next=25;break}return o=i.revision,e.prev=6,e.next=9,this._addOrUpdateItemOnServer(i.uri,a,o,r);case 9:return s=e.sent,this._handleItemMutated(t,s.url,s.last_event_id,s.revision,s.data,s.date_updated,s.date_expires,!1,!1),e.abrupt("return",this.cache.get(t));case 14:if(e.prev=14,e.t0=e.catch(6),412!==e.t0.status){e.next=22;break}return e.next=19,this._getItemFromServer(t);case 19:return e.abrupt("return",this._updateItemWithIfMatch(t,n,r));case 22:throw e.t0;case 23:e.next=26;break;case 25:return e.abrupt("return",i);case 26:case"end":return e.stop()}}),e,this,[[6,14]])}))),function(e,t,n){return c.apply(this,arguments)})},{key:"mutate",value:(u=da(Za.mark((function e(t,n,r){var i,a=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},C_.validateOptionalTtl(i.ttl),e.abrupt("return",this.updateMergingQueue.add(t,i,(function(e){return a._updateItemWithIfMatch(t,n,e.ttl)})));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"update",value:(s=da(Za.mark((function e(t,n,r){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate(t,(function(e){return Object.assign(e,n)}),r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"remove",value:function(){var e=da(Za.mark((function e(t){var n,r,i;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return n=e.sent,r=C_.deepClone(n.data),e.next=6,this.services.network.delete(n.uri);case 6:i=e.sent,this._handleItemRemoved(t,i.body.last_event_id,r,new Date(i.body.date_updated),!1);case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"get",value:function(){var e=da(Za.mark((function e(t){var n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n=this.cache.get(t))){e.next=5;break}return e.abrupt("return",n);case 5:return e.abrupt("return",this._getItemFromServer(t));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getItemFromServer",value:(o=da(Za.mark((function e(t){var n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.queryItems({index:t});case 2:if(!((n=e.sent).items.length<1)){e.next=7;break}throw new O_.SyncError("No item with index ".concat(t," found"),404,54151);case 7:return e.abrupt("return",n.items[0]);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"queryItems",value:function(){var e=da(Za.mark((function e(t){var n,r,i,a,o=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},n=new P_.UriBuilder(this.links.items).queryParam("From",t.from).queryParam("PageSize",t.limit).queryParam("Index",t.index).queryParam("PageToken",t.pageToken).queryParam("Order",t.order).build(),e.next=4,this.services.network.get(n);case 4:return r=e.sent,i=r.body.items.map((function(e){return e.date_updated=new Date(e.date_updated),o.cache.get(e.index)?o._handleItemMutated(e.index,e.url,e.last_event_id,e.revision,e.data,e.date_updated,e.date_expires,!1,!0):o.cache.store(Number(e.index),new A_.ListItem({index:Number(e.index),uri:e.url,revision:e.revision,lastEventId:e.last_event_id,dateUpdated:e.date_updated,dateExpires:e.date_expires,data:e.data}),e.last_event_id),o.cache.get(e.index)})),a=r.body.meta,e.abrupt("return",new D_.Paginator(i,(function(e){return o.queryItems({pageToken:e})}),a.previous_token,a.next_token));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getItems",value:(a=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},C_.validatePageSize(t.pageSize),t.limit=t.pageSize||t.limit||50,t.order=t.order||"asc",e.abrupt("return",this.queryItems(t));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"getContext",value:(i=da(Za.mark((function e(){var t;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.context){e.next=5;break}return e.next=3,this.services.network.get(this.links.context);case 3:t=e.sent,this._updateContextIfRequired(t.body.data,t.body.last_event_id);case 5:return e.abrupt("return",this.context);case 6:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"setTtl",value:(r=da(Za.mark((function e(t){var n,r;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return C_.validateMandatoryTtl(t),e.prev=1,n={ttl:t},e.next=5,this.services.network.post(this.uri,n);case 5:r=e.sent,this.descriptor.date_expires=r.body.date_expires,e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(1),404===e.t0.status&&this.onRemoved(!1),e.t0;case 13:case"end":return e.stop()}}),e,this,[[1,9]])}))),function(e){return r.apply(this,arguments)})},{key:"setItemTtl",value:(n=da(Za.mark((function e(t,n){var r,i,a;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return C_.validateMandatoryTtl(n),e.next=3,this.get(t);case 3:return r=e.sent,i={ttl:n},e.next=7,this.services.network.post(r.uri,i);case 7:a=e.sent,r.updateDateExpires(a.body.date_expires);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeList",value:(t=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}},{key:"shouldIgnoreEvent",value:function(e,t){return this.cache.isKnown(e,t)}},{key:"_update",value:function(e,t){var n=Number(e.item_index);switch(e.date_created=new Date(e.date_created),e.type){case"list_item_added":case"list_item_updated":this._handleItemMutated(n,e.item_url,e.id,e.item_revision,e.item_data,e.date_created,void 0,"list_item_added"===e.type,!0);break;case"list_item_removed":this._handleItemRemoved(n,e.id,e.item_data,e.date_created,!0);break;case"list_context_updated":this._handleContextUpdate(e.context_data,e.id,e.date_created);break;case"list_removed":this.onRemoved(!1)}t&&this._advanceLastEventId(e.id,e.list_revision)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e,t&&(this.descriptor.revision=t))}},{key:"_updateRootDateUpdated",value:function(e){(!this.descriptor.date_updated||e.getTime()>this.descriptor.date_updated.getTime())&&(this.descriptor.date_updated=e,this.services.storage.update(this.type,this.sid,this.uniqueName,{date_updated:e}))}},{key:"_handleItemMutated",value:function(e,t,n,r,i,a,o,s,u){if(this.shouldIgnoreEvent(e,n))M_.default.trace("Item ",e," update skipped, current:",this.lastEventId,", remote:",n);else{this._updateRootDateUpdated(a);var c=this.cache.get(e);if(!c){var l=new A_.ListItem({index:e,uri:t,lastEventId:n,revision:r,data:i,dateUpdated:a,dateExpires:o});return this.cache.store(e,l,n),void this.emitItemMutationEvent(l,u,s)}var f=C_.deepClone(c.data);c.update(n,r,i,a),this.cache.store(e,c,n),void 0!==o&&c.updateDateExpires(o),this.emitItemMutationEvent(c,u,!1,f)}}},{key:"emitItemMutationEvent",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=n?"itemAdded":"itemUpdated",a={item:e,isLocal:!t};n||(a.previousItemData=r),this.broadcastEventToListeners(i,a)}},{key:"_handleItemRemoved",value:function(e,t,n,r,i){this._updateRootDateUpdated(r),this.cache.delete(e,t),this.broadcastEventToListeners("itemRemoved",{index:e,isLocal:!i,previousItemData:n})}},{key:"_handleContextUpdate",value:function(e,t,n){this._updateRootDateUpdated(n),this._updateContextIfRequired(e,t)&&this.broadcastEventToListeners("contextUpdated",{context:e,isLocal:!1})}},{key:"_updateContextIfRequired",value:function(e,t){return!this.contextEventId||t>this.contextEventId?(this.context=e,this.contextEventId=t,!0):(M_.default.trace("Context update skipped, current:",this.lastEventId,", remote:",t),!1)}}],[{key:"type",get:function(){return"list"}}]),v}(Jx.SyncEntity);d_.SyncListImpl=U_;var F_=function(e){ma(h,e);var t,n,r,i,a,o,s,u,c,l,f,d=R_(h);function h(e){var t;return xa(this,h),(t=d.call(this)).syncListImpl=e,t.syncListImpl.attach(va(t)),t}return pa(h,[{key:"uri",get:function(){return this.syncListImpl.uri}},{key:"revision",get:function(){return this.syncListImpl.revision}},{key:"lastEventId",get:function(){return this.syncListImpl.lastEventId}},{key:"links",get:function(){return this.syncListImpl.links}},{key:"dateExpires",get:function(){return this.syncListImpl.dateExpires}},{key:"type",get:function(){return U_.type}},{key:"sid",get:function(){return this.syncListImpl.sid}},{key:"uniqueName",get:function(){return this.syncListImpl.uniqueName}},{key:"dateUpdated",get:function(){return this.syncListImpl.dateUpdated}},{key:"push",value:(f=da(Za.mark((function e(t,n){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.push(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"set",value:(l=da(Za.mark((function e(t,n,r){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.set(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return l.apply(this,arguments)})},{key:"mutate",value:(c=da(Za.mark((function e(t,n,r){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.mutate(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"update",value:(u=da(Za.mark((function e(t,n,r){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.update(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"remove",value:(s=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.remove(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"get",value:(o=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.get(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"getContext",value:(a=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.getContext());case 2:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"getItems",value:(i=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.getItems(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"setTtl",value:(r=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.setTtl(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setItemTtl",value:(n=da(Za.mark((function e(t,n){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.setItemTtl(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeList",value:(t=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncListImpl.removeList());case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"close",value:function(){Pm(ka(h.prototype),"close",this).call(this),this.syncListImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return U_.type}}]),h}(L_.default);d_.SyncList=F_,d_.default=F_;var B_={},q_={};Object.defineProperty(q_,"__esModule",{value:!0});var W_=function(){function e(t){xa(this,e),this.descriptor=t}return pa(e,[{key:"uri",get:function(){return this.descriptor.url}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"key",get:function(){return this.descriptor.key}},{key:"data",get:function(){return this.descriptor.data}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"update",value:function(e,t,n,r){return this.descriptor.last_event_id=e,this.descriptor.revision=t,this.descriptor.data=n,this.descriptor.date_updated=r,this}},{key:"updateDateExpires",value:function(e){this.descriptor.date_expires=e}}]),e}();function z_(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}q_.MapItem=W_,Object.defineProperty(B_,"__esModule",{value:!0});var G_=Kw,V_=Ww,H_=Gw,J_=Xw,K_=q_,$_=v_,Q_=y_,Y_=Yx,X_=e_,Z_=function(e){ma(h,e);var t,n,r,i,a,o,s,u,c,l,f,d=z_(h);function h(e,t,n){var r;xa(this,h);return(r=d.call(this,e,n)).updateMergingQueue=new Y_.NamespacedMergingQueue((function(e,t){return"number"==typeof t.ttl?{ttl:t.ttl}:e})),r.cache=new Q_.Cache,r.descriptor=t,r.descriptor.date_updated=new Date(r.descriptor.date_updated),t.items&&t.items.forEach((function(e){e.date_updated=new Date(e.date_updated),r.cache.store(e.key,new K_.MapItem(e),e.last_event_id)})),r}return pa(h,[{key:"uri",get:function(){return this.descriptor.url}},{key:"links",get:function(){return this.descriptor.links}},{key:"revision",get:function(){return this.descriptor.revision}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"map"}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"dateUpdated",get:function(){return this.descriptor.date_updated}},{key:"set",value:(f=da(Za.mark((function e(t,n,r){var i,a=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},G_.validateOptionalTtl(i.ttl),e.abrupt("return",this.updateMergingQueue.squashAndAdd(t,i,(function(e){return a._putItemUnconditionally(t,n,e.ttl)})));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return f.apply(this,arguments)})},{key:"get",value:function(){var e=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=t){e.next=2;break}throw new H_.SyncError("Item key may not be empty",400,54209);case 2:if(!this.cache.has(t)){e.next=6;break}return e.abrupt("return",this.cache.get(t));case 6:return e.abrupt("return",this._getItemFromServer(t));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"_getItemFromServer",value:(l=da(Za.mark((function e(t){var n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.queryItems({key:t});case 2:if(!((n=e.sent).items.length<1)){e.next=7;break}throw new H_.SyncError("The specified Map Item does not exist",404,54201);case 7:return e.abrupt("return",n.items[0]);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"mutate",value:(c=da(Za.mark((function e(t,n,r){var i,a=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r||{},G_.validateOptionalTtl(i.ttl),e.abrupt("return",this.updateMergingQueue.add(t,i,(function(e){return a._putItemWithIfMatch(t,n,e.ttl)})));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"update",value:(u=da(Za.mark((function e(t,n,r){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.mutate(t,(function(e){return Object.assign(e,n)}),r));case 1:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"_putItemUnconditionally",value:(s=da(Za.mark((function e(t,n,r){var i,a;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._putItemToServer(t,n,void 0,r);case 2:return i=e.sent,a=i.item,this._handleItemMutated(a.key,a.url,a.last_event_id,a.revision,a.data,a.date_updated,a.date_expires,i.added,!1),e.abrupt("return",this.cache.get(a.key));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"_putItemWithIfMatch",value:(o=da(Za.mark((function e(t,n,r){var i,a,o,s,u;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t).catch((function(e){if(404===e.status)return new K_.MapItem({key:t,data:{},last_event_id:-1,revision:"-1",url:null,date_updated:null,date_expires:null});throw e}));case 2:if(i=e.sent,!(a=n(G_.deepClone(i.data)))){e.next=26;break}return o=i.revision,e.prev=6,e.next=9,this._putItemToServer(t,a,o,r);case 9:return s=e.sent,u=s.item,this._handleItemMutated(u.key,u.url,u.last_event_id,u.revision,u.data,u.date_updated,u.date_expires,s.added,!1),e.abrupt("return",this.cache.get(u.key));case 15:if(e.prev=15,e.t0=e.catch(6),412!==e.t0.status){e.next=23;break}return e.next=20,this._getItemFromServer(t);case 20:return e.abrupt("return",this._putItemWithIfMatch(t,n,r));case 23:throw e.t0;case 24:e.next=27;break;case 26:return e.abrupt("return",i);case 27:case"end":return e.stop()}}),e,this,[[6,15]])}))),function(e,t,n){return o.apply(this,arguments)})},{key:"_putItemToServer",value:(a=da(Za.mark((function e(t,n,r,i){var a,o,s,u,c;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=new V_.UriBuilder(this.links.items).pathSegment(t).build(),o={data:n},void 0!==i&&(o.ttl=i),e.prev=3,e.next=6,this.services.network.put(a,o,r);case 6:return s=e.sent,(u=s.body).data=n,u.date_updated=new Date(u.date_updated),c=201===s.status.code,e.abrupt("return",{added:c,item:u});case 14:throw e.prev=14,e.t0=e.catch(3),404===e.t0.status&&this.onRemoved(!1),e.t0;case 18:case"end":return e.stop()}}),e,this,[[3,14]])}))),function(e,t,n,r){return a.apply(this,arguments)})},{key:"remove",value:function(){var e=da(Za.mark((function e(t){var n,r,i;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.get(t);case 2:return n=e.sent,r=G_.deepClone(n.data),e.next=6,this.services.network.delete(n.uri);case 6:i=e.sent,this._handleItemRemoved(t,i.body.last_event_id,r,new Date(i.body.date_updated),!1);case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"queryItems",value:function(){var e=da(Za.mark((function e(t){var n,r,i,a,o=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},n=new V_.UriBuilder(this.links.items).queryParam("From",t.from).queryParam("PageSize",t.limit).queryParam("Key",t.key).queryParam("PageToken",t.pageToken).queryParam("Order",t.order).build(),e.next=4,this.services.network.get(n);case 4:return r=e.sent,i=r.body.items.map((function(e){return e.date_updated=new Date(e.date_updated),o.cache.get(e.key)?o._handleItemMutated(e.key,e.url,e.last_event_id,e.revision,e.data,e.date_updated,e.date_expires,!1,!0):o.cache.store(e.key,new K_.MapItem(e),e.last_event_id),o.cache.get(e.key)})),a=r.body.meta,e.abrupt("return",new $_.Paginator(i,(function(e){return o.queryItems({pageToken:e})}),a.previous_token,a.next_token));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"getItems",value:(i=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},G_.validatePageSize(t.pageSize),t.limit=t.pageSize||t.limit||50,t.order=t.order||"asc",e.abrupt("return",this.queryItems(t));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"shouldIgnoreEvent",value:function(e,t){return this.cache.isKnown(e,t)}},{key:"_update",value:function(e,t){switch(e.date_created=new Date(e.date_created),e.type){case"map_item_added":case"map_item_updated":this._handleItemMutated(e.item_key,e.item_url,e.id,e.item_revision,e.item_data,e.date_created,void 0,"map_item_added"===e.type,!0);break;case"map_item_removed":this._handleItemRemoved(e.item_key,e.id,e.item_data,e.date_created,!0);break;case"map_removed":this.onRemoved(!1)}t&&this._advanceLastEventId(e.id,e.map_revision)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e,t&&(this.descriptor.revision=t))}},{key:"_updateRootDateUpdated",value:function(e){(!this.descriptor.date_updated||e.getTime()>this.descriptor.date_updated.getTime())&&(this.descriptor.date_updated=e,this.services.storage.update(this.type,this.sid,this.uniqueName,{date_updated:e}))}},{key:"_handleItemMutated",value:function(e,t,n,r,i,a,o,s,u){if(this.shouldIgnoreEvent(e,n))J_.default.trace("Item ",e," update skipped, current:",this.lastEventId,", remote:",n);else{this._updateRootDateUpdated(a);var c=this.cache.get(e);if(!c){var l=new K_.MapItem({key:e,url:t,last_event_id:n,revision:r,data:i,date_updated:a,date_expires:o});return this.cache.store(e,l,n),void this.emitItemMutationEvent(l,u,s)}var f=G_.deepClone(c.data);c.update(n,r,i,a),this.cache.store(e,c,n),void 0!==o&&c.updateDateExpires(o),this.emitItemMutationEvent(c,u,!1,f)}}},{key:"emitItemMutationEvent",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,i=n?"itemAdded":"itemUpdated",a={item:e,isLocal:!t};n||(a.previousItemData=r),this.broadcastEventToListeners(i,a)}},{key:"_handleItemRemoved",value:function(e,t,n,r,i){this._updateRootDateUpdated(r),this.cache.delete(e,t),this.broadcastEventToListeners("itemRemoved",{key:e,isLocal:!i,previousItemData:n})}},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}},{key:"setTtl",value:(r=da(Za.mark((function e(t){var n,r;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return G_.validateMandatoryTtl(t),e.prev=1,n={ttl:t},e.next=5,this.services.network.post(this.uri,n);case 5:r=e.sent,this.descriptor.date_expires=r.body.date_expires,e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(1),404===e.t0.status&&this.onRemoved(!1),e.t0;case 13:case"end":return e.stop()}}),e,this,[[1,9]])}))),function(e){return r.apply(this,arguments)})},{key:"setItemTtl",value:(n=da(Za.mark((function e(t,n){var r,i,a;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return G_.validateMandatoryTtl(n),e.next=3,this.get(t);case 3:return r=e.sent,i={ttl:n},e.next=7,this.services.network.post(r.uri,i);case 7:a=e.sent,r.updateDateExpires(a.body.date_expires);case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeMap",value:(t=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}],[{key:"type",get:function(){return"map"}}]),h}(Jx.SyncEntity);B_.SyncMapImpl=Z_;var eS=function(e){ma(f,e);var t,n,r,i,a,o,s,u,c,l=z_(f);function f(e){var t;return xa(this,f),(t=l.call(this)).syncMapImpl=e,t.syncMapImpl.attach(va(t)),t}return pa(f,[{key:"uri",get:function(){return this.syncMapImpl.uri}},{key:"links",get:function(){return this.syncMapImpl.links}},{key:"revision",get:function(){return this.syncMapImpl.revision}},{key:"lastEventId",get:function(){return this.syncMapImpl.lastEventId}},{key:"dateExpires",get:function(){return this.syncMapImpl.dateExpires}},{key:"type",get:function(){return Z_.type}},{key:"sid",get:function(){return this.syncMapImpl.sid}},{key:"uniqueName",get:function(){return this.syncMapImpl.uniqueName}},{key:"dateUpdated",get:function(){return this.syncMapImpl.dateUpdated}},{key:"set",value:(c=da(Za.mark((function e(t,n,r){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.set(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return c.apply(this,arguments)})},{key:"get",value:(u=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.get(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"mutate",value:(s=da(Za.mark((function e(t,n,r){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.mutate(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return s.apply(this,arguments)})},{key:"update",value:(o=da(Za.mark((function e(t,n,r){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.update(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return o.apply(this,arguments)})},{key:"remove",value:(a=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.remove(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"getItems",value:(i=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.getItems(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"setTtl",value:(r=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.setTtl(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setItemTtl",value:(n=da(Za.mark((function e(t,n){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncMapImpl.setItemTtl(t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"removeMap",value:(t=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.next=3,this.syncMapImpl.removeMap();case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"close",value:function(){Pm(ka(f.prototype),"close",this).call(this),this.syncMapImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return Z_.type}}]),f}(X_.Closeable);B_.SyncMap=eS,B_.default=eS;var tS={};Object.defineProperty(tS,"__esModule",{value:!0});var nS=Cb.exports,rS=function e(t){xa(this,e),this.sdk="js",this.sdkVer=t,this.os=nS.os.family,this.osVer=nS.os.version,this.pl=nS.name,this.plVer=nS.version};tS.ClientInfo=rS,tS.default=rS;var iS={};Object.defineProperty(iS,"__esModule",{value:!0});var aS=function(){function e(){xa(this,e),this.names=new Map,this.entities=new Map}return pa(e,[{key:"store",value:function(e){var t=this.entities.get(e.sid);return t||(this.entities.set(e.sid,e),e.uniqueName&&this.names.set(e.type+"::"+e.uniqueName,e.sid),e)}},{key:"getResolved",value:function(e,t){var n=this.names.get(t+"::"+e);return n?this.entities.get(n):null}},{key:"get",value:function(e,t){return this.entities.get(e)||this.getResolved(e,t)||null}},{key:"remove",value:function(e){var t=this.entities.get(e);t&&(this.entities.delete(e),t.uniqueName&&this.names.delete(t.type+"::"+t.uniqueName))}}]),e}();iS.EntitiesCache=aS;var oS={};Object.defineProperty(oS,"__esModule",{value:!0});var sS=function(){function e(t,n){xa(this,e),this.config=t,this.storageId=null;try{this.storage=n||sessionStorage}catch(e){}}return pa(e,[{key:"storageKey",value:function(e,t){return"".concat(this.storageId,"::").concat(e,"::").concat(t)}},{key:"isReady",get:function(){return this.config.sessionStorageEnabled&&!!this.storageId}},{key:"updateStorageId",value:function(e){this.storageId=e}},{key:"store",value:function(e,t,n){return this.isReady?this._store(this.storageKey(e,t),n):null}},{key:"read",value:function(e,t){return this.isReady?this._read(this.storageKey(e,t)):null}},{key:"remove",value:function(e,t,n){if(!this.isReady)return null;try{this.storage.removeItem(this.storageKey(e,t)),n&&this.storage.removeItem(this.storageKey(e,n))}catch(e){}}},{key:"update",value:function(e,t,n,r){if(!this.isReady)return null;this._apply(this.storageKey(e,t),r),n&&this._apply(this.storageKey(e,n),r)}},{key:"_store",value:function(e,t){try{this.storage.setItem(e,JSON.stringify(t))}catch(e){}}},{key:"_read",value:function(e){try{var t=this.storage.getItem(e);if(t)return JSON.parse(t)}catch(e){}return null}},{key:"_apply",value:function(e,t){var n=this._read(e);if(!n)return!1;this._store(e,Object.assign(n,t))}}]),e}();oS.SessionStorage=sS;var uS={};function cS(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(uS,"__esModule",{value:!0});var lS=Kw,fS=e_,dS=function(e){ma(a,e);var t,n,r,i=cS(a);function a(e,t,n){var r;return xa(this,a),(r=i.call(this,e,n)).descriptor=t,r}return pa(a,[{key:"uri",get:function(){return this.descriptor.url}},{key:"links",get:function(){return this.descriptor.links}},{key:"dateExpires",get:function(){return this.descriptor.date_expires}},{key:"type",get:function(){return"stream"}},{key:"lastEventId",get:function(){return null}},{key:"indexName",get:function(){}},{key:"queryString",get:function(){}},{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return this.descriptor.unique_name||null}},{key:"publishMessage",value:(r=da(Za.mark((function e(t){var n,r,i,a;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={data:t},e.next=3,this.services.network.post(this.links.messages,n);case 3:return r=e.sent,i=r.body,a=this._handleMessagePublished(i.sid,t,!1),e.abrupt("return",a);case 7:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setTtl",value:(n=da(Za.mark((function e(t){var n,r;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return lS.validateMandatoryTtl(t),e.prev=1,n={ttl:t},e.next=5,this.services.network.post(this.uri,n);case 5:r=e.sent,this.descriptor.date_expires=r.body.date_expires,e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(1),404===e.t0.status&&this.onRemoved(!1),e.t0;case 13:case"end":return e.stop()}}),e,this,[[1,9]])}))),function(e){return n.apply(this,arguments)})},{key:"removeStream",value:(t=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.network.delete(this.uri);case 2:this.onRemoved(!0);case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"_update",value:function(e){switch(e.type){case"stream_message_published":this._handleMessagePublished(e.message_sid,e.message_data,!0);break;case"stream_removed":this.onRemoved(!1)}}},{key:"_handleMessagePublished",value:function(e,t,n){var r={sid:e,value:t};return this.broadcastEventToListeners("messagePublished",{message:r,isLocal:!n}),r}},{key:"onRemoved",value:function(e){this._unsubscribe(),this.removalHandler(this.type,this.sid,this.uniqueName),this.broadcastEventToListeners("removed",{isLocal:e})}}],[{key:"type",get:function(){return"stream"}}]),a}(Jx.SyncEntity);uS.SyncStreamImpl=dS;var hS=function(e){ma(a,e);var t,n,r,i=cS(a);function a(e){var t;return xa(this,a),(t=i.call(this)).syncStreamImpl=e,t.syncStreamImpl.attach(va(t)),t}return pa(a,[{key:"uri",get:function(){return this.syncStreamImpl.uri}},{key:"links",get:function(){return this.syncStreamImpl.links}},{key:"dateExpires",get:function(){return this.syncStreamImpl.dateExpires}},{key:"type",get:function(){return dS.type}},{key:"lastEventId",get:function(){return null}},{key:"sid",get:function(){return this.syncStreamImpl.sid}},{key:"uniqueName",get:function(){return this.syncStreamImpl.uniqueName}},{key:"publishMessage",value:(r=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.publishMessage(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"setTtl",value:(n=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.setTtl(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"removeStream",value:(t=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.ensureNotClosed(),e.abrupt("return",this.syncStreamImpl.removeStream());case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"close",value:function(){Pm(ka(a.prototype),"close",this).call(this),this.syncStreamImpl.detach(this.listenerUuid)}}],[{key:"type",get:function(){return dS.type}}]),a}(fS.default);uS.SyncStream=hS,uS.default=hS;var pS={};function vS(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(pS,"__esModule",{value:!0});var yS=Ww,mS=Gw,gS=Xw,bS=Mm,kS=Jx,wS=e_,xS=y_;pS.InsightsItem=function e(){xa(this,e)};var _S=function(e){ma(n,e);var t=vS(n);function n(e,r,i,a){var o;return xa(this,n),(o=t.call(this,r,i)).descriptor=e,o.cache=new xS.Cache,a&&a.forEach((function(e){o.cache.store(e.key,{key:e.key,value:e.data},e.revision)})),o}return pa(n,[{key:"sid",get:function(){return this.descriptor.sid}},{key:"uniqueName",get:function(){return null}},{key:"type",get:function(){return n.type}},{key:"lastEventId",get:function(){return this.descriptor.last_event_id}},{key:"indexName",get:function(){return this.descriptor.indexName}},{key:"queryString",get:function(){return this.descriptor.queryExpression}},{key:"queryUri",get:function(){return this.descriptor.queryUri}},{key:"liveQueryDescriptor",get:function(){return this.descriptor}},{key:"onRemoved",value:function(){}},{key:"getItems",value:function(){var e={};return this.cache.forEach((function(t,n){e[t]=n.value})),e}},{key:"_update",value:function(e,t){switch(e.type){case"live_query_item_updated":this.handleItemMutated(e.item_key,e.item_data,e.item_revision);break;case"live_query_item_removed":this.handleItemRemoved(e.item_key,e.item_revision);break;case"live_query_updated":this.handleBatchUpdate(e.items)}t&&this._advanceLastEventId(e.last_event_id)}},{key:"handleItemMutated",value:function(e,t,n){if(this.shouldIgnoreEvent(e,n))gS.default.trace("Item ".concat(e," update skipped, revision: ").concat(n));else{var r={key:e,value:t};this.cache.store(e,r,n),this.broadcastEventToListeners("itemUpdated",r)}}},{key:"handleItemRemoved",value:function(e,t){var n=null===t;this.shouldIgnoreEvent(e,t)?gS.default.trace("Item ".concat(e," delete skipped, revision: ").concat(t)):(this.cache.delete(e,t,n),this.broadcastEventToListeners("itemRemoved",{key:e}))}},{key:"handleBatchUpdate",value:function(e){var t=this,n={};for(var r in null!=e&&e.forEach((function(e){n[e.key]={data:e.data,revision:e.revision}})),this.cache.forEach((function(e,r){var i=n[e];null!=i?t.handleItemMutated(e,i.data,i.revision):t.handleItemRemoved(e,null),delete n[e]})),n)this.handleItemMutated(r,n[r].data,n[r].revision)}},{key:"shouldIgnoreEvent",value:function(e,t){return null!=e&&null!=t&&this.cache.isKnown(e,t)}},{key:"_advanceLastEventId",value:function(e,t){this.lastEventId<e&&(this.descriptor.last_event_id=e)}}],[{key:"type",get:function(){return"live_query"}}]),n}(kS.SyncEntity);function SS(e){return TS.apply(this,arguments)}function TS(){return(TS=da(Za.mark((function e(t){var n,r,i,a,o,s;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.network,r=t.queryString,i=t.uri,a=t.type,null!=r){e.next=3;break}throw new mS.SyncError("Invalid query",400,54507);case 3:return o={query_string:r},a===ES.type&&(o.type=a),e.next=7,n.post(i,o,void 0,!0);case 7:return s=e.sent,e.abrupt("return",s.body);case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}pS.LiveQueryImpl=_S,pS.queryItems=SS;var ES=function(e){ma(n,e);var t=vS(n);function n(e){var r;return xa(this,n),(r=t.call(this)).liveQueryImpl=e,r.liveQueryImpl.attach(va(r)),r}return pa(n,[{key:"type",get:function(){return _S.type}},{key:"lastEventId",get:function(){return this.liveQueryImpl.lastEventId}},{key:"sid",get:function(){return this.liveQueryImpl.sid}},{key:"close",value:function(){Pm(ka(n.prototype),"close",this).call(this),this.liveQueryImpl.detach(this.listenerUuid)}},{key:"getItems",value:function(){return this.ensureNotClosed(),this.liveQueryImpl.getItems()}}],[{key:"type",get:function(){return _S.type}}]),n}(wS.Closeable);pS.LiveQuery=ES;var IS=function(e){ma(i,e);var t,n,r=vS(i);function i(e){var t;return xa(this,i),(t=r.call(this)).queryExpression=null,t.items={},Object.assign(va(t),e),t.updateIndexName(e.indexName),t}return pa(i,[{key:"type",get:function(){return i.type}},{key:"search",value:(n=da(Za.mark((function e(t){var n=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.items={},e.abrupt("return",SS({network:this.network,uri:this.queryUri,queryString:t}).then((function(e){n.queryExpression=t,e.items&&e.items.forEach((function(e){n.items[e.key]=e.data})),n.emit("searchResult",n.getItems())})).catch((function(e){throw gS.default.error("Error '".concat(e.message,"' while executing query '").concat(t,"'")),n.queryExpression=null,e})));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"subscribe",value:(t=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=this.queryExpression){e.next=2;break}return e.abrupt("return",Promise.reject(new mS.SyncError("Invalid query",400,54507)));case 2:return e.abrupt("return",this.liveQueryCreator(this.indexName,this.queryExpression));case 3:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"getItems",value:function(){return this.items}},{key:"updateIndexName",value:function(e){if(!e||"string"!=typeof e)throw new Error("Index name must contain a non-empty string value");this.indexName=e,this.queryUri=this.generateQueryUri(this.indexName)}},{key:"generateQueryUri",value:function(e){return new yS.UriBuilder(this.insightsUri).pathSegment(e).pathSegment("Items").build()}}],[{key:"type",get:function(){return"instant_query"}}]),i}(bS.EventEmitter);pS.InstantQuery=IS,pS.default=ES;var RS="1.0.0";function CS(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(qw,"__esModule",{value:!0});var PS=Cm,OS=Qk,MS=Ww,AS=Gw,DS=Kw,jS=Xw,NS=tx,LS=lx,US=Cx,FS=Nx,BS=Hx,qS=d_,WS=B_,zS=tS,GS=iS,VS=oS,HS=uS,JS=pS,KS=pS,$S="data_sync",QS=RS;function YS(e){if(e){if("string"==typeof e)return{id:e,mode:"open_or_create"};DS.validateOptionalTtl(e.ttl),DS.validateId(e.id),e.mode&&DS.validateMode(e.mode);var t=e.mode||(e.id?"open_or_create":"create_new");return Object.assign(Object.assign({},e),{mode:t})}return{mode:"create_new"}}var XS=function(e){ma(Client,e);var t,n,r,i,a,o,s,u,c,l,f,d,h,p,v,y=CS(Client);function Client(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(xa(this,Client),t=y.call(this),!e)throw new Error("Sync library needs a valid Twilio token to be passed");n.hasOwnProperty("logLevel")?jS.default.setLevel(n.logLevel):jS.default.setLevel("silent");var r=n.productId=n.productId||$S;n.clientMetadata=n.clientMetadata||{},n.clientMetadata.hasOwnProperty("type")||(n.clientMetadata.type="sync"),n.clientMetadata.hasOwnProperty("sdk")||(n.clientMetadata.sdk="JS",n.clientMetadata.sdkv=QS);var i=n.twilsockClient=n.twilsockClient||new PS.Twilsock(e,r,n);i.on("tokenAboutToExpire",(function(e){return t.emit("tokenAboutToExpire",e)})),i.on("tokenExpired",(function(){return t.emit("tokenExpired")})),i.on("connectionError",(function(e){return t.emit("connectionError",e)}));var a=n.notificationsClient=n.notificationsClient||new OS.Notifications(e,n),o=new NS.Configuration(n),s=new FS.NetworkService(new zS.ClientInfo(QS),o,i),u=new VS.SessionStorage(o);t.localStorageId=null,i.connect(),t.services={config:o,twilsock:i,notifications:a,network:s,storage:u,router:null,subscriptions:null};var c=new LS.Subscriptions(t.services),l=new US.Router({config:o,subscriptions:c,notifications:a});return t.services.router=l,t.services.subscriptions=c,t.entities=new GS.EntitiesCache,a.on("connectionStateChanged",(function(){t.emit("connectionStateChanged",t.services.notifications.connectionState)})),t}return pa(Client,[{key:"connectionState",get:function(){return this.services.notifications.connectionState}},{key:"ensureReady",value:(v=da(Za.mark((function e(){var t;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.services.config.sessionStorageEnabled){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,e.next=5,this.services.twilsock.storageId();case 5:t=e.sent,this.services.storage.updateStorageId(t.id),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(2),jS.default.warn("Failed to initialize storage",e.t0);case 12:case"end":return e.stop()}}),e,this,[[2,9]])}))),function(){return v.apply(this,arguments)})},{key:"storeRootInSessionCache",value:function(e,t,n){if(this.services.config.sessionStorageEnabled&&t){var r=DS.deepClone(n);e!==qS.SyncList.type&&e!==WS.SyncMap.type||(r.last_event_id=null,delete r.items),this.services.storage.store(e,t,r)}}},{key:"readRootFromSessionCache",value:function(e,t){return this.services.config.sessionStorageEnabled&&t?this.services.storage.read(e,t):null}},{key:"_get",value:(p=da(Za.mark((function e(t,n){var r,i,a,o=arguments;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=o.length>2&&void 0!==o[2]&&o[2],n){e.next=3;break}throw new AS.SyncError("Cannot get entity without id",404);case 3:return i=new MS.UriBuilder(t).pathSegment(n).queryParam("Include",r?"items":void 0).build(),e.next=6,this.services.network.get(i);case 6:return a=e.sent,e.abrupt("return",a.body);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return p.apply(this,arguments)})},{key:"_createDocument",value:function(e,t,n){var r={unique_name:e,data:t||{}};return void 0!==n&&(r.ttl=n),this.services.network.post(this.services.config.documentsUri,r).then((function(e){return e.body.data=r.data,e.body}))}},{key:"_getDocument",value:(h=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(BS.SyncDocument.type,t)||this._get(this.services.config.documentsUri,t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"_createList",value:function(e,t,n,r){var i={unique_name:e,purpose:t,context:n};return void 0!==r&&(i.ttl=r),this.services.network.post(this.services.config.listsUri,i).then((function(e){return e.body}))}},{key:"_getList",value:(d=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(qS.SyncList.type,t)||this._get(this.services.config.listsUri,t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"_createMap",value:function(e,t){var n={unique_name:e};return void 0!==t&&(n.ttl=t),this.services.network.post(this.services.config.mapsUri,n).then((function(e){return e.body}))}},{key:"_getMap",value:(f=da(Za.mark((function e(t){var n,r=arguments;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.length>1&&void 0!==r[1]&&r[1],e.abrupt("return",this.readRootFromSessionCache(WS.SyncMap.type,t)||this._get(this.services.config.mapsUri,t,n));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"_getStream",value:(l=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.readRootFromSessionCache(HS.SyncStream.type,t)||this._get(this.services.config.streamsUri,t,!1));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"_createStream",value:(c=da(Za.mark((function e(t,n){var r,i;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={unique_name:t},void 0!==n&&(r.ttl=n),e.next=4,this.services.network.post(this.services.config.streamsUri,r);case 4:return i=e.sent,e.abrupt("return",i.body);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return c.apply(this,arguments)})},{key:"_getLiveQuery",value:function(e){return this.readRootFromSessionCache(JS.LiveQuery.type,e)}},{key:"getCached",value:function(e,t){return e&&this.entities.get(e,t)||null}},{key:"removeFromCacheAndSession",value:function(e,t,n){this.entities.remove(t),this.services.config.sessionStorageEnabled&&this.services.storage.remove(e,t,n)}},{key:"document",value:(u=da(Za.mark((function e(t){var n,r,i,a,o=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"!==(n=YS(t)).mode){e.next=9;break}return e.next=6,this._createDocument(n.id,n.data,n.ttl);case 6:r=e.sent,e.next=39;break;case 9:if(!(i=this.getCached(n.id,BS.SyncDocument.type))){e.next=14;break}return e.abrupt("return",new BS.SyncDocument(i));case 14:return e.prev=14,e.next=17,this._getDocument(n.id);case 17:r=e.sent,e.next=39;break;case 20:if(e.prev=20,e.t0=e.catch(14),404===e.t0.status&&"open_existing"!==n.mode){e.next=26;break}throw e.t0;case 26:return e.prev=26,e.next=29,this._createDocument(n.id,n.data,n.ttl);case 29:r=e.sent,e.next=39;break;case 32:if(e.prev=32,e.t1=e.catch(26),409!==e.t1.status){e.next=38;break}return e.abrupt("return",this.document(t));case 38:throw e.t1;case 39:return this.storeRootInSessionCache(BS.SyncDocument.type,n.id,r),a=new BS.SyncDocumentImpl(this.services,r,(function(e,t,n){return o.removeFromCacheAndSession(e,t,n)})),a=this.entities.store(a),e.abrupt("return",new BS.SyncDocument(a));case 43:case"end":return e.stop()}}),e,this,[[14,20],[26,32]])}))),function(e){return u.apply(this,arguments)})},{key:"map",value:(s=da(Za.mark((function e(t){var n,r,i,a,o=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"!==(n=YS(t)).mode){e.next=9;break}return e.next=6,this._createMap(n.id,n.ttl);case 6:r=e.sent,e.next=39;break;case 9:if(!(i=this.getCached(n.id,WS.SyncMap.type))){e.next=14;break}return e.abrupt("return",new WS.SyncMap(i));case 14:return e.prev=14,e.next=17,this._getMap(n.id,n.includeItems);case 17:r=e.sent,e.next=39;break;case 20:if(e.prev=20,e.t0=e.catch(14),404===e.t0.status&&"open_existing"!==n.mode){e.next=26;break}throw e.t0;case 26:return e.prev=26,e.next=29,this._createMap(n.id,n.ttl);case 29:r=e.sent,e.next=39;break;case 32:if(e.prev=32,e.t1=e.catch(26),409!==e.t1.status){e.next=38;break}return e.abrupt("return",this.map(t));case 38:throw e.t1;case 39:return this.storeRootInSessionCache(WS.SyncMap.type,n.id,r),a=new WS.SyncMapImpl(this.services,r,(function(e,t,n){return o.removeFromCacheAndSession(e,t,n)})),a=this.entities.store(a),e.abrupt("return",new WS.SyncMap(a));case 43:case"end":return e.stop()}}),e,this,[[14,20],[26,32]])}))),function(e){return s.apply(this,arguments)})},{key:"list",value:(o=da(Za.mark((function e(t){var n,r,i,a,o=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"!==(n=YS(t)).mode){e.next=9;break}return e.next=6,this._createList(n.id,n.purpose,n.context,n.ttl);case 6:r=e.sent,e.next=39;break;case 9:if(!(i=this.getCached(n.id,qS.SyncList.type))){e.next=14;break}return e.abrupt("return",new qS.SyncList(i));case 14:return e.prev=14,e.next=17,this._getList(n.id);case 17:r=e.sent,e.next=39;break;case 20:if(e.prev=20,e.t0=e.catch(14),404===e.t0.status&&"open_existing"!==n.mode){e.next=26;break}throw e.t0;case 26:return e.prev=26,e.next=29,this._createList(n.id,n.purpose,n.context,n.ttl);case 29:r=e.sent,e.next=39;break;case 32:if(e.prev=32,e.t1=e.catch(26),409!==e.t1.status){e.next=38;break}return e.abrupt("return",this.list(t));case 38:throw e.t1;case 39:return this.storeRootInSessionCache(qS.SyncList.type,n.id,r),a=new qS.SyncListImpl(this.services,r,(function(e,t,n){return o.removeFromCacheAndSession(e,t,n)})),a=this.entities.store(a),e.abrupt("return",new qS.SyncList(a));case 43:case"end":return e.stop()}}),e,this,[[14,20],[26,32]])}))),function(e){return o.apply(this,arguments)})},{key:"stream",value:(a=da(Za.mark((function e(t){var n,r,i,a,o,s=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if("create_new"!==(n=YS(t)).mode){e.next=9;break}return e.next=6,this._createStream(n.id,n.ttl);case 6:r=e.sent,e.next=39;break;case 9:if(!(i=this.getCached(n.id,HS.SyncStream.type))){e.next=14;break}return e.abrupt("return",new HS.SyncStream(i));case 14:return e.prev=14,e.next=17,this._getStream(n.id);case 17:r=e.sent,e.next=39;break;case 20:if(e.prev=20,e.t0=e.catch(14),404===e.t0.status&&"open_existing"!==n.mode){e.next=26;break}throw e.t0;case 26:return e.prev=26,e.next=29,this._createStream(n.id,n.ttl);case 29:r=e.sent,e.next=39;break;case 32:if(e.prev=32,e.t1=e.catch(26),409!==e.t1.status){e.next=38;break}return e.abrupt("return",this.stream(t));case 38:throw e.t1;case 39:return this.storeRootInSessionCache(HS.SyncStream.type,n.id,r),a=function(e,t,n){return s.removeFromCacheAndSession(e,t,n)},o=new HS.SyncStreamImpl(this.services,r,a),o=this.entities.store(o),e.abrupt("return",new HS.SyncStream(o));case 44:case"end":return e.stop()}}),e,this,[[14,20],[26,32]])}))),function(e){return a.apply(this,arguments)})},{key:"shutdown",value:(i=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.subscriptions.shutdown();case 2:return e.next=4,this.services.twilsock.disconnect();case 4:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"updateToken",value:(r=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return",Promise.reject(new Error("A valid Twilio token should be provided")));case 2:return e.abrupt("return",this.services.twilsock.updateToken(t).catch((function(e){var t,n=null===(t=null==e?void 0:e.reply)||void 0===t?void 0:t.status;if(401===(null==n?void 0:n.code)&&"UNAUTHORIZED"===(null==n?void 0:n.status))throw new AS.SyncError("Updated token was rejected by server",400,51130);throw e})));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"liveQuery",value:(n=da(Za.mark((function e(t,n){var r,i,a,o,s,u=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:if(t&&"string"==typeof t){e.next=4;break}throw new Error("Index name must contain a non-empty string value");case 4:return r=new MS.UriBuilder(this.services.config.insightsUri).pathSegment(t).pathSegment("Items").build(),e.next=7,KS.queryItems({network:this.services.network,uri:r,queryString:n,type:JS.LiveQuery.type});case 7:return i=e.sent,(a=this.getCached(i.query_id,JS.LiveQuery.type))||((o=this._getLiveQuery(i.query_id))||(o={indexName:t,queryExpression:n,sid:i.query_id,queryUri:r,last_event_id:i.last_event_id}),s=function(e,t,n){return u.removeFromCacheAndSession(e,t,n)},a=new JS.LiveQueryImpl(o,this.services,s,i.items)),this.storeRootInSessionCache(JS.LiveQuery.type,i.query_id,a.liveQueryDescriptor),a=this.entities.store(a),e.abrupt("return",new JS.LiveQuery(a));case 13:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"instantQuery",value:(t=da(Za.mark((function e(t){var n,r,i=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ensureReady();case 2:return n=function(e,t){return i.liveQuery(e,t)},r=new JS.InstantQuery({indexName:t,network:this.services.network,insightsUri:this.services.config.insightsUri,liveQueryCreator:n}),e.abrupt("return",r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}],[{key:"version",get:function(){return QS}}]),Client}(Mm.EventEmitter);qw.Client=XS,qw.SyncClient=XS,qw.default=XS,function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=qw;t.SyncClient=n.SyncClient;var r=Hx;t.SyncDocument=r.SyncDocument;var i=d_;t.SyncList=i.SyncList;var a=h_;t.SyncListItem=a.ListItem;var o=B_;t.SyncMap=o.SyncMap;var s=q_;t.SyncMapItem=s.MapItem,t.default=n.SyncClient,e.exports=n.SyncClient,e.exports.SyncClient=n.SyncClient}(Bw,Bw.exports);var ZS={},eT={};Object.defineProperty(eT,"__esModule",{value:!0});var tT=gd.exports;function nT(e,t){return["".concat((new Date).toISOString()," MCS Client ").concat(e,":")].concat(Array.from(t))}var rT=function(){function e(t){xa(this,e),this.prefix="",this.prefix=null!=t&&t.length>0?t+" ":""}return pa(e,[{key:"setLevel",value:function(e){tT.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];tT.trace.apply(null,nT(this.prefix+"T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];tT.debug.apply(null,nT(this.prefix+"D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];tT.info.apply(null,nT(this.prefix+"I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];tT.warn.apply(null,nT(this.prefix+"W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];tT.error.apply(null,nT(this.prefix+"E",t))}}],[{key:"scope",value:function(t){return new e(t)}},{key:"setLevel",value:function(e){tT.setLevel(e)}},{key:"trace",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];tT.trace.apply(null,nT("T",t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];tT.debug.apply(null,nT("D",t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];tT.info.apply(null,nT("I",t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];tT.warn.apply(null,nT("W",t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];tT.error.apply(null,nT("E",t))}}]),e}();eT.Logger=rT;var iT={};Object.defineProperty(iT,"__esModule",{value:!0});var aT=function(){function e(t,n,r){xa(this,e);var i=r.MCS||r||{};this.region=i.region||r.region,this.baseUrl=(void 0===this.region?"https://mcs.us1.twilio.com":"https://mcs.".concat(this.region,".twilio.com"))+n,this.token=t,this.retryWhenThrottledOverride=i.retryWhenThrottledOverride,this.backoffConfigOverride=i.backoffConfigOverride}return pa(e,[{key:"updateToken",value:function(e){this.token=e}}],[{key:"backoffConfigDefault",get:function(){return{min:1e3,max:4e3,maxAttemptsCount:3}}},{key:"retryWhenThrottledDefault",get:function(){return true}}]),e}();iT.Configuration=aT;var oT={};Object.defineProperty(oT,"__esModule",{value:!0});var sT=function(){function Media(e,t,n){xa(this,Media),this.config=e,this.network=t,this._update(n)}var e;return pa(Media,[{key:"sid",get:function(){return this.state.sid}},{key:"serviceSid",get:function(){return this.state.serviceSid}},{key:"dateCreated",get:function(){return this.state.dateCreated}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"contentType",get:function(){return this.state.contentType}},{key:"size",get:function(){return this.state.size}},{key:"fileName",get:function(){return this.state.filename}},{key:"getContentUrl",value:(e=da(Za.mark((function e(){var t;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.network.get("".concat(this.config.baseUrl,"/").concat(this.sid));case 2:return t=e.sent,this._update(t.body),e.abrupt("return",Promise.resolve(this.state.contentDirectUrl));case 5:case"end":return e.stop()}}),e,this)}))),function(){return e.apply(this,arguments)})},{key:"_update",value:function(e){this.state={sid:e.sid,serviceSid:e.service_sid,channelSid:e.channel_sid,messageSid:e.message_sid,dateCreated:e.date_created?new Date(e.date_created):null,dateUpdated:e.date_updated?new Date(e.date_updated):null,size:e.size,contentType:e.content_type,url:e.url,contentUrl:e.links.content,contentDirectUrl:e.links.content_direct_temporary,filename:e.filename?e.filename:null}}}]),Media}();oT.Media=sT;var uT={},cT={};function lT(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(cT,"__esModule",{value:!0});var fT=function(e){ma(n,e);var t=lT(n);function n(e,r,i,a,o){var s;return xa(this,n),(s=t.call(this,e)).code=r,s.body=i,s.status=a,s.headers=o,s}return n}(Xg(Error));cT.TransportError=fT,Object.defineProperty(uT,"__esModule",{value:!0});var dT=cT,hT=t.XMLHttpRequest||zb.XMLHttpRequest;var pT=function(){function e(){xa(this,e)}return pa(e,[{key:"get",value:function(t,n){return e.request("GET",t,n)}},{key:"post",value:function(t,n,r){return e.request("POST",t,n,r)}}],[{key:"request",value:function(e,t,n,r){return new Promise((function(i,a){var o=new hT;for(var s in o.open(e,t,!0),o.onreadystatechange=function(){if(4===o.readyState){var e,t=(e=o.getAllResponseHeaders())?e.split("\r\n").map((function(e){return e.split(": ")})).filter((function(e){return 2===e.length&&e[1].length>0})).reduce((function(e,t){return e[t[0]]=t[1],e}),{}):{},n=function(e){var t=e.getResponseHeader("Content-Type");if(!t||0!==t.indexOf("application/json")||0===e.responseText.length)return e.responseText;try{return JSON.parse(e.responseText)}catch(t){return e.responseText}}(o);if(200<=o.status&&o.status<300)i({status:o.status,headers:t,body:n});else{var r,s=o.statusText&&o.statusText.code?o.statusText.code:"NONE";r="string"==typeof n?n&&1===n.split("\n",2).length?n:"":JSON.stringify(n);var u="".concat(o.status,": [").concat(s,"] ").concat(r);a(new dT.TransportError(u,o.status,n,s,t))}}},n)o.setRequestHeader(s,n[s]),"Content-Type"===s&&"application/json"===n[s]&&(r=JSON.stringify(r));o.send(r)}))}}]),e}();uT.Transport=pT;var vT={},yT={},mT={};function gT(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Object.defineProperty(mT,"__esModule",{value:!0});var bT=function(e){ma(n,e);var t=gT(n);function n(e){var r;return xa(this,n),(r=t.call(this)).minDelay=e.min,r.maxDelay=e.max,r.initialDelay=e.initial||0,r.maxAttemptsCount=e.maxAttemptsCount||0,r.maxAttemptsTime=e.maxAttemptsTime||0,r.randomness=e.randomness||0,r.inProgress=!1,r.attemptNum=0,r.prevDelay=0,r.currDelay=0,r}return pa(n,[{key:"attempt",value:function(){clearTimeout(this.timeout),this.attemptNum++,this.timeout=null,this.emit("attempt",this)}},{key:"nextDelay",value:function(e){if("number"==typeof e)return this.prevDelay=0,this.currDelay=e,e;if(0==this.attemptNum)return this.initialDelay;if(1==this.attemptNum)return this.currDelay=this.minDelay,this.currDelay;this.prevDelay=this.currDelay;var t=this.currDelay+this.prevDelay;return this.maxDelay&&t>this.maxDelay&&(this.currDelay=this.maxDelay,t=this.maxDelay),this.currDelay=t,t}},{key:"randomize",value:function(e){var t=e*this.randomness,n=Math.round(Math.random()*t*2-t);return Math.max(0,e+n)}},{key:"scheduleAttempt",value:function(e){var t=this;if(this.maxAttemptsCount&&this.attemptNum>=this.maxAttemptsCount)return this.cleanup(),this.emit("failed",new Error("Maximum attempt count limit reached")),void this.reject(new Error("Maximum attempt count reached"));var n=this.nextDelay(e);if(n=this.randomize(n),this.maxAttemptsTime&&this.startTimestamp+this.maxAttemptsTime<Date.now()+n)return this.cleanup(),this.emit("failed",new Error("Maximum attempt time limit reached")),void this.reject(new Error("Maximum attempt time limit reached"));this.timeout=setTimeout((function(){return t.attempt()}),n)}},{key:"cleanup",value:function(){clearTimeout(this.timeout),this.timeout=null,this.inProgress=!1,this.attemptNum=0,this.prevDelay=0,this.currDelay=0}},{key:"start",value:function(){var e=this;if(this.inProgress)throw new Error("Retrier is already in progress");return this.inProgress=!0,new Promise((function(t,n){e.resolve=t,e.reject=n,e.startTimestamp=Date.now(),e.scheduleAttempt(e.initialDelay)}))}},{key:"cancel",value:function(){this.timeout&&(clearTimeout(this.timeout),this.timeout=null,this.inProgress=!1,this.emit("cancelled"),this.reject(new Error("Cancelled")))}},{key:"succeeded",value:function(e){this.emit("succeeded",e),this.resolve(e)}},{key:"failed",value:function(e,t){if(this.timeout)throw new Error("Retrier attempt is already in progress");this.scheduleAttempt(t)}},{key:"run",value:function(e){var t=this;return this.on("attempt",(function(){e().then((function(e){return t.succeeded(e)})).catch((function(e){return t.failed(e)}))})),this.start()}}]),n}(Mm.EventEmitter);mT.Retrier=bT,mT.default=bT;var kT={};function wT(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}function xT(e){return null!=e}Object.defineProperty(kT,"__esModule",{value:!0});var _T=function(e){ma(n,e);var t=wT(n);function n(e){var r;if(xa(this,n),r=t.call(this),xT((e=e||{}).initialDelay)&&e.initialDelay<1)throw new Error("The initial timeout must be equal to or greater than 1.");if(xT(e.maxDelay)&&e.maxDelay<=1)throw new Error("The maximal timeout must be greater than 1.");if(xT(e.randomisationFactor)&&(e.randomisationFactor<0||e.randomisationFactor>1))throw new Error("The randomisation factor must be between 0 and 1.");if(xT(e.factor)&&e.factor<=1)throw new Error("Exponential factor should be greater than 1.");if(r.initialDelay=e.initialDelay||100,r.maxDelay=e.maxDelay||1e4,r.maxDelay<=r.initialDelay)throw new Error("The maximal backoff delay must be greater than the initial backoff delay.");return r.randomisationFactor=e.randomisationFactor||0,r.factor=e.factor||2,r.maxNumberOfRetry=-1,r.reset(),r}return pa(n,[{key:"backoff",value:function(e){null==this.timeoutID&&(this.backoffNumber===this.maxNumberOfRetry?(this.emit("fail",e),this.reset()):(this.backoffDelay=this.next(),this.timeoutID=setTimeout(this.onBackoff.bind(this),this.backoffDelay),this.emit("backoff",this.backoffNumber,this.backoffDelay,e)))}},{key:"reset",value:function(){this.backoffDelay=0,this.nextBackoffDelay=this.initialDelay,this.backoffNumber=0,clearTimeout(this.timeoutID),this.timeoutID=null}},{key:"failAfter",value:function(e){if(e<=0)throw new Error("Expected a maximum number of retry greater than 0 but got ".concat(e));this.maxNumberOfRetry=e}},{key:"next",value:function(){this.backoffDelay=Math.min(this.nextBackoffDelay,this.maxDelay),this.nextBackoffDelay=this.backoffDelay*this.factor;var e=1+Math.random()*this.randomisationFactor;return Math.min(this.maxDelay,Math.round(this.backoffDelay*e))}},{key:"onBackoff",value:function(){this.timeoutID=null,this.emit("ready",this.backoffNumber,this.backoffDelay),this.backoffNumber++}}],[{key:"exponential",value:function(e){return new n(e)}}]),n}(Mm.EventEmitter);kT.Backoff=_T,kT.default=_T,Object.defineProperty(yT,"__esModule",{value:!0});var ST=mT;yT.Retrier=ST.Retrier;var TT=kT;yT.Backoff=TT.Backoff,yT.default=ST.Retrier,Object.defineProperty(vT,"__esModule",{value:!0});var ET=yT,IT=iT,RT=eT.Logger.scope("Network"),CT=function(){function e(t,n){xa(this,e),this.config=t,this.transport=n}var t;return pa(e,[{key:"backoffConfig",value:function(){return Object.assign(IT.Configuration.backoffConfigDefault,this.config.backoffConfigOverride)}},{key:"retryWhenThrottled",value:function(){return void 0!==this.config.retryWhenThrottledOverride?this.config.retryWhenThrottledOverride:void 0!==IT.Configuration.retryWhenThrottledDefault&&IT.Configuration.retryWhenThrottledDefault}},{key:"executeWithRetry",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return new Promise((function(r,i){var a=[502,503,504];n&&a.push(429);var o=new ET.Retrier(t.backoffConfig());o.on("attempt",(function(){e().then((function(e){return o.succeeded(e)})).catch((function(e){a.indexOf(e.status)>-1||"Twilsock disconnected"===e.message?o.failed(e):(o.removeAllListeners(),o.cancel(),i(e))}))})),o.on("succeeded",(function(e){r(e)})),o.on("cancelled",(function(e){return i(e)})),o.on("failed",(function(e){return i(e)})),o.start()}))}},{key:"get",value:function(){var e=da(Za.mark((function e(t){var n,r,i=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={"X-Twilio-Token":this.config.token},RT.trace("sending GET request to ",t," headers ",n),e.next=4,this.executeWithRetry((function(){return i.transport.get(t,n)}),this.retryWhenThrottled());case 4:return r=e.sent,RT.trace("response",r),e.abrupt("return",r);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"post",value:(t=da(Za.mark((function e(t,n,r){var i,a;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i={"X-Twilio-Token":this.config.token},"undefined"!=typeof FormData&&n instanceof FormData||!r||Object.assign(i,{"Content-Type":r}),RT.trace("sending POST request to ",t," headers ",i),e.prev=3,e.next=6,this.transport.post(t,i,n);case 6:a=e.sent,e.next=17;break;case 9:if(e.prev=9,e.t0=e.catch(3),!(e.t0 instanceof TypeError)){e.next=16;break}throw RT.trace("got error in post response",e.t0),new TypeError("Posting FormData supported only with browser engine's FormData");case 16:throw e.t0;case 17:return RT.trace("response",a),e.abrupt("return",a);case 19:case"end":return e.stop()}}),e,this,[[3,9]])}))),function(e,n,r){return t.apply(this,arguments)})}]),e}();vT.Network=CT;var PT="0.3.3";Object.defineProperty(ZS,"__esModule",{value:!0});var OT=eT,MT=iT,AT=oT;ZS.Media=AT.Media,ZS.McsMedia=AT.Media;var DT=uT,jT=vT,NT=OT.Logger.scope(""),LT=PT,UT="A valid Twilio token should be provided",FT=function(){function Client(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(xa(this,Client),this.options=n,this.options.logLevel=this.options.logLevel||"silent",this.config=new MT.Configuration(e,t,this.options),!e)throw new Error(UT);NT.setLevel(this.options.logLevel),this.options.transport=this.options.transport||new DT.Transport,this.transport=this.options.transport,this.network=new jT.Network(this.config,this.transport)}var e,t;return pa(Client,[{key:"updateToken",value:function(e){if(NT.info("updateToken"),!e)throw new Error(UT);this.config.updateToken(e)}},{key:"get",value:function(){var e=da(Za.mark((function e(t){var n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.network.get("".concat(this.config.baseUrl,"/").concat(t));case 2:return n=e.sent,e.abrupt("return",new AT.Media(this.config,this.network,n.body));case 4:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()},{key:"post",value:(t=da(Za.mark((function e(t,n){var r;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.network.post(this.config.baseUrl,n,t);case 2:return r=e.sent,e.abrupt("return",new AT.Media(this.config,this.network,r.body));case 4:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})},{key:"postFormData",value:(e=da(Za.mark((function e(t){var n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.network.post(this.config.baseUrl,t);case 2:return n=e.sent,e.abrupt("return",new AT.Media(this.config,this.network,n.body));case 4:case"end":return e.stop()}}),e,this)}))),function(t){return e.apply(this,arguments)})}]),Client}();ZS.Client=FT,ZS.McsClient=FT,FT.version=LT,ZS.default=FT;var BT=ZS,qT=function e(){xa(this,e)};function WT(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}wa(qT,"HTTP_200_OK",200),wa(qT,"HTTP_400_BAD_REQUEST",400),wa(qT,"HTTP_404_NOT_FOUND",404),wa(qT,"ACCESS_FORBIDDEN_FOR_IDENTITY",54007),wa(qT,"LIST_NOT_FOUND",54150);var zT,GT,SessionError=function(e){ma(SessionError,e);var t=WT(SessionError);function SessionError(e,n){var r;return xa(this,SessionError),(r=t.call(this)).name=r.constructor.name,r.message=e,r.code=n,Error.captureStackTrace?Error.captureStackTrace(va(r),r.constructor):r.stack=(new Error).stack,r}return SessionError}(Xg(Error)),VT=function(){function e(){var t=this;xa(this,e),this._promise=new Promise((function(e,n){t._resolve=e,t._reject=n}))}return pa(e,[{key:"promise",get:function(){return this._promise}},{key:"update",value:function(e){this._resolve(e)}},{key:"set",value:function(e){this.current=e,this._resolve(e)}},{key:"fail",value:function(e){this._reject(e)}}]),e}(),HT={};Object.defineProperty(HT,"__esModule",{value:!0});var JT=["weeks","years","months","days","hours","minutes","seconds"],KT=HT.pattern=new RegExp("P(?:(\\d+(?:[\\.,]\\d+)?W)|(\\d+(?:[\\.,]\\d+)?Y)?(\\d+(?:[\\.,]\\d+)?M)?(\\d+(?:[\\.,]\\d+)?D)?(?:T(\\d+(?:[\\.,]\\d+)?H)?(\\d+(?:[\\.,]\\d+)?M)?(\\d+(?:[\\.,]\\d+)?S)?)?)"),$T=GT=HT.parse=function(e){return e.match(KT).slice(1).reduce((function(e,t,n){return e[JT[n]]=parseFloat(t)||0,e}),{})},QT=HT.end=function(e,t){var n=t?t.getTime():Date.now(),r=new Date(n);return r.setFullYear(r.getFullYear()+e.years),r.setMonth(r.getMonth()+e.months),r.setDate(r.getDate()+e.days),r.setHours(r.getHours()+e.hours),r.setMinutes(r.getMinutes()+e.minutes),r.setMilliseconds(r.getMilliseconds()+1e3*e.seconds),r.setDate(r.getDate()+7*e.weeks),r},YT=zT=HT.toSeconds=function(e,t){var n=t?t.getTime():Date.now(),r=new Date(n);return(QT(e,r).getTime()-r.getTime())/1e3};HT.default={end:QT,toSeconds:YT,pattern:KT,parse:$T};var XT="1.2.3",ZT=XT,eE=wd.scope("Session"),tE=function e(){xa(this,e)};var nE=function(){function e(t,n){xa(this,e);var r="undefined"!=typeof navigator?Cb.exports.parse(navigator.userAgent):Ob;this.services=t,this.config=n,this.sessionInfo=new VT,this.currentContext={},this.pendingCommands=new Map,this.sessionStreamPromise=null,this.endpointPlatform=["JS",ZT,r.os,r.name,r.version].join("|")}var t,n,r,i,a,o;return pa(e,[{key:"identity",get:function(){return this.sessionInfo.current.identity}},{key:"reachabilityEnabled",get:function(){return this.currentContext.reachabilityEnabled}},{key:"handleContextUpdate",value:function(e){var t;(eE.info("Session context updated"),eE.debug("new session context:",e),this.currentContext=e,t=e,["identity","userInfo","links","myChannels","channels"].some((function(e){return!t.hasOwnProperty(e)})))||(eE.info("new session context accepted"),this.sessionInfo.set(e))}},{key:"initialize",value:function(){var e=this,t={type:"IpMsgSession",apiVersion:"4",endpointPlatform:this.endpointPlatform};return this.sessionStreamPromise=this.services.syncClient.list({purpose:"com.twilio.rtd.ipmsg",context:t}).then((function(t){return eE.info("Session created",t.sid),t.on("itemAdded",(function(t){return e.processCommandResponse(t.item)})),t.on("itemUpdated",(function(t){return e.processCommandResponse(t.item)})),t.on("contextUpdated",(function(t){return e.handleContextUpdate(t.context)})),t})).catch((function(e){throw eE.error("Failed to create session",e),e})),this.sessionStreamPromise}},{key:"addCommand",value:function(e,t){return this.processCommand(e,t)}},{key:"processCommand",value:function(e,t){var n=this,r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],i=new tE;return i.request=t,i.request.action=e,i.commandId=fg.v4(),eE.info("Adding command: ",e,i.commandId),eE.debug("command arguments:",t,r),new Promise((function(a,o){n.sessionStreamPromise.then((function(e){return n.pendingCommands.set(i.commandId,{resolve:a,reject:o,commandId:i.commandId,request:i.request}),e.push(i)})).then((function(){return eE.debug("Command accepted by server",i.commandId)})).catch((function(s){n.pendingCommands.delete(i.commandId),eE.error("Failed to add a command to the session",s),s.code!=qT.ACCESS_FORBIDDEN_FOR_IDENTITY&&s.code!==qT.LIST_NOT_FOUND||!r?o(new Error("Can't add command: "+s.message)):(eE.info("recreating session..."),n.initialize(),a(n.processCommand(e,t,!1)))}))}))}},{key:"processCommandResponse",value:function(e){if(e.data.hasOwnProperty("response")&&e.data.hasOwnProperty("commandId")&&this.pendingCommands.has(e.data.commandId)){var t=e.data,n=t.commandId;if(t.response.status===qT.HTTP_200_OK){eE.debug("Command succeeded: ",t);var r=this.pendingCommands.get(n).resolve;this.pendingCommands.delete(n),r(t.response)}else{eE.error("Command failed: ",t);var i=this.pendingCommands.get(n).reject;this.pendingCommands.delete(n),i(new SessionError(t.response.statusText,t.response.status))}}}},{key:"getSessionContext",value:function(){return this.sessionStreamPromise.then((function(e){return e.getContext()}))}},{key:"getSessionLinks",value:(o=da(Za.mark((function e(){var t;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sessionInfo.promise;case 2:return t=e.sent,e.abrupt("return",{publicChannelsUrl:this.config.baseUrl+t.links.publicChannelsUrl,myChannelsUrl:this.config.baseUrl+t.links.myChannelsUrl,typingUrl:this.config.baseUrl+t.links.typingUrl,syncListUrl:this.config.baseUrl+t.links.syncListUrl,usersUrl:this.config.baseUrl+t.links.usersUrl,mediaServiceUrl:t.links.mediaServiceUrl,messagesReceiptsUrl:this.config.baseUrl+t.links.messagesReceiptsUrl});case 4:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"getConversationsId",value:(a=da(Za.mark((function e(){var t;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sessionInfo.promise;case 2:return t=e.sent,e.abrupt("return",t.channels);case 4:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"getMyConversationsId",value:(i=da(Za.mark((function e(){var t;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sessionInfo.promise;case 2:return t=e.sent,e.abrupt("return",t.myChannels);case 4:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"getMaxUserInfosToSubscribe",value:(r=da(Za.mark((function e(){var t;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sessionInfo.promise;case 2:return t=e.sent,e.abrupt("return",this.config.userInfosToSubscribeOverride||t.userInfosToSubscribe||this.config.userInfosToSubscribeDefault);case 4:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"getUsersData",value:function(){return this.sessionInfo.promise.then((function(e){return{user:e.userInfo,identity:e.identity}}))}},{key:"getConsumptionReportInterval",value:(n=da(Za.mark((function e(){var t,n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getSessionContext();case 2:return t=e.sent,n=this.config.consumptionReportIntervalOverride||t.consumptionReportInterval||this.config.consumptionReportIntervalDefault,e.prev=4,e.abrupt("return",zT(GT(n)));case 8:return e.prev=8,e.t0=e.catch(4),eE.error("Failed to parse consumption report interval",n,"using default value",this.config.consumptionReportIntervalDefault),e.abrupt("return",zT(GT(this.config.consumptionReportIntervalDefault)));case 12:case"end":return e.stop()}}),e,this,[[4,8]])}))),function(){return n.apply(this,arguments)})},{key:"getHttpCacheInterval",value:(t=da(Za.mark((function e(){var t,n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getSessionContext();case 2:return t=e.sent,n=this.config.httpCacheIntervalOverride||t.httpCacheInterval||this.config.httpCacheIntervalDefault,e.prev=4,e.abrupt("return",zT(GT(n)));case 8:return e.prev=8,e.t0=e.catch(4),eE.error("Failed to parse cache interval",n,"using default value",this.config.httpCacheIntervalDefault),e.abrupt("return",zT(GT(this.config.httpCacheIntervalDefault)));case 12:case"end":return e.stop()}}),e,this,[[4,8]])}))),function(){return t.apply(this,arguments)})}]),e}();By("Set",(function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}}),Zy);var rE,iE={exports:{}},aE="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView,oE=aE,sE=s,uE=i,cE=x,lE=C,fE=xs,dE=ee,hE=te.exports,pE=G.f,vE=Io,yE=Go,mE=dr,gE=we,bE=uE.Int8Array,kE=bE&&bE.prototype,wE=uE.Uint8ClampedArray,xE=wE&&wE.prototype,_E=bE&&vE(bE),SE=kE&&vE(kE),TE=Object.prototype,EE=TE.isPrototypeOf,IE=mE("toStringTag"),RE=gE("TYPED_ARRAY_TAG"),CE=oE&&!!yE&&"Opera"!==fE(uE.opera),PE=!1,OE={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},ME={BigInt64Array:8,BigUint64Array:8},AE=function(e){if(!cE(e))return!1;var t=fE(e);return lE(OE,t)||lE(ME,t)};for(rE in OE)uE[rE]||(CE=!1);if((!CE||"function"!=typeof _E||_E===Function.prototype)&&(_E=function(){throw TypeError("Incorrect invocation")},CE))for(rE in OE)uE[rE]&&yE(uE[rE],_E);if((!CE||!SE||SE===TE)&&(SE=_E.prototype,CE))for(rE in OE)uE[rE]&&yE(uE[rE].prototype,SE);if(CE&&vE(xE)!==SE&&yE(xE,SE),sE&&!lE(SE,IE))for(rE in PE=!0,pE(SE,IE,{get:function(){return cE(this)?this[RE]:void 0}}),OE)uE[rE]&&dE(uE[rE],RE,rE);var DE={NATIVE_ARRAY_BUFFER_VIEWS:CE,TYPED_ARRAY_TAG:PE&&RE,aTypedArray:function(e){if(AE(e))return e;throw TypeError("Target is not a typed array")},aTypedArrayConstructor:function(e){if(yE){if(EE.call(_E,e))return e}else for(var t in OE)if(lE(OE,rE)){var n=uE[t];if(n&&(e===n||EE.call(n,e)))return e}throw TypeError("Target is not a typed array constructor")},exportTypedArrayMethod:function(e,t,n){if(sE){if(n)for(var r in OE){var i=uE[r];if(i&&lE(i.prototype,e))try{delete i.prototype[e]}catch(e){}}SE[e]&&!n||hE(SE,e,n?t:CE&&kE[e]||t)}},exportTypedArrayStaticMethod:function(e,t,n){var r,i;if(sE){if(yE){if(n)for(r in OE)if((i=uE[r])&&lE(i,e))try{delete i[e]}catch(e){}if(_E[e]&&!n)return;try{return hE(_E,e,n?t:CE&&_E[e]||t)}catch(e){}}for(r in OE)!(i=uE[r])||i[e]&&!n||hE(i,e,t)}},isView:function(e){if(!cE(e))return!1;var t=fE(e);return"DataView"===t||lE(OE,t)||lE(ME,t)},isTypedArray:AE,TypedArray:_E,TypedArrayPrototype:SE},jE=i,NE=o,LE=uu,UE=DE.NATIVE_ARRAY_BUFFER_VIEWS,FE=jE.ArrayBuffer,BE=jE.Int8Array,qE=!UE||!NE((function(){BE(1)}))||!NE((function(){new BE(-1)}))||!LE((function(e){new BE,new BE(null),new BE(1.5),new BE(e)}),!0)||NE((function(){return 1!==new BE(new FE(2),1,void 0).length})),WE=it,zE=st,GE=function(e){if(void 0===e)return 0;var t=WE(e),n=zE(t);if(t!==n)throw RangeError("Wrong length or index");return n},VE=Math.abs,HE=Math.pow,JE=Math.floor,KE=Math.log,$E=Math.LN2,QE=E,YE=ft,XE=st,ZE=function(e){for(var t=QE(this),n=XE(t.length),r=arguments.length,i=YE(r>1?arguments[1]:void 0,n),a=r>2?arguments[2]:void 0,o=void 0===a?n:YE(a,n);o>i;)t[i++]=e;return t},eI=i,tI=s,nI=aE,rI=ee,iI=Ps,aI=o,oI=Ns,sI=it,uI=st,cI=GE,lI={pack:function(e,t,n){var r,i,a,o=new Array(n),s=8*n-t-1,u=(1<<s)-1,c=u>>1,l=23===t?HE(2,-24)-HE(2,-77):0,f=e<0||0===e&&1/e<0?1:0,d=0;for((e=VE(e))!=e||e===1/0?(i=e!=e?1:0,r=u):(r=JE(KE(e)/$E),e*(a=HE(2,-r))<1&&(r--,a*=2),(e+=r+c>=1?l/a:l*HE(2,1-c))*a>=2&&(r++,a/=2),r+c>=u?(i=0,r=u):r+c>=1?(i=(e*a-1)*HE(2,t),r+=c):(i=e*HE(2,c-1)*HE(2,t),r=0));t>=8;o[d++]=255&i,i/=256,t-=8);for(r=r<<t|i,s+=t;s>0;o[d++]=255&r,r/=256,s-=8);return o[--d]|=128*f,o},unpack:function(e,t){var n,r=e.length,i=8*r-t-1,a=(1<<i)-1,o=a>>1,s=i-7,u=r-1,c=e[u--],l=127&c;for(c>>=7;s>0;l=256*l+e[u],u--,s-=8);for(n=l&(1<<-s)-1,l>>=-s,s+=t;s>0;n=256*n+e[u],u--,s-=8);if(0===l)l=1-o;else{if(l===a)return n?NaN:c?-1/0:1/0;n+=HE(2,t),l-=o}return(c?-1:1)*n*HE(2,l-t)}},fI=Io,dI=Go,hI=tt.f,pI=G.f,vI=ZE,yI=_r,mI=qe.get,gI=qe.set,bI="ArrayBuffer",kI="DataView",wI="Wrong index",xI=eI.ArrayBuffer,_I=xI,SI=eI.DataView,TI=SI&&SI.prototype,EI=Object.prototype,II=eI.RangeError,RI=lI.pack,CI=lI.unpack,PI=function(e){return[255&e]},OI=function(e){return[255&e,e>>8&255]},MI=function(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]},AI=function(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]},DI=function(e){return RI(e,23,4)},jI=function(e){return RI(e,52,8)},NI=function(e,t){pI(e.prototype,t,{get:function(){return mI(this)[t]}})},LI=function(e,t,n,r){var i=cI(n),a=mI(e);if(i+t>a.byteLength)throw II(wI);var o=mI(a.buffer).bytes,s=i+a.byteOffset,u=o.slice(s,s+t);return r?u:u.reverse()},UI=function(e,t,n,r,i,a){var o=cI(n),s=mI(e);if(o+t>s.byteLength)throw II(wI);for(var u=mI(s.buffer).bytes,c=o+s.byteOffset,l=r(+i),f=0;f<t;f++)u[c+f]=l[a?f:t-f-1]};if(nI){if(!aI((function(){xI(1)}))||!aI((function(){new xI(-1)}))||aI((function(){return new xI,new xI(1.5),new xI(NaN),xI.name!=bI}))){for(var FI,BI=(_I=function(e){return oI(this,_I),new xI(cI(e))}).prototype=xI.prototype,qI=hI(xI),WI=0;qI.length>WI;)(FI=qI[WI++])in _I||rI(_I,FI,xI[FI]);BI.constructor=_I}dI&&fI(TI)!==EI&&dI(TI,EI);var zI=new SI(new _I(2)),GI=TI.setInt8;zI.setInt8(0,2147483648),zI.setInt8(1,2147483649),!zI.getInt8(0)&&zI.getInt8(1)||iI(TI,{setInt8:function(e,t){GI.call(this,e,t<<24>>24)},setUint8:function(e,t){GI.call(this,e,t<<24>>24)}},{unsafe:!0})}else _I=function(e){oI(this,_I,bI);var t=cI(e);gI(this,{bytes:vI.call(new Array(t),0),byteLength:t}),tI||(this.byteLength=t)},SI=function(e,t,n){oI(this,SI,kI),oI(e,_I,kI);var r=mI(e).byteLength,i=sI(t);if(i<0||i>r)throw II("Wrong offset");if(i+(n=void 0===n?r-i:uI(n))>r)throw II("Wrong length");gI(this,{buffer:e,byteLength:n,byteOffset:i}),tI||(this.buffer=e,this.byteLength=n,this.byteOffset=i)},tI&&(NI(_I,"byteLength"),NI(SI,"buffer"),NI(SI,"byteLength"),NI(SI,"byteOffset")),iI(SI.prototype,{getInt8:function(e){return LI(this,1,e)[0]<<24>>24},getUint8:function(e){return LI(this,1,e)[0]},getInt16:function(e){var t=LI(this,2,e,arguments.length>1?arguments[1]:void 0);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=LI(this,2,e,arguments.length>1?arguments[1]:void 0);return t[1]<<8|t[0]},getInt32:function(e){return AI(LI(this,4,e,arguments.length>1?arguments[1]:void 0))},getUint32:function(e){return AI(LI(this,4,e,arguments.length>1?arguments[1]:void 0))>>>0},getFloat32:function(e){return CI(LI(this,4,e,arguments.length>1?arguments[1]:void 0),23)},getFloat64:function(e){return CI(LI(this,8,e,arguments.length>1?arguments[1]:void 0),52)},setInt8:function(e,t){UI(this,1,e,PI,t)},setUint8:function(e,t){UI(this,1,e,PI,t)},setInt16:function(e,t){UI(this,2,e,OI,t,arguments.length>2?arguments[2]:void 0)},setUint16:function(e,t){UI(this,2,e,OI,t,arguments.length>2?arguments[2]:void 0)},setInt32:function(e,t){UI(this,4,e,MI,t,arguments.length>2?arguments[2]:void 0)},setUint32:function(e,t){UI(this,4,e,MI,t,arguments.length>2?arguments[2]:void 0)},setFloat32:function(e,t){UI(this,4,e,DI,t,arguments.length>2?arguments[2]:void 0)},setFloat64:function(e,t){UI(this,8,e,jI,t,arguments.length>2?arguments[2]:void 0)}});yI(_I,bI),yI(SI,kI);var VI={ArrayBuffer:_I,DataView:SI},HI=it,JI=function(e){var t=HI(e);if(t<0)throw RangeError("The argument can't be less than 0");return t},KI=function(e,t){var n=JI(e);if(n%t)throw RangeError("Wrong offset");return n},$I=E,QI=st,YI=Gs,XI=Bs,ZI=Tr,eR=DE.aTypedArrayConstructor,tR=Yt,nR=i,rR=s,iR=qE,aR=DE,oR=VI,sR=Ns,uR=d,cR=ee,lR=st,fR=GE,dR=KI,hR=S,pR=C,vR=xs,yR=x,mR=gn,gR=Go,bR=tt.f,kR=function(e){var t,n,r,i,a,o,s=$I(e),u=arguments.length,c=u>1?arguments[1]:void 0,l=void 0!==c,f=YI(s);if(null!=f&&!XI(f))for(o=(a=f.call(s)).next,s=[];!(i=o.call(a)).done;)s.push(i.value);for(l&&u>2&&(c=ZI(c,arguments[2],2)),n=QI(s.length),r=new(eR(this))(n),t=0;n>t;t++)r[t]=l?c(s[t],t):s[t];return r},wR=Lr.forEach,xR=js,_R=G,SR=a,TR=Yl,ER=qe.get,IR=qe.set,RR=_R.f,CR=SR.f,PR=Math.round,OR=nR.RangeError,MR=oR.ArrayBuffer,AR=oR.DataView,DR=aR.NATIVE_ARRAY_BUFFER_VIEWS,jR=aR.TYPED_ARRAY_TAG,NR=aR.TypedArray,LR=aR.TypedArrayPrototype,UR=aR.aTypedArrayConstructor,FR=aR.isTypedArray,BR="BYTES_PER_ELEMENT",qR="Wrong length",WR=function(e,t){for(var n=0,r=t.length,i=new(UR(e))(r);r>n;)i[n]=t[n++];return i},zR=function(e,t){RR(e,t,{get:function(){return ER(this)[t]}})},GR=function(e){var t;return e instanceof MR||"ArrayBuffer"==(t=vR(e))||"SharedArrayBuffer"==t},VR=function(e,t){return FR(e)&&"symbol"!=typeof t&&t in e&&String(+t)==String(t)},HR=function(e,t){return VR(e,t=hR(t,!0))?uR(2,e[t]):CR(e,t)},JR=function(e,t,n){return!(VR(e,t=hR(t,!0))&&yR(n)&&pR(n,"value"))||pR(n,"get")||pR(n,"set")||n.configurable||pR(n,"writable")&&!n.writable||pR(n,"enumerable")&&!n.enumerable?RR(e,t,n):(e[t]=n.value,e)};rR?(DR||(SR.f=HR,_R.f=JR,zR(LR,"buffer"),zR(LR,"byteOffset"),zR(LR,"byteLength"),zR(LR,"length")),tR({target:"Object",stat:!0,forced:!DR},{getOwnPropertyDescriptor:HR,defineProperty:JR}),iE.exports=function(e,t,n){var r=e.match(/\d+$/)[0]/8,i=e+(n?"Clamped":"")+"Array",a="get"+e,o="set"+e,s=nR[i],u=s,c=u&&u.prototype,l={},f=function(e,t){RR(e,t,{get:function(){return function(e,t){var n=ER(e);return n.view[a](t*r+n.byteOffset,!0)}(this,t)},set:function(e){return function(e,t,i){var a=ER(e);n&&(i=(i=PR(i))<0?0:i>255?255:255&i),a.view[o](t*r+a.byteOffset,i,!0)}(this,t,e)},enumerable:!0})};DR?iR&&(u=t((function(e,t,n,a){return sR(e,u,i),TR(yR(t)?GR(t)?void 0!==a?new s(t,dR(n,r),a):void 0!==n?new s(t,dR(n,r)):new s(t):FR(t)?WR(u,t):kR.call(u,t):new s(fR(t)),e,u)})),gR&&gR(u,NR),wR(bR(s),(function(e){e in u||cR(u,e,s[e])})),u.prototype=c):(u=t((function(e,t,n,a){sR(e,u,i);var o,s,c,l=0,d=0;if(yR(t)){if(!GR(t))return FR(t)?WR(u,t):kR.call(u,t);o=t,d=dR(n,r);var h=t.byteLength;if(void 0===a){if(h%r)throw OR(qR);if((s=h-d)<0)throw OR(qR)}else if((s=lR(a)*r)+d>h)throw OR(qR);c=s/r}else c=fR(t),o=new MR(s=c*r);for(IR(e,{buffer:o,byteOffset:d,byteLength:s,length:c,view:new AR(o)});l<c;)f(e,l++)})),gR&&gR(u,NR),c=u.prototype=mR(LR)),c.constructor!==u&&cR(c,"constructor",u),jR&&cR(c,jR,i),l[i]=u,tR({global:!0,forced:u!=s,sham:!DR},l),BR in u||cR(u,BR,r),BR in c||cR(c,BR,r),xR(i)}):iE.exports=function(){},(0,iE.exports)("Uint8",(function(e){return function(t,n,r){return e(this,t,n,r)}}));var KR=E,$R=ft,QR=st,YR=Math.min,XR=[].copyWithin||function(e,t){var n=KR(this),r=QR(n.length),i=$R(e,r),a=$R(t,r),o=arguments.length>2?arguments[2]:void 0,s=YR((void 0===o?r:$R(o,r))-a,r-i),u=1;for(a<i&&i<a+s&&(u=-1,a+=s-1,i+=s-1);s-- >0;)a in n?n[i]=n[a]:delete n[i],i+=u,a+=u;return n},ZR=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("copyWithin",(function(e,t){return XR.call(ZR(this),e,t,arguments.length>2?arguments[2]:void 0)}));var eC=Lr.every,tC=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("every",(function(e){return eC(tC(this),e,arguments.length>1?arguments[1]:void 0)}));var nC=ZE,rC=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("fill",(function(e){return nC.apply(rC(this),arguments)}));var iC=DE.aTypedArrayConstructor,aC=du,oC=Lr.filter,sC=function(e,t){for(var n=aC(e,e.constructor),r=0,i=t.length,a=new(iC(n))(i);i>r;)a[r]=t[r++];return a},uC=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("filter",(function(e){var t=oC(uC(this),e,arguments.length>1?arguments[1]:void 0);return sC(this,t)}));var cC=Lr.find,lC=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("find",(function(e){return cC(lC(this),e,arguments.length>1?arguments[1]:void 0)}));var fC=Lr.findIndex,dC=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("findIndex",(function(e){return fC(dC(this),e,arguments.length>1?arguments[1]:void 0)}));var hC=Lr.forEach,pC=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("forEach",(function(e){hC(pC(this),e,arguments.length>1?arguments[1]:void 0)}));var vC=yt.includes,yC=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("includes",(function(e){return vC(yC(this),e,arguments.length>1?arguments[1]:void 0)}));var mC=yt.indexOf,gC=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("indexOf",(function(e){return mC(gC(this),e,arguments.length>1?arguments[1]:void 0)}));var bC=i,kC=DE,wC=vs,xC=dr("iterator"),_C=bC.Uint8Array,SC=wC.values,TC=wC.keys,EC=wC.entries,IC=kC.aTypedArray,RC=kC.exportTypedArrayMethod,CC=_C&&_C.prototype[xC],PC=!!CC&&("values"==CC.name||null==CC.name),OC=function(){return SC.call(IC(this))};RC("entries",(function(){return EC.call(IC(this))})),RC("keys",(function(){return TC.call(IC(this))})),RC("values",OC,!PC),RC(xC,OC,!PC);var MC=DE.aTypedArray,AC=[].join;(0,DE.exportTypedArrayMethod)("join",(function(e){return AC.apply(MC(this),arguments)}));var DC=w,jC=it,NC=st,LC=no,UC=Math.min,FC=[].lastIndexOf,BC=!!FC&&1/[1].lastIndexOf(1,-0)<0,qC=LC("lastIndexOf"),WC=BC||!qC?function(e){if(BC)return FC.apply(this,arguments)||0;var t=DC(this),n=NC(t.length),r=n-1;for(arguments.length>1&&(r=UC(r,jC(arguments[1]))),r<0&&(r=n+r);r>=0;r--)if(r in t&&t[r]===e)return r||0;return-1}:FC,zC=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("lastIndexOf",(function(e){return WC.apply(zC(this),arguments)}));var GC=Lr.map,VC=du,HC=DE.aTypedArray,JC=DE.aTypedArrayConstructor;(0,DE.exportTypedArrayMethod)("map",(function(e){return GC(HC(this),e,arguments.length>1?arguments[1]:void 0,(function(e,t){return new(JC(VC(e,e.constructor)))(t)}))}));var KC=Xt,$C=E,QC=m,YC=st,XC=function(e){return function(t,n,r,i){KC(n);var a=$C(t),o=QC(a),s=YC(a.length),u=e?s-1:0,c=e?-1:1;if(r<2)for(;;){if(u in o){i=o[u],u+=c;break}if(u+=c,e?u<0:s<=u)throw TypeError("Reduce of empty array with no initial value")}for(;e?u>=0:s>u;u+=c)u in o&&(i=n(i,o[u],u,a));return i}},ZC={left:XC(!1),right:XC(!0)},eP=ZC.left,tP=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("reduce",(function(e){return eP(tP(this),e,arguments.length,arguments.length>1?arguments[1]:void 0)}));var nP=ZC.right,rP=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("reduceRight",(function(e){return nP(rP(this),e,arguments.length,arguments.length>1?arguments[1]:void 0)}));var iP=DE.aTypedArray,aP=DE.exportTypedArrayMethod,oP=Math.floor;aP("reverse",(function(){for(var e,t=this,n=iP(t).length,r=oP(n/2),i=0;i<r;)e=t[i],t[i++]=t[--n],t[n]=e;return t}));var sP=st,uP=KI,cP=E,lP=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("set",(function(e){lP(this);var t=uP(arguments.length>1?arguments[1]:void 0,1),n=this.length,r=cP(e),i=sP(r.length),a=0;if(i+t>n)throw RangeError("Wrong length");for(;a<i;)this[t+a]=r[a++]}),o((function(){new Int8Array(1).set({})})));var fP=du,dP=DE.aTypedArray,hP=DE.aTypedArrayConstructor,pP=[].slice;(0,DE.exportTypedArrayMethod)("slice",(function(e,t){for(var n=pP.call(dP(this),e,t),r=fP(this,this.constructor),i=0,a=n.length,o=new(hP(r))(a);a>i;)o[i]=n[i++];return o}),o((function(){new Int8Array(1).slice()})));var vP=Lr.some,yP=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("some",(function(e){return vP(yP(this),e,arguments.length>1?arguments[1]:void 0)}));var mP=Math.floor,gP=function(e,t){var n=e.length,r=mP(n/2);return n<8?bP(e,t):kP(gP(e.slice(0,r),t),gP(e.slice(r),t),t)},bP=function(e,t){for(var n,r,i=e.length,a=1;a<i;){for(r=a,n=e[a];r&&t(e[r-1],n)>0;)e[r]=e[--r];r!==a++&&(e[r]=n)}return e},kP=function(e,t,n){for(var r=e.length,i=t.length,a=0,o=0,s=[];a<r||o<i;)a<r&&o<i?s.push(n(e[a],t[o])<=0?e[a++]:t[o++]):s.push(a<r?e[a++]:t[o++]);return s},wP=gP,xP=Bn.match(/firefox\/(\d+)/i),_P=!!xP&&+xP[1],SP=/MSIE|Trident/.test(Bn),TP=Bn.match(/AppleWebKit\/(\d+)\./),EP=!!TP&&+TP[1],IP=o,RP=Xt,CP=st,PP=wP,OP=_P,MP=SP,AP=Vn,DP=EP,jP=DE.aTypedArray,NP=DE.exportTypedArrayMethod,LP=i.Uint16Array,UP=LP&&LP.prototype.sort,FP=!!UP&&!IP((function(){var e=new LP(2);e.sort(null),e.sort({})})),BP=!!UP&&!IP((function(){if(AP)return AP<74;if(OP)return OP<67;if(MP)return!0;if(DP)return DP<602;var e,t,n=new LP(516),r=Array(516);for(e=0;e<516;e++)t=e%4,n[e]=515-e,r[e]=e-2*t+3;for(n.sort((function(e,t){return(e/4|0)-(t/4|0)})),e=0;e<516;e++)if(n[e]!==r[e])return!0}));NP("sort",(function(e){var t=this;if(void 0!==e&&RP(e),BP)return UP.call(t,e);jP(t);var n,r=CP(t.length),i=Array(r);for(n=0;n<r;n++)i[n]=t[n];for(i=PP(t,function(e){return function(t,n){return void 0!==e?+e(t,n)||0:n!=n?-1:t!=t?1:0===t&&0===n?1/t>0&&1/n<0?1:-1:t>n}}(e)),n=0;n<r;n++)t[n]=i[n];return t}),!BP||FP);var qP=st,WP=ft,zP=du,GP=DE.aTypedArray;(0,DE.exportTypedArrayMethod)("subarray",(function(e,t){var n=GP(this),r=n.length,i=WP(e,r);return new(zP(n,n.constructor))(n.buffer,n.byteOffset+i*n.BYTES_PER_ELEMENT,qP((void 0===t?r:WP(t,r))-i))}));var VP=DE,HP=o,JP=i.Int8Array,KP=VP.aTypedArray,$P=VP.exportTypedArrayMethod,QP=[].toLocaleString,YP=[].slice,XP=!!JP&&HP((function(){QP.call(new JP(1))}));$P("toLocaleString",(function(){return QP.apply(XP?YP.call(KP(this)):KP(this),arguments)}),HP((function(){return[1,2].toLocaleString()!=new JP([1,2]).toLocaleString()}))||!HP((function(){JP.prototype.toLocaleString.call([1,2])})));var ZP=DE.exportTypedArrayMethod,eO=o,tO=i.Uint8Array,nO=tO&&tO.prototype||{},rO=[].toString,iO=[].join;eO((function(){rO.call({})}))&&(rO=function(){return iO.call(this)});var aO=nO.toString!=rO;ZP("toString",rO,aO);var oO=js,sO="ArrayBuffer",uO=VI.ArrayBuffer;function cO(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Yt({global:!0,forced:i.ArrayBuffer!==uO},{ArrayBuffer:uO}),oO(sO);var lO=wd.scope("Participant"),Participant=function(e){ma(Participant,e);var t,n,r=cO(Participant);function Participant(e,t,n,i){var a;if(xa(this,Participant),(a=r.call(this)).conversation=t,a.services=e,a.state={attributes:yp(n.attributes,"Retrieved malformed attributes from the server for participant: "+i,lO),dateCreated:n.dateCreated?vp(n.dateCreated):null,dateUpdated:n.dateCreated?vp(n.dateUpdated):null,sid:i,typingTimeout:null,isTyping:!1,identity:n.identity||null,roleSid:n.roleSid||null,lastReadMessageIndex:Number.isInteger(n.lastConsumedMessageIndex)?n.lastConsumedMessageIndex:null,lastReadTimestamp:n.lastConsumptionTimestamp?vp(n.lastConsumptionTimestamp):null,type:n.type||"chat",userInfo:n.userInfo},!n.identity&&!n.type)throw new Error("Received invalid Participant object from server: Missing identity or type of Participant.");return a}return pa(Participant,[{key:"sid",get:function(){return this.state.sid}},{key:"attributes",get:function(){return this.state.attributes}},{key:"dateCreated",get:function(){return this.state.dateCreated}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"identity",get:function(){return this.state.identity}},{key:"isTyping",get:function(){return this.state.isTyping}},{key:"lastReadMessageIndex",get:function(){return this.state.lastReadMessageIndex}},{key:"lastReadTimestamp",get:function(){return this.state.lastReadTimestamp}},{key:"roleSid",get:function(){return this.state.roleSid}},{key:"type",get:function(){return this.state.type}},{key:"_startTyping",value:function(e){var t=this;return clearTimeout(this.state.typingTimeout),this.state.isTyping=!0,this.emit("typingStarted",this),this.conversation.emit("typingStarted",this),this.state.typingTimeout=setTimeout((function(){return t._endTyping()}),e),this}},{key:"_endTyping",value:function(){this.state.typingTimeout&&(this.state.isTyping=!1,this.emit("typingEnded",this),this.conversation.emit("typingEnded",this),clearInterval(this.state.typingTimeout),this.state.typingTimeout=null)}},{key:"_update",value:function(e){var t=[],n=yp(e.attributes,"Retrieved malformed attributes from the server for participant: "+this.state.sid,lO);e.attributes&&!hp(this.state.attributes,n)&&(this.state.attributes=n,t.push("attributes"));var r=vp(e.dateUpdated);e.dateUpdated&&r.getTime()!==(this.state.dateUpdated&&this.state.dateUpdated.getTime())&&(this.state.dateUpdated=r,t.push("dateUpdated"));var i=vp(e.dateCreated);if(e.dateCreated&&i.getTime()!==(this.state.dateCreated&&this.state.dateCreated.getTime())&&(this.state.dateCreated=i,t.push("dateCreated")),e.roleSid&&this.state.roleSid!==e.roleSid&&(this.state.roleSid=e.roleSid,t.push("roleSid")),!Number.isInteger(e.lastConsumedMessageIndex)&&null!==e.lastConsumedMessageIndex||this.state.lastReadMessageIndex===e.lastConsumedMessageIndex||(this.state.lastReadMessageIndex=e.lastConsumedMessageIndex,t.push("lastReadMessageIndex")),e.lastConsumptionTimestamp){var a=new Date(e.lastConsumptionTimestamp);this.state.lastReadTimestamp&&this.state.lastReadTimestamp.getTime()===a.getTime()||(this.state.lastReadTimestamp=a,t.push("lastReadTimestamp"))}return t.length>0&&this.emit("updated",{participant:this,updateReasons:t}),this}},{key:"getUser",value:(n=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("chat"==this.type){e.next=2;break}throw new Error("Getting User is not supported for this Participant type: "+this.type);case 2:return e.abrupt("return",this.services.users.getUser(this.state.identity,this.state.userInfo));case 3:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"remove",value:function(){var e=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.conversation.removeParticipant(this));case 1:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"updateAttributes",value:(t=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.addCommand("editMemberAttributes",{channelSid:this.conversation.sid,memberSid:this.sid,attributes:JSON.stringify(t)});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),Participant}(Of);function fO(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Rf([ly(["string","number","boolean","object",iy(null)]),Cf("design:type",Function),Cf("design:paramtypes",[Object]),Cf("design:returntype",Promise)],Participant.prototype,"updateAttributes",null);var dO=wd.scope("Participants"),hO=function(e){ma(o,e);var t,n,r,i,a=fO(o);function o(e,t,n){var r;return xa(this,o),(r=a.call(this)).services=t,r.conversation=e,r.participants=n,r}return pa(o,[{key:"unsubscribe",value:(i=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.rosterEntityPromise){e.next=6;break}return e.next=3,this.rosterEntityPromise;case 3:e.sent.close(),this.rosterEntityPromise=null;case 6:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"subscribe",value:function(e){var t=this;return this.rosterEntityPromise=this.rosterEntityPromise||this.services.syncClient.map({id:e,mode:"open_existing"}).then((function(e){e.on("itemAdded",(function(e){dO.debug(t.conversation.sid+" itemAdded: "+e.item.key),t.upsertParticipant(e.item.key,e.item.data).then((function(e){t.emit("participantJoined",e)}))})),e.on("itemRemoved",(function(e){dO.debug(t.conversation.sid+" itemRemoved: "+e.key);var n=e.key;if(t.participants.has(n)){var r=t.participants.get(n);t.participants.delete(n),t.emit("participantLeft",r)}})),e.on("itemUpdated",(function(e){dO.debug(t.conversation.sid+" itemUpdated: "+e.item.key),t.upsertParticipant(e.item.key,e.item.data)}));var n=[],r=t;return e.getItems().then((function e(t){return t.items.forEach((function(e){n.push(r.upsertParticipant(e.key,e.data))})),t.hasNextPage?t.nextPage().then(e):null})).then((function(){return Promise.all(n)})).then((function(){return e}))})).catch((function(e){throw t.rosterEntityPromise=null,"disconnected"!=t.services.syncClient.connectionState&&dO.error("Failed to get roster object for conversation",t.conversation.sid,e),dO.debug("ERROR: Failed to get roster object for conversation",t.conversation.sid,e),e}))}},{key:"upsertParticipant",value:(r=da(Za.mark((function e(t,n){var r,i=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(r=this.participants.get(t))){e.next=3;break}return e.abrupt("return",r._update(n));case 3:return r=new Participant(this.services,this.conversation,n,t),this.participants.set(t,r),r.on("updated",(function(e){return i.emit("participantUpdated",e)})),e.abrupt("return",r);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"getParticipants",value:function(){var e=this;return this.rosterEntityPromise.then((function(){var t=[];return e.participants.forEach((function(e){return t.push(e)})),t}))}},{key:"getParticipantBySid",value:(n=da(Za.mark((function e(t){var n=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.rosterEntityPromise.then((function(){var e=n.participants.get(t);if(!e)throw new Error("Participant with SID "+t+" was not found");return e})));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"getParticipantByIdentity",value:(t=da(Za.mark((function e(t){var n,r=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=null,e.abrupt("return",this.rosterEntityPromise.then((function(){if(r.participants.forEach((function(e){e.identity===t&&(n=e)})),!n)throw new Error("Participant with identity "+t+" was not found");return n})));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"add",value:function(e,t){return this.services.session.addCommand("addMemberV2",{channelSid:this.conversation.sid,attributes:JSON.stringify(t),username:e})}},{key:"addNonChatParticipant",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return this.services.session.addCommand("addNonChatParticipant",{conversationSid:this.conversation.sid,proxyAddress:e,attributes:JSON.stringify(n),address:t})}},{key:"invite",value:function(e){return this.services.session.addCommand("inviteMember",{channelSid:this.conversation.sid,username:e})}},{key:"removeByIdentity",value:function(e){return this.services.session.addCommand("removeMember",{channelSid:this.conversation.sid,username:e})}},{key:"removeBySid",value:function(e){return this.services.session.addCommand("removeMember",{channelSid:this.conversation.sid,memberSid:e})}}]),o}(Of),pO=Yt,vO=Xt,yO=E,mO=st,gO=o,bO=wP,kO=no,wO=_P,xO=SP,_O=Vn,SO=EP,TO=[],EO=TO.sort,IO=gO((function(){TO.sort(void 0)})),RO=gO((function(){TO.sort(null)})),CO=kO("sort"),PO=!gO((function(){if(_O)return _O<70;if(!(wO&&wO>3)){if(xO)return!0;if(SO)return SO<603;var e,t,n,r,i="";for(e=65;e<76;e++){switch(t=String.fromCharCode(e),e){case 66:case 69:case 70:case 72:n=3;break;case 68:case 71:n=4;break;default:n=2}for(r=0;r<47;r++)TO.push({k:t+r,v:n})}for(TO.sort((function(e,t){return t.v-e.v})),r=0;r<TO.length;r++)t=TO[r].k.charAt(0),i.charAt(i.length-1)!==t&&(i+=t);return"DGBEFHACIJK"!==i}}));pO({target:"Array",proto:!0,forced:IO||!RO||!CO||!PO},{sort:function(e){void 0!==e&&vO(e);var t=yO(this);if(PO)return void 0===e?EO.call(t):EO.call(t,e);var n,r,i=[],a=mO(t.length);for(r=0;r<a;r++)r in t&&i.push(t[r]);for(n=(i=bO(i,function(e){return function(t,n){return void 0===n?-1:void 0===t?1:void 0!==e?+e(t,n)||0:String(t)>String(n)?1:-1}}(e))).length,r=0;r<n;)t[r]=i[r++];for(;r<a;)delete t[r++];return t}});var OO=te.exports,MO=H,AO=o,DO=Td,jO="toString",NO=RegExp.prototype,LO=NO.toString,UO=AO((function(){return"/a/b"!=LO.call({source:"a",flags:"b"})})),FO=LO.name!=jO;(UO||FO)&&OO(RegExp.prototype,jO,(function(){var e=MO(this),t=String(e.source),n=e.flags;return"/"+t+"/"+String(void 0===n&&e instanceof RegExp&&!("flags"in NO)?DO.call(e):n)}),{unsafe:!0});var Media=function(){function Media(e,t){xa(this,Media),wa(this,"mcsMedia",null),this.services=t,this.state={sid:e.sid,filename:e.filename,contentType:e.contentType,size:e.size}}var e;return pa(Media,[{key:"sid",get:function(){return this.state.sid}},{key:"filename",get:function(){return this.state.filename}},{key:"contentType",get:function(){return this.state.contentType}},{key:"size",get:function(){return this.state.size}},{key:"getContentTemporaryUrl",value:(e=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.mcsMedia){e.next=8;break}if(!this.services.mcsClient){e.next=7;break}return e.next=4,this.services.mcsClient.get(this.state.sid);case 4:this.mcsMedia=e.sent,e.next=8;break;case 7:throw new Error("Media Content Service is unavailable");case 8:return e.abrupt("return",this.mcsMedia.getContentUrl());case 9:case"end":return e.stop()}}),e,this)}))),function(){return e.apply(this,arguments)})}]),Media}(),AggregatedDeliveryReceipt=function(){function AggregatedDeliveryReceipt(e){xa(this,AggregatedDeliveryReceipt),this.state=e}return pa(AggregatedDeliveryReceipt,[{key:"total",get:function(){return this.state.total}},{key:"sent",get:function(){return this.state.sent}},{key:"delivered",get:function(){return this.state.delivered}},{key:"read",get:function(){return this.state.read}},{key:"undelivered",get:function(){return this.state.undelivered}},{key:"failed",get:function(){return this.state.failed}},{key:"_update",value:function(e){this.state=e}},{key:"_isEquals",value:function(e){var t=this.total===e.total,n=this.sent===e.sent,r=this.delivered===e.delivered,i=this.read===e.read,a=this.undelivered===e.undelivered,o=this.failed===e.failed;return t&&n&&r&&i&&a&&o}}]),AggregatedDeliveryReceipt}(),DetailedDeliveryReceipt=function DetailedDeliveryReceipt(e){xa(this,DetailedDeliveryReceipt),this.sid=e.sid,this.messageSid=e.message_sid,this.conversationSid=e.conversation_sid,this.channelMessageSid=e.channel_message_sid,this.participantSid=e.participant_sid,this.status=e.status||"queued",this.errorCode=e.error_code||0,this.dateCreated=e.date_created,this.dateUpdated=e.date_updated};function BO(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}var qO=wd.scope("Message"),Message=function(e){ma(Message,e);var t,n,r,i,a,o=BO(Message);function Message(e,t,n,r){var i;return xa(this,Message),(i=o.call(this)).conversation=e,i.services=t,i.state={sid:r.sid,index:n,author:null==r.author?null:r.author,subject:null==r.subject?null:r.subject,body:r.text,timestamp:r.timestamp?new Date(r.timestamp):null,dateUpdated:r.dateUpdated?new Date(r.dateUpdated):null,lastUpdatedBy:r.lastUpdatedBy?r.lastUpdatedBy:null,attributes:yp(r.attributes,"Got malformed attributes for the message ".concat(r.sid),qO),type:r.type?r.type:"text",media:r.type&&"media"===r.type&&r.media?new Media(r.media,i.services):null,participantSid:null==r.memberSid?null:r.memberSid,aggregatedDeliveryReceipt:r.delivery?new AggregatedDeliveryReceipt(r.delivery):null},i}return pa(Message,[{key:"sid",get:function(){return this.state.sid}},{key:"author",get:function(){return this.state.author}},{key:"subject",get:function(){return this.state.subject}},{key:"body",get:function(){return"media"===this.type?null:this.state.body}},{key:"dateUpdated",get:function(){return this.state.dateUpdated}},{key:"index",get:function(){return this.state.index}},{key:"lastUpdatedBy",get:function(){return this.state.lastUpdatedBy}},{key:"dateCreated",get:function(){return this.state.timestamp}},{key:"attributes",get:function(){return this.state.attributes}},{key:"type",get:function(){return this.state.type}},{key:"media",get:function(){return this.state.media}},{key:"participantSid",get:function(){return this.state.participantSid}},{key:"aggregatedDeliveryReceipt",get:function(){return this.state.aggregatedDeliveryReceipt}},{key:"_update",value:function(e){var t=[];!e.text&&"string"!=typeof e.text||e.text===this.state.body||(this.state.body=e.text,t.push("body")),e.subject&&e.subject!==this.state.subject&&(this.state.subject=e.subject,t.push("subject")),e.lastUpdatedBy&&e.lastUpdatedBy!==this.state.lastUpdatedBy&&(this.state.lastUpdatedBy=e.lastUpdatedBy,t.push("lastUpdatedBy")),e.author&&e.author!==this.state.author&&(this.state.author=e.author,t.push("author")),e.dateUpdated&&new Date(e.dateUpdated).getTime()!==(this.state.dateUpdated&&this.state.dateUpdated.getTime())&&(this.state.dateUpdated=new Date(e.dateUpdated),t.push("dateUpdated")),e.timestamp&&new Date(e.timestamp).getTime()!==(this.state.timestamp&&this.state.timestamp.getTime())&&(this.state.timestamp=new Date(e.timestamp),t.push("dateCreated"));var n=yp(e.attributes,"Got malformed attributes for the message ".concat(this.sid),qO);hp(this.state.attributes,n)||(this.state.attributes=n,t.push("attributes"));var r=e.delivery,i=this.state.aggregatedDeliveryReceipt;!!(r&&r.total&&r.delivered&&r.failed&&r.read&&r.sent&&r.undelivered)&&(i?i._isEquals(r)||(i._update(r),t.push("deliveryReceipt")):(this.state.aggregatedDeliveryReceipt=new AggregatedDeliveryReceipt(r),t.push("deliveryReceipt"))),t.length>0&&this.emit("updated",{message:this,updateReasons:t})}},{key:"getParticipant",value:(a=da(Za.mark((function e(){var t,n,r=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=null,!this.state.participantSid){e.next=5;break}return e.next=4,this.conversation.getParticipantBySid(this.participantSid).catch((function(){return qO.debug('Participant with sid "'+r.participantSid+'" not found for message '+r.sid),null}));case 4:t=e.sent;case 5:if(t||!this.state.author){e.next=9;break}return e.next=8,this.conversation.getParticipantByIdentity(this.state.author).catch((function(){return qO.debug('Participant with identity "'+r.author+'" not found for message '+r.sid),null}));case 8:t=e.sent;case 9:if(!t){e.next=11;break}return e.abrupt("return",t);case 11:throw n="Participant with ",this.state.participantSid&&(n+="SID '"+this.state.participantSid+"' "),this.state.author&&(this.state.participantSid&&(n+="or "),n+="identity '"+this.state.author+"' "),"Participant with "===n&&(n="Participant "),n+="was not found",new Error(n);case 17:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"getDetailedDeliveryReceipts",value:(i=da(Za.mark((function e(){var t,n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._getDetailedDeliveryReceiptsPaginator();case 2:t=e.sent,n=[];case 4:if(n=[].concat(mw(n),mw(t.items)),t.hasNextPage){e.next=8;break}return e.abrupt("break",13);case 8:return e.next=10,t.nextPage();case 10:t=e.sent,e.next=4;break;case 13:return e.abrupt("return",n);case 14:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"remove",value:function(){var e=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.addCommand("deleteMessage",{channelSid:this.conversation.sid,messageIdx:this.index.toString()});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}()},{key:"updateBody",value:(r=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.addCommand("editMessage",{channelSid:this.conversation.sid,messageIdx:this.index.toString(),text:t});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"updateAttributes",value:(n=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.addCommand("editMessageAttributes",{channelSid:this.conversation.sid,messageIdx:this.index,attributes:JSON.stringify(t)});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"_getDetailedDeliveryReceiptsPaginator",value:(t=da(Za.mark((function e(t){var n,r,i,a,o=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.getSessionLinks();case 2:return n=e.sent,r=n.messagesReceiptsUrl.replace("%s",this.conversation.sid).replace("%s",this.sid),i=new mp(r).arg("PageToken",null==t?void 0:t.pageToken).arg("PageSize",null==t?void 0:t.pageSize).build(),e.next=7,this.services.network.get(i);case 7:return a=e.sent,e.abrupt("return",new Em(a.body.delivery_receipts.map((function(e){return new DetailedDeliveryReceipt(e)})),(function(e,t){return o._getDetailedDeliveryReceiptsPaginator({pageToken:e,pageSize:t})}),a.body.meta.previous_token,a.body.meta.next_token));case 9:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),Message}(Of);function WO(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Rf([ly("string"),Cf("design:type",Function),Cf("design:paramtypes",[String]),Cf("design:returntype",Promise)],Message.prototype,"updateBody",null),Rf([ly(["string","number","boolean","object",iy(null)]),Cf("design:type",Function),Cf("design:paramtypes",[Object]),Cf("design:returntype",Promise)],Message.prototype,"updateAttributes",null);var zO=wd.scope("Messages"),GO=function(e){ma(a,e);var t,n,r,i=WO(a);function a(e,t){var n;return xa(this,a),(n=i.call(this)).conversation=e,n.services=t,n.messagesByIndex=new Map,n.messagesListPromise=null,n}return pa(a,[{key:"subscribe",value:function(e){var t=this;return this.messagesListPromise=this.messagesListPromise||this.services.syncClient.list({id:e,mode:"open_existing"}).then((function(e){return e.on("itemAdded",(function(e){zO.debug(t.conversation.sid+" itemAdded: "+e.item.index);var n=new Message(t.conversation,t.services,e.item.index,e.item.data);t.messagesByIndex.has(n.index)?zO.debug("Message arrived, but already known and ignored",t.conversation.sid,n.index):(t.messagesByIndex.set(n.index,n),n.on("updated",(function(e){return t.emit("messageUpdated",e)})),t.emit("messageAdded",n))})),e.on("itemRemoved",(function(e){zO.debug(t.conversation.sid+" itemRemoved: "+e.index);var n=e.index;if(t.messagesByIndex.has(n)){var r=t.messagesByIndex.get(n);t.messagesByIndex.delete(r.index),r.removeAllListeners("updated"),t.emit("messageRemoved",r)}})),e.on("itemUpdated",(function(e){zO.debug(t.conversation.sid+" itemUpdated: "+e.item.index);var n=t.messagesByIndex.get(e.item.index);n&&n._update(e.item.data)})),e})).catch((function(e){throw t.messagesListPromise=null,"disconnected"!=t.services.syncClient.connectionState&&zO.error("Failed to get messages object for conversation",t.conversation.sid,e),zO.debug("ERROR: Failed to get messages object for conversation",t.conversation.sid,e),e}))}},{key:"unsubscribe",value:(r=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.messagesListPromise){e.next=6;break}return e.next=3,this.messagesListPromise;case 3:e.sent.close(),this.messagesListPromise=null;case 6:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"send",value:(n=da(Za.mark((function e(t){var n,r,i=arguments;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>1&&void 0!==i[1]?i[1]:{},r=i.length>2?i[2]:void 0,zO.debug("Sending text message",t,n,r),e.abrupt("return",this.services.session.addCommand("sendMessage",{channelSid:this.conversation.sid,text:t,attributes:JSON.stringify(n),subject:null==r?void 0:r.subject}));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"sendMedia",value:(t=da(Za.mark((function e(t){var n,r,i,a,o=arguments;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=o.length>1&&void 0!==o[1]?o[1]:{},r=o.length>2?o[2]:void 0,zO.debug("Sending media message",t,n,r),!("undefined"!=typeof FormData&&t instanceof FormData)){e.next=10;break}return zO.debug("Sending media message as FormData",t,n),e.next=7,this.services.mcsClient.postFormData(t);case 7:i=e.sent,e.next=17;break;case 10:if(zO.debug("Sending media message as SendMediaOptions",t,n),(a=t).contentType&&a.media){e.next=14;break}throw new Error("Media content <Conversation#SendMediaOptions> must contain non-empty contentType and media");case 14:return e.next=16,this.services.mcsClient.post(a.contentType,a.media);case 16:i=e.sent;case 17:return e.abrupt("return",this.services.session.addCommand("sendMediaMessage",{channelSid:this.conversation.sid,mediaSid:i.sid,attributes:JSON.stringify(n)}));case 18:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"getMessages",value:function(e,t,n){return t=void 0!==t?t:"end",n=n||"backwards",this._getMessages(e,t,n)}},{key:"wrapPaginator",value:function(e,t,n){var r=this,i="desc"===e,a=function(){return t.nextPage().then((function(t){return r.wrapPaginator(e,t,n)}))},o=function(){return t.prevPage().then((function(t){return r.wrapPaginator(e,t,n)}))};return n(t.items).then((function(e){return{items:e.sort((function(e,t){return e.index-t.index})),hasPrevPage:i?t.hasNextPage:t.hasPrevPage,hasNextPage:i?t.hasPrevPage:t.hasNextPage,prevPage:i?a:o,nextPage:i?o:a}}))}},{key:"_upsertMessage",value:function(e,t){var n=this,r=this.messagesByIndex.get(e);if(r)return r;var i=new Message(this.conversation,this.services,e,t);return this.messagesByIndex.set(i.index,i),i.on("updated",(function(e){return n.emit("messageUpdated",e)})),i}},{key:"_getMessages",value:function(e,t,n){var r=this;t=void 0!==t?t:"end",e=e||30;var i="backwards"===n?"desc":"asc";return this.messagesListPromise.then((function(n){return n.getItems({from:"end"!==t?t:void 0,pageSize:e,order:i})})).then((function(e){return r.wrapPaginator(i,e,(function(e){return Promise.all(e.map((function(e){return r._upsertMessage(e.index,e.data)})))}))}))}}]),a}(Of);function VO(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return HO(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return HO(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function HO(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function JO(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}var KO=wd.scope("Conversation"),$O={lastMessage:"lastMessage",attributes:"attributes",createdBy:"createdBy",dateCreated:"dateCreated",dateUpdated:"dateUpdated",friendlyName:"friendlyName",lastConsumedMessageIndex:"lastConsumedMessageIndex",notificationLevel:"notificationLevel",sid:"sid",status:"status",uniqueName:"uniqueName",state:"state"};function QO(e){try{return new Date(e)}catch(e){return null}}var Conversation=function(e){ma(Conversation,e);var t,n,r,i,a,o,s,u,c,l,f,d,h,p,v,y,m,g,b,k,w,x,_,S,T=JO(Conversation);function Conversation(e,t,n){var r;xa(this,Conversation),r=T.call(this);var i=t.attributes||{},a=t.createdBy,o=QO(t.dateCreated),s=QO(t.dateUpdated),u=t.friendlyName||null,c=Number.isInteger(t.lastConsumedMessageIndex)?t.lastConsumedMessageIndex:null,l=t.uniqueName||null;try{JSON.stringify(i)}catch(e){throw new Error("Attributes must be a valid JSON object.")}return r.services=e,r.sid=n,r.entityName=t.channel,r.channelState={uniqueName:l,status:"notParticipating",attributes:i,createdBy:a,dateCreated:o,dateUpdated:s,friendlyName:u,lastReadMessageIndex:c},t.notificationLevel&&(r.channelState.notificationLevel=t.notificationLevel),r.participants=new Map,r.participantsEntity=new hO(va(r),r.services,r.participants),r.participantsEntity.on("participantJoined",r.emit.bind(va(r),"participantJoined")),r.participantsEntity.on("participantLeft",r.emit.bind(va(r),"participantLeft")),r.participantsEntity.on("participantUpdated",(function(e){return r.emit("participantUpdated",e)})),r.messagesEntity=new GO(va(r),e),r.messagesEntity.on("messageAdded",(function(e){return r._onMessageAdded(e)})),r.messagesEntity.on("messageUpdated",(function(e){return r.emit("messageUpdated",e)})),r.messagesEntity.on("messageRemoved",r.emit.bind(va(r),"messageRemoved")),r}return pa(Conversation,[{key:"uniqueName",get:function(){return this.channelState.uniqueName}},{key:"status",get:function(){return this.channelState.status}},{key:"friendlyName",get:function(){return this.channelState.friendlyName}},{key:"dateUpdated",get:function(){return this.channelState.dateUpdated}},{key:"dateCreated",get:function(){return this.channelState.dateCreated}},{key:"createdBy",get:function(){return this.channelState.createdBy}},{key:"attributes",get:function(){return this.channelState.attributes}},{key:"lastReadMessageIndex",get:function(){return this.channelState.lastReadMessageIndex}},{key:"lastMessage",get:function(){return this.channelState.lastMessage}},{key:"notificationLevel",get:function(){return this.channelState.notificationLevel}},{key:"state",get:function(){return this.channelState.state}},{key:"_subscribe",value:function(){var e=this;return this.entityPromise?this.entityPromise:this.entityPromise=this.entityPromise||this.services.syncClient.document({id:this.entityName,mode:"open_existing"}).then((function(t){return e.entity=t,e.entity.on("updated",(function(t){e._update(t.data)})),e.entity.on("removed",(function(){return e.emit("removed",e)})),e._update(e.entity.data),t})).catch((function(t){throw e.entity=null,e.entityPromise=null,"disconnected"!=e.services.syncClient.connectionState&&KO.error("Failed to get conversation object",t),KO.debug("ERROR: Failed to get conversation object",t),t}))}},{key:"_subscribeStreams",value:(S=da(Za.mark((function e(){var t,n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._subscribe();case 3:return KO.trace("_subscribeStreams, this.entity.data=",this.entity.data),t=this.entity.data.messages,n=this.entity.data.roster,e.next=8,Promise.all([this.messagesEntity.subscribe(t),this.participantsEntity.subscribe(n)]);case 8:e.next=15;break;case 10:throw e.prev=10,e.t0=e.catch(0),"disconnected"!==this.services.syncClient.connectionState&&KO.error("Failed to subscribe on conversation objects",this.sid,e.t0),KO.debug("ERROR: Failed to subscribe on conversation objects",this.sid,e.t0),e.t0;case 15:case"end":return e.stop()}}),e,this,[[0,10]])}))),function(){return S.apply(this,arguments)})},{key:"_unsubscribe",value:(_=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.entity){e.next=5;break}return e.next=3,this.entity.close();case 3:this.entity=null,this.entityPromise=null;case 5:return e.abrupt("return",Promise.all([this.participantsEntity.unsubscribe(),this.messagesEntity.unsubscribe()]));case 6:case"end":return e.stop()}}),e,this)}))),function(){return _.apply(this,arguments)})},{key:"_setStatus",value:function(e,t){var n=this;this.statusSource=t,this.channelState.status!==e&&(this.channelState.status=e,"joined"===e?this._subscribeStreams().catch((function(t){if(KO.debug("ERROR while setting conversation status "+e,t),"disconnected"!==n.services.syncClient.connectionState)throw t})):this.entityPromise&&this._unsubscribe().catch((function(t){if(KO.debug("ERROR while setting conversation status "+e,t),"disconnected"!==n.services.syncClient.connectionState)throw t})))}},{key:"_statusSource",value:function(){return this.statusSource}},{key:"_update",value:function(e){var t,n,r,i,a;KO.trace("_update",e),Conversation.preprocessUpdate(e,this.sid);for(var o=new Set,s=0,u=Object.keys(e);s<u.length;s++){var c=u[s],l=$O[c];if(l)switch(l){case $O.status:if(!e.status||"unknown"===e.status||this.channelState.status===e.status)break;this.channelState.status=e.status,o.add(l);break;case $O.attributes:if(hp(this.channelState.attributes,e.attributes))break;this.channelState.attributes=e.attributes,o.add(l);break;case $O.lastConsumedMessageIndex:if(void 0===e.lastConsumedMessageIndex||e.lastConsumedMessageIndex===this.channelState.lastReadMessageIndex)break;this.channelState.lastReadMessageIndex=e.lastConsumedMessageIndex,o.add("lastReadMessageIndex");break;case $O.lastMessage:if(this.channelState.lastMessage&&!e.lastMessage){delete this.channelState.lastMessage,o.add(l);break}this.channelState.lastMessage=this.channelState.lastMessage||{},void 0!==(null===(t=e.lastMessage)||void 0===t?void 0:t.index)&&e.lastMessage.index!==this.channelState.lastMessage.index&&(this.channelState.lastMessage.index=e.lastMessage.index,o.add(l)),void 0!==(null===(n=e.lastMessage)||void 0===n?void 0:n.timestamp)&&(null===(r=this.channelState.lastMessage)||void 0===r||null===(i=r.dateCreated)||void 0===i?void 0:i.getTime())!==e.lastMessage.timestamp.getTime()&&(this.channelState.lastMessage.dateCreated=e.lastMessage.timestamp,o.add(l)),hp(this.channelState.lastMessage,{})&&delete this.channelState.lastMessage;break;case $O.state:var f=e.state||void 0;if(void 0!==f&&(f.dateUpdated=new Date(f.dateUpdated)),hp(this.channelState.state,f))break;this.channelState.state=f,o.add(l);break;default:var d=e[c]instanceof Date,h=d&&(null===(a=this.channelState[l])||void 0===a?void 0:a.getTime())===e[c].getTime(),p=!d&&this[l]===e[c];if(h||p)break;this.channelState[l]=e[c],o.add(l)}}o.size>0&&this.emit("updated",{conversation:this,updateReasons:mw(o)})}},{key:"_onMessageAdded",value:function(e){var t,n=VO(this.participants.values());try{for(n.s();!(t=n.n()).done;){var r=t.value;if(r.identity===e.author){r._endTyping();break}}}catch(e){n.e(e)}finally{n.f()}this.emit("messageAdded",e)}},{key:"add",value:function(){var e=da(Za.mark((function e(t,n){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.participantsEntity.add(t,n));case 1:case"end":return e.stop()}}),e,this)})));return function(t,n){return e.apply(this,arguments)}}()},{key:"addNonChatParticipant",value:(x=da(Za.mark((function e(t,n){var r,i=arguments;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=i.length>2&&void 0!==i[2]?i[2]:{},e.abrupt("return",this.participantsEntity.addNonChatParticipant(t,n,r));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return x.apply(this,arguments)})},{key:"advanceLastReadMessageIndex",value:(w=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this.services.readHorizon.advanceLastReadMessageIndexForConversation(this.sid,t,this.lastReadMessageIndex));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"delete",value:(k=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.addCommand("destroyChannel",{channelSid:this.sid});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(){return k.apply(this,arguments)})},{key:"getAttributes",value:(b=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribe();case 2:return e.abrupt("return",this.attributes);case 3:case"end":return e.stop()}}),e,this)}))),function(){return b.apply(this,arguments)})},{key:"getMessages",value:(g=da(Za.mark((function e(t,n,r){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this.messagesEntity.getMessages(t,n,r));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return g.apply(this,arguments)})},{key:"getParticipants",value:(m=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this.participantsEntity.getParticipants());case 3:case"end":return e.stop()}}),e,this)}))),function(){return m.apply(this,arguments)})},{key:"getParticipantsCount",value:(y=da(Za.mark((function e(){var t,n,r;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.getSessionLinks();case 2:return t=e.sent,n=new mp(t.publicChannelsUrl).path(this.sid).build(),e.next=6,this.services.network.get(n);case 6:return r=e.sent,e.abrupt("return",r.body.members_count);case 8:case"end":return e.stop()}}),e,this)}))),function(){return y.apply(this,arguments)})},{key:"getParticipantBySid",value:(v=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.participantsEntity.getParticipantBySid(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return v.apply(this,arguments)})},{key:"getParticipantByIdentity",value:(p=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.participantsEntity.getParticipantByIdentity(t));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"getMessagesCount",value:(h=da(Za.mark((function e(){var t,n,r;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.getSessionLinks();case 2:return t=e.sent,n=new mp(t.publicChannelsUrl).path(this.sid).build(),e.next=6,this.services.network.get(n);case 6:return r=e.sent,e.abrupt("return",r.body.messages_count);case 8:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"getUnreadMessagesCount",value:(d=da(Za.mark((function e(){var t,n,r;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.getSessionLinks();case 2:return t=e.sent,n=new mp(t.myChannelsUrl).arg("ChannelSid",this.sid).build(),e.next=6,this.services.network.get(n);case 6:if(!(r=e.sent).body.channels.length||r.body.channels[0].channel_sid!=this.sid){e.next=11;break}if(void 0===r.body.channels[0].unread_messages_count||null==r.body.channels[0].unread_messages_count){e.next=10;break}return e.abrupt("return",r.body.channels[0].unread_messages_count);case 10:return e.abrupt("return",null);case 11:throw new Error("Conversation is not in user conversations list");case 12:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"join",value:(f=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.addCommand("joinChannelV2",{channelSid:this.sid});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"leave",value:(l=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("joined"!==this.channelState.status){e.next=3;break}return e.next=3,this.services.session.addCommand("leaveChannel",{channelSid:this.sid});case 3:return e.abrupt("return",this);case 4:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"removeParticipant",value:(c=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t instanceof Participant)){e.next=4;break}return e.next=3,this.participantsEntity.removeBySid(t.sid);case 3:return e.abrupt("return");case 4:return e.next=6,this.participantsEntity.removeByIdentity(t);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return c.apply(this,arguments)})},{key:"sendMessage",value:(u=da(Za.mark((function e(t,n,r){var i,a;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("string"!=typeof t&&null!==t){e.next=5;break}return e.next=3,this.messagesEntity.send(t,n,r);case 3:return i=e.sent,e.abrupt("return",pp(i.messageId));case 5:return e.next=7,this.messagesEntity.sendMedia(t,n,r);case 7:return a=e.sent,e.abrupt("return",pp(a.messageId));case 9:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return u.apply(this,arguments)})},{key:"setAllMessagesRead",value:(s=da(Za.mark((function e(){var t;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.next=4,this.getMessages(1);case 4:if(!((t=e.sent).items.length>0)){e.next=7;break}return e.abrupt("return",this.advanceLastReadMessageIndex(t.items[0].index));case 7:return e.abrupt("return",Promise.resolve(0));case 8:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"setAllMessagesUnread",value:(o=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this.services.readHorizon.updateLastReadMessageIndexForConversation(this.sid,null));case 3:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"setUserNotificationLevel",value:(a=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.addCommand("editNotificationLevel",{channelSid:this.sid,notificationLevel:t});case 2:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"typing",value:function(){return this.services.typingIndicator.send(this.sid)}},{key:"updateAttributes",value:(i=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.addCommand("editAttributes",{channelSid:this.sid,attributes:JSON.stringify(t)});case 2:return e.abrupt("return",this);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"updateFriendlyName",value:(r=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.channelState.friendlyName===t){e.next=3;break}return e.next=3,this.services.session.addCommand("editFriendlyName",{channelSid:this.sid,friendlyName:t});case 3:return e.abrupt("return",this);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"updateLastReadMessageIndex",value:(n=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._subscribeStreams();case 2:return e.abrupt("return",this.services.readHorizon.updateLastReadMessageIndexForConversation(this.sid,t));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"updateUniqueName",value:(t=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.channelState.uniqueName===t){e.next=4;break}return t||(t=""),e.next=4,this.services.session.addCommand("editUniqueName",{channelSid:this.sid,uniqueName:t});case 4:return e.abrupt("return",this);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}],[{key:"preprocessUpdate",value:function(e,t){try{"string"==typeof e.attributes?e.attributes=JSON.parse(e.attributes):e.attributes&&JSON.stringify(e.attributes)}catch(n){KO.warn("Retrieved malformed attributes from the server for conversation: "+t),e.attributes={}}try{e.dateCreated&&(e.dateCreated=new Date(e.dateCreated))}catch(n){KO.warn("Retrieved malformed dateCreated from the server for conversation: "+t),delete e.dateCreated}try{e.dateUpdated&&(e.dateUpdated=new Date(e.dateUpdated))}catch(n){KO.warn("Retrieved malformed dateUpdated from the server for conversation: "+t),delete e.dateUpdated}try{e.lastMessage&&e.lastMessage.timestamp&&(e.lastMessage.timestamp=new Date(e.lastMessage.timestamp))}catch(n){KO.warn("Retrieved malformed lastMessage.timestamp from the server for conversation: "+t),delete e.lastMessage.timestamp}}}]),Conversation}(Of);function YO(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}Rf([ly(ay,["undefined","string","number","boolean","object",iy(null)]),Cf("design:type",Function),Cf("design:paramtypes",[String,Object]),Cf("design:returntype",Promise)],Conversation.prototype,"add",null),Rf([ly(ay,ay,["undefined","object"]),Cf("design:type",Function),Cf("design:paramtypes",[String,String,Object]),Cf("design:returntype",Promise)],Conversation.prototype,"addNonChatParticipant",null),Rf([ly(oy),Cf("design:type",Function),Cf("design:paramtypes",[Number]),Cf("design:returntype",Promise)],Conversation.prototype,"advanceLastReadMessageIndex",null),Rf([ly(["undefined",oy],["undefined",oy],["undefined",iy("backwards","forward")]),Cf("design:type",Function),Cf("design:paramtypes",[Number,Number,String]),Cf("design:returntype",Promise)],Conversation.prototype,"getMessages",null),Rf([ly(ay),Cf("design:type",Function),Cf("design:paramtypes",[String]),Cf("design:returntype",Promise)],Conversation.prototype,"getParticipantBySid",null),Rf([ly(ay),Cf("design:type",Function),Cf("design:paramtypes",[String]),Cf("design:returntype",Promise)],Conversation.prototype,"getParticipantByIdentity",null),Rf([ly([ay,Participant]),Cf("design:type",Function),Cf("design:paramtypes",[Object]),Cf("design:returntype",Promise)],Conversation.prototype,"removeParticipant",null),Rf([ly(["string",iy(null),ry((function(e){return[e instanceof FormData,"an instance of FormData"]})),sy("media options",{contentType:ay,media:ry((function(e){var t="string"==typeof e&&e.length>0||e instanceof Uint8Array||e instanceof ArrayBuffer;return"function"==typeof Blob&&(t=t||e instanceof Blob),[t,"a non-empty string, an instance of Buffer or an instance of Blob"]}))})],["undefined","string","number","boolean","object",iy(null)],["undefined",iy(null),sy("email attributes",{subject:[ay,"undefined"]})]),Cf("design:type",Function),Cf("design:paramtypes",[Object,Object,Object]),Cf("design:returntype",Promise)],Conversation.prototype,"sendMessage",null),Rf([ly(iy("default","muted")),Cf("design:type",Function),Cf("design:paramtypes",[String]),Cf("design:returntype",Promise)],Conversation.prototype,"setUserNotificationLevel",null),Rf([ly(["string","number","boolean","object",iy(null)]),Cf("design:type",Function),Cf("design:paramtypes",[Object]),Cf("design:returntype",Promise)],Conversation.prototype,"updateAttributes",null),Rf([ly(["string",iy(null)]),Cf("design:type",Function),Cf("design:paramtypes",[String]),Cf("design:returntype",Promise)],Conversation.prototype,"updateFriendlyName",null),Rf([ly([iy(null),oy]),Cf("design:type",Function),Cf("design:paramtypes",[Number]),Cf("design:returntype",Promise)],Conversation.prototype,"updateLastReadMessageIndex",null),Rf([ly(["string",iy(null)]),Cf("design:type",Function),Cf("design:paramtypes",[String]),Cf("design:returntype",Promise)],Conversation.prototype,"updateUniqueName",null);var XO=wd.scope("Conversations"),ZO=function(e){ma(a,e);var t,n,r,i=YO(a);function a(e){var t;return xa(this,a),(t=i.call(this)).services=e,t.conversations=new Map,t.thumbstones=new Set,t.syncListFetched=!1,t.syncListRead=new VT,t}return pa(a,[{key:"getMap",value:function(){var e=this;return this.services.session.getMyConversationsId().then((function(t){return e.services.syncClient.map({id:t,mode:"open_existing"})}))}},{key:"addConversation",value:(r=da(Za.mark((function e(t){var n,r,i,a,o,s;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=void 0===t.attributes?{}:t.attributes,e.next=3,this.services.session.addCommand("createConversation",{friendlyName:t.friendlyName,uniqueName:t.uniqueName,attributes:JSON.stringify(n)});case 3:if(r=e.sent,i="conversationSid"in r?r.conversationSid:null,a="conversation"in r?r.conversation:null,!(o=this.conversations.get(i))){e.next=11;break}return e.next=10,o._subscribe();case 10:return e.abrupt("return",o);case 11:return s=new Conversation(this.services,{channel:a,entityName:null,uniqueName:null,attributes:null,createdBy:null,friendlyName:null,lastConsumedMessageIndex:null,dateCreated:null,dateUpdated:null},i),this.conversations.set(s.sid,s),this.registerForEvents(s),e.next=16,s._subscribe();case 16:return this.emit("conversationAdded",s),e.abrupt("return",s);case 18:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"fetchConversations",value:function(){var e=this;this.getMap().then(function(){var t=da(Za.mark((function t(n){var r,i;return Za.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n.on("itemAdded",(function(t){XO.debug("itemAdded: "+t.item.key),e.upsertConversation("sync",t.item.key,t.item.data)})),n.on("itemRemoved",(function(t){XO.debug("itemRemoved: "+t.key);var n=t.key;e.syncListFetched||e.thumbstones.add(n);var r=e.conversations.get(n);r&&(r&&"joined"===r.status&&(r._setStatus("notParticipating","sync"),e.emit("conversationLeft",r)),e.conversations.delete(n),e.emit("conversationRemoved",r),r.emit("removed",r))})),n.on("itemUpdated",(function(t){XO.debug("itemUpdated: "+t.item.key),e.upsertConversation("sync",t.item.key,t.item.data)})),r=[],t.next=6,e.services.syncList.getPage();case 6:i=t.sent,i.items.forEach((function(t){r.push(e.upsertConversation("synclist",t.channel_sid,t))}));case 9:if(!i.hasNextPage){t.next=16;break}return t.next=12,i.nextPage();case 12:(i=t.sent).items.forEach((function(t){r.push(e.upsertConversation("synclist",t.channel_sid,t))})),t.next=9;break;case 16:return e.syncListRead.set(!0),t.abrupt("return",Promise.all(r));case 18:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()).then((function(){e.syncListFetched=!0,e.thumbstones.clear(),XO.debug("Conversations list fetched")})).then((function(){return e})).catch((function(t){throw"disconnected"!=e.services.syncClient.connectionState&&XO.error("Failed to get conversations list",t),XO.debug("ERROR: Failed to get conversations list",t),t}))}},{key:"_wrapPaginator",value:function(e,t){var n=this;return t(e.items).then((function(r){return{items:r,hasNextPage:e.hasNextPage,hasPrevPage:e.hasPrevPage,nextPage:function(){return e.nextPage().then((function(e){return n._wrapPaginator(e,t)}))},prevPage:function(){return e.prevPage().then((function(e){return n._wrapPaginator(e,t)}))}}}))}},{key:"getConversations",value:function(e){var t=this;return this.getMap().then((function(t){return t.getItems(e)})).then((function(e){return t._wrapPaginator(e,(function(e){return Promise.all(e.map((function(e){return t.upsertConversation("sync",e.key,e.data)})))}))}))}},{key:"getConversation",value:function(e){var t=this;return this.getMap().then((function(t){return t.getItems({key:e})})).then((function(e){return e.items.map((function(e){return t.upsertConversation("sync",e.key,e.data)}))})).then((function(e){return e.length>0?e[0]:null}))}},{key:"getConversationByUniqueName",value:(n=da(Za.mark((function e(t){var n,r,i,a,o,s;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.getSessionLinks();case 2:return n=e.sent,r=new mp(n.myChannelsUrl).path(t).build(),e.next=6,this.services.network.get(r);case 6:return i=e.sent,a=i.body,o=a.channel_sid,s={entityName:null,lastConsumedMessageIndex:a.last_consumed_message_index,status:(null==a?void 0:a.status)||"unknown",friendlyName:a.friendly_name,dateUpdated:a.date_updated,dateCreated:a.date_created,uniqueName:a.unique_name,createdBy:a.created_by,attributes:a.attributes,channel:"".concat(o,".channel"),notificationLevel:null==a?void 0:a.notification_level,sid:o},e.abrupt("return",this.upsertConversation("sync",o,s));case 11:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"getWhisperConversation",value:(t=da(Za.mark((function e(t){var n,r,i,a,o,s,u,c;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.getSessionLinks();case 2:return i=e.sent,a=new mp(i.publicChannelsUrl).path(t).build(),e.next=6,this.services.network.get(a);case 6:if(o=e.sent,"private"===(s=o.body).type){e.next=10;break}return e.abrupt("return");case 10:if("string"==typeof s.state&&(u=JSON.parse(s.state)),"object"===ga(s.state)&&null!==s.state&&(u=s.state),"closed"!==(null===(n=u)||void 0===n||null===(r=n["state.v1"])||void 0===r?void 0:r.current)){e.next=14;break}return e.abrupt("return");case 14:return c={entityName:null,lastConsumedMessageIndex:s.last_consumed_message_index,status:(null==s?void 0:s.status)||"unknown",friendlyName:s.friendly_name,dateUpdated:s.date_updated,dateCreated:s.date_created,uniqueName:s.unique_name,createdBy:s.created_by,attributes:s.attributes,channel:"".concat(t,".channel"),notificationLevel:null==s?void 0:s.notification_level,sid:t},e.abrupt("return",this.upsertConversation("sync",t,c));case 16:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"upsertConversation",value:function(e,t,n){var r=this;XO.trace("upsertConversation(sid="+t+", data=",n);var i=this.conversations.get(t);if(i){if(XO.trace("upsertConversation: conversation "+t+" is known and it's status is known from source "+i._statusSource()+" and update came from source "+e,i),void 0===i._statusSource()||e===i._statusSource()||"synclist"===e&&"sync"!==i._statusSource()||"sync"===e)if("joined"===n.status&&"joined"!==i.status){i._setStatus("joined",e);var a={};void 0!==n.notificationLevel&&(a.notificationLevel=n.notificationLevel),void 0!==n.lastConsumedMessageIndex&&(a.lastConsumedMessageIndex=n.lastConsumedMessageIndex),hp(a,{})||i._update(a),i._subscribe().then((function(){r.emit("conversationJoined",i)}))}else"notParticipating"===n.status&&"joined"===i.status?(i._setStatus("notParticipating",e),i._update(n),i._subscribe().then((function(){r.emit("conversationLeft",i)}))):"notParticipating"===n.status?i._subscribe():i._update(n);else XO.trace("upsertConversation: conversation is known from sync and came from chat, ignoring",{sid:t,data:n.status,conversation:i.status});return i._subscribe().then((function(){return i}))}if("chat"!==e&&"synclist"!==e||!this.thumbstones.has(t))return XO.trace("upsertConversation: creating local conversation object with sid "+t,n),i=new Conversation(this.services,n,t),this.conversations.set(t,i),i._subscribe().then((function(){return r.registerForEvents(i),r.emit("conversationAdded",i),"joined"===n.status&&(i._setStatus("joined",e),r.emit("conversationJoined",i)),i}));XO.trace("upsertConversation: conversation is deleted and came again from chat, ignoring",t)}},{key:"onConversationRemoved",value:function(e){var t=this.conversations.get(e);t&&(this.conversations.delete(e),this.emit("conversationRemoved",t))}},{key:"registerForEvents",value:function(e){var t=this;e.on("removed",(function(){return t.onConversationRemoved(e.sid)})),e.on("updated",(function(e){return t.emit("conversationUpdated",e)})),e.on("participantJoined",this.emit.bind(this,"participantJoined")),e.on("participantLeft",this.emit.bind(this,"participantLeft")),e.on("participantUpdated",(function(e){return t.emit("participantUpdated",e)})),e.on("messageAdded",this.emit.bind(this,"messageAdded")),e.on("messageUpdated",(function(e){return t.emit("messageUpdated",e)})),e.on("messageRemoved",this.emit.bind(this,"messageRemoved")),e.on("typingStarted",this.emit.bind(this,"typingStarted")),e.on("typingEnded",this.emit.bind(this,"typingEnded"))}}]),a}(Of),eM=Yt,tM=Lr.find,nM=bo,rM="find",iM=!0;rM in[]&&Array(1).find((function(){iM=!1})),eM({target:"Array",proto:!0,forced:iM},{find:function(e){return tM(this,e,arguments.length>1?arguments[1]:void 0)}}),nM(rM);var aM=Yt,oM=ft,sM=it,uM=st,cM=E,lM=Cr,fM=oa,dM=$i("splice"),hM=Math.max,pM=Math.min,vM=9007199254740991,yM="Maximum allowed length exceeded";function mM(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}aM({target:"Array",proto:!0,forced:!dM},{splice:function(e,t){var n,r,i,a,o,s,u=cM(this),c=uM(u.length),l=oM(e,c),f=arguments.length;if(0===f?n=r=0:1===f?(n=0,r=c-l):(n=f-2,r=pM(hM(sM(t),0),c-l)),c+n-r>vM)throw TypeError(yM);for(i=lM(u,r),a=0;a<r;a++)(o=l+a)in u&&fM(i,a,u[o]);if(i.length=r,n<r){for(a=l;a<c-r;a++)s=a+n,(o=a+r)in u?u[s]=u[o]:delete u[s];for(a=c;a>c-r+n;a--)delete u[a-1]}else if(n>r)for(a=c-r;a>l;a--)s=a+n-1,(o=a+r-1)in u?u[s]=u[o]:delete u[s];for(a=0;a<n;a++)u[a+l]=arguments[a+2];return u.length=c-r+n,i}});var gM=function(e){ma(a,e);var t,n,r,i=mM(a);function a(e){var t;return xa(this,a),(t=i.call(this)).services=e,t.fifoStack=[],t.fifoStackMaxLength=100,t.myself=new User(null,null,t.services),t.myself.on("updated",(function(e){return t.emit("userUpdated",e)})),t.myself.on("userSubscribed",(function(){return t.emit("userSubscribed",t.myself)})),t.myself.on("userUnsubscribed",(function(){t.emit("userUnsubscribed",t.myself),t.myself._ensureFetched()})),t.services=e,t.subscribedUsers=new Map,t.userUrlPromise=t.services.session.getSessionLinks().then((function(e){return t.userUrl=e.usersUrl,t.userUrl})),t.services.session.getMaxUserInfosToSubscribe().then((function(e){t.fifoStackMaxLength=e})),t.services.session.getUsersData().then((function(e){return t.myself.identity=e.identity,t.myself.entityName=e.user,t.myself._ensureFetched()})),t}return pa(a,[{key:"handleUnsubscribeUser",value:function(e){this.subscribedUsers.has(e.identity)&&this.subscribedUsers.delete(e.identity);var t=-1;this.fifoStack.find((function(n,r){return n==e.identity&&(t=r,!0)}))&&this.fifoStack.splice(t,1),this.emit("userUnsubscribed",e)}},{key:"handleSubscribeUser",value:function(e){this.subscribedUsers.has(e.identity)||(this.fifoStack.length>=this.fifoStackMaxLength&&this.subscribedUsers.get(this.fifoStack.shift()).unsubscribe(),this.fifoStack.push(e.identity),this.subscribedUsers.set(e.identity,e),this.emit("userSubscribed",e))}},{key:"getUser",value:(r=da(Za.mark((function e(t){var n,r,i=this,a=arguments;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.length>1&&void 0!==a[1]?a[1]:null,e.next=3,this.services.session.getUsersData();case 3:return e.next=5,this.myself._ensureFetched();case 5:if(t!=this.myself.identity){e.next=7;break}return e.abrupt("return",this.myself);case 7:if(r=this.subscribedUsers.get(t)){e.next=19;break}if(n){e.next=13;break}return e.next=12,this.getSyncUniqueName(t);case 12:n=e.sent;case 13:return(r=new User(t,n,this.services)).on("updated",(function(e){return i.emit("userUpdated",e)})),r.on("userSubscribed",(function(){return i.handleSubscribeUser(r)})),r.on("userUnsubscribed",(function(){return i.handleUnsubscribeUser(r)})),e.next=19,r._ensureFetched();case 19:return e.abrupt("return",r);case 20:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"getSubscribedUsers",value:(n=da(Za.mark((function e(){var t;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.session.getUsersData();case 2:return e.next=4,this.myself._ensureFetched();case 4:return t=[this.myself],this.subscribedUsers.forEach((function(e){return t.push(e)})),e.abrupt("return",t);case 7:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getSyncUniqueName",value:(t=da(Za.mark((function e(t){var n,r;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new mp(this.userUrl).path(t).build(),e.next=3,this.services.network.get(n);case 3:return r=e.sent,e.abrupt("return",r.body.sync_unique_name);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),a}(Of),bM=wd.scope("TypingIndicator"),kM=function(){function e(t,n,r){xa(this,e),this.config=t,this.services=n,this.getConversation=r,this.serviceTypingTimeout=null,this.sentUpdates=new Map}return pa(e,[{key:"typingTimeout",get:function(){return this.config.typingIndicatorTimeoutOverride||this.serviceTypingTimeout||this.config.typingIndicatorTimeoutDefault}},{key:"initialize",value:function(){var e=this;this.services.notificationClient.subscribe(Tm.TYPING_INDICATOR,"twilsock"),this.services.notificationClient.on("message",(function(t,n){t===Tm.TYPING_INDICATOR&&e.handleRemoteTyping(n)}))}},{key:"handleRemoteTyping",value:function(e){var t=this;bM.trace("Got new typing indicator ",e),this.getConversation(e.channel_sid).then((function(n){n&&n.participants.forEach((function(n){if(n.identity===e.identity){var r=t.config.typingIndicatorTimeoutOverride+1e3||1e3*e.typing_timeout;n._startTyping(r)}}))})).catch((function(e){throw bM.error(e),e}))}},{key:"send",value:function(e){var t=this.sentUpdates.get(e);return t&&t>Date.now()-this.typingTimeout?Promise.resolve():(this.sentUpdates.set(e,Date.now()),this._send(e))}},{key:"_send",value:function(e){var t=this;bM.trace("Sending typing indicator");var n=this.config.typingIndicatorUri,r="ChannelSid="+e;return this.services.transport.post(n,{"Content-Type":"application/x-www-form-urlencoded"},r,this.config.productId).then((function(e){e.body.hasOwnProperty("typing_timeout")&&(t.serviceTypingTimeout=1e3*e.body.typing_timeout)})).catch((function(e){throw bM.error("Failed to send typing indicator:",e),e}))}}]),e}(),wM=function(){function e(t){xa(this,e),this.services=t,this.readHorizonRequests=new Map,this.readHorizonUpdateTimer=null}return pa(e,[{key:"getReportInterval",value:function(){return this.services.session.getConsumptionReportInterval().then((function(e){return 1e3*e}))}},{key:"delayedSendReadHorizon",value:function(e){var t=this;null===this.readHorizonUpdateTimer&&(this.sendConsumptionReport(!0),this.readHorizonUpdateTimer=setTimeout((function(){t.sendConsumptionReport(!1)}),e))}},{key:"sendConsumptionReport",value:function(e){var t=this,n=[],r=new Map;this.readHorizonRequests.forEach((function(e,t){n.push(e.entry),r.set(t,e.promises)})),n.length>0&&this.services.session.addCommand("consumptionReportV2",{report:n}).then((function(e){return t.processConsumptionReportResponse(e,r)})).catch((function(e){return t.processConsumptionReportError(e,r)})),e||(this.readHorizonUpdateTimer=null),this.readHorizonRequests.clear()}},{key:"processConsumptionReportResponse",value:function(e,t){e&&e.report&&Array.isArray(e.report)&&e.report.length>0&&e.report.forEach((function(e){var n=e;if(t.has(n.channelSid)){var r=null;void 0!==n.unreadMessagesCount&&null!=n.unreadMessagesCount&&(r=n.unreadMessagesCount),t.get(n.channelSid).forEach((function(e){return e.resolve(r)})),t.delete(n.channelSid)}})),this.processConsumptionReportError(new SessionError("Error while setting LastReadMessageIndex",null),t)}},{key:"processConsumptionReportError",value:function(e,t){t.forEach((function(t){return t.forEach((function(t){return t.reject(e)}))}))}},{key:"updateLastReadMessageIndexForConversation",value:function(e,t){var n=this;return new Promise((function(r,i){n.addPendingConsumptionHorizonRequest(e,{channelSid:e,messageIdx:t},{resolve:r,reject:i}),n.getReportInterval().then((function(e){return n.delayedSendReadHorizon(e)}))}))}},{key:"advanceLastReadMessageIndexForConversation",value:function(e,t,n){var r=this,i=this.readHorizonRequests.get(e);return new Promise((function(a,o){i&&i.entry?i.entry.messageIdx>=t?r.addPendingConsumptionHorizonRequest(e,i.entry,{resolve:a,reject:o}):r.addPendingConsumptionHorizonRequest(e,{channelSid:e,messageIdx:t},{resolve:a,reject:o}):null!==n&&t<n?r.addPendingConsumptionHorizonRequest(e,{channelSid:e,messageIdx:n},{resolve:a,reject:o}):r.addPendingConsumptionHorizonRequest(e,{channelSid:e,messageIdx:t},{resolve:a,reject:o}),r.getReportInterval().then((function(e){return r.delayedSendReadHorizon(e)}))}))}},{key:"addPendingConsumptionHorizonRequest",value:function(e,t,n){if(this.readHorizonRequests.has(e)){var r=this.readHorizonRequests.get(e);r.entry=t,r.promises.push(n)}else this.readHorizonRequests.set(e,{entry:t,promises:[n]})}}]),e}(),PushNotification=function PushNotification(e){xa(this,PushNotification),this.title=e.title||null,this.body=e.body||null,this.sound=e.sound||null,this.badge=e.badge||null,this.action=e.action||null,this.type=e.type||null,this.data=e.data||{}};function xM(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function _M(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?xM(Object(n),!0).forEach((function(t){wa(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):xM(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function SM(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=ka(e);if(t){var i=ka(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ba(this,n)}}var TM=wd.scope("Client"),EM=XT,IM=function e(){xa(this,e)},Client=function(e){ma(Client,e);var t,n,r,i,a,o,s,u,c,l,f=SM(Client);function Client(e,t){var n,r;if(xa(this,Client),wa(va(n=f.call(this)),"connectionState","connecting"),wa(va(n),"sessionPromise",null),wa(va(n),"conversationsPromise",null),wa(va(n),"version",EM),wa(va(n),"parsePushNotification",Client.parsePushNotification),n.options=t||{},!n.options.disableDeepClone){var i=_M(_M({},n.options),{},{transport:void 0,twilsockClient:void 0});r=i,(i=JSON.parse(JSON.stringify(r))).transport=n.options.transport,i.twilsockClient=n.options.twilsockClient,n.options=i}n.options.logLevel=n.options.logLevel||"silent",TM.setLevel(n.options.logLevel);var a=n.options.productId="ip_messaging";if(n.options.clientMetadata=n.options.clientMetadata||{},n.options.clientMetadata.hasOwnProperty("type")||(n.options.clientMetadata.type="conversations"),n.options.clientMetadata.hasOwnProperty("sdk")||(n.options.clientMetadata.sdk="JS",n.options.clientMetadata.sdkv=EM),n.options.Sync=n.options.Sync||{},void 0===n.options.Sync.enableSessionStorage&&(n.options.Sync.enableSessionStorage=!0),n.options.region&&(n.options.Sync.region=n.options.region),!e)throw new Error("A valid Twilio token should be provided");return n.services=new IM,n.config=new xd(n.options),n.options.twilsockClient=n.options.twilsockClient||new Jk(e,a,n.options),n.options.transport=n.options.transport||n.options.twilsockClient,n.options.notificationsClient=n.options.notificationsClient||new Qk.Notifications(e,n.options),n.options.syncClient=n.options.syncClient||new Bw.exports.SyncClient(e,n.options),n.services.syncClient=n.options.syncClient,n.services.transport=n.options.transport,n.services.twilsockClient=n.options.twilsockClient,n.services.notificationClient=n.options.notificationsClient,n.services.session=new nE(n.services,n.config),n.sessionPromise=n.services.session.initialize(),n.services.network=new Sm(n.config,n.services),n.services.users=new gM({session:n.services.session,network:n.services.network,syncClient:n.services.syncClient}),n.services.users.on("userSubscribed",n.emit.bind(va(n),"userSubscribed")),n.services.users.on("userUpdated",(function(e){return n.emit("userUpdated",e)})),n.services.users.on("userUnsubscribed",n.emit.bind(va(n),"userUnsubscribed")),n.services.twilsockClient.on("tokenAboutToExpire",(function(e){return n.emit("tokenAboutToExpire",e)})),n.services.twilsockClient.on("tokenExpired",(function(){return n.emit("tokenExpired")})),n.services.twilsockClient.on("connectionError",(function(e){return n.emit("connectionError",e)})),n.services.readHorizon=new wM(n.services),n.services.typingIndicator=new kM(n.config,{transport:n.services.twilsockClient,notificationClient:n.services.notificationClient},n.getConversationBySid.bind(va(n))),n.services.syncList=new Rm(n.services),n.conversations=new ZO(n.services),n.conversationsPromise=n.sessionPromise.then((function(){return n.conversations.on("conversationAdded",n.emit.bind(va(n),"conversationAdded")),n.conversations.on("conversationRemoved",n.emit.bind(va(n),"conversationRemoved")),n.conversations.on("conversationJoined",n.emit.bind(va(n),"conversationJoined")),n.conversations.on("conversationLeft",n.emit.bind(va(n),"conversationLeft")),n.conversations.on("conversationUpdated",(function(e){return n.emit("conversationUpdated",e)})),n.conversations.on("participantJoined",n.emit.bind(va(n),"participantJoined")),n.conversations.on("participantLeft",n.emit.bind(va(n),"participantLeft")),n.conversations.on("participantUpdated",(function(e){return n.emit("participantUpdated",e)})),n.conversations.on("messageAdded",n.emit.bind(va(n),"messageAdded")),n.conversations.on("messageUpdated",(function(e){return n.emit("messageUpdated",e)})),n.conversations.on("messageRemoved",n.emit.bind(va(n),"messageRemoved")),n.conversations.on("typingStarted",n.emit.bind(va(n),"typingStarted")),n.conversations.on("typingEnded",n.emit.bind(va(n),"typingEnded")),n.conversations.fetchConversations()})).then((function(){return n.conversations})),n.services.notificationClient.on("connectionStateChanged",(function(e){var t=null;switch(e){case"connected":t="connected";break;case"denied":t="denied";break;case"disconnecting":t="disconnecting";break;case"disconnected":t="disconnected";break;default:t="connecting"}t!==n.connectionState&&(n.connectionState=t,n.emit("connectionStateChanged",n.connectionState))})),n.fpaToken=e,n}return pa(Client,[{key:"user",get:function(){return this.services.users.myself}},{key:"reachabilityEnabled",get:function(){return this.services.session.reachabilityEnabled}},{key:"token",get:function(){return this.fpaToken}},{key:"subscribeToPushNotifications",value:function(e){var t=this,n=[];return[Tm.NEW_MESSAGE,Tm.ADDED_TO_CONVERSATION,Tm.REMOVED_FROM_CONVERSATION,Tm.TYPING_INDICATOR,Tm.CONSUMPTION_UPDATE].forEach((function(r){n.push(t.services.notificationClient.subscribe(r,e))})),Promise.all(n)}},{key:"unsubscribeFromPushNotifications",value:function(e){var t=this,n=[];return[Tm.NEW_MESSAGE,Tm.ADDED_TO_CONVERSATION,Tm.REMOVED_FROM_CONVERSATION,Tm.TYPING_INDICATOR,Tm.CONSUMPTION_UPDATE].forEach((function(r){n.push(t.services.notificationClient.unsubscribe(r,e))})),Promise.all(n)}},{key:"initialize",value:(l=da(Za.mark((function e(){var t,n,r=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.sessionPromise;case 2:return Client.supportedPushChannels.forEach((function(e){return r.subscribeToPushNotifications(e)})),e.next=5,this.services.session.getSessionLinks();case 5:return t=e.sent,(n=Object.assign(this.options)).transport=null,this.services.mcsClient=new BT.McsClient(this.fpaToken,t.mediaServiceUrl,n),e.next=11,this.services.typingIndicator.initialize();case 11:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"shutdown",value:(c=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.services.twilsockClient.disconnect();case 2:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"updateToken",value:(u=da(Za.mark((function e(t){var n=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(TM.info("updateToken"),this.fpaToken!==t){e.next=3;break}return e.abrupt("return",this);case 3:return e.next=5,this.services.twilsockClient.updateToken(t).then((function(){return n.fpaToken=t})).then((function(){return n.services.mcsClient.updateToken(t)})).then((function(){return n.sessionPromise}));case 5:return e.abrupt("return",this);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"getConversationBySid",value:(s=da(Za.mark((function e(t){var n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.conversations.syncListRead.promise;case 2:return e.next=4,this.conversations.getConversation(t);case 4:if(n=e.sent){e.next=9;break}return e.next=8,this.conversations.getWhisperConversation(t);case 8:n=e.sent;case 9:if(n){e.next=11;break}throw new Error("Conversation with SID ".concat(t," is not found."));case 11:return e.abrupt("return",n);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return s.apply(this,arguments)})},{key:"getConversationByUniqueName",value:(o=da(Za.mark((function e(t){var n;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.conversations.syncListRead.promise;case 2:return e.next=4,this.conversations.getConversationByUniqueName(t);case 4:if(n=e.sent){e.next=7;break}throw new Error("Conversation with unique name ".concat(t," is not found."));case 7:return e.abrupt("return",n);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"getSubscribedConversations",value:function(e){return this.conversationsPromise.then((function(t){return t.getConversations(e)}))}},{key:"createConversation",value:function(e){return e=e||{},this.conversationsPromise.then((function(t){return t.addConversation(e)}))}},{key:"setPushRegistrationId",value:(a=da(Za.mark((function e(t,n){var r=this;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.subscribeToPushNotifications(t).then((function(){return r.services.notificationClient.setPushRegistrationId(n,t)}));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"unsetPushRegistrationId",value:(i=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(-1!==Client.supportedPushChannels.indexOf(t)){e.next=2;break}throw new Error("Invalid or unsupported channelType: "+t);case 2:return e.next=4,this.unsubscribeFromPushNotifications(t);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"handlePushNotification",value:(r=da(Za.mark((function e(t){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:TM.debug("handlePushNotification, notificationPayload=",t),this.emit("pushNotification",Client.parsePushNotification(t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"getUser",value:function(e){return this.services.users.getUser(e)}},{key:"getSubscribedUsers",value:(n=da(Za.mark((function e(){return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this.services.users.getSubscribedUsers());case 1:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})}],[{key:"create",value:(t=da(Za.mark((function e(t,n){var r,i;return Za.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new Client(t,n),i="conversations.client.startup",r.services.twilsockClient.addPartialTelemetryEvent(new Ek(i,"Conversations client startup",new Date),i,Rk.Start),e.next=5,r.initialize();case 5:return r.services.twilsockClient.addPartialTelemetryEvent(new Ek("","",new Date),i,Rk.End),e.abrupt("return",r);case 7:case"end":return e.stop()}}),e)}))),function(e,n){return t.apply(this,arguments)})},{key:"parsePushNotificationChatData",value:function(e){var t={};for(var n in Client.supportedPushDataFields)void 0!==e[n]&&null!==e[n]&&("message_index"===n?null!==pp(e[n])&&(t[Client.supportedPushDataFields[n]]=Number(e[n])):t[Client.supportedPushDataFields[n]]=e[n]);return t}},{key:"parsePushNotification",value:function(e){if(TM.debug("parsePushNotification, notificationPayload=",e),void 0!==e.aps){if(!e.twi_message_type)throw new Error("Provided push notification payload does not contain Programmable Chat push notification type");var t=Client.parsePushNotificationChatData(e),n=e.aps,r=null,i=null;return"string"==typeof n.alert?r=n.alert||null:(r=n.alert.body||null,i=n.alert.title||null),new PushNotification({title:i,body:r,sound:n.sound||null,badge:n.badge||null,action:n.category||null,type:e.twi_message_type,data:t})}if(void 0!==e.data){var a=e.data;if(!a.twi_message_type)throw new Error("Provided push notification payload does not contain Programmable Chat push notification type");var o=Client.parsePushNotificationChatData(e.data);return new PushNotification({title:a.twi_title||null,body:a.twi_body||null,sound:a.twi_sound||null,badge:null,action:a.twi_action||null,type:a.twi_message_type,data:o})}throw new Error("Provided push notification payload is not Programmable Chat notification")}}]),Client}(Of);return wa(Client,"version",EM),wa(Client,"supportedPushChannels",["fcm","apn"]),wa(Client,"supportedPushDataFields",{conversation_sid:"conversationSid",message_sid:"messageSid",message_index:"messageIndex"}),Rf([ly(ay),Cf("design:type",Function),Cf("design:paramtypes",[String]),Cf("design:returntype",Promise)],Client.prototype,"updateToken",null),Rf([ly(ay),Cf("design:type",Function),Cf("design:paramtypes",[String]),Cf("design:returntype",Promise)],Client.prototype,"getConversationBySid",null),Rf([ly(ay),Cf("design:type",Function),Cf("design:paramtypes",[String]),Cf("design:returntype",Promise)],Client.prototype,"getConversationByUniqueName",null),Rf([ly(["undefined",sy("conversation options",{friendlyName:["string","undefined"],isPrivate:["boolean","undefined"],uniqueName:["string","undefined"]})]),Cf("design:type",Function),Cf("design:paramtypes",[Object]),Cf("design:returntype",Promise)],Client.prototype,"createConversation",null),Rf([ly(iy("fcm","apn"),"string"),Cf("design:type",Function),Cf("design:paramtypes",[String,String]),Cf("design:returntype",Promise)],Client.prototype,"setPushRegistrationId",null),Rf([ly(iy("fcm","apn")),Cf("design:type",Function),Cf("design:paramtypes",[String]),Cf("design:returntype",Promise)],Client.prototype,"unsetPushRegistrationId",null),Rf([ly(uy),Cf("design:type",Function),Cf("design:paramtypes",[Object]),Cf("design:returntype",Promise)],Client.prototype,"handlePushNotification",null),Rf([ly(ay),Cf("design:type",Function),Cf("design:paramtypes",[String]),Cf("design:returntype",Promise)],Client.prototype,"getUser",null),Rf([ly("string",["undefined",uy]),Cf("design:type",Function),Cf("design:paramtypes",[String,Object]),Cf("design:returntype",Promise)],Client,"create",null),Rf([cy(uy),Cf("design:type",Function),Cf("design:paramtypes",[Object]),Cf("design:returntype",PushNotification)],Client,"parsePushNotification",null),e.Client=Client,e.PushNotification=PushNotification,e.User=User,e.default=Client,Object.defineProperty(e,"__esModule",{value:!0}),e}({});
